<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>七路灯</title>
  
  <subtitle>人的一生应当有许多停靠站，但愿每一个站台都有一盏雾中的灯。</subtitle>
  <link href="http://www.lights8080.com/atom.xml" rel="self"/>
  
  <link href="http://www.lights8080.com/"/>
  <updated>2021-07-08T06:30:09.000Z</updated>
  <id>http://www.lights8080.com/</id>
  
  <author>
    <name>七路灯</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Git</title>
    <link href="http://www.lights8080.com/2021/07/08/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/Git/"/>
    <id>http://www.lights8080.com/2021/07/08/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/Git/</id>
    <published>2021-07-07T16:00:00.000Z</published>
    <updated>2021-07-08T06:30:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>Git</p><span id="more"></span><h2 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h2><p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/07/unknown.jpg"><br>Production 分支<br>也就是我们经常使用的Master分支，这个分支最近发布到生产环境的代码，最近发布的Release， 这个分支只能从其他分支合并，不能在这个分支直接修改</p><p>Develop 分支<br>这个分支是我们是我们的主开发分支，包含所有要发布到下一个Release的代码，这个主要合并与其他分支，比如Feature分支</p><p>Feature 分支<br>这个分支主要是用来开发一个新的功能，一旦开发完成，我们合并回Develop分支进入下一个Release</p><p>Release分支<br>当你需要一个发布一个新Release的时候，我们基于Develop分支创建一个Release分支，完成Release后，我们合并到Master和Develop分支</p><p>Hotfix分支<br>当我们在Production发现新的Bug时候，我们需要创建一个Hotfix, 完成Hotfix后，我们合并回Master和Develop分支，所以Hotfix的改动会进入下一个Release</p><h2 id="工作区（Working-Directory）"><a href="#工作区（Working-Directory）" class="headerlink" title="工作区（Working Directory）"></a>工作区（Working Directory）</h2><p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/07/DFS0Z5.png"></p><p>git add命令实际上是把文件添加到Stage<br>git commit就是往master分支上提交更改</p><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/07/RJ7iyg.png"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">git revert：撤销某次操作，此次操作之前和之后的commit和<span class="built_in">history</span>都会保留，并且把这次撤销</span><br><span class="line">git clean：删除工作目录中所有没有tracked过的文件</span><br><span class="line">git reset：返回到某个节点</span><br><span class="line">git <span class="built_in">clone</span>：命令用于从远程主机克隆一个版本库。Git支持https和ssh协议，https每次需要输入密码速度慢</span><br><span class="line">git pull：命令用于取回远程主机某个分支的更新，与本地的指定分支合并</span><br><span class="line">git push：命令用于将本地分支的更新，推送到远程主机</span><br><span class="line">git remote：远程仓库管理</span><br><span class="line">git fetch：命令用于将远程主机版本库中更新内容取回本地，可指定分支</span><br><span class="line">git <span class="built_in">log</span>：显示提交历史</span><br><span class="line">git merge：合并分支</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###（分支管理）</span></span><br><span class="line"><span class="comment">#基于远程分支“master”，创建本地分支dev</span></span><br><span class="line"><span class="variable">$git</span> checkout -b dev origin/master</span><br><span class="line"><span class="comment">#创建分支并切换。相当于执行git branch dev和git checkout dev两条命令</span></span><br><span class="line"><span class="variable">$git</span> checkout -b dev</span><br><span class="line"><span class="comment">#切换到master分支</span></span><br><span class="line"><span class="variable">$git</span> checkout master</span><br><span class="line"></span><br><span class="line">git reset：返回到某个节点</span><br><span class="line"><span class="comment">#（默认方式）回退到某个版本，只保留源码，取消了commit ，取消了add</span></span><br><span class="line"><span class="variable">$git</span> reset --mixed HASH</span><br><span class="line"><span class="comment">#回到当前分支最新的版本，不保留修改（不可逆）</span></span><br><span class="line"><span class="variable">$git</span> reset --hard [HASH]</span><br><span class="line"><span class="comment">#返回到某个节点。回退了commit的信息，保留修改</span></span><br><span class="line"><span class="variable">$git</span> reset --soft HASH</span><br><span class="line"><span class="comment">#从add中返回到之前的状态，保留修改</span></span><br><span class="line"><span class="variable">$git</span> reset -q 文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#列出Git配置</span></span><br><span class="line"><span class="variable">$git</span> config --list</span><br><span class="line"><span class="comment">#设置用户名</span></span><br><span class="line"><span class="variable">$git</span> config --global user.name <span class="string">&quot;Jerry Mouse&quot;</span></span><br><span class="line"><span class="comment">#设置邮箱ID</span></span><br><span class="line"><span class="variable">$git</span> config --global user.email <span class="string">&quot;jerry@yiibai.com&quot;</span></span><br><span class="line">(如果省略--global选项，那么配置是具体当前的Git存储库)</span><br><span class="line"></span><br><span class="line">git stash    <span class="comment">#储藏当前工作现场，等以后恢复现场继续工作</span></span><br><span class="line">git stash list    <span class="comment">#查询保存的工作现场列表</span></span><br><span class="line">git stash apply stash@&#123;0&#125;    <span class="comment">#恢复指定的stash</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Git&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="Git" scheme="http://www.lights8080.com/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Linux 2&gt;&amp;1</title>
    <link href="http://www.lights8080.com/2021/07/07/%E6%8A%80%E6%9C%AF/Linux/Linux%202%3E&amp;1/"/>
    <id>http://www.lights8080.com/2021/07/07/%E6%8A%80%E6%9C%AF/Linux/Linux%202%3E&amp;1/</id>
    <published>2021-07-06T16:00:00.000Z</published>
    <updated>2021-07-07T08:22:27.000Z</updated>
    
    <content type="html"><![CDATA[<p>2&gt;&amp;1说明</p><span id="more"></span><h2 id="2-gt-amp-1"><a href="#2-gt-amp-1" class="headerlink" title="2&gt;&amp;1"></a>2&gt;&amp;1</h2><p>看下这个命令<code>nohup command&gt;/dev/null 2&gt;&amp;1 &amp;</code></p><ul><li><code>nohup</code> 表示可以在你退出帐户之后继续运行相应的进程</li><li><code>&gt;</code> 代表重定向到哪里，例如：echo “123” &gt; /home/123.txt</li><li>/dev/null 表示空设备文件</li><li>2&gt;&amp;1 表示把标准错误重定向到标准输出<ul><li>0 表示stdin标准输入</li><li>1 表示stdout标准输出，系统默认值是1，所以”&gt;/dev/null”等同于 “1&gt;/dev/null”</li><li>2 表示stderr标准错误</li></ul></li><li><code>&amp;</code> 表示该命令以后台的job的形式运行</li></ul><h2 id="command-gt-a-2-gt-a-VS-command-gt-a-2-gt-amp-1"><a href="#command-gt-a-2-gt-a-VS-command-gt-a-2-gt-amp-1" class="headerlink" title="command&gt;a 2&gt;a VS command&gt;a 2&gt;&amp;1"></a>command&gt;a 2&gt;a VS command&gt;a 2&gt;&amp;1</h2><ul><li>command&gt;a 2&gt;&amp;1：打开了一次文件a，&amp;1的含义就可以理解为用标准输出的引用</li><li>command&gt;a 2&gt;a：打开文件两次，并导致stdout被stderr覆盖</li></ul><h2 id="gt-dev-null-2-gt-amp-1-VS-2-gt-amp-1-gt-dev-null"><a href="#gt-dev-null-2-gt-amp-1-VS-2-gt-amp-1-gt-dev-null" class="headerlink" title="&gt;/dev/null 2&gt;&amp;1 VS 2&gt;&amp;1 &gt;/dev/null"></a>&gt;/dev/null 2&gt;&amp;1 VS 2&gt;&amp;1 &gt;/dev/null</h2><ul><li><code>&gt;/dev/null 2&gt;&amp;1</code>：标准输出(丢弃)，错误输出(丢弃)</li><li><code>2&gt;&amp;1 &gt;/dev/null</code>：标准输出(丢弃)，错误输出(屏幕)</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;2&amp;gt;&amp;amp;1说明&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/Linux/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>同步订单到ES</title>
    <link href="http://www.lights8080.com/2021/07/07/%E6%8A%80%E6%9C%AF/%E8%84%9A%E6%9C%AC/%E5%90%8C%E6%AD%A5%E8%AE%A2%E5%8D%95%E5%88%B0ES/"/>
    <id>http://www.lights8080.com/2021/07/07/%E6%8A%80%E6%9C%AF/%E8%84%9A%E6%9C%AC/%E5%90%8C%E6%AD%A5%E8%AE%A2%E5%8D%95%E5%88%B0ES/</id>
    <published>2021-07-06T16:00:00.000Z</published>
    <updated>2021-07-08T08:46:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>从Mysql-&gt;logstash-&gt;Elasticsearch。支持时间字段时区设置，防止重复执行，错误订单记录。</p><span id="more"></span><h2 id="sync-order-fix2-sh"><a href="#sync-order-fix2-sh" class="headerlink" title="sync_order_fix2.sh"></a>sync_order_fix2.sh</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">es_script_path=<span class="string">&quot;/opt/sync_elasticsearch/&quot;</span></span><br><span class="line">file_suffix=<span class="string">&quot;order_fix2&quot;</span></span><br><span class="line"></span><br><span class="line">LOCK=$(cat <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$LOCK</span> -eq 1 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;`date &quot;</span>+%Y-%m-%d %H:%M:%S<span class="string">&quot;` locked&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#DATE_BEGIN=$(cat $es_script_path/.lasttime_$file_suffix)</span></span><br><span class="line"><span class="comment">#DATE_END=`date +&quot;%Y-%m-%d %H:%M:%S&quot;`</span></span><br><span class="line"></span><br><span class="line">DATE_BEGIN=<span class="string">&quot;2021-01-01 00:00:00&quot;</span></span><br><span class="line">DATE_END=<span class="string">&quot;2021-04-01 00:00:00&quot;</span></span><br><span class="line"></span><br><span class="line">ORDERS_SQL=<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">select order_no from db.order_main where gmt_create BETWEEN &#x27;<span class="variable">$DATE_BEGIN</span>&#x27; and &#x27;<span class="variable">$DATE_END</span>&#x27;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">successStr=<span class="string">&#x27;&quot;status&quot;:0&#x27;</span></span><br><span class="line"><span class="built_in">declare</span> -i succ_c</span><br><span class="line"><span class="built_in">declare</span> -i fail_c</span><br><span class="line"><span class="built_in">declare</span> -i order_c</span><br><span class="line"><span class="built_in">declare</span> -i run_c</span><br><span class="line">succ_c=0</span><br><span class="line">fail_c=0</span><br><span class="line">run_c=0</span><br><span class="line">ORDERS_RESULT=$(mysql -u xxx -pxxx -h 127.0.0.1 db -e  <span class="string">&quot;<span class="variable">$ORDERS_SQL</span>&quot;</span>);</span><br><span class="line">order_c=$(<span class="built_in">echo</span> <span class="variable">$ORDERS_RESULT</span>|wc -w)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$order_c</span> -gt 0 ];<span class="keyword">then</span></span><br><span class="line">  order_c=<span class="variable">$order_c</span>-1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sync order begin. time:<span class="variable">$DATE_BEGIN</span> ~ <span class="variable">$DATE_END</span>, count:<span class="variable">$order_c</span>&quot;</span></span><br><span class="line"><span class="keyword">for</span> LINE <span class="keyword">in</span> <span class="variable">$ORDERS_RESULT</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&#x27;order_no&#x27;</span> != <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    run_c=<span class="variable">$run_c</span>+1</span><br><span class="line">    orderdetail_result=$(curl -XPOST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -H <span class="string">&quot;username: _system_sync&quot;</span> -H <span class="string">&quot;Authorization: fbIywHBF4Y0uaX5xDLReM5kypLrxP2pY&quot;</span> -d <span class="string">&#x27;&#123;&quot;orderNo&quot;:&quot;&#x27;</span><span class="variable">$LINE</span><span class="string">&#x27;&quot;&#125;&#x27;</span> http://10.88.2.1:80/u2c-order-service/orderDetail -s)</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$orderdetail_result</span>  =~ <span class="variable">$successStr</span> ]];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$orderdetail_result</span>&quot;</span> &gt; <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span></span><br><span class="line">      cat <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span> |jq <span class="string">&#x27;.orderInfo&#x27;</span> -c &gt;<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">      sed -i <span class="string">&#x27;s/[0-9]\&#123;4\&#125;-[0-9]\&#123;2\&#125;-[0-9]\&#123;2\&#125; [0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;/&amp; +0800/g&#x27;</span> <span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">      logstash_result=$(curl -XPOST -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://10.88.2.1:4000 -d@<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span> -s)</span><br><span class="line">      <span class="keyword">if</span> [ <span class="string">&quot;ok&quot;</span> == <span class="variable">$logstash_result</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$order_c</span>/<span class="variable">$run_c</span> <span class="variable">$LINE</span> ok&quot;</span></span><br><span class="line">        succ_c=<span class="variable">$succ_c</span>+1</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> &gt;&gt; <span class="variable">$es_script_path</span>/failure_<span class="variable">$file_suffix</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$order_c</span>/<span class="variable">$run_c</span> <span class="variable">$LINE</span> fail -&gt; <span class="variable">$logstash_result</span>&quot;</span></span><br><span class="line">        fail_c=<span class="variable">$fail_c</span>+1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> &gt;&gt; <span class="variable">$es_script_path</span>/failure_<span class="variable">$file_suffix</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$order_c</span>/<span class="variable">$run_c</span> <span class="variable">$LINE</span> fail -&gt; <span class="variable">$orderdetail_result</span>&quot;</span></span><br><span class="line">      fail_c=<span class="variable">$fail_c</span>+1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sync order end. time:<span class="variable">$DATE_BEGIN</span> ~ <span class="variable">$DATE_END</span>, count:<span class="variable">$order_c</span>, succ:<span class="variable">$succ_c</span>, fail:<span class="variable">$fail_c</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DATE_END</span> &gt; <span class="variable">$es_script_path</span>/.lasttime_<span class="variable">$file_suffix</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;从Mysql-&amp;gt;logstash-&amp;gt;Elasticsearch。支持时间字段时区设置，防止重复执行，错误订单记录。&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="脚本" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/%E8%84%9A%E6%9C%AC/"/>
    
    
    <category term="脚本" scheme="http://www.lights8080.com/tags/%E8%84%9A%E6%9C%AC/"/>
    
    <category term="Shell" scheme="http://www.lights8080.com/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>ELK-实践20210629</title>
    <link href="http://www.lights8080.com/2021/06/29/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B520210629/"/>
    <id>http://www.lights8080.com/2021/06/29/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B520210629/</id>
    <published>2021-06-28T16:00:00.000Z</published>
    <updated>2021-07-01T07:32:02.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>复合聚合按计数排序，TSVB使用脚本字段，滚动升级，Elastic中国社区官方博客</p></blockquote><span id="more"></span><h2 id="1-复合聚合按计数排序"><a href="#1-复合聚合按计数排序" class="headerlink" title="1. 复合聚合按计数排序"></a>1. 复合聚合按计数排序</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">GET /service-exception/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;2021-05-06 00:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="string">&quot;2021-05-06 23:59:59&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;time_zone&quot;</span>:<span class="string">&quot;+08:00&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;group_by_fields&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;composite&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;sources&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;service_name&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;service_name&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            <span class="attr">&quot;error_message&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;error_message&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">50</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;top_bucket_sort&quot;</span>:&#123;</span><br><span class="line">          <span class="attr">&quot;bucket_sort&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: [</span><br><span class="line">              &#123; <span class="attr">&quot;_count&quot;</span>: &#123; <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span> &#125; &#125;</span><br><span class="line">              ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-TSVB使用脚本字段（-TSVB-Visualize-Scripted-Fields）"><a href="#2-TSVB使用脚本字段（-TSVB-Visualize-Scripted-Fields）" class="headerlink" title="2. TSVB使用脚本字段（[TSVB] Visualize Scripted Fields）"></a>2. TSVB使用脚本字段（[TSVB] Visualize Scripted Fields）</h2><p>在7.13版本中支持</p><p><a href="https://github.com/elastic/kibana/issues/13928">https://github.com/elastic/kibana/issues/13928</a><br><a href="https://github.com/elastic/kibana/issues/11999">https://github.com/elastic/kibana/issues/11999</a><br><a href="https://github.com/elastic/kibana/issues/82438">https://github.com/elastic/kibana/issues/82438</a></p><h2 id="3-滚动升级（Rolling-Upgrade-Elasticsearch）"><a href="#3-滚动升级（Rolling-Upgrade-Elasticsearch）" class="headerlink" title="3. 滚动升级（Rolling Upgrade Elasticsearch）"></a>3. 滚动升级（Rolling Upgrade Elasticsearch）</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-upgrade.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-upgrade.html</a></p><p>注意事项：</p><ol><li>不支持在升级期间以外在同一集群中运行多个版本的Elasticsearch，因为不能将分片从升级的节点复制到运行旧版本的节点。</li><li>升级时将集群的节点划分为两组并按顺序升级组（第一组：Nodes that are not Master-eligible，第二组：Master-eligible nodes），可以确保所有Master-ineligible节点都能够加入集群，无论符合Master-eligible节点是否已经升级。</li><li>一旦您开始将集群升级到指定版本，您就必须完成升级，它可能对其内部状态进行无法恢复的更改</li></ol><p>升级步骤：</p><ul><li>禁用分片分配</li><li>停止非必要的索引和执行同步刷新(可选)</li><li>暂时停止与活动机器学习作业和数据源相关的任务(可选)</li><li>关闭单个节点</li><li>升级关闭的节点(如果没有使用外部数据目录，请将旧数据目录复制到新安装)</li><li>升级任何插件</li><li>启动升级后的节点</li><li>重新启用分片分配</li><li>等待节点恢复</li><li>对于需要更新的每个节点重复这些步骤</li><li>重新启动机器学习作业</li></ul><p>检查</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 升级时将集群的节点划分为两组并按顺序升级组</span><br><span class="line">GET /_nodes/_all,master:<span class="literal">false</span></span><br><span class="line">GET /_nodes/master:<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"># 禁用分片分配</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.enable&quot;</span>: <span class="string">&quot;primaries&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 停止非必要的索引和执行同步刷新</span><br><span class="line">POST _flush/synced</span><br><span class="line"></span><br><span class="line"># 重新启用分片分配</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.enable&quot;</span>: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 等待节点恢复</span><br><span class="line">GET _cat/health?v=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"># 对于需要更新的每个节点重复这些步骤</span><br><span class="line">GET /_cat/health?v=<span class="literal">true</span></span><br><span class="line">GET /_cat/nodes?h=ip,name,version&amp;v=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"># 重新启动机器学习作业</span><br><span class="line">POST _ml/set_upgrade_mode?enabled=<span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="4-数据增强"><a href="#4-数据增强" class="headerlink" title="4. 数据增强"></a>4. 数据增强</h2><p>数据增强有很多种方式</p><ol><li>数据源处理</li><li>自定义脚本</li><li>Logstash Filter</li><li>ES pipeline</li></ol><h2 id="5-Elastic中国社区官方博客"><a href="#5-Elastic中国社区官方博客" class="headerlink" title="5. Elastic中国社区官方博客"></a>5. Elastic中国社区官方博客</h2><p><a href="https://elasticstack.blog.csdn.net/article/details/118152293">Kibana：如何让用户匿名访问 Kibana 中的 Dashboard</a><br><a href="https://elasticstack.blog.csdn.net/article/details/117187064">Elasticsearch：运用 Python 来实现对搜索结果的分页</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;复合聚合按计数排序，TSVB使用脚本字段，滚动升级，Elastic中国社区官方博客&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>JAVA面向对象编程思想</title>
    <link href="http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/JAVA%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/"/>
    <id>http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/JAVA%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/</id>
    <published>2021-06-23T16:00:00.000Z</published>
    <updated>2021-06-24T08:20:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>翻看之前总结的文本，整理时在重新理解这些概念，发现编程思想真的非常重要，是怎么把复杂的逻辑梳理结构化的过程。</p><span id="more"></span><h2 id="如何理解面向对象编程"><a href="#如何理解面向对象编程" class="headerlink" title="如何理解面向对象编程"></a>如何理解面向对象编程</h2><p>只定义业务的框架，而不去实现具体业务功能。就像盖楼房，有楼梯、电梯、门的位置等；只提供了一个框架和公共设施，不去管住户室内的设计，让住户按照自己的需求去实现。如Struts：提供了MVC的流程架构，具体的展示和业务实现交给用户处理。</p><p>面向接口编程：实现应用层与实现层的分离，提高系统维护和扩展。通过接口约束对象的属性和行为，是面向对象的一部分。</p><h4 id="面向对象编程优点："><a href="#面向对象编程优点：" class="headerlink" title="面向对象编程优点："></a>面向对象编程优点：</h4><p>1）易维护：代码可读性高，维护成本低<br>2）易扩展：由于封装、继承、多态的特征设计出高内聚、低耦合的系统架构，提高系统灵活性和扩展性。</p><p>耦合：模块之间的关联强度应该是比较弱的，即低耦合。<br>内聚：模块内的各个元素的联系时紧密的，即高内聚。<br>面向对象编程是一种思想。主要特征是：封装、继承、多态、抽象。5个设计原则。</p><h4 id="面向对象编程特征："><a href="#面向对象编程特征：" class="headerlink" title="面向对象编程特征："></a>面向对象编程特征：</h4><ul><li>封装：把过程和数据包围起来，通过已定义的界面访问数据。提高代码重用性。</li><li>继承：对象的一个新类可以从现有的类中派生，这个过程叫做继承。新类继承了原有类的属性和方法。提高代码重用性。</li><li>多态：允许不同类的对象对同一消息做出响应。提高灵活性和重用性。</li><li>抽象：分离对象的行为和实现。</li></ul><h4 id="面向对象设计原则："><a href="#面向对象设计原则：" class="headerlink" title="面向对象设计原则："></a>面向对象设计原则：</h4><ul><li>单一职责原则(Single Responsibility Principle-SRP)：一个对象只有一种单一的职责。过多的职责会使代码牵一发而动全身。</li><li>开放封闭原则(Open-Closed Principle-OCP)：对扩展开放，对修改封闭。是面向对象所有原则的核心。</li><li>依赖倒置原则(Dependency Inversion Principle-DIP)：核心思想是依赖于抽象，不依赖于具体。是面向对象设计的精髓。抽象的稳定性决定了系统的稳定性，因为抽象是不变的。</li><li>接口隔离原则(Interface Segregation Principle-ISP)：定义许多特定的接口好过定义一个通用的接口。</li><li>里氏替换原则(Liskvo Substitution Principle-LSP)：程序中子类必须能够替换其父类，这是保证继承复用的基础。是关于继承机制的设计原则。保证系统具有良好的拓展性，同时实现基于多态的抽象机制，能够减少代码冗余，避免运行期的类型判别。</li><li>迪米特法则(Law of Demeter or Least Knowlegde Principle-LoD or LKP)：一个对象应该尽可能少的去了解其他对象。松耦合原则。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;翻看之前总结的文本，整理时在重新理解这些概念，发现编程思想真的非常重要，是怎么把复杂的逻辑梳理结构化的过程。&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="JAVA" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/JAVA/"/>
    
    
    <category term="JAVA" scheme="http://www.lights8080.com/tags/JAVA/"/>
    
    <category term="编程思想" scheme="http://www.lights8080.com/tags/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>Maven</title>
    <link href="http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/Maven/"/>
    <id>http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/Maven/</id>
    <published>2021-06-23T16:00:00.000Z</published>
    <updated>2021-06-24T08:48:08.000Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="依赖范围"><a href="#依赖范围" class="headerlink" title="依赖范围"></a>依赖范围</h2><p>Maven在编译、测试、运行环境下都需要独立的一套classpath。</p><ul><li>compile：（默认）编译依赖范围，对于编译、测试、运行三种classpath都有效。典型的是spring-core，三种环境都使用。</li><li>test：测试依赖范围，只对于测试classpath有效。典型的是Junit，测试时使用。</li><li>provided：已提供依赖范围，对于编译和测试classpath有效。典型的是servlet-api，容器已提供。</li><li>runtime：运行时依赖范围，对于测试和运行classpath有效。典型的是JDBC驱动实现，编译时JDK提供了JDBC接口。</li><li>system：系统依赖范围，往往与本地系统绑定，造成不可移植性，谨慎使用。</li></ul><h2 id="依赖原则"><a href="#依赖原则" class="headerlink" title="依赖原则"></a>依赖原则</h2><p>传递性依赖：A项目–依赖于–&gt;B项目–依赖于–&gt;C项目。A项目对于C项目是传递性依赖。<br>依赖调解：A–&gt;B–&gt;C–&gt;X(1.0)，A–&gt;D–&gt;X(2.0)。传递性依赖有可能造成依赖问题。这时候依赖路径上有两个X版本，该依赖那条路径下的X项目呢？路径选择原则，第一原则：路径最近者优先，第二原则：第一声明者优先。<br>可选依赖：A–&gt;B，B–&gt;X(可选)，B–&gt;Y(可选)。可选依赖只会对当前项目B产生影响，依赖不会被传递，A不会有任何影响。例如：X为mysql驱动包，Y为oracle驱动包，这种情况只能依赖一种数据库驱动包。POM代码：<optional>true</optional>。推荐采用单一职责原则。为mysql和oracle分别建立Maven项目。就不存在可选依赖了。</p><h2 id="Maven插件和生命周期"><a href="#Maven插件和生命周期" class="headerlink" title="Maven插件和生命周期"></a>Maven插件和生命周期</h2><p>Maven插件执行详解：</p><ul><li>maven-clean-plugin:2.5:clean (default-clean)   删除target目录</li><li>maven-resources-plugin:2.6:resources (default-resources)    拷贝主程序配置文件到target/classes目录</li><li>maven-compiler-plugin:2.5.1:compile (default-compile)    编译主程序目录java文件到target/classes目录</li><li>maven-resources-plugin:2.6:testResources (default-testResources)    拷贝测试程序配置文件到target/classes目录</li><li>maven-compiler-plugin:2.5.1:testCompile (default-testCompile)    编译测试程序目录java文件到target/classes目录</li><li>maven-surefire-plugin:2.12.4:test (default-test)    运行测试用例</li><li>maven-jar-plugin:2.4:jar (default-jar)    将项目主代码打包成jar文件（不包含测试程序和测试配置文件）</li><li>maven-install-plugin:2.4:install (default-install)   将项目输出的jar文件安装到Maven本地仓库中</li></ul><p>mvn命令执行过程：</p><ul><li>mvn clean   default-clean</li><li>mvn compile   default-resources–&gt; default-compile</li><li>mvn test     mvn compile–&gt; default-testResources–&gt; default-testCompile–&gt; default-test</li><li>mvn package    mvn test–&gt; default-jar</li><li>mvn install   mvn package–&gt; default-install</li><li>mvn deploy   项目构建输出的构件部署到对应的远程仓库</li><li>mvn clean install-U   强制让Maven检查更新</li><li>mvn help:describe -Dplugin=compiler  获取插件compiler的描述信息</li><li>mvn dependency:tree    获得项目依赖树</li></ul><h2 id="插件说明"><a href="#插件说明" class="headerlink" title="插件说明"></a>插件说明</h2><p>1、设置源文件编码方式<br>2、解决资源文件的编码问题<br>3、配置多个源文件夹<br>4、打包source文件为jar文件<br>5、拷贝依赖的jar包到目录<br>6、生成源代码包<br>7、打包jar文件时，配置manifest文件，加入lib包的jar依赖<br>8、编译java文件使用依赖本地jar包<br>9、打war包配置项目webContext相对路径、排除文件<br>10、生成可执行jar文件1<br>11、生成可执行jar文件2<br>12、编译错误（错误: 不兼容的类型）增加配置<br>13、跳过测试</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 解决资源文件的编码问题 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 打包source文件为jar文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attach</span>&gt;</span>true<span class="tag">&lt;/<span class="name">attach</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 拷贝依赖的jar包到目录 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                    $&#123;project.build.directory&#125;/dependency</span><br><span class="line">                <span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includeScope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">includeScope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludeScope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">excludeScope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 设置源文件编码方式 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">defaultLibBundleDir</span>&gt;</span>lib<span class="tag">&lt;/<span class="name">defaultLibBundleDir</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 打包jar文件时，配置manifest文件，加入lib包的jar依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>.....MonitorMain<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置多个源文件夹 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>build-helper-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>add-source<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sources</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>src/utils<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>src/platform<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">sources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 编译java文件使用依赖本地jar包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extdirs</span>&gt;</span>src\main\webapp\WEB-INF\lib或$&#123;basedir&#125;/WebContent/WEB-INF/lib<span class="tag">&lt;/<span class="name">extdirs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 打war包配置项目webContext相对路径、排除文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--包含空文件夹--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includeEmptyDirectories</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeEmptyDirectories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">warSourceDirectory</span>&gt;</span>WebContent<span class="tag">&lt;/<span class="name">warSourceDirectory</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 排除文件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">packagingExcludes</span>&gt;</span>WEB-INF/classes/**/*.*,WEB-INF/lib/**/*<span class="tag">&lt;/<span class="name">packagingExcludes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--将类文件打成jar包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archiveClasses</span>&gt;</span>true<span class="tag">&lt;/<span class="name">archiveClasses</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 生成源代码包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>attach-sources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar-no-fork<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 生成可执行jar文件1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.abc.ABCTest<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span><span class="comment">&lt;!-- 入口类名 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 生成可执行jar文件2   执行命令：mvn clean install --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.lihp.mvnbook.helloworld.HelloWorld<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 编译错误（错误: 不兼容的类型）增加配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">compilerId</span>&gt;</span>csharp<span class="tag">&lt;/<span class="name">compilerId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extdirs</span>&gt;</span>$&#123;lib.dir&#125;<span class="tag">&lt;/<span class="name">extdirs</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.plexus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>plexus-compiler-csharp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 跳过测试 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;h2 id=&quot;依赖范围&quot;&gt;&lt;a href=&quot;#依赖范围&quot; class=&quot;headerlink&quot; title=&quot;依赖范围&quot;&gt;&lt;/a&gt;依赖范围&lt;/h2&gt;&lt;p&gt;Maven在编译、测试、运行环境下都需要独立的一套classpath。&lt;/</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Java" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/Java/"/>
    
    
    <category term="Maven" scheme="http://www.lights8080.com/tags/Maven/"/>
    
  </entry>
  
  <entry>
    <title>字符集和字符编码</title>
    <link href="http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/%E5%AD%97%E7%AC%A6%E9%9B%86%E5%92%8C%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/"/>
    <id>http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/%E5%AD%97%E7%AC%A6%E9%9B%86%E5%92%8C%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/</id>
    <published>2021-06-23T16:00:00.000Z</published>
    <updated>2021-07-08T03:15:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>UTF-8、GBK、ASCII、Unicode的区别</p><span id="more"></span><h2 id="字符集和字符编码"><a href="#字符集和字符编码" class="headerlink" title="字符集和字符编码"></a>字符集和字符编码</h2><p>字符集（Charset）：是一个系统支持的所有抽象字符的集合。字符是各种文字和符号的总称，包括各国家文字、标点符号、图形符号、数字等。</p><p>字符编码（Character Encoding）：是一套法则，使用该法则能够对自然语言的字符的一个集合（如字母表或音节表），与其他东西的一个集合（如号码或电脉冲）进行配对。</p><p>常见字符集名称：ASCII字符集、GB2312字符集、BIG5字符集、GB18030字符集、Unicode字符集等。计算机要准确的处理各种字符集文字，需要进行字符编码，以便计算机能够识别和存储各种文字。</p><h3 id="ASCII字符集-amp-编码"><a href="#ASCII字符集-amp-编码" class="headerlink" title="ASCII字符集&amp;编码"></a>ASCII字符集&amp;编码</h3><p>ASCII（American Standard Code for Information Interchange，美国信息交换标准代码）是基于拉丁字母的一套电脑编码系统。<br>ASCII字符集使用7位（bits）表示一个字符，共128字符，ASCII扩展字符集使用8位（bits）表示一个字符，共256字符。</p><h3 id="GBXXXX字符集-amp-编码"><a href="#GBXXXX字符集-amp-编码" class="headerlink" title="GBXXXX字符集&amp;编码"></a>GBXXXX字符集&amp;编码</h3><p>为了显示中文，必须设计一套编码规则用于将汉字转换为计算机可以接受的数字系统的数。规定：一个小于127的字符的意义与原来相同，但两个大于127的字符连在一起时，就表示一个汉字。连在ASCII里本来就有的数字、标点、字母都统统重新编了两个字节长的编码，这就是常说的”全角”字符，而原来在127号以下的那些就叫”半角”字符了。</p><p>GB2312或GB2312-80是中国国家标准简体中文字符集，全称《信息交换用汉字编码字符集·基本集》，又称GB0，由中国国家标准总局发布。对于人名、古汉语等方面出现的罕用字，GB2312不能处理，这导致了后来GBK及GB18030汉字字符集的出现。</p><h3 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h3><p>Unicode编码系统为表达任意语言的任意字符而设计，是国际组织制定的可以容纳所有文字和符号的字符编码方案。它使用4字节的数字来表达每个字母、符号，或者表意文字(ideograph)。其用数字来映射字符，浏览器不能直接展示，只能转换成其他格式的编码（UTF-8、GBK）。<br>Unicode用数字0-0x10FFFF来映射这些字符，最多可以容纳1114112（16^4 * 17） 个字符。</p><p>GBK与UTF-8之间必须通过Unicode编码才能相互转换</p><h3 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h3><p>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字符编码，也是一种前缀码。它可以用来表示Unicode标准中的任何字符，且其编码中的第一个字节仍与ASCII兼容，这使得原来处理ASCII字符的软件无须或只须做少部份修改，即可继续使用。因此，它逐渐成为电子邮件、网页及其他存储或传送文字的应用中，优先采用的编码。互联网工程工作小组（IETF）要求所有互联网协议都必须支持UTF-8编码。</p><p>UTF-8：用来解决国际上字符的一种多字节编码，包含全世界所有国家需要用到的字符。通用性比较好。<br>示例：使用UTF-8编码，如果外国人用英文IE访问中文网站，也能显示中文，不需要中文语言包支持。避免乱码问题</p><ul><li>UTF-8是ASCII的超集。不需要转换和修改就能和UTF-8一起使用。</li><li>GBK与UTF-8之间必须通过Unicode编码才能相互转换。</li><li>UTF-8对于英文使用8位（一个字节）编码，对于中文使用24位（三个字节）编码。</li><li>一个汉字GBK编码占两个字节，UTF-8编码占三个字节，所以UTF-8对中文来说占用空间要大。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;UTF-8、GBK、ASCII、Unicode的区别&lt;/p&gt;</summary>
    
    
    
    <category term="计算机" scheme="http://www.lights8080.com/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/"/>
    
    
    <category term="计算机" scheme="http://www.lights8080.com/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>阻塞、非阻塞、异步</title>
    <link href="http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/%E9%98%BB%E5%A1%9E%E3%80%81%E9%9D%9E%E9%98%BB%E5%A1%9E%E3%80%81%E5%BC%82%E6%AD%A5/"/>
    <id>http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/JAVA/%E9%98%BB%E5%A1%9E%E3%80%81%E9%9D%9E%E9%98%BB%E5%A1%9E%E3%80%81%E5%BC%82%E6%AD%A5/</id>
    <published>2021-06-23T16:00:00.000Z</published>
    <updated>2021-06-24T08:40:42.000Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="阻塞调用"><a href="#阻塞调用" class="headerlink" title="阻塞调用"></a>阻塞调用</h2><p>请求过来，要建立连接，然后再接收数据，接收数据后，再发送数据。具体到系统底层，就是读写事件，而当读写事件没有准备好时，必然不可操作，如果不用非阻塞的方式来调用，那就得阻塞调用了，事件没有准备好，那就只能等了，等事件准备好了，你再继续吧。<br>cpu空闲没人用，cpu利用率自然上不去了，更别谈高并发了。好吧，你说加进程数，这跟apache的线程模型有什么区别，注意，别增加无谓的上下文切换。</p><h2 id="非阻塞调用"><a href="#非阻塞调用" class="headerlink" title="非阻塞调用"></a>非阻塞调用</h2><p>非阻塞就是，事件没有准备好，马上返回EAGAIN，告诉你，事件还没准备好呢，你慌什么，过会再来吧。好吧，你过一会，再来检查一下事件，直到事件准备好了为止，在这期间，你就可以先去做其它事情，然后再来看看事件好了没。<br>虽然不阻塞了，但你得不时地过来检查一下事件的状态，你可以做更多的事情了，但带来的开销也是不小的。</p><h2 id="异步非阻塞调用"><a href="#异步非阻塞调用" class="headerlink" title="异步非阻塞调用"></a>异步非阻塞调用</h2><p>它们提供了一种机制，让你可以同时监控多个事件，调用他们是阻塞的，但可以设置超时时间，在超时时间之内，如果有事件准备好了，就返回。<br>拿epoll为例(在后面的例子中，我们多以epoll为例子，以代表这一类函数)，当事件没准备好时，放到epoll里面，事件准备好了，我们就去读写，当读写返回EAGAIN时，我们将它再次加入到epoll里面。<br>这样，只要有事件准备好了，我们就去处理它，只有当所有事件都没准备好时，才在epoll里面等着。<br>这样，我们就可以并发处理大量的并发了，当然，这里的并发请求，是指未处理完的请求，线程只有一个，所以同时能处理的请求当然只有一个了，只是在请求间进行不断地切换而已，切换也是因为异步事件未准备好，而主动让出的。<br>这里的切换是没有任何代价，你可以理解为循环处理多个准备好的事件，事实上就是这样的。与多线程相比，这种事件处理方式是有很大的优势的，不需要创建线程，每个请求占用的内存也很少，没有上下文切换，事件处理非常的轻量级。并发数再多也不会导致无谓的资源浪费（[link]上下文切换  ）。</p><h2 id="异步非阻塞的理解"><a href="#异步非阻塞的理解" class="headerlink" title="异步非阻塞的理解"></a>异步非阻塞的理解</h2><p><a href="http://blog.csdn.net/feitianxuxue/article/details/8936802">http://blog.csdn.net/feitianxuxue/article/details/8936802</a></p><ul><li>阻塞，非阻塞：关注的是程序在等待调用结果（消息或返回值）时的状态。进程/线程要访问的数据是否就绪，进程/线程是否需要等待；</li><li>同步，异步：关注的是消息通信机制。访问数据的方式，同步需要主动读写数据，在读写数据的过程中还是会阻塞；异步只需要I/O操作完成的通知，并不主动读写数据，由操作系统内核完成数据的读写。</li></ul><h2 id="故事-老张爱喝茶"><a href="#故事-老张爱喝茶" class="headerlink" title="故事(老张爱喝茶)"></a>故事(老张爱喝茶)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">知乎老张爱喝茶，废话不说，煮开水。出场人物：老张，水壶两把（普通水壶，简称水壶；会响的水壶，简称响水壶）。</span><br><span class="line">1 老张把水壶放到火上，立等水开。（同步阻塞）老张觉得自己有点傻</span><br><span class="line">2 老张把水壶放到火上，去客厅看电视，时不时去厨房看看水开没有。（同步非阻塞）老张还是觉得自己有点傻，于是变高端了，买了把会响笛的那种水壶。水开之后，能大声发出嘀~~~~的噪音。</span><br><span class="line">3 老张把响水壶放到火上，立等水开。（异步阻塞）老张觉得这样傻等意义不大</span><br><span class="line">4 老张把响水壶放到火上，去客厅看电视，水壶响之前不再去看它了，响了再去拿壶。（异步非阻塞）老张觉得自己聪明了。</span><br><span class="line"></span><br><span class="line">所谓同步异步，只是对于水壶而言。普通水壶，同步；响水壶，异步。虽然都能干活，但响水壶可以在自己完工之后，提示老张水开了。这是普通水壶所不能及的。同步只能让调用者去轮询自己（情况2中），造成老张效率的低下。所谓阻塞非阻塞，仅仅对于老张而言。立等的老张，阻塞；看电视的老张，非阻塞。情况1和情况3中老张就是阻塞的，媳妇喊他都不知道。虽然3中响水壶是异步的，可对于立等的老张没有太大的意义。所以一般异步是配合非阻塞使用的，这样才能发挥异步的效用。</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;h2 id=&quot;阻塞调用&quot;&gt;&lt;a href=&quot;#阻塞调用&quot; class=&quot;headerlink&quot; title=&quot;阻塞调用&quot;&gt;&lt;/a&gt;阻塞调用&lt;/h2&gt;&lt;p&gt;请求过来，要建立连接，然后再接收数据，接收数据后，再发送数据。具体到系统底</summary>
      
    
    
    
    <category term="计算机" scheme="http://www.lights8080.com/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/"/>
    
    
    <category term="计算机" scheme="http://www.lights8080.com/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>Linux使用总结</title>
    <link href="http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/Linux/Linux%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/"/>
    <id>http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/Linux/Linux%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/</id>
    <published>2021-06-23T16:00:00.000Z</published>
    <updated>2021-06-30T01:39:47.000Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找目录下的所有文件中是否含有某个字符串,只打印出文件名称</span></span><br><span class="line">find . | xargs grep -ri <span class="string">&#x27;string&#x27;</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件字符串替换</span></span><br><span class="line">sed -i <span class="string">&#x27;s/oldStr/newStr/g&#x27;</span> demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将worker-5的异常前后20行保存到文件中</span></span><br><span class="line">cat all.log.2015-08-26 | grep <span class="string">&#x27;schedulerFactoryBean_Worker-5] - 异常信息&#x27;</span> -A 20 -B 20 &gt; worker-5-exception.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询文件中时间段的内容</span></span><br><span class="line">sed -n <span class="string">&#x27;/2014-05-16/,/2014-05-17/p&#x27;</span> catalina.out &gt; 20140516tomcat.log</span><br><span class="line">grep <span class="string">&quot;2014-07-23 13:[00-59]&quot;</span> 20140514tomcat.log &gt;05-14.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正则匹配</span></span><br><span class="line">egrep <span class="string">&#x27;(-开始)|(-结束)&#x27;</span> p.log &gt; begin-end.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 昨天这个时候的时间</span></span><br><span class="line">date -d<span class="string">&quot;yesterday&quot;</span> +<span class="string">&quot;%F %H:%M:%S&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># linux 查询端口占用情况</span></span><br><span class="line">netstat -natp|grep 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建软连接</span></span><br><span class="line">ln -s 目标文件 连接文件</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看CPU性能</span></span><br><span class="line">vmstat 1</span><br><span class="line"><span class="comment">#显示CPU数，ALL为索引</span></span><br><span class="line">mpstat -P ALL 1</span><br><span class="line"><span class="comment">#查看I/O性能</span></span><br><span class="line">iostat -m -x 1</span><br></pre></td></tr></table></figure><h2 id="Statistics-Examples"><a href="#Statistics-Examples" class="headerlink" title="Statistics Examples"></a>Statistics Examples</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 每小时的访问量统计</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span> /data/<span class="built_in">log</span>/nginxlog/nginx.log|awk -F: <span class="string">&#x27;&#123;s[$1&quot;:&quot;$2]++&#125;END&#123;for(a in s)&#123;print a,s[a]&#125;&#125;&#x27;</span>|sort</span><br><span class="line"></span><br><span class="line"><span class="comment">### 每小时状态码统计</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $5&quot;:&quot;$10&#125;&#x27;</span> /data/<span class="built_in">log</span>/nginxlog/nginx.log|awk -F: <span class="string">&#x27;&#123;s[$1&quot;:&quot;$2&quot;:&quot;$5]++&#125;END&#123;for(a in s)&#123;print a,s[a]&#125;&#125;&#x27;</span>|sort</span><br><span class="line"></span><br><span class="line"><span class="comment">### 统计search服务每分钟处理时间大于7秒的统计</span></span><br><span class="line">grep <span class="string">&#x27;2021-02-02 00&#x27;</span> /data/<span class="built_in">log</span>/service/service.2021-02-02.log |grep <span class="string">&#x27;ServiceImpl&#x27;</span>| awk <span class="string">&#x27;&#123;print $1,$2&quot;:&quot;strtonum($12)&#125;&#x27;</span> |awk -F: <span class="string">&#x27;&#123;if($4&gt;7000)&#123;s[$1&quot;:&quot;$2]++&#125;&#125;END&#123;for(a in s)&#123;print a,s[a]&#125;&#125;&#x27;</span>|sort</span><br><span class="line"></span><br><span class="line"><span class="comment">### 每小时统计[hour,gds_ms,jaxb_ms,parser_ms,spendms,count,spendms/1000]</span></span><br><span class="line">grep <span class="string">&#x27;INFO  c.f.s.s.api.service.impl.ServiceImpl &#x27;</span> /data/<span class="built_in">log</span>/service/service.2019-04-24.log \</span><br><span class="line">| awk <span class="string">&#x27;&#123;split($2,time,&quot;:&quot;);split($9,gds,&quot;:&quot;);split($10,jaxb,&quot;:&quot;);split($11,parse,&quot;:&quot;);split($13,count,&quot;:&quot;);&#123;print $1 &quot;-&quot; time[1] &quot; &quot; strtonum(gds[2]) &quot; &quot; strtonum(jaxb[2]) &quot; &quot; strtonum(parse[2]) &quot; &quot; strtonum(count[2])&#125;&#125;&#x27;</span> \</span><br><span class="line">| awk <span class="string">&#x27;&#123;gds[$1]=gds[$1]+$2;jaxb[$1]=jaxb[$1]+$3;parser[$1]=parser[$1]+$4;count[$1]=count[$1]+$5;size[$1]=size[$1]+1&#125;;END&#123;for(i in gds)print i,gds[i],jaxb[i],parser[i],(gds[i]+jaxb[i]+parser[i]),count[i],size[i],(gds[i]+jaxb[i]+parser[i])/1000 | &quot;sort&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 按航线统计</span></span><br><span class="line">grep <span class="string">&#x27;INFO  c.f.s.s.api.service.impl.ServiceImpl &#x27;</span> /data/<span class="built_in">log</span>/service/service.2019-04-24.log \</span><br><span class="line">| awk <span class="string">&#x27;&#123;split($2,time,&quot;:&quot;);split($9,gds,&quot;:&quot;);split($10,jaxb,&quot;:&quot;);split($11,parse,&quot;:&quot;);split($13,count,&quot;:&quot;);&#123;if(strtonum(gds[2])&gt;7000)&#123;print $1 &quot;-&quot; time[1] &quot;#&quot; $7 &quot; &quot; strtonum(gds[2]) &quot; &quot; strtonum(jaxb[2]) &quot; &quot; strtonum(parse[2]) &quot; &quot; strtonum(count[2])&#125;&#125;&#125;&#x27;</span> \</span><br><span class="line">| awk <span class="string">&#x27;&#123;gds[$1]+=$2;jaxb[$1]+=$3;parser[$1]+=$4;count[$1]+=$5;size[$1]+=1&#125;;END&#123;for(i in gds)print (gds[i]+jaxb[i]+parser[i]),(gds[i]+jaxb[i]+parser[i])/size[i],size[i],i | &quot;sort -nr&quot;&#125;&#x27;</span> \</span><br><span class="line">| head -n 100 &gt;&gt; <span class="built_in">stat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 统计每小时查询量</span></span><br><span class="line">grep <span class="string">&#x27;INFO&#x27;</span> /data/<span class="built_in">log</span>/service/service.2019-11-11.log|awk -F: <span class="string">&#x27;&#123;sum[$1]+=1&#125;END&#123;for(c in sum)&#123;print c,sum[c]&#125;&#125;&#x27;</span>|sort</span><br><span class="line"></span><br><span class="line"><span class="comment">### 统计单个小时航线查询量</span></span><br><span class="line">grep <span class="string">&#x27;INFO&#x27;</span> /data/<span class="built_in">log</span>/service/service.2019-11-11.log|awk -F: <span class="string">&#x27;&#123;split($6,fromto,&quot;|&quot;);&#123;print $1,fromto[1]&#125;&#125;&#x27;</span>|awk -F: <span class="string">&#x27;&#123;sum[$1]+=1&#125;END&#123;for(c in sum)&#123;print c,sum[c]&#125;&#125;&#x27;</span>|sort -k 4 -nr|head</span><br><span class="line"></span><br><span class="line"><span class="comment">### 统计每小时超时数</span></span><br><span class="line">grep <span class="string">&#x27;INFO&#x27;</span> /data/<span class="built_in">log</span>/service/service.2019-11-11.log|awk -F: <span class="string">&#x27;&#123;split($5,detail,&quot;,&quot;);&#123;print $1,strtonum(detail[1])&#125;&#125;&#x27;</span>| awk <span class="string">&#x27;&#123;if(strtonum($3)&gt;7000)&#123;print $1,$2,&quot;timeout&quot;&#125;else&#123;print $1,$2,&quot;ok&quot;&#125;&#125;&#x27;</span>|awk -F: <span class="string">&#x27;&#123;sum[$1]+=1&#125;END&#123;for(c in sum)&#123;print c,sum[c]&#125;&#125;&#x27;</span>|sort</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;h2 id=&quot;常用命令&quot;&gt;&lt;a href=&quot;#常用命令&quot; class=&quot;headerlink&quot; title=&quot;常用命令&quot;&gt;&lt;/a&gt;常用命令&lt;/h2&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="Linux" scheme="http://www.lights8080.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Mysql使用总结</title>
    <link href="http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/Mysql%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/"/>
    <id>http://www.lights8080.com/2021/06/24/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/Mysql%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/</id>
    <published>2021-06-23T16:00:00.000Z</published>
    <updated>2021-06-29T11:15:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>新建用户及授权、性能指标、数据库容量、导入导出、存储过程和事件、sql总结</p><span id="more"></span><h2 id="新建用户及授权"><a href="#新建用户及授权" class="headerlink" title="新建用户及授权"></a>新建用户及授权</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"><span class="comment">-- 授权</span></span><br><span class="line"><span class="keyword">GRANT</span> [<span class="keyword">select</span>,update,<span class="keyword">delete</span>,<span class="keyword">create</span>,<span class="keyword">drop</span>] privileges <span class="keyword">ON</span> databasename.tablename <span class="keyword">TO</span> <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br><span class="line"><span class="comment">-- 授权示例</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">all</span> privileges <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;user1&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 刷新系统权限表</span></span><br><span class="line">flush privileges;</span><br><span class="line"><span class="comment">-- 设置或更改用户密码</span></span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="keyword">FOR</span> <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span> <span class="operator">=</span> PASSWORD(<span class="string">&#x27;newpassword&#x27;</span>);</span><br><span class="line"><span class="comment">-- 撤销用户权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> privilege <span class="keyword">ON</span> databasename.tablename <span class="keyword">FROM</span> <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看授权信息</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br><span class="line"><span class="comment">-- 删除用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grant all privileges on *.* to root@&#x27;%&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">CREATE USER &#x27;lihaipeng&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class="line">GRANT all privileges ON *.* TO &#x27;lihaipeng&#x27;@&#x27;%&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><h2 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- sql性能分析</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> xxx</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 显示正在执行语句</span></span><br><span class="line"><span class="keyword">show</span> PROCESSLIST;</span><br><span class="line"><span class="comment">-- 查询表连接数和锁表数</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> tables;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- max_connections 最大连接数</span></span><br><span class="line"><span class="comment">-- max_user_connections 单用户的最大连接数</span></span><br><span class="line"><span class="comment">-- thread_cache_size 线程缓存最大数</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%max_connections%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Threads_cached 当前缓存中空闲的连接数量</span></span><br><span class="line"><span class="comment">-- Threads_connected 当前打开的连接数量</span></span><br><span class="line"><span class="comment">-- Threads_running 不在睡眠的线程数量</span></span><br><span class="line"><span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;Threads%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Max_used_connections 同时使用的连接的最大数目</span></span><br><span class="line"><span class="comment">-- Connections 试图连接到MySQL(不管是否连接成功)的连接数</span></span><br><span class="line"><span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;Max_used_connections&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 显示group_concat长度限制</span></span><br><span class="line"><span class="keyword">show</span> session variables <span class="keyword">LIKE</span> <span class="string">&#x27;%group_concat_max_len%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 设置group_concat长度限制</span></span><br><span class="line"><span class="keyword">SET</span> SESSION group_concat_max_len<span class="operator">=</span><span class="number">512000</span>;</span><br></pre></td></tr></table></figure><h4 id="事务和锁"><a href="#事务和锁" class="headerlink" title="事务和锁"></a>事务和锁</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看数据库当前的进程</span></span><br><span class="line"><span class="keyword">show</span> processlist;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.processlist;</span><br><span class="line"><span class="comment">-- 当前运行的所有事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_TRX;</span><br><span class="line"><span class="comment">-- 查看正在锁的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_LOCKS;</span><br><span class="line"><span class="comment">-- 查看等待锁的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_LOCK_WAITS;</span><br><span class="line"><span class="comment">-- 结束线程</span></span><br><span class="line">KILL <span class="operator">&lt;</span>trx_mysql_thread_id<span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure><h4 id="连接数和超时时间"><a href="#连接数和超时时间" class="headerlink" title="连接数和超时时间"></a>连接数和超时时间</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看服务器状态信息(分为全局和会话，支持like)</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">global</span> status <span class="keyword">LIKE</span> <span class="string">&#x27;slow_queries&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看系统变量及其值(分为全局和会话，支持like)</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">LIKE</span> <span class="string">&#x27;%slow_queries%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 更改全局变量，必须具有SUPER权限</span></span><br><span class="line"><span class="comment">-- 最大连接数</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> max_connections<span class="operator">=</span><span class="number">1500</span>;</span><br><span class="line"><span class="comment">-- 关闭一个非交互的连接之前等待秒数 28800</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> wait_timeout<span class="operator">=</span><span class="number">600</span>;</span><br><span class="line"><span class="comment">-- 关闭一个交互的连接之前等待秒数 28800</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> interactive_timeout<span class="operator">=</span><span class="number">600</span>;</span><br><span class="line"><span class="comment">-- 锁等待时间 31536000</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> lock_wait_timeout<span class="operator">=</span><span class="number">600</span>;</span><br></pre></td></tr></table></figure><h4 id="查看数据库容量"><a href="#查看数据库容量" class="headerlink" title="查看数据库容量"></a>查看数据库容量</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看所有数据库容量大小</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>(table_rows) <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>(<span class="keyword">truncate</span>(data_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>(<span class="keyword">truncate</span>(index_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> table_schema</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">sum</span>(data_length) <span class="keyword">desc</span>, <span class="built_in">sum</span>(index_length) <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看所有数据库各表容量大小</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">table_name <span class="keyword">as</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">table_rows <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(data_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(index_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> data_length <span class="keyword">desc</span>, index_length <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定数据库容量大小</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>(table_rows) <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>(<span class="keyword">truncate</span>(data_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>(<span class="keyword">truncate</span>(index_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>)) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定数据库各表容量大小</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">table_schema <span class="keyword">as</span> <span class="string">&#x27;数据库&#x27;</span>,</span><br><span class="line">table_name <span class="keyword">as</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">table_rows <span class="keyword">as</span> <span class="string">&#x27;记录数&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(data_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;数据容量(MB)&#x27;</span>,</span><br><span class="line"><span class="keyword">truncate</span>(index_length<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> <span class="string">&#x27;索引容量(MB)&#x27;</span></span><br><span class="line"><span class="keyword">from</span> information_schema.tables</span><br><span class="line"><span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;mysql&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> data_length <span class="keyword">desc</span>, index_length <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><h2 id="导入-导出"><a href="#导入-导出" class="headerlink" title="导入/导出"></a>导入/导出</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导出指定库所有表结构</span></span><br><span class="line">mysqldump <span class="operator">-</span>u root <span class="operator">-</span>p234234 <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.75</span> <span class="operator">-</span>d [数据库] <span class="operator">&gt;</span> a.sql</span><br><span class="line"><span class="comment">-- 导出指定数据库所有结构和数据</span></span><br><span class="line">mysqldump <span class="operator">-</span>u root <span class="operator">-</span>p234234 <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.75</span> [数据库] <span class="operator">&gt;</span> a.sql</span><br><span class="line"><span class="comment">-- 导出指定数据库，指定表结构</span></span><br><span class="line">mysqldump <span class="operator">-</span>u root <span class="operator">-</span>p234234 <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.75</span> <span class="operator">-</span>d [数据库] [表] <span class="operator">&gt;</span> a.sql</span><br><span class="line"><span class="comment">-- 导出指定数据库，指定表结构和数据</span></span><br><span class="line">mysqldump <span class="operator">-</span>u root <span class="operator">-</span>p234234 <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.75</span> [数据库] [表] <span class="operator">&gt;</span> a.sql</span><br><span class="line"><span class="comment">-- 导入</span></span><br><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>proot test <span class="operator">&lt;</span> cid<span class="operator">-</span>fromto<span class="number">-1.</span><span class="keyword">sql</span> </span><br></pre></td></tr></table></figure><h4 id="to-csv"><a href="#to-csv" class="headerlink" title="to csv"></a>to csv</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id,product_name,qty <span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;/tmp/orders.csv&#x27;</span></span><br><span class="line">FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">ENCLOSED <span class="keyword">BY</span> <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">LINES TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="to-txt"><a href="#to-txt" class="headerlink" title="to txt"></a>to txt</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id,product_name,qty <span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;/tmp/orders.txt&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Sql"><a href="#Sql" class="headerlink" title="Sql"></a>Sql</h2><h3 id="统计：mysql中每10分钟统计"><a href="#统计：mysql中每10分钟统计" class="headerlink" title="统计：mysql中每10分钟统计"></a>统计：mysql中每10分钟统计</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> concat(date_format(createtime,<span class="string">&#x27;%Y-%m-%d %H:&#x27;</span>) , <span class="built_in">floor</span>( date_format(createtime, <span class="string">&#x27;%i&#x27;</span>)<span class="operator">/</span><span class="number">10</span>)) <span class="keyword">AS</span> c, <span class="built_in">count</span>( id )</span><br><span class="line"><span class="keyword">FROM</span> `qm_log`</span><br><span class="line"><span class="keyword">WHERE</span> createtime <span class="keyword">BETWEEN</span> <span class="string">&#x27;2015-11-24 07:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2015-11-24 08:59:59&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> c</span><br></pre></td></tr></table></figure><h3 id="关联表更新"><a href="#关联表更新" class="headerlink" title="关联表更新"></a>关联表更新</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">update fesf_order.order_detail od <span class="keyword">set</span> od.child_policy_no <span class="operator">=</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> pg.policy_no <span class="keyword">from</span> fesf_commission.policy_general pg <span class="keyword">where</span> pg.id <span class="operator">=</span> substring_index(od.child_policy_id,&quot;|&quot;,<span class="number">-1</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="数据库表迁移"><a href="#数据库表迁移" class="headerlink" title="数据库表迁移"></a>数据库表迁移</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 复制表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> database1.table1 <span class="keyword">like</span> database2.table1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 复制表数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> database1.table1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> database2.table1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数据库改名方案</span></span><br><span class="line"><span class="comment">-- 1. 创建目标库</span></span><br><span class="line"><span class="keyword">CREATE</span> SCHEMA `unififi_security` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line"><span class="comment">-- 2. 生成改表名的sql</span></span><br><span class="line"><span class="keyword">select</span> concat(<span class="string">&#x27;rename table &#x27;</span>,TABLE_SCHEMA,<span class="string">&#x27;.&#x27;</span>,TABLE_NAME,<span class="string">&#x27; to target_schema.&#x27;</span>,TABLE_NAME,<span class="string">&#x27;;&#x27;</span>) <span class="keyword">from</span> information_schema.TABLES <span class="keyword">where</span> TABLE_SCHEMA<span class="operator">=</span><span class="string">&#x27;origin_schema&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="数据库改名脚本"><a href="#数据库改名脚本" class="headerlink" title="数据库改名脚本"></a>数据库改名脚本</h4><p>rename_schema.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 假设将sakila数据库名改为new_sakila</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MyISAM直接更改数据库目录下的文件即可</span></span><br><span class="line"></span><br><span class="line">mysql -uroot -p123456 -e &#x27;create database if not exists new_sakila&#x27;</span><br><span class="line">list_table=$(mysql -uroot -p123456 -Nse &quot;select table_name from information_schema.TABLES where TABLE_SCHEMA=&#x27;sakila&#x27;&quot;)</span><br><span class="line"></span><br><span class="line">for table in $list_table</span><br><span class="line">do</span><br><span class="line">    mysql -uroot -p123456 -e &quot;rename table sakila.$table to new_sakila.$table&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="库表操作"><a href="#库表操作" class="headerlink" title="库表操作"></a>库表操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建库</span></span><br><span class="line"><span class="keyword">CREATE</span> SCHEMA `lights` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line"><span class="comment">-- 删除/创建表</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> `lights`.`scheduler_log`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `lights`.`scheduler_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `task_id` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;任务ID&#x27;</span>,</span><br><span class="line">  `task_type` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;任务类型 once:一次性任务 cron:定时任务&#x27;</span>,</span><br><span class="line">  `task_module` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;任务模块&#x27;</span>,</span><br><span class="line">  `callback_url` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调URL&#x27;</span>,</span><br><span class="line">  `callback_request` <span class="type">varchar</span>(<span class="number">3000</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调请求内容&#x27;</span>,</span><br><span class="line">  `callback_response` <span class="type">varchar</span>(<span class="number">3000</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;回调响应内容&#x27;</span>,</span><br><span class="line">  `callback_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;回调响应状态 0:成功&#x27;</span>,</span><br><span class="line">  `callback_spendms` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;回调响应时间（毫秒）&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> UPDATE <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_query` (`gmt_create`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `idx_task_module` (`task_module`) <span class="keyword">USING</span> HASH</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 ROW_FORMAT<span class="operator">=</span><span class="keyword">DYNAMIC</span> COMMENT<span class="operator">=</span><span class="string">&#x27;任务执行日志表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改表</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> `lights`.`scheduler_log` <span class="keyword">add</span> <span class="keyword">column</span> `test` longtext COMMENT <span class="string">&#x27;test&#x27;</span> after callback_spendms;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">UNIQUE</span> index uk_orderno <span class="keyword">on</span> lights.order_main (order_no);</span><br><span class="line"><span class="keyword">create</span> index idx_query <span class="keyword">on</span> lights.order_main (gmt_create, status) <span class="keyword">USING</span> BTREE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建存储过程</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> if <span class="keyword">exists</span> `lights`.`proc_report`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> `lights`.`proc_report`(<span class="keyword">IN</span> report_day <span class="type">date</span>)</span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> end_day <span class="type">date</span>;</span><br><span class="line">    <span class="keyword">declare</span> usd_rmbratio <span class="type">decimal</span>(<span class="number">18</span>, <span class="number">6</span>) <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">set</span> usd_rmbratio <span class="operator">=</span> <span class="number">6.890000</span>;</span><br><span class="line">    <span class="keyword">set</span> end_day <span class="operator">=</span> date_add(date_add(report_day, <span class="type">interval</span> <span class="number">1</span> <span class="keyword">day</span>), <span class="type">interval</span> <span class="number">-1</span> microsecond);</span><br><span class="line">    <span class="comment">-- 可以执行delete、update、insert操作</span></span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">call</span> `lights`.proc_report(<span class="string">&#x27;2019-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lights.proc_report;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建事件</span></span><br><span class="line"><span class="keyword">drop</span> event if <span class="keyword">exists</span> `lights`.`proc_report`;</span><br><span class="line"><span class="keyword">CREATE</span> EVENT `lights`.`event_call_proc_report`</span><br><span class="line">  <span class="keyword">on</span> schedule <span class="keyword">EVERY</span> <span class="number">1</span> <span class="keyword">DAY</span></span><br><span class="line">    STARTS DATE_ADD(DATE_ADD(CURDATE(), <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>), <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">HOUR</span>)</span><br><span class="line">  <span class="keyword">ON</span> COMPLETION PRESERVE</span><br><span class="line">DO</span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">call</span> `lights`.`proc_report`(DATE_ADD(CURDATE(), <span class="type">INTERVAL</span> <span class="number">-1</span> <span class="keyword">DAY</span>));</span><br><span class="line">  <span class="keyword">END</span>;</span><br><span class="line">  </span><br><span class="line"><span class="comment">-- 创建函数</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> fesf_accounting.accounting_status(cc_status <span class="type">int</span>, iata_status <span class="type">int</span>) <span class="keyword">RETURNS</span> <span class="type">int</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">declare</span> status <span class="type">int</span> <span class="keyword">default</span> <span class="keyword">null</span>;</span><br><span class="line">    if  iata_status <span class="operator">=</span> <span class="number">1</span> <span class="operator">||</span> cc_status <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">then</span> <span class="keyword">set</span> status <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    elseif iata_status <span class="operator">=</span> <span class="number">6</span> <span class="operator">||</span> cc_status <span class="operator">=</span> <span class="number">6</span></span><br><span class="line">        <span class="keyword">then</span> <span class="keyword">set</span> status <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">set</span> status <span class="operator">=</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">end</span> if;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line"><span class="keyword">END</span> $$</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;新建用户及授权、性能指标、数据库容量、导入导出、存储过程和事件、sql总结&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="Mysql" scheme="http://www.lights8080.com/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Linux Shell</title>
    <link href="http://www.lights8080.com/2021/06/18/%E6%8A%80%E6%9C%AF/Linux/Linux%20Shell/"/>
    <id>http://www.lights8080.com/2021/06/18/%E6%8A%80%E6%9C%AF/Linux/Linux%20Shell/</id>
    <published>2021-06-17T16:00:00.000Z</published>
    <updated>2021-06-18T06:19:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>shell介绍和shell环境</p><span id="more"></span><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p>shell是用户使用Linux系统的一座桥梁，是一种命令语言。Shell 脚本（shell script）是一种为 shell 编写的脚本程序。业界所说的 shell 通常都是指 shell 脚本，但是shell 和 shell script是两个不同的概念。</p><p>Linux Shell分类：</p><ul><li>Bourne Shell（/usr/bin/sh或/bin/sh）</li><li>Bourne Again Shell（/bin/bash）</li><li>C Shell（/usr/bin/csh）</li><li>K Shell（/usr/bin/ksh）</li><li>…</li></ul><p>Bash 也是大多数Linux系统默认的Shell。</p><p>命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看shell外壳</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$SHELL</span></span><br><span class="line"><span class="comment"># 切换bash</span></span><br><span class="line">chsh -s /bin/bash</span><br></pre></td></tr></table></figure><h2 id="shell环境"><a href="#shell环境" class="headerlink" title="shell环境"></a>shell环境</h2><p>定制bash shell环境</p><ul><li>/etc/profile：为系统的每个用户设置环境信息，当用户第一次登录时，该文件被执行</li><li>/etc/bashrc：为每一个运行bash shell的用户执行此文件，进行个性化设置</li><li>~/.bash_profile：为当前用户设置专属的环境信息，当用户登录时该文件执行一次</li><li>~/.bashrc：为当前用户每次打开新的shell时，读取该文件，进行个性化设置</li><li>~/.bash_logout：退出shell时被读取</li></ul><p>命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 立马生效</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;shell介绍和shell环境&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/Linux/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>pyenv for Mac</title>
    <link href="http://www.lights8080.com/2021/06/18/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/pyenv%20for%20Mac/"/>
    <id>http://www.lights8080.com/2021/06/18/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/pyenv%20for%20Mac/</id>
    <published>2021-06-17T16:00:00.000Z</published>
    <updated>2021-06-18T02:56:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>pyenv for mac安装说明</p><span id="more"></span><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install pyenv</span><br><span class="line"><span class="comment"># pyenv管理的Python命令目录添加到$PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(pyenv init --path)&quot;&#x27;</span> &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装指定python版本</span></span><br><span class="line">pyenv install 3.6.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看安装的python版本</span></span><br><span class="line">pyenv versions</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局python版本</span></span><br><span class="line">pyenv global 3.5.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为本地环境设置python版本，覆盖global</span></span><br><span class="line">pyenv <span class="built_in">local</span> 3.6.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为当前shell会话设置python版本，覆盖local</span></span><br><span class="line">pyenv shell 3.6.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消设置</span></span><br><span class="line">pyenv <span class="built_in">local</span> --<span class="built_in">unset</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/pyenv/pyenv#homebrew-on-macos">https://github.com/pyenv/pyenv#homebrew-on-macos</a><br><a href="https://github.com/pyenv/pyenv/blob/master/COMMANDS.md#command-reference">https://github.com/pyenv/pyenv/blob/master/COMMANDS.md#command-reference</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;pyenv for mac安装说明&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="Python" scheme="http://www.lights8080.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>ElastAlert-实践</title>
    <link href="http://www.lights8080.com/2021/06/17/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E5%AE%9E%E8%B7%B5/"/>
    <id>http://www.lights8080.com/2021/06/17/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E5%AE%9E%E8%B7%B5/</id>
    <published>2021-06-16T16:00:00.000Z</published>
    <updated>2021-06-24T02:17:28.000Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="基于Elastalert的二次开发"><a href="#基于Elastalert的二次开发" class="headerlink" title="基于Elastalert的二次开发"></a>基于Elastalert的二次开发</h2><p><a href="https://github.com/lights8080/elastalert">https://github.com/lights8080/elastalert</a> forked from Yelp/elastalert</p><p>修改内容大致如下：</p><ol><li>修改报警及日志的日期格式为<code>%Y-%m-%d %H:%M:%S %Z</code></li><li>集成钉钉报警（支持At、secret认证），参考<code>example_rules/example_frequency_lights8080.yaml</code></li><li>PercentageMatchRule，报警内容增加match_bucket_count字段</li><li>FrequencyRule，报警内容增加doc_count字段</li><li>requirements.txt改为elasticsearch==7.0.0</li><li>优化日志</li></ol><h2 id="规则配置建议"><a href="#规则配置建议" class="headerlink" title="规则配置建议"></a>规则配置建议</h2><ul><li>buffer_time与run_every参数设置相同</li></ul><h2 id="支持钉钉报警"><a href="#支持钉钉报警" class="headerlink" title="支持钉钉报警"></a>支持钉钉报警</h2><ol><li><p>新增文件：elastalert_modules/dingtalk_alert.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@author: xuyaoqiang,lights8080</span></span><br><span class="line"><span class="string">@contact: xuyaoqiang@gmail.com</span></span><br><span class="line"><span class="string">@date: 2017-09-14 17:35,2021-06-23</span></span><br><span class="line"><span class="string">@version: 0.0.0</span></span><br><span class="line"><span class="string">@license:</span></span><br><span class="line"><span class="string">@copyright:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> elastalert.alerts <span class="keyword">import</span> Alerter, DateTimeEncoder</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> RequestException</span><br><span class="line"><span class="keyword">from</span> elastalert.util <span class="keyword">import</span> EAException</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DingTalkAlerter</span>(<span class="params">Alerter</span>):</span></span><br><span class="line">    required_options = <span class="built_in">frozenset</span>([<span class="string">&#x27;dingtalk_webhook&#x27;</span>, <span class="string">&#x27;dingtalk_msgtype&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, rule</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(DingTalkAlerter, self).__init__(rule)</span><br><span class="line">        self.dingtalk_webhook_url = self.rule[<span class="string">&#x27;dingtalk_webhook&#x27;</span>]</span><br><span class="line">        self.dingtalk_msgtype = self.rule.get(<span class="string">&#x27;dingtalk_msgtype&#x27;</span>, <span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">        self.dingtalk_isAtAll = self.rule.get(<span class="string">&#x27;dingtalk_isAtAll&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">        self.dingtalk_title = self.rule.get(<span class="string">&#x27;dingtalk_title&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        self.dingtalk_atMobiles = self.rule.get(<span class="string">&#x27;dingtalk_atMobiles&#x27;</span>, [])</span><br><span class="line">        self.dingtalk_secret = self.rule.get(<span class="string">&#x27;dingtalk_secret&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">format_body</span>(<span class="params">self, body</span>):</span></span><br><span class="line">        <span class="keyword">return</span> body.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">alert</span>(<span class="params">self, matches</span>):</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json;charset=utf-8&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        body = self.create_alert_body(matches)</span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&quot;msgtype&quot;</span>: self.dingtalk_msgtype,</span><br><span class="line">            <span class="string">&quot;text&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: body</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;at&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;isAtAll&quot;</span>:<span class="literal">False</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.dingtalk_atMobiles) &gt; <span class="number">0</span>:</span><br><span class="line">          payload[<span class="string">&quot;at&quot;</span>][<span class="string">&quot;atMobiles&quot;</span>] = self.dingtalk_atMobiles</span><br><span class="line"></span><br><span class="line">        url = self.dingtalk_webhook_url</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.dingtalk_secret) &gt; <span class="number">0</span>:</span><br><span class="line">            timestamp = <span class="built_in">round</span>(time.time() * <span class="number">1000</span>)</span><br><span class="line">            secret_enc = <span class="built_in">bytes</span>(self.dingtalk_secret, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">            string_to_sign = <span class="string">&#x27;&#123;&#125;\n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(timestamp, self.dingtalk_secret)</span><br><span class="line">            string_to_sign_enc = <span class="built_in">bytes</span>(string_to_sign, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">            hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest()</span><br><span class="line">            sign = urllib.parse.quote(base64.b64encode(hmac_code))</span><br><span class="line">            url = <span class="string">&#x27;&#123;&#125;&amp;timestamp=&#123;&#125;&amp;sign=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.dingtalk_webhook_url, timestamp, sign)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.post(url,</span><br><span class="line">                        data=json.dumps(payload, cls=DateTimeEncoder),</span><br><span class="line">                        headers=headers)</span><br><span class="line">            response.raise_for_status()</span><br><span class="line">            <span class="built_in">print</span>(response)</span><br><span class="line">        <span class="keyword">except</span> RequestException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> EAException(<span class="string">&quot;Error request to Dingtalk: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(e)))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_info</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;dingtalk&quot;</span>,</span><br><span class="line">            <span class="string">&quot;dingtalk_webhook&quot;</span>: self.dingtalk_webhook_url</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></li><li><p>修改规则</p></li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alert:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&quot;elastalert_modules.dingtalk_alert.DingTalkAlerter&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dingtalk_webhook:</span> <span class="string">&quot;https://oapi.dingtalk.com/robot/send?access_token=token&quot;</span></span><br><span class="line"><span class="attr">dingtalk_msgtype:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line"><span class="attr">dingtalk_secret:</span> <span class="string">&quot;secret&quot;</span></span><br><span class="line"><span class="attr">dingtalk_atMobiles:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&quot;18610241024&quot;</span></span><br></pre></td></tr></table></figure><h2 id="报警实践转换为本地时区"><a href="#报警实践转换为本地时区" class="headerlink" title="报警实践转换为本地时区"></a>报警实践转换为本地时区</h2><p>规则配置增强模块：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">match_enhancements:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&quot;elastalert.enhancements.TimeEnhancement&quot;</span></span><br></pre></td></tr></table></figure><p>修改前：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Example rule</span><br><span class="line"></span><br><span class="line">At least 50 events occurred between 2021-06-18 19:55:24 CST and 2021-06-18 20:00:24 CST</span><br><span class="line">@timestamp: 2021-06-18T12:00:24.768631Z</span><br></pre></td></tr></table></figure><p>修改后：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Example rule</span><br><span class="line"></span><br><span class="line">At least 50 events occurred between 2021-06-18 19:55:24 CST and 2021-06-18 20:00:24 CST</span><br><span class="line"></span><br><span class="line">@timestamp: 2021-06-18 20:00:24 CST</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;h2 id=&quot;基于Elastalert的二次开发&quot;&gt;&lt;a href=&quot;#基于Elastalert的二次开发&quot; class=&quot;headerlink&quot; title=&quot;基于Elastalert的二次开发&quot;&gt;&lt;/a&gt;基于Elastale</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ElastAlert-核心逻辑流程及源码解析</title>
    <link href="http://www.lights8080.com/2021/06/10/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>http://www.lights8080.com/2021/06/10/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</id>
    <published>2021-06-09T16:00:00.000Z</published>
    <updated>2021-06-10T02:50:31.000Z</updated>
    
    <content type="html"><![CDATA[<ol><li>ElastAlert核心逻辑流程及源码解析</li><li>run_every、buffer_time、timeframe之间的关系</li><li>num_hits、num_matches说明</li></ol><span id="more"></span><h2 id="1、核心主流程及源码解析"><a href="#1、核心主流程及源码解析" class="headerlink" title="1、核心主流程及源码解析"></a>1、核心主流程及源码解析</h2><p>核心主流程：</p><ol><li>初始化ElastAlerter对象，并调用start()：加载规则、并启动job</li><li>job调用规则处理(handle_rule_execution)：计算结束时间，run_rule，设置job下次执行时间</li><li>run_rule：计算查询开始和结束时间，run_query，send_alert，回写索引</li><li>run_query：根据规则调用ES查询，向规则中添加计数数据</li><li>send_alert：根据计数数据报警，回写索引</li></ol><p>流程图如下：<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/06/ElastAlert%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.png" alt="ElastAlert核心源码解析"></p><p><a href="https://www.processon.com/view/60bf156fe0b34d0950a54ac4?fromnew=1">ElastAlert核心逻辑流程及源码解析</a></p><h2 id="2、run-every、buffer-time、timeframe之间的关系"><a href="#2、run-every、buffer-time、timeframe之间的关系" class="headerlink" title="2、run_every、buffer_time、timeframe之间的关系"></a>2、run_every、buffer_time、timeframe之间的关系</h2><ul><li>run_every：任务执行时间间隔</li><li>buffer_time：查询窗口范围。未设置use_count_query和use_terms_query时，有效</li><li>timeframe：事件数的时间窗口</li></ul><h2 id="3、num-hits、num-matches说明"><a href="#3、num-hits、num-matches说明" class="headerlink" title="3、num_hits、num_matches说明"></a>3、num_hits、num_matches说明</h2><ul><li>match[‘num_hits’]：查询文档计数或聚合桶数</li><li>match[‘num_matches’]：查询符合过滤规则的计数<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### match[&#x27;num_hits&#x27;]不同的查询统计，计算方式不同</span></span><br><span class="line"><span class="comment"># get_hits_count：</span></span><br><span class="line">thread_data.num_hits += res[<span class="string">&#x27;count&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># get_hits：</span></span><br><span class="line">thread_data.num_hits += <span class="built_in">len</span>(res[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># get_hits_terms：</span></span><br><span class="line">thread_data.num_hits += <span class="built_in">len</span>(res[<span class="string">&#x27;aggregations&#x27;</span>][<span class="string">&#x27;counts&#x27;</span>][<span class="string">&#x27;buckets&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># get_hits_aggregation：</span></span><br><span class="line">thread_data.num_hits += res[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;total&#x27;</span>][<span class="string">&#x27;value&#x27;</span>]</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;ol&gt;
&lt;li&gt;ElastAlert核心逻辑流程及源码解析&lt;/li&gt;
&lt;li&gt;run_every、buffer_time、timeframe之间的关系&lt;/li&gt;
&lt;li&gt;num_hits、num_matches说明&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Hexo搭建个人博客系统</title>
    <link href="http://www.lights8080.com/2021/06/08/%E5%B7%A5%E5%85%B7/Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/"/>
    <id>http://www.lights8080.com/2021/06/08/%E5%B7%A5%E5%85%B7/Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/</id>
    <published>2021-06-07T16:00:00.000Z</published>
    <updated>2021-06-08T02:22:38.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍基于Hexo搭建个人博客，包括评论、图床、站内搜索、字数统计、PV统计、百度统计等</p></blockquote><span id="more"></span><h2 id="特色"><a href="#特色" class="headerlink" title="特色"></a>特色</h2><ol><li>Hexo（<a href="https://hexo.io/zh-cn/%EF%BC%89">https://hexo.io/zh-cn/）</a></li><li>模板：pure（<a href="https://github.com/cofess/hexo-theme-pure.git%EF%BC%89">https://github.com/cofess/hexo-theme-pure.git）</a></li><li>模板2：hexo-theme-matery（<a href="https://github.com/blinkfox/hexo-theme-matery%EF%BC%89">https://github.com/blinkfox/hexo-theme-matery）</a></li><li>图床：gitee</li><li>评论：valine（<a href="https://console.leancloud.cn/apps%EF%BC%89">https://console.leancloud.cn/apps）</a></li><li>站内搜索：insight</li><li>字数统计：postCount</li><li>PV统计（leancloud）</li><li>百度统计（<a href="https://tongji.baidu.com/web/10000362099/homepage/index%EF%BC%89">https://tongji.baidu.com/web/10000362099/homepage/index）</a></li></ol><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换Node版本</span></span><br><span class="line">nvm use v14.17.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成静态文件（-d：部署；-w：监视文件变动）</span></span><br><span class="line">hexo generate/hexo g</span><br><span class="line"><span class="comment"># 启动服务器</span></span><br><span class="line">hexo server/hexo s</span><br><span class="line"><span class="comment"># 部署网站</span></span><br><span class="line">hexo deploy/hexo d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更换主题后，清除缓存文件和已生成的静态文件</span></span><br><span class="line">hexo clean</span><br><span class="line"></span><br><span class="line">hexo clean &amp;&amp; hexo deploy</span><br><span class="line">hexo s -w</span><br></pre></td></tr></table></figure><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换Node版本</span></span><br><span class="line">nvm use v14.17.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hexo初始化项目</span></span><br><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖模块</span></span><br><span class="line">npm install hexo-wordcount --save</span><br><span class="line">npm install hexo-generator-json-content --save</span><br><span class="line">npm install hexo-generator-feed --save</span><br><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-baidu-sitemap --save</span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">npm install highlight.js --save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载pure模板</span></span><br><span class="line"><span class="built_in">cd</span> themes</span><br><span class="line">git <span class="built_in">clone</span> git@github.com:cofess/hexo-theme-pure.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">npm install</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>$ vim _config.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hexo发布</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/lights8080/lights8080.github.io</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">token:</span> </span><br></pre></td></tr></table></figure><p>$ vim themes/pure/_config.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 评论</span></span><br><span class="line"><span class="attr">comment:</span></span><br><span class="line">  <span class="attr">valine:</span></span><br><span class="line">    <span class="attr">appid:</span> </span><br><span class="line">    <span class="attr">appkey:</span> </span><br><span class="line"><span class="comment"># 百度统计</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="attr">baidu_analytics:</span> </span><br></pre></td></tr></table></figure><h2 id="报错问题处理"><a href="#报错问题处理" class="headerlink" title="报错问题处理"></a>报错问题处理</h2><p>执行hexo server命令，报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INFO  Validating config</span><br><span class="line">INFO  Start processing</span><br><span class="line">FATAL &#123; err:</span><br><span class="line">   TypeError: line.matchAll is not a function</span><br><span class="line">       at res.value.res.value.split.map.line (/home/seek/Data/hexosite/node_modules/hexo-util/lib/highlight.js:128:26)</span><br><span class="line">       at Array.map (&lt;anonymous&gt;)</span><br></pre></td></tr></table></figure><p>升级node到12以上<br><a href="https://stackoverflow.com/questions/67516168/i-just-installed-hexo-static-site-generator-on-debian-and-ran-hexo-server-to-see">https://stackoverflow.com/questions/67516168/i-just-installed-hexo-static-site-generator-on-debian-and-ran-hexo-server-to-see</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍基于Hexo搭建个人博客，包括评论、图床、站内搜索、字数统计、PV统计、百度统计等&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="工具" scheme="http://www.lights8080.com/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Hexo" scheme="http://www.lights8080.com/tags/Hexo/"/>
    
    <category term="效率" scheme="http://www.lights8080.com/tags/%E6%95%88%E7%8E%87/"/>
    
    <category term="个人博客" scheme="http://www.lights8080.com/tags/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    
  </entry>
  
  <entry>
    <title>NodeJs VS Nginx</title>
    <link href="http://www.lights8080.com/2021/06/08/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/NodeJs%20VS%20Nginx/"/>
    <id>http://www.lights8080.com/2021/06/08/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/NodeJs%20VS%20Nginx/</id>
    <published>2021-06-07T16:00:00.000Z</published>
    <updated>2021-06-24T08:18:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>前端项目动态应用和静态应用的区别，有了 Vue + Nginx，为什么还要 Node？</p><span id="more"></span><ul><li>Vue：只是一个 UI 层的框架，因此他打包出来的就是一套 UI 的静态文件：html + js-bundle</li><li>Nginx：反向服务器，并不提供逻辑处理，只做譬如负载均衡、流量控制、静态服务器等功能</li><li>Node：运行在服务端的 JavaScript</li></ul><p>vue 对 node 的服务端渲染支持最好（反过来说就不准确了）</p><h2 id="NodeJS的核心优势"><a href="#NodeJS的核心优势" class="headerlink" title="NodeJS的核心优势"></a>NodeJS的核心优势</h2><ul><li>服务端渲染-SSR（Server Side Rendering）</li><li>鉴权</li><li>接口聚合</li></ul><p>Node要避免一些高CPU开销的功能</p><p><img src="https://pic4.zhimg.com/80/v2-4bc69c4ff1594d1ff4a55d93c78ea55c_1440w.jpg?source=1940ef5c"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;前端项目动态应用和静态应用的区别，有了 Vue + Nginx，为什么还要 Node？&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="前端" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="NodeJs" scheme="http://www.lights8080.com/tags/NodeJs/"/>
    
    <category term="Nginx" scheme="http://www.lights8080.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>ELK-合集</title>
    <link href="http://www.lights8080.com/2021/06/07/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%90%88%E9%9B%86/"/>
    <id>http://www.lights8080.com/2021/06/07/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%90%88%E9%9B%86/</id>
    <published>2021-06-06T16:00:00.000Z</published>
    <updated>2021-07-08T03:33:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>ELK文章合集，《Elastic Stack 实战手册》</p><span id="more"></span><p>通过最近对ELK全家桶的学习和应用实践，总结成系列文章。<br>如有疑问，欢迎私信，共同学习，一起成长。</p><p>安利一下《Elastic Stack 实战手册》早鸟版首发，这是我最近才关注到的，写的很好<br><a href="https://developer.aliyun.com/topic/elasticstack/playbook">https://developer.aliyun.com/topic/elasticstack/playbook</a></p><h2 id="文章合集"><a href="#文章合集" class="headerlink" title="文章合集"></a>文章合集</h2><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483825&idx=1&sn=c0ee14f7a3ba2f711e69b8b0a4404cde&chksm=ce815d40f9f6d456ef4b34fdac70983da494c6c9ae2e3ab3d8049a9f8c6546a89e295e9e158a#rd">ELK-实践（架构选择&amp;部署说明）</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483834&idx=1&sn=f8017c717e356b59e4ef8466765e8627&chksm=ce815d4bf9f6d45d25a4ed069e16cc2a84c5cfde73fa24d0849bb88865351ded6945a73bf872#rd">ELK-实践（业务框架&amp;业务配置）</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483779&idx=1&sn=6045a654a38601d746336b1a6d868a60&chksm=ce815d72f9f6d46462fa9c5baef1838828d59127b32b3f6fc0282925677e9db12ef86ebae128#rd">ELK-加密通信的说明和配置教程</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483729&idx=1&sn=ca15c6ec94fc9b7ffdacb98d75f61d5d&chksm=ce815da0f9f6d4b614bde8ef625997f422328f1ae4c565b7fd37ba55bc92784fa6ac97084421#rd">Elasticsearch-介绍</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483738&idx=1&sn=ce7d41e234be487049e31c6df194caf7&chksm=ce815dabf9f6d4bd2aa099c8eb2aebb14470b829b24949799a247ecbbacfe599475a138c1046#rd">Elasticsearch-索引（Index）</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483734&idx=1&sn=47218443301f9a281d17f871e84d9316&chksm=ce815da7f9f6d4b149d980d2118a3f713a305e8793f10f2ee2a5b64e3b1c71f0a4ac697886c9#rd">Elasticsearch-映射（Mapping）</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483750&idx=1&sn=e2b51357e801a7c8a0c7ef70b10367ea&chksm=ce815d97f9f6d4815b735a2a26c09ec3582f0922fad400ef8aeae9934f2587150d4926567694#rd">Elasticsearch-搜索（Search DSL）</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483754&idx=1&sn=507a348902d4006fc91ddc635919b7d2&chksm=ce815d9bf9f6d48d4fe38b7298d83b1441afbd9842f06ed060cfbd15fc49980d2de3eb8c3748#rd">Elasticsearch-聚合（Aggregations）</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483758&idx=1&sn=2199dc453f358f039c74b83879e894d4&chksm=ce815d9ff9f6d48916e3590a46d4b4e1ae30770cd79ae971d9ca2d1f233634424853fa489aca#rd">Elasticsearch-安全特性（Security）</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483713&idx=1&sn=cd942045fc334d618065e269581e1498&chksm=ce815db0f9f6d4a6f666783535d8e705692d82a819998251d6dc0d46661c06b9962d29b10371#rd">Logstash介绍</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483718&idx=1&sn=e71a8d1d9ee2442ef2d692f3ea8d072b&chksm=ce815db7f9f6d4a1c208731b20305a85aa3518a5794b0c5be46263d265bb7ea273713c9d31b6#rd">Logstash配置及说明</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483769&idx=1&sn=372fac436174074cd5835fde821f7291&chksm=ce815d88f9f6d49e3b87ed06d5699e62fd41277b5d4d5749a9549bcc4a9f3630e7025c0c58d3#rd">Beats-Filebeat命令&amp;配置说明</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483765&idx=1&sn=bbf6ef6a206adb251dabbc3bd5d044f3&chksm=ce815d84f9f6d4922bddd77f57689db5bea50e3a1dbb7b86f5255dc85174de34ed9508ac645b#rd">Beats-Filebeat介绍</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483774&idx=1&sn=e457027dd104cedd57bad60614818366&chksm=ce815d8ff9f6d4997ecd614ba6e14077cf2bb13f83f0d1889e225014776a3b8f62fe251113b2#rd">Kibana-介绍</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483840&idx=1&sn=f95a5fc49236bda17a664bd06c801ef2&chksm=ce815d31f9f6d4273d4d4742da8e053b3effe16f0049497b51c5e40836b6a11b5b4126f712b8#rd">ElastAlert-介绍</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483845&idx=1&sn=7b43e00a5013fa1076cee4511888b6fe&chksm=ce815d34f9f6d422a8580266879d463f436fd5a9c8a71a200632a354c0c4106189203afc9d2a#rd">ElastAlert-配置</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483851&idx=1&sn=99b9d80c03e57fe2234b555ecb35a705&chksm=ce815d3af9f6d42c3c219d838670993590a158127dc0bc78182920d7b78a1aeb8eac173d6c18#rd">ElastAlert-核心逻辑流程及源码解析</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3MTMzNzM3NA==&mid=2247483881&idx=1&sn=2c745e2184b0d8432a917eb18abde348&chksm=ce815d18f9f6d40ea1c04706c29f4963dc7c743ffe348842bd59d5da14e94523e13e48017d8f#rd">ElastAlert-实践</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ELK文章合集，《Elastic Stack 实战手册》&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ELK-实践（业务框架&amp;业务配置）</title>
    <link href="http://www.lights8080.com/2021/06/04/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%A1%86%E6%9E%B6&amp;%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/06/04/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%A1%86%E6%9E%B6&amp;%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%EF%BC%89/</id>
    <published>2021-06-03T16:00:00.000Z</published>
    <updated>2021-06-08T10:55:27.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍基于业务的数据模型框架和业务配置（Elasticsearch的映射和索引、Logstash配置管理、Filebeat规则管理、同步脚本等）。<br>基于7.11版本。</p></blockquote><span id="more"></span><p>业务中Elasticsearch数据分为两类：</p><ul><li><p>日志类：数据线性增长，无修改操作，无主键，数据价值随时间递减。如：用户操作、异常信息等</p></li><li><p>业务类：有主键，允许修改删除，长期保留。如：订单信息、基础信息</p></li></ul><p>数据提取方式和特点：</p><p>日志类数据：Filebeat-&gt;Logstash-&gt;Elasticsearch。数据流、通用模型、容错性强</p><p>业务类数据：通过脚本获取数据信息（数据库、API等）直接更新到Elasticsearch。自定义灵活可控</p><p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/06/vgIs47.png"></p><h2 id="1-Elasticsearch-映射和索引"><a href="#1-Elasticsearch-映射和索引" class="headerlink" title="1. Elasticsearch 映射和索引"></a>1. Elasticsearch 映射和索引</h2><ul><li>lights-mappings：组件模板mappings</li><li>lights-settings：组件模板settings</li><li>lights-log：索引生命周期-日志类</li><li>lights-data：索引生命周期-数据类</li><li>lights-service-exception：服务异常信息（数据流）</li><li>lights-nginx-web：Nginx日志（数据流）</li><li>lights-order：订单信息（索引别名）</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 创建索引模板组件-mapping</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_component_template/lights-mappings</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;dynamic_date_formats&quot;:</span> [</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;dynamic_templates&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;string_as_keyword&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">1024</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="string">&quot;@timestamp&quot;</span><span class="string">:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;message&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;index&quot;:</span> <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;log&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;file&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                                <span class="attr">&quot;path&quot;:</span> &#123;</span><br><span class="line">                                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;index&quot;:</span> <span class="literal">false</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板组件-setting</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_component_template/lights-settings</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;index&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">                <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;codec&quot;:</span> <span class="string">&quot;best_compression&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;default_field&quot;:</span> [</span><br><span class="line">                    <span class="string">&quot;@timestamp&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;message&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引生命周期-日志类</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">_ilm/policy/lights-log</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;phases&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;hot&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;rollover&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;max_size&quot;:</span> <span class="string">&quot;50GB&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;max_age&quot;:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;delete&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;min_age&quot;:</span> <span class="string">&quot;365d&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;delete&quot;:</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引生命周期-数据类</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_ilm/policy/lights-data</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;phases&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;hot&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;rollover&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;max_size&quot;:</span> <span class="string">&quot;50GB&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;max_age&quot;:</span> <span class="string">&quot;30d&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（数据流）-服务异常信息</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-service-exception</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-service-exception&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;data_stream&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index.lifecycle.name&quot;:</span> <span class="string">&quot;lights-log-30&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;composed_of&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-mappings&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lights-settings&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;_meta&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;:</span> <span class="string">&quot;索引模板-服务异常信息&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（数据流）-Nginx日志</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-nginx-web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-nginx-web&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;data_stream&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;codec&quot;:</span> <span class="string">&quot;best_compression&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index.lifecycle.name&quot;:</span> <span class="string">&quot;lights-log&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;bytes&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;request_time&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;upstream_status&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;upstream_response_time&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;composed_of&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-mappings&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lights-settings&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（索引别名）-订单数据</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-order</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-order-*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;dynamic_date_formats&quot;:</span> [</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;dynamic_templates&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;string_as_keyword&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">1024</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;total_as_double&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;long&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;match&quot;:</span>   <span class="string">&quot;*Amount&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;orderNum&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;logs&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;remark&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;aliases&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;lights-order&quot;:</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;_meta&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;:</span> <span class="string">&quot;索引模板-订单数据&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-Logstash-Config"><a href="#2-Logstash-Config" class="headerlink" title="2. Logstash Config"></a>2. Logstash Config</h2><ol><li>通过Filebeat标签识别日志类型</li><li>根据具体的服务名称打上业务标签，过滤、处理数据</li><li>根据不同的业务标签，输出到不同的Elasticsearch索引</li></ol><p>config/lights.conf</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sample Logstash configuration for creating a simple</span></span><br><span class="line"><span class="comment"># Beats -&gt; Logstash -&gt; Elasticsearch pipeline.</span></span><br><span class="line"></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">    <span class="string">beats</span> &#123;</span><br><span class="line">        <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">5044</span></span><br><span class="line">        <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">filter</span> &#123;</span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;lights-service&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">if</span> <span class="type">!([service_name])</span> &#123;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">copy</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;[log][file][path]&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;log_file_path&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">split</span> <span class="string">=&gt;</span> [ <span class="string">&quot;log_file_path&quot;</span> , <span class="string">&quot;/&quot;</span> ]</span><br><span class="line">                <span class="string">add_field</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;service_name&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;[log_file_path][2]&#125;</span>&quot;</span> &#125;</span><br><span class="line">                <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;log_file_path&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">if</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; ERROR &quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;Exception&quot;</span> &#123;</span><br><span class="line">            <span class="string">truncate</span> &#123;</span><br><span class="line">                <span class="string">fields</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">                <span class="string">length_bytes</span> <span class="string">=&gt;</span> <span class="number">10000</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">grok</span> &#123;</span><br><span class="line">                <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                    <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>\n<span class="template-variable">%&#123;GREEDYDATA:throwable&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>\n<span class="template-variable">%&#123;GREEDYDATA:throwable&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;service-exception&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;service-exception&quot;</span> ]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">if</span> [<span class="string">throwable</span>] &#123;</span><br><span class="line">                <span class="string">mutate</span> &#123;</span><br><span class="line">                    <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;throwable&quot;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="string">else</span> &#123;</span><br><span class="line">            <span class="string">if</span> [<span class="string">service_name</span>] <span class="string">==</span> <span class="string">&quot;lights-search-service&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;LightSearchServiceImpl&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; INFO &quot;</span> &#123;</span><br><span class="line">                <span class="string">grok</span> &#123;</span><br><span class="line">                    <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                        <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                            <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;GREEDYDATA:response_message&#125;</span>&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-search-service&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">mutate</span> &#123;</span><br><span class="line">                    <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;lights-search-service&quot;</span> ]</span><br><span class="line">                    <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;lights-nginx-web&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">grok</span> &#123;</span><br><span class="line">            <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                    <span class="string">&quot;<span class="template-variable">%&#123;IPORHOST:clientip&#125;</span> <span class="template-variable">%&#123;IPORHOST:server_name&#125;</span> <span class="template-variable">%&#123;HTTPDUSER:ident&#125;</span> <span class="template-variable">%&#123;HTTPDUSER:auth&#125;</span> \[<span class="template-variable">%&#123;HTTPDATE:timestamp&#125;</span>\] \&quot;(?:<span class="template-variable">%&#123;WORD:verb&#125;</span> <span class="template-variable">%&#123;DATA:request&#125;</span>(?: HTTP/<span class="template-variable">%&#123;NUMBER:httpversion&#125;</span>)?|<span class="template-variable">%&#123;DATA:rawrequest&#125;</span>)\&quot; (?:-|<span class="template-variable">%&#123;NUMBER:status&#125;</span>) (?:-|<span class="template-variable">%&#123;NUMBER:request_time&#125;</span>) (?:-|<span class="template-variable">%&#123;NUMBER:bytes&#125;</span>) \&quot;<span class="template-variable">%&#123;DATA:http_referer&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:http_user_agent&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:http_x_forwarded_for&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:upstream_addr&#125;</span>\&quot; <span class="template-variable">%&#123;NUMBER:upstream_status&#125;</span> <span class="template-variable">%&#123;NUMBER:upstream_response_time&#125;</span>&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">mutate</span> &#123;</span><br><span class="line">            <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">date</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>, <span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">mutate</span> &#123;</span><br><span class="line">        <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;@version&quot;</span>, <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;input&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">    <span class="comment">#stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span></span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;_grokparsefailure&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">file</span> &#123;</span><br><span class="line">            <span class="string">path</span> <span class="string">=&gt;</span> <span class="string">&quot;/opt/elk/logstash-7.11.2/_grokparsefailure-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="string">else</span> &#123;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;service-exception&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-service-exception&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;lights-search-service&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-search&quot;</span></span><br><span class="line">                <span class="comment">#document_id =&gt; &quot;%&#123;[@metadata][_id]&#125;&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;lights-nginx-web&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-nginx-web&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-1-Filebeat"><a href="#3-1-Filebeat" class="headerlink" title="3.1 Filebeat"></a>3.1 Filebeat</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx日志</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/log/nginx/lights.log</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;lights-nginx&quot;</span>]</span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Java日志(异常多行合并)</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/log/&lt;service-name&gt;/*.log</span></span><br><span class="line">  <span class="attr">exclude_lines:</span> [<span class="string">&#x27;/actuator/&#x27;</span>]</span><br><span class="line">  <span class="attr">exclude_files:</span> [<span class="string">&#x27;.gz$&#x27;</span>]</span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;lights-service&quot;</span>]</span><br><span class="line">  <span class="attr">multiline.type:</span> <span class="string">pattern</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">6h</span></span><br></pre></td></tr></table></figure><h2 id="3-2-脚本（同步到Elasticsearch）"><a href="#3-2-脚本（同步到Elasticsearch）" class="headerlink" title="3.2 脚本（同步到Elasticsearch）"></a>3.2 脚本（同步到Elasticsearch）</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 判断脚本正在执行</span></span><br><span class="line">LOCK=$(cat <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$LOCK</span> -eq 1 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;`date &quot;</span>+%Y-%m-%d %H:%M:%S<span class="string">&quot;` locked&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br><span class="line"></span><br><span class="line">DATE_BEGIN=$(cat <span class="variable">$es_script_path</span>/.lasttime_<span class="variable">$file_suffix</span>)</span><br><span class="line">DATE_END=`date +<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>`</span><br><span class="line">DATE_BEGIN=<span class="string">&quot;2021-05-01 09:00:10&quot;</span></span><br><span class="line">DATE_END=<span class="string">&quot;2021-05-01 09:00:10&quot;</span></span><br><span class="line"></span><br><span class="line">ORDERS_SQL=<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">select order_no from lights.order where createtime BETWEEN &#x27;<span class="variable">$DATE_BEGIN</span>&#x27; and &#x27;<span class="variable">$DATE_END</span>&#x27;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 查询同步订单列表</span></span><br><span class="line">ORDERS_RESULT=$(mysql -u &lt;user&gt; &lt;db&gt; -e  <span class="string">&quot;<span class="variable">$ORDERS_SQL</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> LINE <span class="keyword">in</span> <span class="variable">$ORDERS_RESULT</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&#x27;order_no&#x27;</span> != <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    es_index=`<span class="built_in">echo</span> <span class="string">&quot;lights-order-20<span class="variable">$LINE</span>&quot;</span>|cut -c 1-20`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;sync order time:<span class="variable">$DATE_BEGIN</span> ~ <span class="variable">$DATE_END</span> order no: <span class="variable">$LINE</span>, es index: <span class="variable">$es_index</span>&quot;</span></span><br><span class="line">    <span class="comment"># 调用查询接口</span></span><br><span class="line">    orderdetail_result=$(curl -XPOST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;orderNo&quot;:&quot;&#x27;</span><span class="variable">$LINE</span><span class="string">&#x27;&quot;&#125;&#x27;</span> http://localhost:8080/flights-order-service/order/detail)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$orderdetail_result</span>&quot;</span> &gt; <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span></span><br><span class="line">    <span class="comment"># 时区设置</span></span><br><span class="line">    cat <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span> |jq <span class="string">&#x27;.orderInfo&#x27;</span> -c &gt;<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">    sed -i <span class="string">&#x27;s/[0-9]\&#123;4\&#125;-[0-9]\&#123;2\&#125;-[0-9]\&#123;2\&#125; [0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;/&amp; +0800/g&#x27;</span> <span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">    <span class="comment"># 保持到Elasticsearch</span></span><br><span class="line">    curl -XPOST --user <span class="string">&#x27;elastic:&lt;password&gt;&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://localhost:9200/<span class="variable">$es_index</span>/_doc/<span class="variable">$LINE</span> -d@<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新同步时间 及 解除正在执行标记</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DATE_END</span> &gt; <span class="variable">$es_script_path</span>/.lasttime_<span class="variable">$file_suffix</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br></pre></td></tr></table></figure><h2 id="4-其他"><a href="#4-其他" class="headerlink" title="4. 其他"></a>4. 其他</h2><h4 id="1-Logstash-Req-Resp合并成一条事件"><a href="#1-Logstash-Req-Resp合并成一条事件" class="headerlink" title="1. Logstash Req-Resp合并成一条事件"></a>1. Logstash Req-Resp合并成一条事件</h4><p>正常情况下Controller层会拦截请求参数和响应结果并输出到日志，如何基于线程ID将前后两条日志记录合并到一个事件中。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">if</span> [<span class="string">service_name</span>] <span class="string">==</span> <span class="string">&quot;lights-order-service&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;LIGHTS-RE&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; INFO &quot;</span> &#123;</span><br><span class="line">    <span class="string">grok</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - LIGHTS-<span class="template-variable">%&#123;DATA:type&#125;</span>-\[<span class="template-variable">%&#123;DATA:class_method&#125;</span>\] \[<span class="template-variable">%&#123;DATA:username&#125;</span>\] \[<span class="template-variable">%&#123;GREEDYDATA:request&#125;</span>\]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - LIGHTS-<span class="template-variable">%&#123;DATA:type&#125;</span>-\[<span class="template-variable">%&#123;DATA:class_method&#125;</span>\] <span class="template-variable">%&#123;GREEDYDATA:response&#125;</span> size:<span class="template-variable">%&#123;DATA:size&#125;</span> spend:<span class="template-variable">%&#123;DATA:spend&#125;</span>ms&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-order-service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">if</span> [<span class="string">type</span>] <span class="string">==</span> <span class="string">&quot;REQ&quot;</span> &#123;</span><br><span class="line">        <span class="string">aggregate</span> &#123;</span><br><span class="line">            <span class="string">task_id</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;thread&#125;</span>&quot;</span></span><br><span class="line">            <span class="string">code</span> <span class="string">=&gt;</span> <span class="string">&quot;map[&#x27;request_timestamp&#x27;] = event.get(&#x27;timestamp&#x27;); map[&#x27;username&#x27;] = event.get(&#x27;username&#x27;); map[&#x27;request&#x27;] = event.get(&#x27;request&#x27;)&quot;</span></span><br><span class="line">            <span class="string">map_action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">if</span> [<span class="string">type</span>] <span class="string">==</span> <span class="string">&quot;RESP&quot;</span> &#123;</span><br><span class="line">        <span class="string">aggregate</span> &#123;</span><br><span class="line">            <span class="string">task_id</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;thread&#125;</span>&quot;</span></span><br><span class="line">            <span class="string">code</span> <span class="string">=&gt;</span> <span class="string">&quot;event.set(&#x27;request_timestamp&#x27;, map[&#x27;request_timestamp&#x27;]); event.set(&#x27;username&#x27;, map[&#x27;username&#x27;]); event.set(&#x27;request&#x27;, map[&#x27;request&#x27;])&quot;</span></span><br><span class="line">            <span class="string">map_action</span> <span class="string">=&gt;</span> <span class="string">&quot;update&quot;</span></span><br><span class="line">            <span class="string">end_of_task</span> <span class="string">=&gt;</span> <span class="literal">true</span></span><br><span class="line">            <span class="string">timeout</span> <span class="string">=&gt;</span> <span class="number">120</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">mutate</span> &#123;</span><br><span class="line">            <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;lights-order-service&quot;</span> ]</span><br><span class="line">            <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-Kibana小技巧和注意事项"><a href="#2-Kibana小技巧和注意事项" class="headerlink" title="2. Kibana小技巧和注意事项"></a>2. Kibana小技巧和注意事项</h4><ol><li><p>Kibana可视化中Lens(条形图、饼图等)，如何使用索引的另一个时间x字段统计？<br>新建一个Kibana索引，选择x字段作为时间字段。</p></li><li><p>Kibana可视化中Lens(条形图、饼图等)，如何像TSVB那样使用公式计算值？<br>使用Kibana索引的脚本字段，在Lens中使用</p></li><li><p>Kibana中Discover时间框搜索是大于等于(&gt;=)开始时间，小于(&lt;)结束时间，对时间敏感的搜索需要注意</p></li></ol><h4 id="3-Elasticsearch时区问题"><a href="#3-Elasticsearch时区问题" class="headerlink" title="3. Elasticsearch时区问题"></a>3. Elasticsearch时区问题</h4><p>Elasticsearch存储和读取时都要带上时区</p><ul><li><p>Logstash存储修改UTC时间为东八区时间</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ruby &#123;</span><br><span class="line">            code =&gt; <span class="attr">&quot;event.set(&#x27;temp&#x27;, event.get(&#x27;@timestamp&#x27;).time.localtime + 8*60*60); event.set(&#x27;@timestamp&#x27;, event.get(&#x27;temp&#x27;))&quot;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>直接存储ES的时间字段要带上时区信息<code>2021-05-15 00:00:00 +0800</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST --user <span class="string">&#x27;elastic:xxx&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1:9200/es_index/_doc/<span class="variable">$LINE</span> -d@/json_data</span><br></pre></td></tr></table></figure></li><li><p>Kibana搜索时带上时区</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET lights-order/_count</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;2021-04-15 00:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="string">&quot;2021-04-15 23:59:59&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;time_zone&quot;</span>:<span class="string">&quot;+08:00&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-设计上的原则"><a href="#4-设计上的原则" class="headerlink" title="4. 设计上的原则"></a>4. 设计上的原则</h4><p>数据清洗一定发生在写入ES之前，而不是请求数据后处理，那势必会降低请求速度和效率。<br>让ES做他擅长的事，检索+不复杂的聚合，否则数据量+复杂的业务逻辑会有性能问题。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍基于业务的数据模型框架和业务配置（Elasticsearch的映射和索引、Logstash配置管理、Filebeat规则管理、同步脚本等）。&lt;br&gt;基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-数据迁移</title>
    <link href="http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    <id>http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/</id>
    <published>2021-06-02T16:00:00.000Z</published>
    <updated>2021-06-07T07:04:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Reindex数据迁移"><a href="#Reindex数据迁移" class="headerlink" title="Reindex数据迁移"></a>Reindex数据迁移</h2><p>重建索引（_reindex），即：一旦索引被创建，则无法直接修改索引字段的mapping属性，必需要重建索引然后将旧的索引数据迁移到新的索引中才行（迁移过程底层使用了scroll API ）。</p><p>示例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;conflicts&quot;</span>: <span class="string">&quot;proceed&quot;</span>, <span class="comment"># 发生冲突继续执行</span></span><br><span class="line">      <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;old_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 5000, <span class="comment"># 设置每批迁移的文档记录数</span></span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;user&quot;</span>, <span class="string">&quot;_doc&quot;</span>], <span class="comment"># 可设置要迁移的索引字段，不设置则默认所有字段</span></span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123; <span class="comment"># 可设置要迁移的文档记录过滤条件</span></span><br><span class="line">          <span class="string">&quot;match_all&quot;</span>: &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;new_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version_type&quot;</span>: <span class="string">&quot;internal&quot;</span> <span class="comment"># &quot;internal&quot;或者不设置，则Elasticsearch强制性的将文档转储到目标中，覆盖具有相同类型和ID的任何内容</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Reindex数据迁移&quot;&gt;&lt;a href=&quot;#Reindex数据迁移&quot; class=&quot;headerlink&quot; title=&quot;Reindex数据迁移&quot;&gt;&lt;/a&gt;Reindex数据迁移&lt;/h2&gt;&lt;p&gt;重建索引（_reindex），即：一旦索引被创建，则无法直接修改索引</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-配置及系统配置说明</title>
    <link href="http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/"/>
    <id>http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/</id>
    <published>2021-06-02T16:00:00.000Z</published>
    <updated>2021-06-04T08:04:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>系统配置、Elasticsearch配置说明</p><span id="more"></span><h2 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h2><p>理想情况下，Elasticsearch应该单独运行在服务器上，并使用所有可用的资源。为了做到这一点，您需要配置您的操作系统，以允许运行Elasticsearch的用户访问超过默认允许的资源。</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/system-config.html">Important System Configuration</a></p><h3 id="系统配置-参考"><a href="#系统配置-参考" class="headerlink" title="系统配置-参考"></a>系统配置-参考</h3><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">elasticsearch soft memlock unlimited</span><br><span class="line">elasticsearch hard memlock unlimited</span><br><span class="line">elasticsearch soft nproc 4096</span><br><span class="line">elasticsearch hard nproc 4096</span><br></pre></td></tr></table></figure><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count = 262144</span><br><span class="line">net.ipv4.tcp_retries2 = 5</span><br></pre></td></tr></table></figure><h3 id="系统配置-说明"><a href="#系统配置-说明" class="headerlink" title="系统配置-说明"></a>系统配置-说明</h3><h4 id="Disable-swapping（禁用内存交互）"><a href="#Disable-swapping（禁用内存交互）" class="headerlink" title="Disable swapping（禁用内存交互）"></a>Disable swapping（禁用内存交互）</h4><p>大多数操作系统尝试为文件系统缓存使用尽可能多的内存，并急切地交换未使用的应用程序内存。这可能导致部分JVM堆甚至其可执行页被交换到磁盘。交换对于性能和节点稳定性非常不利，应该不惜一切代价避免。</p><ul><li><p>On Linux systems，临时禁用</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a</span><br></pre></td></tr></table></figure></li><li><p>On Linux systems，永久禁用<br>编辑/etc/fstab，注释掉包含swap的任意行</p></li><li><p>Elasticsearch配置<br>set bootstrap.memory_lock to true in elasticsearch.yml</p></li></ul><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># allow user &#x27;elasticsearch&#x27; mlockall</span></span><br><span class="line">elasticsearch soft memlock unlimited</span><br><span class="line">elasticsearch hard memlock unlimited</span><br></pre></td></tr></table></figure><p>检查：<br><code>GET _nodes?filter_path=**.mlockall</code><br>如果为false，最可能的原因是，运行Elasticsearch的用户没有锁定内存的权限，通过以下方式授权</p><h4 id="File-Descriptors（文件描述符）"><a href="#File-Descriptors（文件描述符）" class="headerlink" title="File Descriptors（文件描述符）"></a>File Descriptors（文件描述符）</h4><p>Elasticsearch使用了很多文件描述符或文件句柄。耗尽文件描述符可能是灾难性的，很可能会导致数据丢失。确保将运行Elasticsearch的用户打开文件描述符数量的限制增加到65536或更高。</p><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch  -  nofile  65535</span></span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></table></figure><p>检查：<br><code>GET _nodes/stats/process?filter_path=**.max_file_descriptors</code></p><h4 id="Virtual-memory（虚拟内存）"><a href="#Virtual-memory（虚拟内存）" class="headerlink" title="Virtual memory（虚拟内存）"></a>Virtual memory（虚拟内存）</h4><p>Elasticsearch默认使用一个mappfs目录来存储索引。默认操作系统对mmap计数的限制可能太低，这可能会导致内存不足异常。</p><ul><li><p>暂时设置<br><code>sysctl -w vm.max_map_count=262144</code></p></li><li><p>永久设置</p></li></ul><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置操作系统mmap数限制，Elasticsearch与Lucene使用mmap来映射部分索引到Elasticsearch的地址空间</span></span><br><span class="line"><span class="comment"># 为了让mmap生效，Elasticsearch还需要有创建需要内存映射区的能力。最大map数检查是确保内核允许创建至少262144个内存映射区</span></span><br><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure><h4 id="Number-of-threads（线程数）"><a href="#Number-of-threads（线程数）" class="headerlink" title="Number of threads（线程数）"></a>Number of threads（线程数）</h4><p>Elasticsearch为不同类型的操作使用了许多线程池。它能够在需要时创建新线程，这一点很重要。确保Elasticsearch用户可以创建的线程数量至少是4096个。</p><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch soft nproc 4096</span><br><span class="line">elasticsearch hard nproc 4096</span><br></pre></td></tr></table></figure><h4 id="TCP-retransmission-timeout（TCP重传超时）"><a href="#TCP-retransmission-timeout（TCP重传超时）" class="headerlink" title="TCP retransmission timeout（TCP重传超时）"></a>TCP retransmission timeout（TCP重传超时）</h4><p>集群中的每一对节点通过许多TCP连接进行通信，这些TCP连接一直保持打开状态，直到其中一个节点关闭或由于底层基础设施中的故障而中断节点之间的通信。</p><p>TCP通过对通信应用程序隐藏临时的网络中断，在偶尔不可靠的网络上提供可靠的通信。在通知发送者任何问题之前，您的操作系统将多次重新传输任何丢失的消息。大多数Linux发行版默认重传任何丢失的数据包15次。重传速度呈指数级下降，所以这15次重传需要900秒才能完成。这意味着Linux使用这种方法需要花费许多分钟来检测网络分区或故障节点。Windows默认只有5次重传，相当于6秒左右的超时。</p><p>Linux默认允许在可能经历很长时间包丢失的网络上进行通信，但是对于单个数据中心内的生产网络来说，这个默认值太大了，就像大多数Elasticsearch集群一样。高可用集群必须能够快速检测节点故障，以便它们能够通过重新分配丢失的碎片、重新路由搜索以及可能选择一个新的主节点来迅速作出反应。因此，Linux用户应该减少TCP重传的最大数量。</p><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_retries2 = 5</span><br></pre></td></tr></table></figure><h2 id="Elasticsearch配置"><a href="#Elasticsearch配置" class="headerlink" title="Elasticsearch配置"></a>Elasticsearch配置</h2><p>默认情况Elasticsearch假设处于开发模式中，任何的配置不正确都会在日志文件中写入警告，能够正常启动和运行节点；一旦配置了像network.host这样的网络设置，Elasticsearch就会假设处于生产环境中，并将上面的警告升级为异常，这些异常将阻止节点启动。</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/important-settings.html#important-settings">Important Elasticsearch configuration</a></p><h4 id="config-elasticsearch-yml"><a href="#config-elasticsearch-yml" class="headerlink" title="config/elasticsearch.yml"></a>config/elasticsearch.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ES数据目录和日志目录，path.data可以设置多个路径</span></span><br><span class="line"><span class="attr">path:</span></span><br><span class="line">  <span class="attr">logs:</span> <span class="string">/var/log/elasticsearch</span></span><br><span class="line">  <span class="attr">data:</span> <span class="string">/var/data/elasticsearch</span></span><br><span class="line"><span class="comment"># 集群名称，默认elasticsearch。相同的集群名称的节点，才能加入集群</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="comment"># 设置全新群集中符合主机资格的节点的初始集合（首次启动集群时需要）；默认为空表示该节点希望加入已经被引导的集群</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;10.188.80.14&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点名称，默认随机生成</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">prod-data-2</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 启用预处理，默认启用</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 集群绑定的主机名或IP地址，用于形成一个可以相互通讯的集群；0.0.0.0表示绑定到所有网络接口</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span></span><br><span class="line"><span class="comment"># 节点间通讯绑定端口，默认9300-9400</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提供可访问的集群列表，没有给出端口的通过`transport.port`确定端口，以前使用`discovery.zen.ping.unicast.hosts`</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;10.188.80.14&quot;</span>]</span><br><span class="line"><span class="comment"># 启用单节点发现（节点将选举自己为主节点，并且不会与任何其他节点一起加入集群），推迟了TLS的配置；默认形成多节点集群（发现其他节点，并允许他们加入集群）</span></span><br><span class="line"><span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群的最小master节点数，避免集群脑裂</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># HTTP服务绑定到的主机地址</span></span><br><span class="line"><span class="attr">http.bind_host:</span> </span><br><span class="line"><span class="comment"># 发布以供HTTP客户端连接的主机地址</span></span><br><span class="line"><span class="attr">http.publish_host:</span> </span><br><span class="line"><span class="comment"># http.bind_host and the http.publish_host</span></span><br><span class="line"><span class="attr">http.host:</span> <span class="string">&quot;10.188.80.14&quot;</span></span><br><span class="line"><span class="comment"># HTTP请求绑定端口，默认9200-9300</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment"># 允许跨域</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用swapping，避免影响集群的性能和稳定性，默认开启。（大多数操作系统尝试使用尽可能多的内存文件系统缓存和热切换出未使用的应用程序内存，避免JVM堆交互到磁盘上）</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启通过系统调用过滤器检查，默认为true，如果自己承担禁用系统调用过滤器的风险，设置为false</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动创建索引，默认为true</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 删除索引时必须显示的指定名称，默认为true</span></span><br><span class="line"><span class="attr">action.destructive_requires_name:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="config-jvm-options"><a href="#config-jvm-options" class="headerlink" title="config/ jvm.options"></a>config/ jvm.options</h4><ul><li>Elasticsearch有足够的可用堆是非常重要的。</li><li>堆的最小值（Xms）与堆的最大值（Xmx）设置成相同的。</li><li>Elasticsearch的可用堆越大，它能在内存中缓存的数据越多。但是需要注意堆越大在垃圾回收时造成的暂停会越长。</li><li>设置Xmx不要大于物理内存的50%。用来确保有足够多的物理内存预留给操作系统缓存。</li><li>禁止用串行收集器来运行Elasticsearch（-XX:+UseSerialGC），默认JVM配置通过Elasticsearch的配置将使用CMS回收器。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms8g</span><br><span class="line">-Xmx8g</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;系统配置、Elasticsearch配置说明&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
</feed>
