<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>七路灯</title>
  
  <subtitle>人的一生应当有许多停靠站，但愿每一个站台都有一盏雾中的灯。</subtitle>
  <link href="http://www.lights8080.com/atom.xml" rel="self"/>
  
  <link href="http://www.lights8080.com/"/>
  <updated>2021-06-08T02:22:38.000Z</updated>
  <id>http://www.lights8080.com/</id>
  
  <author>
    <name>七路灯</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hexo搭建个人博客系统</title>
    <link href="http://www.lights8080.com/2021/06/08/%E5%B7%A5%E5%85%B7/Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/"/>
    <id>http://www.lights8080.com/2021/06/08/%E5%B7%A5%E5%85%B7/Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/</id>
    <published>2021-06-07T16:00:00.000Z</published>
    <updated>2021-06-08T02:22:38.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍基于Hexo搭建个人博客，包括评论、图床、站内搜索、字数统计、PV统计、百度统计等</p></blockquote><span id="more"></span><h2 id="特色"><a href="#特色" class="headerlink" title="特色"></a>特色</h2><ol><li>Hexo（<a href="https://hexo.io/zh-cn/%EF%BC%89">https://hexo.io/zh-cn/）</a></li><li>模板：pure（<a href="https://github.com/cofess/hexo-theme-pure.git%EF%BC%89">https://github.com/cofess/hexo-theme-pure.git）</a></li><li>模板2：hexo-theme-matery（<a href="https://github.com/blinkfox/hexo-theme-matery%EF%BC%89">https://github.com/blinkfox/hexo-theme-matery）</a></li><li>图床：gitee</li><li>评论：valine（<a href="https://console.leancloud.cn/apps%EF%BC%89">https://console.leancloud.cn/apps）</a></li><li>站内搜索：insight</li><li>字数统计：postCount</li><li>PV统计（leancloud）</li><li>百度统计（<a href="https://tongji.baidu.com/web/10000362099/homepage/index%EF%BC%89">https://tongji.baidu.com/web/10000362099/homepage/index）</a></li></ol><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换Node版本</span></span><br><span class="line">nvm use v14.17.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成静态文件（-d：部署；-w：监视文件变动）</span></span><br><span class="line">hexo generate/hexo g</span><br><span class="line"><span class="comment"># 启动服务器</span></span><br><span class="line">hexo server/hexo s</span><br><span class="line"><span class="comment"># 部署网站</span></span><br><span class="line">hexo deploy/hexo d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更换主题后，清除缓存文件和已生成的静态文件</span></span><br><span class="line">hexo clean</span><br><span class="line"></span><br><span class="line">hexo clean &amp;&amp; hexo deploy</span><br><span class="line">hexo s -w</span><br></pre></td></tr></table></figure><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换Node版本</span></span><br><span class="line">nvm use v14.17.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hexo初始化项目</span></span><br><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖模块</span></span><br><span class="line">npm install hexo-wordcount --save</span><br><span class="line">npm install hexo-generator-json-content --save</span><br><span class="line">npm install hexo-generator-feed --save</span><br><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-baidu-sitemap --save</span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">npm install highlight.js --save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载pure模板</span></span><br><span class="line"><span class="built_in">cd</span> themes</span><br><span class="line">git <span class="built_in">clone</span> git@github.com:cofess/hexo-theme-pure.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">npm install</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>$ vim _config.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hexo发布</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/lights8080/lights8080.github.io</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">token:</span> </span><br></pre></td></tr></table></figure><p>$ vim themes/pure/_config.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 评论</span></span><br><span class="line"><span class="attr">comment:</span></span><br><span class="line">  <span class="attr">valine:</span></span><br><span class="line">    <span class="attr">appid:</span> </span><br><span class="line">    <span class="attr">appkey:</span> </span><br><span class="line"><span class="comment"># 百度统计</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="attr">baidu_analytics:</span> </span><br></pre></td></tr></table></figure><h2 id="报错问题处理"><a href="#报错问题处理" class="headerlink" title="报错问题处理"></a>报错问题处理</h2><p>执行hexo server命令，报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INFO  Validating config</span><br><span class="line">INFO  Start processing</span><br><span class="line">FATAL &#123; err:</span><br><span class="line">   TypeError: line.matchAll is not a function</span><br><span class="line">       at res.value.res.value.split.map.line (/home/seek/Data/hexosite/node_modules/hexo-util/lib/highlight.js:128:26)</span><br><span class="line">       at Array.map (&lt;anonymous&gt;)</span><br></pre></td></tr></table></figure><p>升级node到12以上<br><a href="https://stackoverflow.com/questions/67516168/i-just-installed-hexo-static-site-generator-on-debian-and-ran-hexo-server-to-see">https://stackoverflow.com/questions/67516168/i-just-installed-hexo-static-site-generator-on-debian-and-ran-hexo-server-to-see</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍基于Hexo搭建个人博客，包括评论、图床、站内搜索、字数统计、PV统计、百度统计等&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="工具" scheme="http://www.lights8080.com/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Hexo" scheme="http://www.lights8080.com/tags/Hexo/"/>
    
    <category term="效率" scheme="http://www.lights8080.com/tags/%E6%95%88%E7%8E%87/"/>
    
    <category term="个人博客" scheme="http://www.lights8080.com/tags/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    
  </entry>
  
  <entry>
    <title>NodeJs VS Nginx</title>
    <link href="http://www.lights8080.com/2021/06/08/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/NodeJs%20VS%20Nginx/"/>
    <id>http://www.lights8080.com/2021/06/08/%E6%8A%80%E6%9C%AF/%E5%85%B6%E4%BB%96/NodeJs%20VS%20Nginx/</id>
    <published>2021-06-07T16:00:00.000Z</published>
    <updated>2021-06-08T06:08:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>前端项目动态应用和静态应用的区别，有了 Vue + Nginx，为什么还要 Node？</p><span id="more"></span><ul><li>Vue：只是一个 UI 层的框架，因此他打包出来的就是一套 UI 的静态文件：html + js-bundle</li><li>Nginx：反向服务器，并不提供逻辑处理，只做譬如负载均衡、流量控制、静态服务器等功能</li><li>Node：运行在服务端的 JavaScript</li></ul><p>vue 对 node 的服务端渲染支持最好（反过来说就不准确了）</p><h2 id="NodeJS的核心优势"><a href="#NodeJS的核心优势" class="headerlink" title="NodeJS的核心优势"></a>NodeJS的核心优势</h2><ul><li>服务端渲染-SSR（Server Side Rendering）</li><li>鉴权</li><li>接口聚合</li></ul><p>Node要避免一些高CPU开销的功能</p><p><img src="https://pic4.zhimg.com/80/v2-4bc69c4ff1594d1ff4a55d93c78ea55c_1440w.jpg?source=1940ef5c"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;前端项目动态应用和静态应用的区别，有了 Vue + Nginx，为什么还要 Node？&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="前端" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="NodeJs" scheme="http://www.lights8080.com/tags/NodeJs/"/>
    
    <category term="Nginx" scheme="http://www.lights8080.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>ELK-文章合集</title>
    <link href="http://www.lights8080.com/2021/06/07/%E6%8A%80%E6%9C%AF/ELK/ELK-%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/"/>
    <id>http://www.lights8080.com/2021/06/07/%E6%8A%80%E6%9C%AF/ELK/ELK-%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/</id>
    <published>2021-06-06T16:00:00.000Z</published>
    <updated>2021-06-07T08:40:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>ELK文章合集</p><span id="more"></span><ul><li><a href="">Logstash-介绍</a></li><li><a href="">Logstash-配置</a></li></ul><h4 id="什么是ELK-Stack（指的就是Elastic-Stack）"><a href="#什么是ELK-Stack（指的就是Elastic-Stack）" class="headerlink" title="什么是ELK Stack（指的就是Elastic Stack）"></a>什么是ELK Stack（指的就是Elastic Stack）</h4><p>一切都起源于 Elasticsearch…<br>引入 Logstash 和 Kibana，产品更强大，ELK源自三者首字母缩写<br>社区越来越壮大，用例越来越丰富<br>然后我们向 ELK 中加入了 Beats<br>那么，ELK 需要怎么变化呢？<br>就这样，Elastic Stack 这个名字应运而生了</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ELK文章合集&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ELK-实践（业务框架&amp;业务配置）</title>
    <link href="http://www.lights8080.com/2021/06/04/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%A1%86%E6%9E%B6&amp;%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/06/04/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%A1%86%E6%9E%B6&amp;%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%EF%BC%89/</id>
    <published>2021-06-03T16:00:00.000Z</published>
    <updated>2021-06-08T10:55:27.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍基于业务的数据模型框架和业务配置（Elasticsearch的映射和索引、Logstash配置管理、Filebeat规则管理、同步脚本等）。<br>基于7.11版本。</p></blockquote><span id="more"></span><p>业务中Elasticsearch数据分为两类：</p><ul><li><p>日志类：数据线性增长，无修改操作，无主键，数据价值随时间递减。如：用户操作、异常信息等</p></li><li><p>业务类：有主键，允许修改删除，长期保留。如：订单信息、基础信息</p></li></ul><p>数据提取方式和特点：</p><p>日志类数据：Filebeat-&gt;Logstash-&gt;Elasticsearch。数据流、通用模型、容错性强</p><p>业务类数据：通过脚本获取数据信息（数据库、API等）直接更新到Elasticsearch。自定义灵活可控</p><p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/06/vgIs47.png"></p><h2 id="1-Elasticsearch-映射和索引"><a href="#1-Elasticsearch-映射和索引" class="headerlink" title="1. Elasticsearch 映射和索引"></a>1. Elasticsearch 映射和索引</h2><ul><li>lights-mappings：组件模板mappings</li><li>lights-settings：组件模板settings</li><li>lights-log：索引生命周期-日志类</li><li>lights-data：索引生命周期-数据类</li><li>lights-service-exception：服务异常信息（数据流）</li><li>lights-nginx-web：Nginx日志（数据流）</li><li>lights-order：订单信息（索引别名）</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 创建索引模板组件-mapping</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_component_template/lights-mappings</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;dynamic_date_formats&quot;:</span> [</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;dynamic_templates&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;string_as_keyword&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">1024</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="string">&quot;@timestamp&quot;</span><span class="string">:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;message&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;index&quot;:</span> <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;log&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;file&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                                <span class="attr">&quot;path&quot;:</span> &#123;</span><br><span class="line">                                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;index&quot;:</span> <span class="literal">false</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板组件-setting</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_component_template/lights-settings</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;index&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">                <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;codec&quot;:</span> <span class="string">&quot;best_compression&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;default_field&quot;:</span> [</span><br><span class="line">                    <span class="string">&quot;@timestamp&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;message&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引生命周期-日志类</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">_ilm/policy/lights-log</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;phases&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;hot&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;rollover&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;max_size&quot;:</span> <span class="string">&quot;50GB&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;max_age&quot;:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;delete&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;min_age&quot;:</span> <span class="string">&quot;365d&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;delete&quot;:</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引生命周期-数据类</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_ilm/policy/lights-data</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;phases&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;hot&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;rollover&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;max_size&quot;:</span> <span class="string">&quot;50GB&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;max_age&quot;:</span> <span class="string">&quot;30d&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（数据流）-服务异常信息</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-service-exception</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-service-exception&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;data_stream&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index.lifecycle.name&quot;:</span> <span class="string">&quot;lights-log-30&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;composed_of&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-mappings&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lights-settings&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;_meta&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;:</span> <span class="string">&quot;索引模板-服务异常信息&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（数据流）-Nginx日志</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-nginx-web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-nginx-web&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;data_stream&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;codec&quot;:</span> <span class="string">&quot;best_compression&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index.lifecycle.name&quot;:</span> <span class="string">&quot;lights-log&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;bytes&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;request_time&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;upstream_status&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;upstream_response_time&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;composed_of&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-mappings&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lights-settings&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（索引别名）-订单数据</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-order</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-order-*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;dynamic_date_formats&quot;:</span> [</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;dynamic_templates&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;string_as_keyword&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">1024</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;total_as_double&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;long&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;match&quot;:</span>   <span class="string">&quot;*Amount&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;orderNum&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;logs&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;remark&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;aliases&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;lights-order&quot;:</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;_meta&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;:</span> <span class="string">&quot;索引模板-订单数据&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-Logstash-Config"><a href="#2-Logstash-Config" class="headerlink" title="2. Logstash Config"></a>2. Logstash Config</h2><ol><li>通过Filebeat标签识别日志类型</li><li>根据具体的服务名称打上业务标签，过滤、处理数据</li><li>根据不同的业务标签，输出到不同的Elasticsearch索引</li></ol><p>config/lights.conf</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sample Logstash configuration for creating a simple</span></span><br><span class="line"><span class="comment"># Beats -&gt; Logstash -&gt; Elasticsearch pipeline.</span></span><br><span class="line"></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">    <span class="string">beats</span> &#123;</span><br><span class="line">        <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">5044</span></span><br><span class="line">        <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">filter</span> &#123;</span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;lights-service&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">if</span> <span class="type">!([service_name])</span> &#123;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">copy</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;[log][file][path]&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;log_file_path&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">split</span> <span class="string">=&gt;</span> [ <span class="string">&quot;log_file_path&quot;</span> , <span class="string">&quot;/&quot;</span> ]</span><br><span class="line">                <span class="string">add_field</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;service_name&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;[log_file_path][2]&#125;</span>&quot;</span> &#125;</span><br><span class="line">                <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;log_file_path&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">if</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; ERROR &quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;Exception&quot;</span> &#123;</span><br><span class="line">            <span class="string">truncate</span> &#123;</span><br><span class="line">                <span class="string">fields</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">                <span class="string">length_bytes</span> <span class="string">=&gt;</span> <span class="number">10000</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">grok</span> &#123;</span><br><span class="line">                <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                    <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>\n<span class="template-variable">%&#123;GREEDYDATA:throwable&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>\n<span class="template-variable">%&#123;GREEDYDATA:throwable&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;service-exception&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;service-exception&quot;</span> ]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">if</span> [<span class="string">throwable</span>] &#123;</span><br><span class="line">                <span class="string">mutate</span> &#123;</span><br><span class="line">                    <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;throwable&quot;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="string">else</span> &#123;</span><br><span class="line">            <span class="string">if</span> [<span class="string">service_name</span>] <span class="string">==</span> <span class="string">&quot;lights-search-service&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;LightSearchServiceImpl&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; INFO &quot;</span> &#123;</span><br><span class="line">                <span class="string">grok</span> &#123;</span><br><span class="line">                    <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                        <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                            <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;GREEDYDATA:response_message&#125;</span>&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-search-service&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">mutate</span> &#123;</span><br><span class="line">                    <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;lights-search-service&quot;</span> ]</span><br><span class="line">                    <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;lights-nginx-web&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">grok</span> &#123;</span><br><span class="line">            <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                    <span class="string">&quot;<span class="template-variable">%&#123;IPORHOST:clientip&#125;</span> <span class="template-variable">%&#123;IPORHOST:server_name&#125;</span> <span class="template-variable">%&#123;HTTPDUSER:ident&#125;</span> <span class="template-variable">%&#123;HTTPDUSER:auth&#125;</span> \[<span class="template-variable">%&#123;HTTPDATE:timestamp&#125;</span>\] \&quot;(?:<span class="template-variable">%&#123;WORD:verb&#125;</span> <span class="template-variable">%&#123;DATA:request&#125;</span>(?: HTTP/<span class="template-variable">%&#123;NUMBER:httpversion&#125;</span>)?|<span class="template-variable">%&#123;DATA:rawrequest&#125;</span>)\&quot; (?:-|<span class="template-variable">%&#123;NUMBER:status&#125;</span>) (?:-|<span class="template-variable">%&#123;NUMBER:request_time&#125;</span>) (?:-|<span class="template-variable">%&#123;NUMBER:bytes&#125;</span>) \&quot;<span class="template-variable">%&#123;DATA:http_referer&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:http_user_agent&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:http_x_forwarded_for&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:upstream_addr&#125;</span>\&quot; <span class="template-variable">%&#123;NUMBER:upstream_status&#125;</span> <span class="template-variable">%&#123;NUMBER:upstream_response_time&#125;</span>&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">mutate</span> &#123;</span><br><span class="line">            <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">date</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>, <span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">mutate</span> &#123;</span><br><span class="line">        <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;@version&quot;</span>, <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;input&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">    <span class="comment">#stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span></span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;_grokparsefailure&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">file</span> &#123;</span><br><span class="line">            <span class="string">path</span> <span class="string">=&gt;</span> <span class="string">&quot;/opt/elk/logstash-7.11.2/_grokparsefailure-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="string">else</span> &#123;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;service-exception&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-service-exception&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;lights-search-service&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-search&quot;</span></span><br><span class="line">                <span class="comment">#document_id =&gt; &quot;%&#123;[@metadata][_id]&#125;&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;lights-nginx-web&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-nginx-web&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-1-Filebeat"><a href="#3-1-Filebeat" class="headerlink" title="3.1 Filebeat"></a>3.1 Filebeat</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx日志</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/log/nginx/lights.log</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;lights-nginx&quot;</span>]</span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Java日志(异常多行合并)</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/log/&lt;service-name&gt;/*.log</span></span><br><span class="line">  <span class="attr">exclude_lines:</span> [<span class="string">&#x27;/actuator/&#x27;</span>]</span><br><span class="line">  <span class="attr">exclude_files:</span> [<span class="string">&#x27;.gz$&#x27;</span>]</span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;lights-service&quot;</span>]</span><br><span class="line">  <span class="attr">multiline.type:</span> <span class="string">pattern</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">6h</span></span><br></pre></td></tr></table></figure><h2 id="3-2-脚本（同步到Elasticsearch）"><a href="#3-2-脚本（同步到Elasticsearch）" class="headerlink" title="3.2 脚本（同步到Elasticsearch）"></a>3.2 脚本（同步到Elasticsearch）</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 判断脚本正在执行</span></span><br><span class="line">LOCK=$(cat <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$LOCK</span> -eq 1 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;`date &quot;</span>+%Y-%m-%d %H:%M:%S<span class="string">&quot;` locked&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br><span class="line"></span><br><span class="line">DATE_BEGIN=$(cat <span class="variable">$es_script_path</span>/.lasttime_<span class="variable">$file_suffix</span>)</span><br><span class="line">DATE_END=`date +<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>`</span><br><span class="line">DATE_BEGIN=<span class="string">&quot;2021-05-01 09:00:10&quot;</span></span><br><span class="line">DATE_END=<span class="string">&quot;2021-05-01 09:00:10&quot;</span></span><br><span class="line"></span><br><span class="line">ORDERS_SQL=<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">select order_no from lights.order where createtime BETWEEN &#x27;<span class="variable">$DATE_BEGIN</span>&#x27; and &#x27;<span class="variable">$DATE_END</span>&#x27;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 查询同步订单列表</span></span><br><span class="line">ORDERS_RESULT=$(mysql -u &lt;user&gt; &lt;db&gt; -e  <span class="string">&quot;<span class="variable">$ORDERS_SQL</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> LINE <span class="keyword">in</span> <span class="variable">$ORDERS_RESULT</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&#x27;order_no&#x27;</span> != <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    es_index=`<span class="built_in">echo</span> <span class="string">&quot;lights-order-20<span class="variable">$LINE</span>&quot;</span>|cut -c 1-20`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;sync order time:<span class="variable">$DATE_BEGIN</span> ~ <span class="variable">$DATE_END</span> order no: <span class="variable">$LINE</span>, es index: <span class="variable">$es_index</span>&quot;</span></span><br><span class="line">    <span class="comment"># 调用查询接口</span></span><br><span class="line">    orderdetail_result=$(curl -XPOST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;orderNo&quot;:&quot;&#x27;</span><span class="variable">$LINE</span><span class="string">&#x27;&quot;&#125;&#x27;</span> http://localhost:8080/flights-order-service/order/detail)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$orderdetail_result</span>&quot;</span> &gt; <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span></span><br><span class="line">    <span class="comment"># 时区设置</span></span><br><span class="line">    cat <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span> |jq <span class="string">&#x27;.orderInfo&#x27;</span> -c &gt;<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">    sed -i <span class="string">&#x27;s/[0-9]\&#123;4\&#125;-[0-9]\&#123;2\&#125;-[0-9]\&#123;2\&#125; [0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;/&amp; +0800/g&#x27;</span> <span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">    <span class="comment"># 保持到Elasticsearch</span></span><br><span class="line">    curl -XPOST --user <span class="string">&#x27;elastic:&lt;password&gt;&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://localhost:9200/<span class="variable">$es_index</span>/_doc/<span class="variable">$LINE</span> -d@<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新同步时间 及 解除正在执行标记</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DATE_END</span> &gt; <span class="variable">$es_script_path</span>/.lasttime_<span class="variable">$file_suffix</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br></pre></td></tr></table></figure><h2 id="4-其他"><a href="#4-其他" class="headerlink" title="4. 其他"></a>4. 其他</h2><h4 id="1-Logstash-Req-Resp合并成一条事件"><a href="#1-Logstash-Req-Resp合并成一条事件" class="headerlink" title="1. Logstash Req-Resp合并成一条事件"></a>1. Logstash Req-Resp合并成一条事件</h4><p>正常情况下Controller层会拦截请求参数和响应结果并输出到日志，如何基于线程ID将前后两条日志记录合并到一个事件中。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">if</span> [<span class="string">service_name</span>] <span class="string">==</span> <span class="string">&quot;lights-order-service&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;LIGHTS-RE&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; INFO &quot;</span> &#123;</span><br><span class="line">    <span class="string">grok</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - LIGHTS-<span class="template-variable">%&#123;DATA:type&#125;</span>-\[<span class="template-variable">%&#123;DATA:class_method&#125;</span>\] \[<span class="template-variable">%&#123;DATA:username&#125;</span>\] \[<span class="template-variable">%&#123;GREEDYDATA:request&#125;</span>\]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - LIGHTS-<span class="template-variable">%&#123;DATA:type&#125;</span>-\[<span class="template-variable">%&#123;DATA:class_method&#125;</span>\] <span class="template-variable">%&#123;GREEDYDATA:response&#125;</span> size:<span class="template-variable">%&#123;DATA:size&#125;</span> spend:<span class="template-variable">%&#123;DATA:spend&#125;</span>ms&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-order-service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">if</span> [<span class="string">type</span>] <span class="string">==</span> <span class="string">&quot;REQ&quot;</span> &#123;</span><br><span class="line">        <span class="string">aggregate</span> &#123;</span><br><span class="line">            <span class="string">task_id</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;thread&#125;</span>&quot;</span></span><br><span class="line">            <span class="string">code</span> <span class="string">=&gt;</span> <span class="string">&quot;map[&#x27;request_timestamp&#x27;] = event.get(&#x27;timestamp&#x27;); map[&#x27;username&#x27;] = event.get(&#x27;username&#x27;); map[&#x27;request&#x27;] = event.get(&#x27;request&#x27;)&quot;</span></span><br><span class="line">            <span class="string">map_action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">if</span> [<span class="string">type</span>] <span class="string">==</span> <span class="string">&quot;RESP&quot;</span> &#123;</span><br><span class="line">        <span class="string">aggregate</span> &#123;</span><br><span class="line">            <span class="string">task_id</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;thread&#125;</span>&quot;</span></span><br><span class="line">            <span class="string">code</span> <span class="string">=&gt;</span> <span class="string">&quot;event.set(&#x27;request_timestamp&#x27;, map[&#x27;request_timestamp&#x27;]); event.set(&#x27;username&#x27;, map[&#x27;username&#x27;]); event.set(&#x27;request&#x27;, map[&#x27;request&#x27;])&quot;</span></span><br><span class="line">            <span class="string">map_action</span> <span class="string">=&gt;</span> <span class="string">&quot;update&quot;</span></span><br><span class="line">            <span class="string">end_of_task</span> <span class="string">=&gt;</span> <span class="literal">true</span></span><br><span class="line">            <span class="string">timeout</span> <span class="string">=&gt;</span> <span class="number">120</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">mutate</span> &#123;</span><br><span class="line">            <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;lights-order-service&quot;</span> ]</span><br><span class="line">            <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-Kibana小技巧和注意事项"><a href="#2-Kibana小技巧和注意事项" class="headerlink" title="2. Kibana小技巧和注意事项"></a>2. Kibana小技巧和注意事项</h4><ol><li><p>Kibana可视化中Lens(条形图、饼图等)，如何使用索引的另一个时间x字段统计？<br>新建一个Kibana索引，选择x字段作为时间字段。</p></li><li><p>Kibana可视化中Lens(条形图、饼图等)，如何像TSVB那样使用公式计算值？<br>使用Kibana索引的脚本字段，在Lens中使用</p></li><li><p>Kibana中Discover时间框搜索是大于等于(&gt;=)开始时间，小于(&lt;)结束时间，对时间敏感的搜索需要注意</p></li></ol><h4 id="3-Elasticsearch时区问题"><a href="#3-Elasticsearch时区问题" class="headerlink" title="3. Elasticsearch时区问题"></a>3. Elasticsearch时区问题</h4><p>Elasticsearch存储和读取时都要带上时区</p><ul><li><p>Logstash存储修改UTC时间为东八区时间</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ruby &#123;</span><br><span class="line">            code =&gt; <span class="attr">&quot;event.set(&#x27;temp&#x27;, event.get(&#x27;@timestamp&#x27;).time.localtime + 8*60*60); event.set(&#x27;@timestamp&#x27;, event.get(&#x27;temp&#x27;))&quot;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>直接存储ES的时间字段要带上时区信息<code>2021-05-15 00:00:00 +0800</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST --user <span class="string">&#x27;elastic:xxx&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1:9200/es_index/_doc/<span class="variable">$LINE</span> -d@/json_data</span><br></pre></td></tr></table></figure></li><li><p>Kibana搜索时带上时区</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET lights-order/_count</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;2021-04-15 00:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="string">&quot;2021-04-15 23:59:59&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;time_zone&quot;</span>:<span class="string">&quot;+08:00&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-设计上的原则"><a href="#4-设计上的原则" class="headerlink" title="4. 设计上的原则"></a>4. 设计上的原则</h4><p>数据清洗一定发生在写入ES之前，而不是请求数据后处理，那势必会降低请求速度和效率。<br>让ES做他擅长的事，检索+不复杂的聚合，否则数据量+复杂的业务逻辑会有性能问题。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍基于业务的数据模型框架和业务配置（Elasticsearch的映射和索引、Logstash配置管理、Filebeat规则管理、同步脚本等）。&lt;br&gt;基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-数据迁移</title>
    <link href="http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    <id>http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/</id>
    <published>2021-06-02T16:00:00.000Z</published>
    <updated>2021-06-07T07:04:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Reindex数据迁移"><a href="#Reindex数据迁移" class="headerlink" title="Reindex数据迁移"></a>Reindex数据迁移</h2><p>重建索引（_reindex），即：一旦索引被创建，则无法直接修改索引字段的mapping属性，必需要重建索引然后将旧的索引数据迁移到新的索引中才行（迁移过程底层使用了scroll API ）。</p><p>示例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;conflicts&quot;</span>: <span class="string">&quot;proceed&quot;</span>, <span class="comment"># 发生冲突继续执行</span></span><br><span class="line">      <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;old_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 5000, <span class="comment"># 设置每批迁移的文档记录数</span></span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;user&quot;</span>, <span class="string">&quot;_doc&quot;</span>], <span class="comment"># 可设置要迁移的索引字段，不设置则默认所有字段</span></span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123; <span class="comment"># 可设置要迁移的文档记录过滤条件</span></span><br><span class="line">          <span class="string">&quot;match_all&quot;</span>: &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;new_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version_type&quot;</span>: <span class="string">&quot;internal&quot;</span> <span class="comment"># &quot;internal&quot;或者不设置，则Elasticsearch强制性的将文档转储到目标中，覆盖具有相同类型和ID的任何内容</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Reindex数据迁移&quot;&gt;&lt;a href=&quot;#Reindex数据迁移&quot; class=&quot;headerlink&quot; title=&quot;Reindex数据迁移&quot;&gt;&lt;/a&gt;Reindex数据迁移&lt;/h2&gt;&lt;p&gt;重建索引（_reindex），即：一旦索引被创建，则无法直接修改索引</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-配置及系统配置说明</title>
    <link href="http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/"/>
    <id>http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/</id>
    <published>2021-06-02T16:00:00.000Z</published>
    <updated>2021-06-04T08:04:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>系统配置、Elasticsearch配置说明</p><span id="more"></span><h2 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h2><p>理想情况下，Elasticsearch应该单独运行在服务器上，并使用所有可用的资源。为了做到这一点，您需要配置您的操作系统，以允许运行Elasticsearch的用户访问超过默认允许的资源。</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/system-config.html">Important System Configuration</a></p><h3 id="系统配置-参考"><a href="#系统配置-参考" class="headerlink" title="系统配置-参考"></a>系统配置-参考</h3><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">elasticsearch soft memlock unlimited</span><br><span class="line">elasticsearch hard memlock unlimited</span><br><span class="line">elasticsearch soft nproc 4096</span><br><span class="line">elasticsearch hard nproc 4096</span><br></pre></td></tr></table></figure><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count = 262144</span><br><span class="line">net.ipv4.tcp_retries2 = 5</span><br></pre></td></tr></table></figure><h3 id="系统配置-说明"><a href="#系统配置-说明" class="headerlink" title="系统配置-说明"></a>系统配置-说明</h3><h4 id="Disable-swapping（禁用内存交互）"><a href="#Disable-swapping（禁用内存交互）" class="headerlink" title="Disable swapping（禁用内存交互）"></a>Disable swapping（禁用内存交互）</h4><p>大多数操作系统尝试为文件系统缓存使用尽可能多的内存，并急切地交换未使用的应用程序内存。这可能导致部分JVM堆甚至其可执行页被交换到磁盘。交换对于性能和节点稳定性非常不利，应该不惜一切代价避免。</p><ul><li><p>On Linux systems，临时禁用</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a</span><br></pre></td></tr></table></figure></li><li><p>On Linux systems，永久禁用<br>编辑/etc/fstab，注释掉包含swap的任意行</p></li><li><p>Elasticsearch配置<br>set bootstrap.memory_lock to true in elasticsearch.yml</p></li></ul><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># allow user &#x27;elasticsearch&#x27; mlockall</span></span><br><span class="line">elasticsearch soft memlock unlimited</span><br><span class="line">elasticsearch hard memlock unlimited</span><br></pre></td></tr></table></figure><p>检查：<br><code>GET _nodes?filter_path=**.mlockall</code><br>如果为false，最可能的原因是，运行Elasticsearch的用户没有锁定内存的权限，通过以下方式授权</p><h4 id="File-Descriptors（文件描述符）"><a href="#File-Descriptors（文件描述符）" class="headerlink" title="File Descriptors（文件描述符）"></a>File Descriptors（文件描述符）</h4><p>Elasticsearch使用了很多文件描述符或文件句柄。耗尽文件描述符可能是灾难性的，很可能会导致数据丢失。确保将运行Elasticsearch的用户打开文件描述符数量的限制增加到65536或更高。</p><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch  -  nofile  65535</span></span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></table></figure><p>检查：<br><code>GET _nodes/stats/process?filter_path=**.max_file_descriptors</code></p><h4 id="Virtual-memory（虚拟内存）"><a href="#Virtual-memory（虚拟内存）" class="headerlink" title="Virtual memory（虚拟内存）"></a>Virtual memory（虚拟内存）</h4><p>Elasticsearch默认使用一个mappfs目录来存储索引。默认操作系统对mmap计数的限制可能太低，这可能会导致内存不足异常。</p><ul><li><p>暂时设置<br><code>sysctl -w vm.max_map_count=262144</code></p></li><li><p>永久设置</p></li></ul><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置操作系统mmap数限制，Elasticsearch与Lucene使用mmap来映射部分索引到Elasticsearch的地址空间</span></span><br><span class="line"><span class="comment"># 为了让mmap生效，Elasticsearch还需要有创建需要内存映射区的能力。最大map数检查是确保内核允许创建至少262144个内存映射区</span></span><br><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure><h4 id="Number-of-threads（线程数）"><a href="#Number-of-threads（线程数）" class="headerlink" title="Number of threads（线程数）"></a>Number of threads（线程数）</h4><p>Elasticsearch为不同类型的操作使用了许多线程池。它能够在需要时创建新线程，这一点很重要。确保Elasticsearch用户可以创建的线程数量至少是4096个。</p><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch soft nproc 4096</span><br><span class="line">elasticsearch hard nproc 4096</span><br></pre></td></tr></table></figure><h4 id="TCP-retransmission-timeout（TCP重传超时）"><a href="#TCP-retransmission-timeout（TCP重传超时）" class="headerlink" title="TCP retransmission timeout（TCP重传超时）"></a>TCP retransmission timeout（TCP重传超时）</h4><p>集群中的每一对节点通过许多TCP连接进行通信，这些TCP连接一直保持打开状态，直到其中一个节点关闭或由于底层基础设施中的故障而中断节点之间的通信。</p><p>TCP通过对通信应用程序隐藏临时的网络中断，在偶尔不可靠的网络上提供可靠的通信。在通知发送者任何问题之前，您的操作系统将多次重新传输任何丢失的消息。大多数Linux发行版默认重传任何丢失的数据包15次。重传速度呈指数级下降，所以这15次重传需要900秒才能完成。这意味着Linux使用这种方法需要花费许多分钟来检测网络分区或故障节点。Windows默认只有5次重传，相当于6秒左右的超时。</p><p>Linux默认允许在可能经历很长时间包丢失的网络上进行通信，但是对于单个数据中心内的生产网络来说，这个默认值太大了，就像大多数Elasticsearch集群一样。高可用集群必须能够快速检测节点故障，以便它们能够通过重新分配丢失的碎片、重新路由搜索以及可能选择一个新的主节点来迅速作出反应。因此，Linux用户应该减少TCP重传的最大数量。</p><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_retries2 = 5</span><br></pre></td></tr></table></figure><h2 id="Elasticsearch配置"><a href="#Elasticsearch配置" class="headerlink" title="Elasticsearch配置"></a>Elasticsearch配置</h2><p>默认情况Elasticsearch假设处于开发模式中，任何的配置不正确都会在日志文件中写入警告，能够正常启动和运行节点；一旦配置了像network.host这样的网络设置，Elasticsearch就会假设处于生产环境中，并将上面的警告升级为异常，这些异常将阻止节点启动。</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/important-settings.html#important-settings">Important Elasticsearch configuration</a></p><h4 id="config-elasticsearch-yml"><a href="#config-elasticsearch-yml" class="headerlink" title="config/elasticsearch.yml"></a>config/elasticsearch.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ES数据目录和日志目录，path.data可以设置多个路径</span></span><br><span class="line"><span class="attr">path:</span></span><br><span class="line">  <span class="attr">logs:</span> <span class="string">/var/log/elasticsearch</span></span><br><span class="line">  <span class="attr">data:</span> <span class="string">/var/data/elasticsearch</span></span><br><span class="line"><span class="comment"># 集群名称，默认elasticsearch。相同的集群名称的节点，才能加入集群</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="comment"># 设置全新群集中符合主机资格的节点的初始集合（首次启动集群时需要）；默认为空表示该节点希望加入已经被引导的集群</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;10.188.80.14&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点名称，默认随机生成</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">prod-data-2</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 启用预处理，默认启用</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 集群绑定的主机名或IP地址，用于形成一个可以相互通讯的集群；0.0.0.0表示绑定到所有网络接口</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span></span><br><span class="line"><span class="comment"># 节点间通讯绑定端口，默认9300-9400</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提供可访问的集群列表，没有给出端口的通过`transport.port`确定端口，以前使用`discovery.zen.ping.unicast.hosts`</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;10.188.80.14&quot;</span>]</span><br><span class="line"><span class="comment"># 启用单节点发现（节点将选举自己为主节点，并且不会与任何其他节点一起加入集群），推迟了TLS的配置；默认形成多节点集群（发现其他节点，并允许他们加入集群）</span></span><br><span class="line"><span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群的最小master节点数，避免集群脑裂</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># HTTP服务绑定到的主机地址</span></span><br><span class="line"><span class="attr">http.bind_host:</span> </span><br><span class="line"><span class="comment"># 发布以供HTTP客户端连接的主机地址</span></span><br><span class="line"><span class="attr">http.publish_host:</span> </span><br><span class="line"><span class="comment"># http.bind_host and the http.publish_host</span></span><br><span class="line"><span class="attr">http.host:</span> <span class="string">&quot;10.188.80.14&quot;</span></span><br><span class="line"><span class="comment"># HTTP请求绑定端口，默认9200-9300</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment"># 允许跨域</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用swapping，避免影响集群的性能和稳定性，默认开启。（大多数操作系统尝试使用尽可能多的内存文件系统缓存和热切换出未使用的应用程序内存，避免JVM堆交互到磁盘上）</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启通过系统调用过滤器检查，默认为true，如果自己承担禁用系统调用过滤器的风险，设置为false</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动创建索引，默认为true</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 删除索引时必须显示的指定名称，默认为true</span></span><br><span class="line"><span class="attr">action.destructive_requires_name:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="config-jvm-options"><a href="#config-jvm-options" class="headerlink" title="config/ jvm.options"></a>config/ jvm.options</h4><ul><li>Elasticsearch有足够的可用堆是非常重要的。</li><li>堆的最小值（Xms）与堆的最大值（Xmx）设置成相同的。</li><li>Elasticsearch的可用堆越大，它能在内存中缓存的数据越多。但是需要注意堆越大在垃圾回收时造成的暂停会越长。</li><li>设置Xmx不要大于物理内存的50%。用来确保有足够多的物理内存预留给操作系统缓存。</li><li>禁止用串行收集器来运行Elasticsearch（-XX:+UseSerialGC），默认JVM配置通过Elasticsearch的配置将使用CMS回收器。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms8g</span><br><span class="line">-Xmx8g</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;系统配置、Elasticsearch配置说明&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>人体系统-糖</title>
    <link href="http://www.lights8080.com/2021/06/02/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F-%E7%B3%96/"/>
    <id>http://www.lights8080.com/2021/06/02/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F-%E7%B3%96/</id>
    <published>2021-06-01T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>糖对人体的重要性。什么是糖、糖的作用、糖的分类、葡萄糖的人体旅程。</p><span id="more"></span><h2 id="什么是糖"><a href="#什么是糖" class="headerlink" title="什么是糖"></a>什么是糖</h2><p>糖是一大类化学物质，糖类都是由碳氢氧三种元素构成的，最初观察发现其中氢和氧的比例是2:1，好像就是碳原子和几个水分子构成的，所以把糖类叫碳水化合物。后来发现一些糖中的氢和氧的比例不是2:1，所以把糖类叫碳水化合物不严谨。但是这个名字一直流传下来，平时所说的碳水化合物一般指的就是糖。</p><h2 id="糖的作用"><a href="#糖的作用" class="headerlink" title="糖的作用"></a>糖的作用</h2><p>糖是最主要的能源物质，人体进行各项生命活动所消耗的能量主要来自于糖类的氧化分解。分解速度快，提供能量非常迅速，我们的大脑和生理活动都需要糖。</p><p>人体获得能量：<br>葡萄糖 + 氧气 =&gt; 水 + 二氧化碳 + 能量</p><p>葡萄糖在无氧的情况下<br>葡萄糖 =&gt; 乳酸 + 能量(酸奶)<br>葡萄糖 =&gt; 酒精 + 能量(酒)</p><h2 id="糖的分类"><a href="#糖的分类" class="headerlink" title="糖的分类"></a>糖的分类</h2><p>糖不一定是甜的，甜的也不一定是糖。</p><h4 id="单糖"><a href="#单糖" class="headerlink" title="单糖"></a>单糖</h4><p>单糖是构成各种糖分子的基本单位，不能再水解，可以直接被人体吸收。<br>饮食中主要单糖有葡萄糖、果糖、半乳糖，其中葡萄糖是最重要的单糖。<br>所有含碳水化合物的食物进入血液之前，都要分解转化为葡萄糖，到达肠道后，在转运蛋白的帮助下穿过肠壁，最快地为人体提供能量。</p><ul><li>葡萄糖：经过肠道直接被人体吸收，进入到血液，称为血糖</li><li>果糖（水果、蜂蜜）：不直接被人体吸收，进入肝脏转换为葡萄糖或脂肪，因为其运转机制迟滞，没有葡萄糖进入血液得快，果糖更容易变成脂肪</li><li>半乳糖（牛奶）：不直接被人体吸收，进入肝脏转换为葡萄糖</li></ul><h4 id="二糖-双糖"><a href="#二糖-双糖" class="headerlink" title="二糖/双糖"></a>二糖/双糖</h4><p>两个单糖结合在一起组成了双糖，可以水解成单糖，被人体吸收</p><ul><li>麦芽糖（麦芽）：葡萄糖+葡萄糖</li><li>蔗糖（甘蔗）：葡萄糖+果糖</li><li>乳糖（牛奶）：葡萄糖+半乳糖</li></ul><h4 id="多糖"><a href="#多糖" class="headerlink" title="多糖"></a>多糖</h4><p>多糖相对来讲是复合的碳水化合物，由很多单糖通过糖苷链接在一起形成的聚合物，因此多糖结构非常大，经常有分支和很多分子。多糖不溶于水而且没有甜味。</p><ul><li>淀粉（大米、白面）：由葡萄糖连接而成</li><li>糖原（肝脏、肌肉）：肝脏可以把多余的单糖合成糖原储存在肝脏和肌肉里，当身体需要能量时糖原会迅速分解成葡萄糖。</li><li>脂肪（皮下、内脏）：糖原储存不下，更多的单糖会合成脂肪储存在皮下和内脏</li><li>纤维（木头、棉花、蔬菜）：不能消化的碳水化合物被划归为“膳食纤维”或者“不可用碳水化合物”。作用：有饱腹感、促进肠道蠕动、促进粪便形成</li><li>几丁质（虾壳、蟹壳）：人体不能消化的东西</li></ul><h4 id="代糖-甜味剂"><a href="#代糖-甜味剂" class="headerlink" title="代糖/甜味剂"></a>代糖/甜味剂</h4><p>通过人工化学改造或者合成的具有甜味的化学物质。特点是甜度非常高，几乎没有热量，也不具有任何营养价值。</p><ul><li>阿斯巴甜：甜度是等量蔗糖的200倍</li><li>三氯蔗糖：甜度是等量蔗糖的600倍</li></ul><h2 id="葡萄糖的人体旅程"><a href="#葡萄糖的人体旅程" class="headerlink" title="葡萄糖的人体旅程"></a>葡萄糖的人体旅程</h2><p>食物中的碳水化合物通过分解转换为单糖，其中葡萄糖经过肠壁吸收直接进入血液（此时叫血糖），果糖和半乳糖经过吸收进入到肝脏，被转换为葡萄糖、糖原或脂肪。</p><p>葡萄糖 ==&gt; 糖原/脂肪：胰岛素<br>葡萄糖 &lt;== 糖原/脂肪：胰高血糖素</p><p><img src="/Users/lihaipeng/Documents/wechat/PGbDKQ.png"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.zhihu.com/question/20714926/answer/73370674">碳水化合物和糖有什么区别？</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;糖对人体的重要性。什么是糖、糖的作用、糖的分类、葡萄糖的人体旅程。&lt;/p&gt;</summary>
    
    
    
    <category term="人体系统" scheme="http://www.lights8080.com/categories/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="李永乐老师" scheme="http://www.lights8080.com/tags/%E6%9D%8E%E6%B0%B8%E4%B9%90%E8%80%81%E5%B8%88/"/>
    
    <category term="人体系统" scheme="http://www.lights8080.com/tags/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>ElastAlert-介绍</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E4%BB%8B%E7%BB%8D/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E4%BB%8B%E7%BB%8D/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-08T10:32:42.000Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="一、Alerting-With-Elasticsearch"><a href="#一、Alerting-With-Elasticsearch" class="headerlink" title="一、Alerting With Elasticsearch"></a>一、Alerting With Elasticsearch</h2><blockquote><p>ElastAlert是一个简单的框架，用于从Elasticsearch中的数据中发出异常，尖峰或其他感兴趣的模式的警报。</p></blockquote><p>它通过将Elasticsearch与两种类型的组件（规则类型和警报）结合使用。定期查询Elasticsearch，并将数据传递到规则类型，该规则类型确定找到任何匹配项。发生匹配时，它会发出一个或多个警报，这些警报根据不同的类型采取相应的措施。</p><p>ElastAlert由一组规则配置，每个规则定义一个查询，一个规则类型和一组警报。</p><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul><li>架构简单，定制灵活</li><li>支持多种匹配规则（频率、阈值、数据变化、黑白名单、变化率等）</li><li>支持多种警报类型（邮件、HTTP POST、自定义脚本等）</li><li>匹配项汇总报警，重复警报抑制，报警失败重试和过期</li><li>可用性强，状态信息保存到Elasticsearch的索引中</li><li>过程的调试和审计等</li></ul><h3 id="可用性（Reliability）"><a href="#可用性（Reliability）" class="headerlink" title="可用性（Reliability）"></a>可用性（Reliability）</h3><ul><li>ElastAlert 将其状态保存到 Elasticsearch，启动后，将恢复之前停止的状态</li><li>如果 Elasticsearch 没有响应，ElastAlert 将等到恢复后才继续</li><li>抛出错误的警报可能会在一段时间内自动重试</li></ul><h3 id="模块性（Modularity）"><a href="#模块性（Modularity）" class="headerlink" title="模块性（Modularity）"></a>模块性（Modularity）</h3><p>ElastAlert具有三个主要组件（规则类型、警报、增强），可以作为模块导入和定制。</p><ul><li><p>规则类型（Rule Types）<br>规则类型负责处理从Elasticsearch返回的数据。它会使用规则配置进行初始化，传递通过规则过滤器查询Elasticsearch返回的数据，并根据此数据输出匹配项。</p></li><li><p>警报（Alerts）<br>警报负责根据匹配采取行动。匹配项通常是一个字典，其中包含Elasticsearch中文档中的值，但可以包含由规则类型添加的任意数据。</p></li><li><p>增强（Enhancements）<br>增强功能是一种拦截警报并以某种方式对其进行修改或增强的方法。在将其提供给警报器之前，将它们传递给匹配字典。</p></li></ul><h3 id="全局配置（Configuration）"><a href="#全局配置（Configuration）" class="headerlink" title="全局配置（Configuration）"></a>全局配置（Configuration）</h3><p>config.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elasticsearch集群配置</span></span><br><span class="line"><span class="attr">es_host:</span></span><br><span class="line"><span class="attr">es_port:</span></span><br><span class="line"><span class="attr">use_ssl:</span></span><br><span class="line"><span class="attr">verify_certs:</span></span><br><span class="line"><span class="attr">es_username:</span></span><br><span class="line"><span class="attr">es_password:</span></span><br><span class="line"><span class="attr">es_url_prefix:</span></span><br><span class="line"><span class="attr">es_conn_timeout:</span></span><br><span class="line"><span class="comment"># 设置检索rules和hashes的加载类</span></span><br><span class="line"><span class="attr">rules_loader:</span> <span class="string">&#x27;FileRulesLoader&#x27;</span></span><br><span class="line"><span class="comment"># 规则配置文件的文件夹的名称，仅rules_loader=FileRulesLoader时有效</span></span><br><span class="line"><span class="attr">rules_folder:</span> <span class="string">rules</span></span><br><span class="line"><span class="comment"># 是否递归rules目录的子目录配置</span></span><br><span class="line"><span class="attr">scan_subdirectories:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 查询Elasticsearch的时间间隔</span></span><br><span class="line"><span class="attr">run_every:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># 查询窗口的大小</span></span><br><span class="line"><span class="attr">buffer_time:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">15</span></span><br><span class="line"><span class="comment"># ElastAlert将存储数据的索引名称</span></span><br><span class="line"><span class="attr">writeback_index:</span> <span class="string">elastalert_status</span></span><br><span class="line"><span class="comment"># 单次查询Elasticsearch最大文档数，默认10000</span></span><br><span class="line"><span class="attr">max_query_size:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># 滚动浏览的最大页面数，默认0（表示不限制）</span></span><br><span class="line"><span class="attr">max_scrolling_count:</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># 在滚动浏览上下文中应保持活动状态的最长时间</span></span><br><span class="line"><span class="attr">scroll_keepalive:</span> </span><br><span class="line"><span class="string">汇总在一起的最大警报数</span></span><br><span class="line"><span class="attr">max_aggregation:</span></span><br><span class="line"><span class="comment"># 两次查询之间的最长时间</span></span><br><span class="line"><span class="attr">old_query_limit:</span></span><br><span class="line"><span class="comment"># 禁用未捕获异常的规则，默认True</span></span><br><span class="line"><span class="attr">disable_rules_on_error:</span> </span><br><span class="line"><span class="comment"># ElastAlert完成执行后会显示“禁用规则”列表</span></span><br><span class="line"><span class="attr">show_disabled_rules:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 通知邮件列表，当前只有未捕获的异常会发送通知电子邮件</span></span><br><span class="line"><span class="attr">notify_email:</span></span><br><span class="line"><span class="comment"># 警报是否包括规则中描述的元数据，默认False</span></span><br><span class="line"><span class="attr">add_metadata_alert:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 跳过无效的文件而不是退出</span></span><br><span class="line"><span class="attr">skip_invalid:</span> </span><br><span class="line"><span class="comment"># 失败警报的重试窗口</span></span><br><span class="line"><span class="attr">alert_time_limit:</span></span><br></pre></td></tr></table></figure><h2 id="二、Running-ElastAlert"><a href="#二、Running-ElastAlert" class="headerlink" title="二、Running ElastAlert"></a>二、Running ElastAlert</h2><blockquote><p>安装、命令、测试规则、运行</p></blockquote><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python3.6安装</span></span><br><span class="line">$ wget https://www.python.org/ftp/python/3.6.9/Python-3.6.9.tgz</span><br><span class="line">$ tar -zxvf Python-3.6.9.tgz</span><br><span class="line">$ <span class="built_in">cd</span> Python-3.6.9</span><br><span class="line">$ ./configure</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Python版本</span></span><br><span class="line">$ python3 -V</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/Yelp/elastalert.git</span><br><span class="line"></span><br><span class="line">$ wget https://github.com/daichi703n/elastalert/archive/refs/heads/fix/initialize_alerts_sent.zip</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> elastalert/</span><br><span class="line">$ pip3 install <span class="string">&quot;setuptools&gt;=11.3&quot;</span></span><br><span class="line">$ python3 ./setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 报错（pip:No module named setuptools_rust）解决办法</span></span><br><span class="line">$ pip3 install setuptools-rust</span><br><span class="line"></span><br><span class="line">$ pip3 install <span class="string">&quot;elasticsearch&gt;=5.0.0&quot;</span></span><br></pre></td></tr></table></figure><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建索引</span></span><br><span class="line">$ elastalert-create-index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试Rule，24小时内以调试模式运行。--config：指定配置文件</span></span><br><span class="line">$ elastalert-test-rule example_rules/example_frequency.yaml</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">$ python3 -m elastalert.elastalert --config ./config.yaml --rule rules/service_exception.yaml --start 2021-05-16T00:00:00+08:00 --debug --es_debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台运行</span></span><br><span class="line">nohup python3 -m elastalert.elastalert --config ./config.yaml --verbose --rule ./your_rule.yaml &gt;&gt; ./elastalert.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h4 id="测试规则（Testing-Rule）"><a href="#测试规则（Testing-Rule）" class="headerlink" title="测试规则（Testing Rule）"></a>测试规则（Testing Rule）</h4><p>可以在调试模式下运行ElastAlert，也可以使用elastalert-test-rule（该脚本可以简化测试的各个方面）</p><p>功能：</p><ul><li>检查配置文件是否加载成功</li><li>检查Elasticsearch过滤器是否解析</li><li>与最后的X天(s)运行，显示匹配您的过滤器的点击数</li><li>在一个结果中显示可用的术语</li><li>保存返回到JSON文件的文档</li><li>使用JSON文件或Elasticsearch的实际结果运行ElastAlert</li><li>打印调试警报或触发真实警报</li><li>如果存在，则检查结果中是否包含primary_key、compare_key和include术语</li><li>显示将要写入elastalert_status的元数据文档</li></ul><p>参数：</p><ul><li>–schema-only：只对文件执行验证</li><li>–count-only：仅查找匹配文档的数量并列出可用字段</li><li>–days N：指定针对最近的N天运行，默认1天</li><li>–save-json FILE：将所有下载的文档保存为JSON文件</li><li>–data FILE：使用JSON文件代替Elasticsearch作为数据源</li><li>–alert：触发实际警报，而不是调试（日志文本）警报</li><li>–formatted-output：以格式化的JSON输出结果。</li></ul><h4 id="运行（Running-ElastAlert）"><a href="#运行（Running-ElastAlert）" class="headerlink" title="运行（Running ElastAlert）"></a>运行（Running ElastAlert）</h4><p>有两种运行ElastAlert的方法。作为守护程序或直接与Python一起使用（$ python3 elastalert/elastalert.py）。</p><p>参数：</p><ul><li>–config：指定要使用的配置文件，默认值为config.yaml</li><li>–debug：debug模式；1.增加日志记录的详细程度，2.将所有的报警更改为DebugAlerter，抑制它们正常的报警行为，3.跳过写入查询和警报的元数据到Elasticsearch</li><li>–verbose：将增加日志记录的详细程度，与–debug不兼容</li><li>–start <timestamp>：强制从指定的时间查询，而不是当前时间。如：2021-05-16T00:00:00+08:00</li><li>–end <timestamp>：将强制在指定时间之后停止查询，默认到当前时间</li><li>–rule &lt;rule.yaml&gt;：只运行给定的规则</li><li>–silence <unit>=<number>：将使给定规则的警报静音一段时间。该规则必须使用–rule指定</li><li>–es_debug：启用对Elasticsearch进行的所有查询的日志记录。</li><li>–es_debug_trace &lt;trace.log&gt;：将启用将对Elasticsearch进行的所有查询的curl命令记录到指定的日志文件</li><li>–pin_rules：禁用动态加载规则</li></ul><h2 id="三、Rule-Types-and-Configuration-Options"><a href="#三、Rule-Types-and-Configuration-Options" class="headerlink" title="三、Rule Types and Configuration Options"></a>三、Rule Types and Configuration Options</h2><blockquote><p>规则类型、配置项、报警配合<br><a href="https://elastalert.readthedocs.io/en/stable/ruletypes.html">https://elastalert.readthedocs.io/en/stable/ruletypes.html</a></p></blockquote><h3 id="Rule-Types"><a href="#Rule-Types" class="headerlink" title="Rule Types"></a>Rule Types</h3><ul><li>frequency：频率；在给定时间范围内至少有一定数量的事件时，此规则匹配<ul><li>num_events：触发警报的事件数</li><li>timeframe：事件数必须发生在的此时间段内，触发报警</li><li>use_count_query：使用count API轮询Elasticsearch</li></ul></li><li>any：过滤器每次匹配都会警报</li><li>blacklist：黑名单；将对照黑名单检查某个字段，如果该字段在黑名单中，则进行匹配<ul><li>compare_key： 用于与黑名单进行比较的字段的名称，如果字段为null，那么这些事件将被忽略</li><li>blacklist：黑名单值的列表</li></ul></li><li>whitelist：白名单；与黑名单类似</li><li>change：更改；将监视特定字段，并在该字段发生更改时进行匹配<ul><li>compare_key：要监视更改的字段的名称</li><li>ignore_null：如果为true，则没有compare_key字段的事件将不会计为已更改</li><li>query_key：对每个query_key的唯一值分别计数。</li><li>timeframe: 可选；时间范围，两次更改之间的最长时间。在这段时间之后，ElastAlert将忘记compare_key字段的旧值</li></ul></li><li>spike：当事件发生率增加或减少时匹配，它使用两个滑动窗口来比较事件的当前频率和参考频率<ul><li>spin_height：上一个时间范围与上一个时间范围内的事件数之比，点击该事件将触发警报</li><li>spike_type：‘up’, ‘down’ or ‘both’</li><li>timeframe：平均出该时间段内的事件发生率</li><li>field_value：可选；使用文档中字段的值而不是匹配文档的数量</li><li>threshold_ref：参考窗口中必须存在的最少数量的事件才能触发警报</li><li>threshold_cur：当前窗口中必须存在的最小数量的事件才能触发警报</li></ul></li><li>flatline：当事件总数在一个时间段内低于给定阈值时，此规则匹配<ul><li>threshold：不触发警报的最小事件数</li><li>timeframe：时间范围</li></ul></li><li>new_term：当新值出现在以前从未见过的字段中时，此规则匹配<ul><li>fields：监视字段列表</li></ul></li><li>cardinality：当时间范围内某个字段的唯一值的总数大于或小于阈值时，此规则匹配<ul><li>cardinality_field：要计算基数的字段</li><li>timeframe：时间范围</li></ul></li><li>metric_aggregation：当计算窗口中的度量值高于或低于阈值时，此规则匹配</li><li>spike_aggregation：当计算窗口中某个指标的值是spike_height乘以比前一个时间段大或小时，该规则匹配</li><li>percentage_match：当计算窗口内匹配存储区中的文档百分比高于或低于阈值时，此规则匹配</li></ul><p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/06/xZ1jbI.jpg" alt="IMAGE"></p><h3 id="规则配置（Rule-Configuration）"><a href="#规则配置（Rule-Configuration）" class="headerlink" title="规则配置（Rule Configuration）"></a>规则配置（Rule Configuration）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elasticsearch配置</span></span><br><span class="line"><span class="attr">es_host:</span> <span class="number">10.188</span><span class="number">.10</span><span class="number">.1</span></span><br><span class="line"><span class="attr">es_port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">es_username:</span> <span class="string">elastic</span></span><br><span class="line"><span class="attr">es_password:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">index:</span> <span class="string">logstash-*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rule Type</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">&#x27;any&#x27;</span></span><br><span class="line"><span class="comment"># Alerts</span></span><br><span class="line"><span class="attr">alert:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">email</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入公共配置</span></span><br><span class="line"><span class="attr">import:</span></span><br><span class="line"><span class="comment"># 用于标识警报的利益相关者</span></span><br><span class="line"><span class="attr">owner:</span> <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line"><span class="comment"># 用于标识警报的相对优先级</span></span><br><span class="line"><span class="attr">priority:</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># 用于标识警报的类别</span></span><br><span class="line"><span class="attr">catagory:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 规则描述</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置请求里查询窗口的范围。当use_count_query或use_terms_query为true时，将忽略此值</span></span><br><span class="line"><span class="attr">buffer_time:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># 延迟查询</span></span><br><span class="line"><span class="attr">query_delay:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启timeframe（当前时间减去timeframe之后开始查询）</span></span><br><span class="line"><span class="attr">scan_entire_timeframe:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attr">timeframe:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Elasticsearch查询过滤器</span></span><br><span class="line"><span class="attr">filter:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">query:</span></span><br><span class="line">    <span class="attr">query_string:</span></span><br><span class="line">      <span class="attr">query:</span> <span class="string">&quot;level: ERROR&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传递给规则类型和警报的查询结果字段列表，默认所有字段</span></span><br><span class="line"><span class="attr">include:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;username&quot;</span></span><br><span class="line"><span class="comment"># 针对每个字段的前X（top_count_number）个最常用的值执行Terms查询</span></span><br><span class="line"><span class="attr">top_count_keys:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;username&quot;</span></span><br><span class="line"><span class="comment"># 术语的前X个最常用的值，与top_count_keys一同使用</span></span><br><span class="line"><span class="attr">top_count_number:</span> <span class="number">5</span></span><br><span class="line"><span class="comment"># 如果为true，top_count_keys中所有字段都会附加.raw</span></span><br><span class="line"><span class="attr">raw_count_keys:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单次查询获取的最大文档数</span></span><br><span class="line"><span class="attr">max_query_size:</span> <span class="number">10000</span></span><br><span class="line"><span class="comment"># 计数查询（count api），而不下载所匹配的文档</span></span><br><span class="line"><span class="attr">use_count_query:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 聚合查询（aggregation），和query_key、doc_type、terms_size一起使用</span></span><br><span class="line"><span class="attr">use_terms_query:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为每个值单独计数（多个逗号分隔，必须配合compound_query_key使用）</span></span><br><span class="line"><span class="attr">query_key:</span> <span class="string">&#x27;service_name,username&#x27;</span></span><br><span class="line"><span class="comment"># 复合的查询key，必须与query_key一一对应，get_hits_terms时使用</span></span><br><span class="line"><span class="attr">compound_query_key:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">service_name</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">username</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">doc_type:</span> <span class="string">_doc</span></span><br><span class="line"><span class="comment"># 桶的最大数</span></span><br><span class="line"><span class="attr">terms_size:</span> <span class="number">50</span></span><br><span class="line"><span class="comment"># 相关事件一同报警。一个桶触发报警，其他的桶一同触发报警</span></span><br><span class="line"><span class="attr">attach_related:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将多次匹配汇总到一个警报中，将聚合时间期内发生的所有匹配项一起发送</span></span><br><span class="line"><span class="attr">aggregation:</span></span><br><span class="line">  <span class="comment"># 需要大量匹配并只需要定期报告</span></span><br><span class="line">  <span class="attr">hours:</span> <span class="number">2</span></span><br><span class="line">  <span class="comment"># 汇总所有警报并定期发送报警</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&#x27;2 4 * * mon,fri&#x27;</span></span><br><span class="line"><span class="comment"># 为不同的字段值创建一个独立的聚合窗口，默认在聚合窗口期中所有事件被分组在一起</span></span><br><span class="line"><span class="attr">aggregation_key:</span> <span class="string">&#x27;my_data.username&#x27;</span></span><br><span class="line"><span class="comment"># 基于第一个事件的时间创建聚合，默认当前时间</span></span><br><span class="line"><span class="attr">aggregate_by_match_time:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 对于聚合报警，指定摘要表字段</span></span><br><span class="line"><span class="attr">summary_table_fields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">my_data.username</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略一段时间的重复警报，支持query_key</span></span><br><span class="line"><span class="attr">realert:</span> </span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">10</span></span><br><span class="line"><span class="comment"># 使realert的值呈指数增加</span></span><br><span class="line"><span class="attr">exponential_realert:</span></span><br><span class="line">  <span class="attr">hours:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否将时间戳转换为警报中的本地时区</span></span><br><span class="line"><span class="attr">use_local_time:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 时间戳类型（iso, unix, unix_ms, custom）</span></span><br><span class="line"><span class="attr">timestamp_type:</span> <span class="string">&#x27;iso&#x27;</span></span><br><span class="line"><span class="comment"># 自定义时间戳格式</span></span><br><span class="line"><span class="attr">timestamp_format:</span> <span class="string">&#x27;%Y-%m-%dT%H:%M:%SZ&#x27;</span></span><br><span class="line"><span class="comment"># 指定时间字段，默认@timestamp</span></span><br><span class="line"><span class="attr">timestamp_field:</span> <span class="string">&#x27;@timestamp&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Alerts"><a href="#Alerts" class="headerlink" title="Alerts"></a>Alerts</h3><p>每个规则都可以附加任何数量的警报。每个警报器的选项既可以定义在yaml文件，也可以嵌套在警报名称中，允许同一警报器的多个不同设置。</p><ul><li>Command：命令报警，并从匹配项中传递参数</li><li>Email：邮件报警</li><li>Http Post：URL报警</li><li>… </li></ul><p>示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">API</span> <span class="string">not</span> <span class="number">200</span></span><br><span class="line"><span class="attr">index:</span> <span class="string">sg-access-*</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">frequency</span></span><br><span class="line"><span class="attr">num_events:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">timeframe:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">filter:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">query:</span></span><br><span class="line">    <span class="attr">query_string:</span></span><br><span class="line">      <span class="attr">query:</span> <span class="string">&quot;NOT statusCode: 200&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alert:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">command</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="attr">command:</span> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;/opt/elastalert/weixin.py&quot;</span>, <span class="string">&quot;生产环境报警，报警:&quot;</span>, <span class="string">&quot;接口&#123;orgPathName&#125; 出现状态码&#123;statusCode&#125;频率高！&quot;</span>,<span class="string">&quot;服务 IP: &#123;directBackServer&#125;; 服务端口：&#123;port&#125;&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="四、ElastAlert-Metadata-Index"><a href="#四、ElastAlert-Metadata-Index" class="headerlink" title="四、ElastAlert Metadata Index"></a>四、ElastAlert Metadata Index</h2><p>ElastAlert使用Elasticsearch来存储有关其状态的各种信息。这不仅可以对ElastAlert的操作进行某种程度的审核和调试，还可以避免在ElastAlert关闭，重新启动或崩溃时丢失数据或重复警报。Elasticsearch群集和索引信息在全局配置文件中使用es_host，es_port和writeback_index进行定义。ElastAlert必须能够写入此索引。脚本elastalert-create-index将为您创建具有正确映射的索引，并可以选择从现有ElastAlert回写索引中复制文档。</p><p>ElastAlert将在回写索引（writeback index）中创建三种不同类型的文档。</p><h4 id="elastalert-status"><a href="#elastalert-status" class="headerlink" title="elastalert_status"></a>elastalert_status</h4><blockquote><p>记录规则的查询执行日志</p></blockquote><p>elastalert_status是ElastAlert在确定其首次开始时要使用的时间范围，以避免重复查询。对于每个规则，它将从最近的结束时间开始查询。如果ElastAlert在调试模式下运行，它仍将通过查找最近执行的搜索来尝试基于其开始时间，但不会将任何查询的结果写回到Elasticsearch。</p><h4 id="elastalert"><a href="#elastalert" class="headerlink" title="elastalert"></a>elastalert</h4><blockquote><p>记录触发的每个警报信息日志</p></blockquote><h4 id="elastalert-error"><a href="#elastalert-error" class="headerlink" title="elastalert_error"></a>elastalert_error</h4><blockquote><p>当ElastAlert中发生错误时，它将同时写入Elasticsearch和stderr</p></blockquote><h4 id="silence"><a href="#silence" class="headerlink" title="silence"></a>silence</h4><blockquote><p>记录何时将抑制给定规则的警报的日志</p></blockquote><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://elastalert.readthedocs.io/en/stable/index.html">https://elastalert.readthedocs.io/en/stable/index.html</a><br><a href="https://www.cnblogs.com/evescn/p/13098343.html">https://www.cnblogs.com/evescn/p/13098343.html</a><br><a href="https://www.jianshu.com/p/e6281cf72e95/">https://www.jianshu.com/p/e6281cf72e95/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;h2 id=&quot;一、Alerting-With-Elasticsearch&quot;&gt;&lt;a href=&quot;#一、Alerting-With-Elasticsearch&quot; class=&quot;headerlink&quot; title=&quot;一、Alertin</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ElastAlert-介绍</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/ELK/ElastAlert-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-08T07:08:48.000Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="1、elastalert-py"><a href="#1、elastalert-py" class="headerlink" title="1、elastalert.py"></a>1、elastalert.py</h2><h2 id="run-every、buffer-time"><a href="#run-every、buffer-time" class="headerlink" title="run_every、buffer_time"></a>run_every、buffer_time</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;h2 id=&quot;1、elastalert-py&quot;&gt;&lt;a href=&quot;#1、elastalert-py&quot; class=&quot;headerlink&quot; title=&quot;1、elastalert.py&quot;&gt;&lt;/a&gt;1、elastalert.py&lt;</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Linux [buff/cache]内存缓存占用过高分析和优化</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/Linux%20[buffcache]%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90%E5%92%8C%E4%BC%98%E5%8C%96/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/Linux%20[buffcache]%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90%E5%92%8C%E4%BC%98%E5%8C%96/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-08T02:15:33.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>buff/cache过高问题解决过程。问题现场、问题分析、如何解决、扩展知识</p></blockquote><span id="more"></span><h2 id="问题现场"><a href="#问题现场" class="headerlink" title="问题现场"></a>问题现场</h2><p>查看系统内存的使用状态<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-free.jpg"></p><p>监控报警可用内存空间不足，常规的解决方案如下：</p><ol><li>增加内存（增加成本）</li><li>增加虚拟内存（影响性能）</li><li>定期清理缓存（echo 1 &gt; /proc/sys/vm/drop_caches）</li></ol><p>本文将介绍定期清除页面缓存，但是过会儿内存又被占满问题的分析。</p><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><ol><li><p>通过监控系统负载情况（vmstat 1），确定是页面缓存（cache项）占用量大，并且释放页面缓存后从块设备读入数据量（bi项）会马上增加。<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-vmstat.jpg"></p></li><li><p>通过监控io情况（iostat -x -k 1）也可以看出<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-iostat.jpg"></p></li><li><p>基于此可以猜测是有进程在频繁的读取文件导致，监视磁盘I/O使用状况（iotop -oP），释放页面缓存后有几个sed命令读取文件进程占用IO很高。<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-iotop.jpg"></p></li><li><p>至此结合业务分析是因为每分钟读取日志统计指标导致</p></li></ol><h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><h3 id="proc-meminfo"><a href="#proc-meminfo" class="headerlink" title="/proc/meminfo"></a>/proc/meminfo</h3><p>查看更详细的内存信息：<br><code>$ cat /proc/meminfo |grep -E &quot;Buffer|Cache|Swap|Mem|Shmem|Slab|SReclaimable|SUnreclaim&quot;</code><br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-meminfo.jpg"></p><ul><li>MemFree：空闲的物理内存</li><li>MemAvailable：可用的物理内存，MemFree+Buffers+Cached</li><li>Buffers：（Buffer Cache）对磁盘块设备数据的缓存</li><li>Cached：（Page Cache）对文件系统上文件数据的缓存，MemFree+SReclaimable</li><li>SwapTotal：虚拟内存，利用磁盘空间虚拟出的一块逻辑内存</li><li>Slab：Linux内存管理机制</li><li>SReclaimable：Slab可回收部分</li><li>SUnreclaim：Slab不可回收部分</li><li>Shmem：进程间共同使用的共享内存</li></ul><h3 id="proc-sys-vm-drop-caches"><a href="#proc-sys-vm-drop-caches" class="headerlink" title="/proc/sys/vm/drop_caches"></a>/proc/sys/vm/drop_caches</h3><p>清除缓存策略：<br>1：清除page cache<br>2：清除slab分配器中的对象（包括目录项和inode）<br>3：清除page cache和slab分配器中的对象</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://lights8080.github.io/post/oom-killer-ji-overcommit/">OOM killer及Overcommit</a><br><a href="https://blog.csdn.net/kunyus/article/details/104617426">Linux buffer/cache 内存占用过高的原因以及解决办法</a><br><a href="https://blog.csdn.net/linxi7/article/details/109078516">Linux查看Buffer&amp;Cache被哪些进程占用</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;buff/cache过高问题解决过程。问题现场、问题分析、如何解决、扩展知识&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/Linux/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="线上问题处理" scheme="http://www.lights8080.com/tags/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>OOM killer及Overcommit</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/OOM%20killer%E5%8F%8AOvercommit/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/OOM%20killer%E5%8F%8AOvercommit/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:38.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>OOM killer(Out Of Memory killer)是Linux内核的一种内存管理机制，该机制在系统物理内存不足时，选择性杀死一些进程以释放内存，以使系统继续运行。</p></blockquote><span id="more"></span><h2 id="OOM-killer"><a href="#OOM-killer" class="headerlink" title="OOM killer"></a>OOM killer</h2><p>OOM killer(Out Of Memory killer)是Linux内核的一种内存管理机制，该机制在系统物理内存不足时，选择性（oom_killer遍历当前所有进程，根据进程的内存使用情况进行打分，然后从中选择一个分数最高的进程）杀死一些进程以释放内存，以使系统继续运行。</p><h3 id="Overcommit（过量使用）"><a href="#Overcommit（过量使用）" class="headerlink" title="Overcommit（过量使用）"></a>Overcommit（过量使用）</h3><p>这个特性出于优化系统考虑，因为进程实际使用到的内存往往比申请的内存少。</p><p>按照Linux的算法，物理内存页的分配发生在使用瞬间，而不是在申请瞬间。Overcommit针对的也是内存申请，而不是内存分配。</p><p>Linux下允许程序申请比系统可用内存更多的内存。因为不是所有的程序申请了内存就立刻使用的，当实际使用时超过可分配物理内存时，利用OOM机制选择性杀死一些进程以释放内存。</p><h3 id="参数调优"><a href="#参数调优" class="headerlink" title="参数调优"></a>参数调优</h3><p>vm.overcommit_memory</p><ul><li>0：OVERCOMMIT_GUESS（默认），内核将检查是否有足够的可用内存供应用进程使用</li><li>1：OVERCOMMIT_ALWAYS，允许超过CommitLimit的分配，即允许分配所有的物理内存，而不管当前的内存状态如何</li><li>2：OVERCOMMIT_NEVER，拒绝超过CommitLimit的分配，即拒绝等于或者大于CommitLimit指定的物理 RAM 比例的内存请求</li></ul><p>CommitLimit 和 Commited_AS</p><ul><li>CommitLimit：最大能分配的内存<ul><li>计算公式：(Physical RAM * vm.overcommit_ratio / 100) + Swap</li></ul></li><li>Committed_AS：当前已经分配的内存</li></ul><h3 id="OVERCOMMIT策略的可用内存判定"><a href="#OVERCOMMIT策略的可用内存判定" class="headerlink" title="OVERCOMMIT策略的可用内存判定"></a>OVERCOMMIT策略的可用内存判定</h3><ul><li>OVERCOMMIT_GUESS：判定可用内存 = free + buff/cache - share + Swap + SLAB已标记可回收的内存 - 系统运行预留的内存 - 管理员操作预留内存</li><li>OVERCOMMIT_ALWAYS：直接返回成功</li><li>OVERCOMMIT_NEVER：判断Committed_AS &lt; CommitLimit</li></ul><h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看overcommit策略</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/sys/vm/overcommit_memory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看进程OOM得分，oom_killer将首先杀死得分最高的进程</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/&lt;pid&gt;/oom_score</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看CommitLimit和Committed_AS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/meminfo |grep -i commit</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://blog.csdn.net/run_for_belief/article/details/83446344">Linux OOM killer机制介绍</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;OOM killer(Out Of Memory killer)是Linux内核的一种内存管理机制，该机制在系统物理内存不足时，选择性杀死一些进程以释放内存，以使系统继续运行。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/Linux/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway与后端服务问题处理总结</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/SpringCloud/Spring%20Cloud%20Gateway%E4%B8%8E%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/SpringCloud/Spring%20Cloud%20Gateway%E4%B8%8E%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-08T02:15:46.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Spring Cloud Gateway相关问题分析、解决思路的过程。</p><ol><li>Connection prematurely closed BEFORE response</li><li>浪涌导致网关报错分析</li></ol></blockquote><span id="more"></span><h2 id="问题1（Connection-prematurely-closed-BEFORE-response）"><a href="#问题1（Connection-prematurely-closed-BEFORE-response）" class="headerlink" title="问题1（Connection prematurely closed BEFORE response）"></a>问题1（Connection prematurely closed BEFORE response）</h2><p>后端服务偶尔报错Connection prematurely closed BEFORE response。</p><p>这个问题的产生原因和解决办法网上很容易找到。我这里只贴出问题原理图和解决办法。<br>详细说明请参考<a href="https://javazhiyin.blog.csdn.net/article/details/112914264">https://javazhiyin.blog.csdn.net/article/details/112914264</a></p><p><strong>原理图</strong><br><img src="https://img-blog.csdnimg.cn/img_convert/87a7537eb4e30ab56e3f8a3d594ef544.png" alt="file"></p><p><strong>解决办法</strong></p><ol><li><p>spring cloud gateway增加jvm启动参数<br>后进先出策略，确保获取的连接最大概率是最近刚被用过的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dreactor.netty.pool.leasingStrategy=lifo</span><br></pre></td></tr></table></figure></li><li><p>后端服务配置<br>后端服务连接超时时长改为10秒（默认20s），超时没有数据交互则关闭连接。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">tomcat:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></li><li><p>spring cloud gateway增加配置<br>设置连接的最大空闲时长为5秒（默认NULL：响应完成即可关闭），超时则关闭连接释放资源。<br>这个时长的设置要小于后端服务的连接超时时长，确保网关回收请求在后端服务回收请求之前完成。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-idle-time:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="问题2（浪涌导致网关报错分析）"><a href="#问题2（浪涌导致网关报错分析）" class="headerlink" title="问题2（浪涌导致网关报错分析）"></a>问题2（浪涌导致网关报错分析）</h2><blockquote><p>每天不定时出现响应失败，Nginx响应状态码出现大量的500和504，网关同样出现大量的500和504，后端服务正常。</p></blockquote><p>Nginx、Gateway、Service每小时统计数如下，其中Nginx，0点的数比较少是因为日志文件截取导致缺失<br><img src="https://img-blog.csdnimg.cn/img_convert/40470233cb556053f82cb6e3c6d1e615.png" alt="file"></p><ul><li>经过分析得到，2点是正常情况，Nginx-&gt;Gateway-&gt;Service数都对的上。</li><li>1点的数据显示Service收到的请求数减少，响应时间也正常，Gateway报错分为504：Gateway响应时间超过导致（配置的60s），500：Gateway连接超过导致（配置的3s），说明Gateway请求并未到达Service端。</li><li>查看Nginx和Gateway的连接数出现了激增，因为外部流量瞬间涌入导致服务器连接数资源被占用。<br><img src="https://img-blog.csdnimg.cn/img_convert/3bf64c40fde06be1e9c1f35e1d35e6f7.png" alt="file"><br><img src="https://img-blog.csdnimg.cn/img_convert/c0ae71367df1d41a1da2d5dd6626d3c2.png" alt="file"></li></ul><p><strong>优化方案</strong></p><ol><li><p>开启Gateway限流策略</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">50</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.requestedTokens:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">key-resolver:</span> <span class="string">&quot;#&#123;@userKeyResolver&#125;&quot;</span></span><br><span class="line">            <span class="attr">deny-empty-key:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></li><li><p>Gateway请求Service超时配置的60s，根据业务需要超过10s响应都视作无效，所以配置响应超时时间为10秒</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">response-timeout:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure></li><li><p>Gateway的连接池使用弹性方式，导致服务器连接数资源被占满，改为固定方式。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="comment"># 线程池类型，ELASTIC：弹性，FIXED：固定</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">FIXED</span></span><br><span class="line">          <span class="comment"># 超过此时间连接不使用就关闭</span></span><br><span class="line">          <span class="attr">max-idle-time:</span> <span class="number">5000</span></span><br><span class="line">          <span class="comment"># 线程池最大连接数，type=FIXED时有效</span></span><br><span class="line">          <span class="attr">max-connections:</span> <span class="number">200</span></span><br><span class="line">          <span class="comment"># 从线程池获取线程的最大等待时间，type=FIXED时有效</span></span><br><span class="line">          <span class="attr">acquire-timeout:</span> <span class="number">45000</span></span><br></pre></td></tr></table></figure></li><li><p>由于Gateway到不同的Service，响应时间不一样，可以在Service端的元数据信息中修改连接超时时间和响应超时时间</p></li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">response-timeout:</span> <span class="number">10000</span></span><br><span class="line">          <span class="attr">connect-timeout:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Spring Cloud Gateway相关问题分析、解决思路的过程。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Connection prematurely closed BEFORE response&lt;/li&gt;
&lt;li&gt;浪涌导致网关报错分析&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="SpringCloud" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/SpringCloud/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="线上问题处理" scheme="http://www.lights8080.com/tags/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
    
    <category term="SpringCloud" scheme="http://www.lights8080.com/tags/SpringCloud/"/>
    
  </entry>
  
  <entry>
    <title>思维乱撞</title>
    <link href="http://www.lights8080.com/2021/05/13/%E6%9D%82%E8%B0%88/%E6%80%9D%E7%BB%B4%E4%B9%B1%E6%92%9E/"/>
    <id>http://www.lights8080.com/2021/05/13/%E6%9D%82%E8%B0%88/%E6%80%9D%E7%BB%B4%E4%B9%B1%E6%92%9E/</id>
    <published>2021-05-12T16:00:00.000Z</published>
    <updated>2021-06-07T09:02:43.000Z</updated>
    
    <content type="html"><![CDATA[<p>思维局限性、美国个人支付、奋斗一生和及时行乐</p><span id="more"></span><p>如果发现一个软件很活跃，但你觉得用另一个产品不是更好吗甚至这个软件还有某些缺陷。那一定是你没有遇到适用场景，当遇到时，你会说这正是我想要的产品。</p><p>产品经理，应该从产品角度去思考用怎样的功能满足需求，而不是简单的把需求做成功能。</p><p>不懂产品，迎合需求，长期来看就是负债。</p><p>开发人员如果更懂产品，会写出更良好的结构化代码，而不是给代码打补丁。</p><hr><p>移动支付对我们来说太平常了。随处都可以拿出手机扫码支付。但是在美国个人支票几乎天天都还在用。出门购物刷信用卡/现金，金额较大的大都还用个人支票，比如：缴学费、交房租、还贷、包红包等。</p><p>我们看来这太落伍了，但站在系统角度，考虑健壮性和可用性，个人支票支付方式是个很好的方案。支付环境不依赖网络，设备，电力系统。单靠信用体系维护运行，零成本。</p><hr><p>有些人奋斗一生，生活水平提高了不少，但迫于社会价值观，内心所想被压抑一生。</p><p>有些人及时行乐，生活虽不富裕，但活的简简单单，随心所欲（在不伤害别人的前提下）。</p><p>艰苦奋斗还是随遇而安，卸掉社会属性，单从生命个体的角度看，怎样的一生更符合生命的本质呢？</p><p>写完之后我也不知道是怎么把它们联系在一起了。。。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;思维局限性、美国个人支付、奋斗一生和及时行乐&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈" scheme="http://www.lights8080.com/categories/%E6%9D%82%E8%B0%88/"/>
    
    
    <category term="杂谈" scheme="http://www.lights8080.com/tags/%E6%9D%82%E8%B0%88/"/>
    
    <category term="美国个人支票" scheme="http://www.lights8080.com/tags/%E7%BE%8E%E5%9B%BD%E4%B8%AA%E4%BA%BA%E6%94%AF%E7%A5%A8/"/>
    
  </entry>
  
  <entry>
    <title>ELK-实践（架构选择&amp;部署说明）</title>
    <link href="http://www.lights8080.com/2021/05/10/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E6%9E%B6%E6%9E%84%E9%80%89%E6%8B%A9&amp;%E9%83%A8%E7%BD%B2%E8%AF%B4%E6%98%8E%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/05/10/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E6%9E%B6%E6%9E%84%E9%80%89%E6%8B%A9&amp;%E9%83%A8%E7%BD%B2%E8%AF%B4%E6%98%8E%EF%BC%89/</id>
    <published>2021-05-09T16:00:00.000Z</published>
    <updated>2021-06-07T06:07:28.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍业务规模和架构选择，以及部署说明。<br>基于7.11版本。</p></blockquote><span id="more"></span><h2 id="业务规模"><a href="#业务规模" class="headerlink" title="业务规模"></a>业务规模</h2><p>业务每天查询量在千万级，采集数据的规模上亿（后续会更大）。单台Logstash，数据延迟并不大，肉眼可见的Logstash的数据处理能力<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/lmWxyk.jpg" alt="Logstash监控"></p><h2 id="架构选择"><a href="#架构选择" class="headerlink" title="架构选择"></a>架构选择</h2><p>ELK架构有很多种，这里简单列出常用的几个：</p><ul><li>架构1（最为简单）<br>Logstash -&gt; Elasticsearch -&gt; Kibana</li><li>架构2（使用Beats作为日志收集器）<br>Beats -&gt; Logstash -&gt; Elasticsearch -&gt; Kibana</li><li>架构3（引入消息队列）<br>Beats -&gt; Logstash -&gt; Kafka -&gt; Logstash -&gt; Elasticsearch -&gt; Kibana</li></ul><p>其中架构3可能是被大家积极推荐和最为认可的理想架构。优点是消息队列可以把数据缓存起来避免数据丢失，可以抵挡浪涌削峰填谷，保护下游Logstash。适用于日志规模比较庞大的场景。</p><p>但我的实践中采用的架构2，理由如下：</p><ul><li>消除不必要的复杂性，较低成本</li><li>关于数据丢失，Filebeat至少投递一次和Logstash持久队列可以解决这个问题</li><li>日志规模比较大的情况，可以水平扩展Logstash节点，一组Logstash之间实现负载</li><li>实践Logstash处理能力很强</li></ul><p><img src="https://www.elastic.co/guide/en/logstash/7.11/static/images/deploy3.png" alt="架构2"></p><h2 id="部署说明-amp-实践配置"><a href="#部署说明-amp-实践配置" class="headerlink" title="部署说明&amp;实践配置"></a>部署说明&amp;实践配置</h2><p>介绍服务器环境配置，以及Elasticsearch、Kibana、Logstash、Filebeat的部署和配置参考。</p><ul><li>logstash-7.11.2/config/lights.conf</li><li>filebeat-7.11.2/inputs.d/lights.yml<br>关于业务的这两个配置，不理解的请私信或留言吧</li></ul><h4 id="新建用户和修改文件夹权限"><a href="#新建用户和修改文件夹权限" class="headerlink" title="新建用户和修改文件夹权限"></a>新建用户和修改文件夹权限</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建用户</span></span><br><span class="line">$ groupadd elk</span><br><span class="line">$ useradd -m -d /home/elk -s /bin/bash -g elk elk</span><br><span class="line"><span class="comment"># 修改文件夹所属组</span></span><br><span class="line">$ chown -R elk:elk /opt/elk</span><br><span class="line">$ chown -R elk:elk /data/elk</span><br></pre></td></tr></table></figure><h4 id="修改系统配置"><a href="#修改系统配置" class="headerlink" title="修改系统配置"></a>修改系统配置</h4><ul><li><p>vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure></li><li><p>vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elk soft memlock unlimited</span><br><span class="line">elk hard memlock unlimited</span><br></pre></td></tr></table></figure></li></ul><h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><ul><li><p>vim bin/elasticsearch</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/elk/elasticsearch-7.11.2/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></li><li><p>vim config/jvm.options</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms8g</span><br><span class="line">-Xmx8g</span><br></pre></td></tr></table></figure></li><li><p>vim config/elasticsearch.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/data/elk/elasticsearch/data</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/data/elk/elasticsearch/logs</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="string">&quot;10.88.2.1&quot;</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;10.88.2.1&quot;</span>]</span><br><span class="line"><span class="comment">#discovery.type: single-node</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;10.88.2.1&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ sh ./bin/elasticsearch -d -p es.pid</span><br><span class="line"><span class="comment"># 初始化内置用户</span></span><br><span class="line">$ bin/elasticsearch-setup-passwords auto</span><br></pre></td></tr></table></figure></li></ul><h4 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h4><ul><li><p>vim config/kibana.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">&quot;elk-1&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibana_system&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;xxxxxxx&quot;</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br><span class="line"><span class="attr">xpack.reporting.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="attr">xpack.security.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="attr">xpack.encryptedSavedObjects.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup sh ./bin/kibana &gt;kibana.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">netstat -napl|grep 5601</span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line"><span class="built_in">kill</span> &lt;port&gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h4><ul><li><p>vim config/jvm.options</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms4g</span><br><span class="line">-Xmx4g</span><br></pre></td></tr></table></figure></li><li><p>vim config/logstash.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pipeline.workers:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">queue.type:</span> <span class="string">persisted</span></span><br></pre></td></tr></table></figure></li><li><p>vim config/lights.conf</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略，请参考实践配置</span></span><br></pre></td></tr></table></figure><ul><li>命令<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试配置</span></span><br><span class="line">$ ./bin/logstash -f config/lights.conf --config.test_and_exit</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup ./bin/logstash -f config/lights.conf --config.reload.automatic &gt; logstash.log &amp;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h4><ul><li><p>vim filebeat.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.config.inputs:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/inputs.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">reload.period:</span> <span class="string">10s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.88.2.1:5044&quot;</span>]</span><br></pre></td></tr></table></figure></li><li><p>vim inputs.d/lights.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略，请参考实践配置</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup ./filebeat -e &gt;filebeat.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Metricbeat"><a href="#Metricbeat" class="headerlink" title="Metricbeat"></a>Metricbeat</h4><ul><li><p>vim metricbeat.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">metricbeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">index.codec:</span> <span class="string">best_compression</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.kibana:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;10.88.2.1:5601&quot;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.88.2.1:9200&quot;</span>]</span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_host_metadata:</span> <span class="string">~</span></span><br></pre></td></tr></table></figure></li><li><p>vim modules.d/elasticsearch-xpack.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">xpack.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;password&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启elasticsearch模块</span></span><br><span class="line">$ ./metricbeat modules <span class="built_in">enable</span> elasticsearch-xpack</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup ./metricbeat -e &gt;metricbeat.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍业务规模和架构选择，以及部署说明。&lt;br&gt;基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Beats-Filebeat命令&amp;配置说明</title>
    <link href="http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E5%91%BD%E4%BB%A4&amp;%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/"/>
    <id>http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E5%91%BD%E4%BB%A4&amp;%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/</id>
    <published>2021-04-28T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:18.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍Filebeat命令、配置以及最佳实战。<br> 基于7.11版本。</p></blockquote><span id="more"></span><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><ul><li>export：导出配置到标准输出（configuration, index template, ILM policy, dashboard）</li><li>keystore：管理秘钥仓库</li><li>modules：管理模块配置</li><li>run：运行Filebeat。不知道命令的情况下，默认使用此命令<ul><li>–modules MODULE_LIST：指定运行的模块</li></ul></li><li>setup：一次性初始化环境。包括索引模板，ILM政策，写别名，Kibana仪表盘等<ul><li>–dashboards：设置Kibana仪表盘，需配置连接Kibana信息</li><li>–pipelines：设置Elasticsearch的ingest pipelines</li><li>-e：发送输出到标准错误而不是syslog</li><li>–index-management：设置与Elasticsearch索引管理相关的组件（template, ILM policy, and write alias）</li></ul></li><li>test：测试配置文件</li></ul><p>全局标记</p><ul><li>-E, –E “SETTING_NAME=VALUE”：覆盖指定的配置</li><li>-M, –M “VAR_NAME=VALUE”：覆盖默认的模块配置</li><li>-c, –c FILE：指定Filebeat的配置文件</li><li>-f：指定管道配置文件</li><li>-d, –d SELECTORS：调试选择器，”*”：开启所有组件的调试，”publish”：开启调试”publish“相关信息</li><li>-e, –e：日志发送到stderr并禁用syslog文件输出</li><li>–path.config：设置配置文件路径</li></ul><p>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 一次性设置Elasticsearch索引和Kibana仪表板，-e：发送输出到标准错误而不是syslog</span></span><br><span class="line">./filebeat setup -e</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用要运行的模块</span></span><br><span class="line">./filebeat modules enable system</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">sudo chown root filebeat.yml </span><br><span class="line">sudo ./filebeat -c filebeat.yml -e</span><br></pre></td></tr></table></figure><h2 id="配置说明-filebeat-yml"><a href="#配置说明-filebeat-yml" class="headerlink" title="配置说明 filebeat.yml"></a>配置说明 filebeat.yml</h2><ul><li>project paths：项目路径</li><li>general settings：配置包括Global、General</li><li>config file loading：允许外部加载inputs和modules配置</li><li>modules：一种开始处理常见日志格式的快速方法</li><li>inputs：指定Filebeat查找和处理的数据</li><li>output：指定输出。如：Logstash、Elasticsearch、Kafka</li><li>Processors：过滤和增强导出的数据</li><li>internal queue：存储事件的内部缓冲队列（内存和磁盘），负责缓冲输入事件并按批次发送到输出。</li><li>load balancing：配置输出的负载均衡</li><li>logging：Filebeat日志输出选项</li><li>http endpoint：Filebeat通过端点查看内部指标</li><li>autodiscover：容器运行时，自动发现配置，移动目标的监视系统</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### project Paths</span></span><br><span class="line"><span class="comment"># Filebeat主目录，默认安装路径</span></span><br><span class="line"><span class="attr">path.home:</span> </span><br><span class="line"><span class="attr">path.config:</span> <span class="string">$&#123;path.home&#125;</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">$&#123;path.home&#125;/data</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">$&#123;path.home&#125;/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Global Filebeat configuration options</span></span><br><span class="line"><span class="comment"># 注册表的根路径，默认$&#123;path.data&#125;/registry</span></span><br><span class="line"><span class="attr">filebeat.registry.path:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">filebeat.registry.file_permissions:</span> <span class="number">0600</span></span><br><span class="line"><span class="comment"># 控制何时将注册表项写入磁盘(刷新)的超时值</span></span><br><span class="line"><span class="attr">filebeat.registry.flush:</span> <span class="string">0s</span></span><br><span class="line"><span class="comment"># Filebeat 在关闭之前等待发布者完成发送事件的关闭时间</span></span><br><span class="line"><span class="attr">filebeat.shutdown_timeout:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### General configuration options</span></span><br><span class="line"><span class="comment"># Beat的名字，默认使用主机名</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="comment"># 标记列表，方便Kibana或Logstash过滤，如服务层，集群名等</span></span><br><span class="line"><span class="attr">tags:</span> [<span class="string">&quot;service-X&quot;</span>, <span class="string">&quot;web-tier&quot;</span>]</span><br><span class="line"><span class="comment"># 属性中添加附加信息的可选字段，如环境信息</span></span><br><span class="line"><span class="attr">fields:</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">staging</span></span><br><span class="line">  <span class="attr">service_name:</span> <span class="string">service-X</span></span><br><span class="line"><span class="comment"># 将自定义字段作为顶级字段存储到到输出文档中，默认false</span></span><br><span class="line"><span class="attr">fields_under_root:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Processors configuration</span></span><br><span class="line"><span class="comment"># 定义模块的处理器，删除所有DEBUG消息</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_event:</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="attr">regexp:</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;^DBG:&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Logging</span></span><br><span class="line"><span class="attr">logging.level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">logging.to_files:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">logging.files:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/var/log/filebeat</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="comment"># 日志文件最大大小，默认10M</span></span><br><span class="line">  <span class="attr">rotateeverybytes:</span> <span class="number">10485760</span></span><br><span class="line">  <span class="comment"># 日志滚动删除旧文件，默认7</span></span><br><span class="line">  <span class="attr">keepfiles:</span> <span class="number">7</span></span><br><span class="line">  <span class="comment"># 日志文件滚动周期，默认禁用</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">24h</span></span><br><span class="line">  <span class="comment"># 标准错误记录到日志文件中</span></span><br><span class="line">  <span class="attr">redirect_stderr:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 定期记录内部发生变化的指标，默认开启</span></span><br><span class="line"><span class="attr">logging.metrics.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 记录内部指标的时间</span></span><br><span class="line"><span class="attr">logging.metrics.period:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 外部配置</span></span><br><span class="line"><span class="attr">filebeat.config.inputs:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 要检查的更改文件路径</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">configs/*.yml</span></span><br><span class="line">  <span class="comment"># 开启配置动态加载</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 指定检查文件更改的频率</span></span><br><span class="line">  <span class="attr">reload.period:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 日志输入</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/var/log/wifi.log&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/var/log/apache2/*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/var/log/*/*.log&quot;</span></span><br><span class="line">  <span class="comment"># 递归模式，默认false。For example: /foo/** expands to /foo, /foo/*, /foo/*/*, and so on</span></span><br><span class="line">  <span class="attr">recursive_glob.enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 文件编码</span></span><br><span class="line">  <span class="attr">encoding:</span> <span class="string">plain</span></span><br><span class="line">  <span class="comment"># 设置标记文件的位置</span></span><br><span class="line">  <span class="attr">file_identity.inode_marker.path:</span> <span class="string">/logs/.filebeat-marker</span></span><br><span class="line">  <span class="comment"># 标记列表，方便Kibana或Logstash过滤</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;service-X&quot;</span>, <span class="string">&quot;web-tier&quot;</span>]</span><br><span class="line">  <span class="comment"># 属性中添加附加信息的可选字段</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">staging</span></span><br><span class="line">  <span class="comment"># 将自定义字段作为顶级字段存储到到输出文档中</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 包含的正则表达式列表，先于exclude_lines执行</span></span><br><span class="line">  <span class="attr">include_lines:</span> [<span class="string">&#x27;^ERR&#x27;</span>, <span class="string">&#x27;^WARN&#x27;</span>]</span><br><span class="line">  <span class="comment"># 排除的正则表达式列表</span></span><br><span class="line">  <span class="attr">exclude_lines:</span> [<span class="string">&#x27;^DBG&#x27;</span>]</span><br><span class="line">  <span class="comment"># 多行消息匹配,Java 堆栈跟踪的例子（https://www.elastic.co/guide/en/beats/filebeat/7.x/multiline-examples.html）</span></span><br><span class="line">  <span class="attr">multiline.type:</span> <span class="string">pattern</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^[[:space:]]+(at|\.&#123;3&#125;)[[:space:]]+\b|^Caused by:&#x27;</span></span><br><span class="line">  <span class="comment"># 否定模式，true：没有匹配的行作为事件行的连贯行；false：匹配的行作为事件行的连贯行。默认false。</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 连贯行组合事件行之前（before）还是之后（after）</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">  <span class="comment"># 每个收割机获取文件时使用的缓冲区大小</span></span><br><span class="line">  <span class="attr">harvester_buffer_size:</span> <span class="number">16384</span></span><br><span class="line">  <span class="comment"># 单个日志消息的最大字节数，超出部分丢弃（10M）</span></span><br><span class="line">  <span class="attr">max_bytes:</span> <span class="number">10485760</span></span><br><span class="line">  <span class="comment"># 排除文件</span></span><br><span class="line">  <span class="attr">exclude_files:</span> [<span class="string">&#x27;\.gz$&#x27;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="comment">##### Harvester closing options</span></span><br><span class="line">  <span class="comment"># 指定的时间段后关闭文件句柄，基于文件的修改，被扫描到后继续进行。建议设置一个大于最少更新频率的值，默认5分钟</span></span><br><span class="line">  <span class="attr">close_inactive:</span> <span class="string">5m</span></span><br><span class="line">  <span class="comment"># 重命名或移动文件时关闭收割机，默认关闭</span></span><br><span class="line">  <span class="attr">close_renamed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 删除文件时立马关闭收割机，当文件再次出现时被扫描到后继续进行，默认启用</span></span><br><span class="line">  <span class="attr">close_removed:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 收割机到达文件末尾时立刻关闭，默认禁用</span></span><br><span class="line">  <span class="attr">close_eof:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 指定时间后关闭，按照扫描频路再次开启新的收割机，默认禁用</span></span><br><span class="line">  <span class="attr">close_timeout:</span> <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">##### State options</span></span><br><span class="line">  <span class="comment"># 指定时间段后文件无更新，则清除注册表中的状态，默认0，表示禁用清除注册表。clean_inactive设置必须大于ignore_older + scan_frequency，否则可能导致不断的重新发送全部内容</span></span><br><span class="line">  <span class="attr">clean_inactive:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 重命名或移动的文件，注册表中的状态将被清除。默认开启</span></span><br><span class="line">  <span class="attr">clean_removed:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 扫描频率，默认10秒</span></span><br><span class="line">  <span class="attr">scan_frequency:</span> <span class="string">10s</span></span><br><span class="line">  <span class="comment"># 扫描顺序，默认禁用，可选值：modtime|filename。如果为此设置指定值，则可以使用scan.order配置文件是按升序还是降序进行扫描</span></span><br><span class="line">  <span class="attr">scan.sort:</span> </span><br><span class="line">  <span class="attr">scan.order:</span> <span class="string">asc|desc</span></span><br><span class="line">  <span class="comment"># Filebeat 将开始在每个文件的结尾而不是开始读取新文件，适用于Filebeat尚未处理的文件。如果已经运行过Filebeat并且文件的状态已经保留，则tail_files配置无效。</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 忽略在指定时间跨度之前修改的所有文件，依赖于文件的修改时间。默认0，不忽略任何文件。必须大于close_inactive</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 限制并行启动的收割机数量</span></span><br><span class="line">  <span class="attr">harvester_limit:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 根据文件的inode和设备id来区分文件</span></span><br><span class="line">  <span class="attr">file_identity.native:</span> <span class="string">~</span></span><br><span class="line">  <span class="comment"># 根据路径来区分文件</span></span><br><span class="line">  <span class="attr">file_identity.path:</span> <span class="string">~</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 日志输出</span></span><br><span class="line"><span class="attr">output.kafka:</span></span><br><span class="line">  <span class="comment"># kafka服务器</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;kafka1:9092&quot;</span>, <span class="string">&quot;kafka2:9092&quot;</span>, <span class="string">&quot;kafka3:9092&quot;</span>]</span><br><span class="line">  <span class="comment"># 动态设置topic</span></span><br><span class="line">  <span class="attr">topic:</span> <span class="string">&#x27;<span class="template-variable">%&#123;[fields.log_topic]&#125;</span>&#x27;</span></span><br><span class="line">  <span class="comment"># 事件将仅发布到可用分区</span></span><br><span class="line">  <span class="attr">partition.round_robin:</span></span><br><span class="line">    <span class="attr">reachable_only:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># ACK可靠性级别，默认1。0 = no response，1 = wait for local commit，-1 = wait for all replica to commit</span></span><br><span class="line">  <span class="attr">required_acks:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># gzip压缩级别，0禁用压缩</span></span><br><span class="line">  <span class="attr">compression:</span> <span class="string">gzip</span></span><br><span class="line">  <span class="attr">compression_level:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># 消息的最大字节数</span></span><br><span class="line">  <span class="attr">max_message_bytes:</span> <span class="number">1000000</span></span><br><span class="line"><span class="comment"># 负载均衡的Logstash</span></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;localhost:5044&quot;</span>, <span class="string">&quot;localhost:5045&quot;</span>]</span><br><span class="line">  <span class="attr">loadbalance:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">worker:</span> <span class="number">2</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">### Internal queue</span></span><br><span class="line"><span class="comment"># 用于缓冲要发布的事件的内部队列配置。默认mem（内存队列）</span></span><br><span class="line"><span class="attr">queue.mem:</span></span><br><span class="line">  <span class="comment"># 内存队列的最大缓冲事件数</span></span><br><span class="line">  <span class="attr">events:</span> <span class="number">4096</span></span><br><span class="line">  <span class="comment"># 发布所需的最小事件数，设置为0则发布事件直接输出使用，无需等待</span></span><br><span class="line">  <span class="attr">flush.min_events:</span> <span class="number">2048</span></span><br><span class="line">  <span class="comment"># 达到flush.min_events的最大等待事件，设置为0则无需等待</span></span><br><span class="line">  <span class="attr">flush.timeout:</span> <span class="string">1s</span></span><br><span class="line"><span class="attr">queue.disk:</span></span><br><span class="line">  <span class="comment"># 启用磁盘队列，指定最大大小既使用空间</span></span><br><span class="line">  <span class="attr">max_size:</span> <span class="string">10GB</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.data&#125;/diskqueue</span></span><br><span class="line">  <span class="comment"># 队列文件以段的形式保存，每个段包含一些待发送到输出的事件，所有事件发送后删除</span></span><br><span class="line">  <span class="attr">segment_size:</span> <span class="string">max_size</span> <span class="string">/</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># 当事件等待输出时，从磁盘读取到内存中的事件数。调高此值可以提高输出速度，但是会占用更多内存</span></span><br><span class="line">  <span class="attr">read_ahead:</span> <span class="number">512</span></span><br><span class="line">  <span class="comment"># 队列等待事件写入磁盘时可以存储到内存中的事件数</span></span><br><span class="line">  <span class="attr">write_ahead:</span> <span class="number">2048</span></span><br><span class="line">  <span class="comment"># 磁盘错误导致的队列操作失败，重试间隔时间</span></span><br><span class="line">  <span class="attr">retry_interval:</span> <span class="string">1s</span></span><br><span class="line">  <span class="comment"># 多个连续的写入磁盘错误，队列将重试间隔增加2倍，最大间隔时间</span></span><br><span class="line">  <span class="attr">max_retry_interval:</span> <span class="string">30s</span></span><br><span class="line"><span class="attr">queue.spool:</span></span><br></pre></td></tr></table></figure><h2 id="最佳实践调优"><a href="#最佳实践调优" class="headerlink" title="最佳实践调优"></a>最佳实践调优</h2><ul><li><p>文件内容变更延迟发送事件调优<br>默认基于内存缓冲事件，最晚需要11s才会发布事件到输出。<br><code>filebeat.inputs.type:log.scan_frequency: 10s</code>：文件的扫描频率<br><code>queue.mem.flush.timeout: 1s</code>：缓冲事件的超时时间<br><code>queue.mem.flush.min_events: 2048</code>：超时时间内发布事件所需的最小缓冲数</p></li><li><p>测试时编辑文件导致整个文件内容重新发送<br>不要用vim修改，使用<code>echo &quot;xxx&quot; &gt;&gt; log_file</code></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍Filebeat命令、配置以及最佳实战。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Filebeat" scheme="http://www.lights8080.com/tags/Filebeat/"/>
    
  </entry>
  
  <entry>
    <title>Kibana-介绍</title>
    <link href="http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Kibana-%E4%BB%8B%E7%BB%8D/"/>
    <id>http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Kibana-%E4%BB%8B%E7%BB%8D/</id>
    <published>2021-04-28T16:00:00.000Z</published>
    <updated>2021-06-07T01:58:36.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍Kibana的侧边栏、面板类型、配置说明等。<br> 基于7.11版本。</p></blockquote><span id="more"></span><h1 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h1><blockquote><p>Kibana是一个开源分析和可视化平台，旨在与Elasticsearch协同工作。您使用Kibana搜索，查看和与存储在Elasticsearch索引中的数据进行交互。您可以轻松执行高级数据分析，并在各种图表，表格和地图中可视化您的数据。<br><a href="https://www.elastic.co/guide/en/kibana/7.11/index.html">https://www.elastic.co/guide/en/kibana/7.11/index.html</a></p></blockquote><h2 id="侧边栏"><a href="#侧边栏" class="headerlink" title="侧边栏"></a>侧边栏</h2><ul><li>Discover（数据探索）：搜索、过滤和展示所选索引模型（Index Pattern）文档数据</li><li>Visualize（可视化）：为数据创建可视化控件</li><li>Dashboard（仪表盘）：展示保存的可视化结果集合</li><li>Canvas（画布）：非常自由灵活对数据进行可视化布局与展现</li><li>Maps（地图）：已地图的方式展示聚合信息</li><li>Machine Learning（机器学习）</li><li>Infrastructure（基础设施监控）：通过metricbeat监控基础服务。如：redis、rocketmq</li><li>Metrics（度量应用）：探索整个生态系统中有关系统和服务的指标</li><li>Logs（日志）：实时跟踪相关的日志数据；提供了一个紧凑的，类似控制台的显示器。可以实时日志拖尾</li><li>APM（Application Performance Monitoring-应用程序性能监视）：业务跟踪及监控。</li><li>Uptime（正常运行时间）：监控应用程序和服务的可用性问题；通过HTTP/S，TCP和ICMP监控网络端点的状态</li><li>SIEM（Security Information &amp; Event Management-安全信息与事件管理）：安全分析师的高度交互式工作区</li><li>Dev Tools（开发工具）：包括控制台、查询分析和聚合</li><li>Stack Monitoring（ELK监控）：可视化监控数据</li><li>Management（Kibana管理）：包括索引模式的初始设置和持续配置等</li></ul><h3 id="Dashboard（仪表板）"><a href="#Dashboard（仪表板）" class="headerlink" title="Dashboard（仪表板）"></a>Dashboard（仪表板）</h3><p>仪表板是用于分析数据的面板的集合。在仪表板上，您可以添加各种面板，可以重新排列并讲述关于数据的故事。</p><p>编辑仪表板：</p><ul><li>Add controls（添加控制器）</li><li>Add markdown（添加说明文档）</li><li>Arrange panels（面板排版）</li><li>Clone panels（克隆面板）</li><li>Customize time ranges（自定义时间范围）</li></ul><p>探索仪表板数据：</p><ul><li>Inspect elements（检查元素）：查看可视化和保存的搜索背后的数据和请求</li><li>Explore underlying data（探索面板底层数据）：可以在其中查看和过滤可视化面板中的数据，为了探索仪表板上面板的底层数据，Kibana打开了Discover，可视化的索引模式、筛选器、查询和时间范围将继续应用。仅适用于单个索引模式的面板</li></ul><p>自定义仪表板操作：</p><ul><li>Dashboard drilldowns（仪表盘深度探讨）：能够从另一个仪表板打开仪表板，带有时间范围、过滤器和其他参数，因此上下文保持不变。仪表板钻取可以帮助您从一个新的角度继续分析。</li><li>URL drilldowns（URL深度探讨）：能够从仪表板导航到内部或外部URL。目标URL可以是动态的，这取决于仪表板上下文或用户与面板的交互。</li></ul><p>共享仪表板：</p><ul><li>将代码嵌入网页中，必须具有Kibana访问权限才能查看嵌入式仪表板</li><li>直接链接到 Kibana 的控制面板</li><li>生成PDF/PNG报告</li></ul><h4 id="面板类型"><a href="#面板类型" class="headerlink" title="面板类型"></a>面板类型</h4><ul><li>Area（面积图）：使用面积图比较两个或多个类别随时间变化的趋势，并显示趋势的幅度。</li><li>Stacked Area（堆积面积图）：使用堆积面积图可视化部分-整体关系，并显示每个类别对累积总数的贡献。</li><li>Bar（条形图）：使用条形图对大量类别的数据进行比较，也支持水平条形图。</li><li>Stacked bar（堆积条形图）：使用堆叠的条形图可以比较分类值级别之间的数值。</li><li>Line（折线图）：使用折线图可以直观地显示一系列值，发现一段时间内的趋势并预测未来值。</li><li>Pie（饼图）：使用饼图显示多个类别之间的比较，说明一个类别相对于其他类别的优势，并显示百分比或比例数据。</li><li>Donut（甜甜圈图）：与饼形图相似，但删除了中心圆。当您想一次显示多个统计信息时，请使用甜甜圈图。</li><li>Tree map（树图）：将数据的不同部分关联到整体，使用树图可以有效利用空间来显示每个类别的总计百分比。</li><li>Heat map（热图）：显示数据的图形表示形式，其中各个值由颜色表示。当数据集包含范畴数据时，使用热图。</li><li>Goal（进度图）：显示指标如何朝固定目标发展，使用目标显示目标进度状态的易于阅读的视觉效果。</li><li>Gauge（计量图）：沿比例尺显示数据，使用计量图来显示度量值与参考阈值的关系。</li><li>Metric（度量值）：显示聚合的单个数值。</li><li>Data table（表格数据）：以表格格式显示原始数据或聚合结果。</li><li>Tag cloud（标签云）：显示单词在出现的频率，使用标签云可以轻松生成大型文档的摘要。</li><li>Maps（地图）</li><li>Lens（透镜）：创建强大的数据可视化效果的最简单、最快捷的方法。可以将任意多的数据字段拖放到可视化构建窗格中。</li><li>TSVB（时间序列数据）：TSVB是时间序列数据可视化工具，充分利用Elasticsearch聚合框架的功能。可以组合无数个聚合来显示数据。支持：选择不同的数据展示方式、叠加注释事件等。</li><li>Timelion（时间序列数据）：时间序列数据可视化工具，可以在单个可视化文件中组合独立的数据源。在7.0及更高版本中，不建议使用Timelion应用。</li><li>Vega（自定义可视化）：使用Vega和Vega-Lite构建自定义可视化，并由一个或多个数据源支持。支持：使用嵌套或父/子映射的聚合、没有索引模式的聚合、自定义时间过滤器查询、复杂的计算、从_source而不是聚合中提取数据等。</li><li>Controls（控制器）：可以实时过滤面板上的数据，支持选择列表和范围滑杆</li><li>Markdown（文本编辑器）：当您要将上下文（例如重要信息，说明和图像）添加到仪表板上的其他面板时，请使用Markdown。</li></ul><h3 id="Alerts-and-Actions（监控警报）"><a href="#Alerts-and-Actions（监控警报）" class="headerlink" title="Alerts and Actions（监控警报）"></a>Alerts and Actions（监控警报）</h3><ul><li>General alert details（警报详细信息）：<ul><li>Name：警报名称，显示在警报列表，帮助识别和查询警报</li><li>Tags：警报标签列表，显示在警报列表，有助于查询和组织警报</li><li>Check every：检查警报条件的频率</li><li>Notify every：限制重复报警的频率</li></ul></li><li>Alert type and conditions（警报类型和条件）：选择不同的警报类型不同的条件表达形式。<ul><li>Index threshold：索引阈值警报类型</li></ul></li><li>Action type and action details（动作类型和详细信息）：每个操作都必须指定一个连接器实例。<ul><li>Index：Index data into Elasticsearch</li><li>Email：Send email from your server</li><li>Server log：Add a message to a Kibana log</li><li>Webhook：Send a request to a web service</li></ul></li></ul><h3 id="Graph（图形分析）"><a href="#Graph（图形分析）" class="headerlink" title="Graph（图形分析）"></a>Graph（图形分析）</h3><p>图形分析功能使您能够发现 Elasticsearch 索引中的项目是如何相关的。您可以研究索引词汇之间的连接，并查看哪些连接最有意义。这在各种应用程序中都很有用，从欺诈检测到推荐引擎。</p><p>例如，图形浏览可以帮助您发现黑客所针对的网站漏洞，从而可以加固您的网站。或者，您可以向电子商务客户提供基于图的个性化推荐。</p><p>图形分析特性为 Kibana 提供了一个简单但强大的图形探索 API 和一个交互式图形可视化工具。两者都可以在现有的 Elasticsearch 索引中使用ー你不需要存储任何额外的数据来使用这些特性。</p><h2 id="kibana-yml"><a href="#kibana-yml" class="headerlink" title="kibana.yml"></a>kibana.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">&quot;elk-1&quot;</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;http://your_elasticsearch_host:9200&quot;</span>]</span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibana_system&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;xxxxxxxxxxxxxxx&quot;</span></span><br><span class="line"><span class="comment"># 防止会话在重启时失效</span></span><br><span class="line"><span class="attr">xpack.security.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="comment"># 防止挂起的报告在重新启动时失败</span></span><br><span class="line"><span class="attr">xpack.reporting.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br></pre></td></tr></table></figure><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="1-创建索引失败"><a href="#1-创建索引失败" class="headerlink" title="1. 创建索引失败"></a>1. 创建索引失败</h3><p>错误信息：POST 403 (forbidden) on create index pattern<br>解决办法：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT _settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;blocks&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;read_only_allow_delete&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍Kibana的侧边栏、面板类型、配置说明等。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Kibana" scheme="http://www.lights8080.com/tags/Kibana/"/>
    
  </entry>
  
  <entry>
    <title>人格分裂</title>
    <link href="http://www.lights8080.com/2021/04/28/%E6%9D%82%E8%B0%88/%E4%BA%BA%E6%A0%BC%E5%88%86%E8%A3%82/"/>
    <id>http://www.lights8080.com/2021/04/28/%E6%9D%82%E8%B0%88/%E4%BA%BA%E6%A0%BC%E5%88%86%E8%A3%82/</id>
    <published>2021-04-27T16:00:00.000Z</published>
    <updated>2021-06-07T09:14:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>人格分裂和癌细胞一样，是人类无法驾驭的更强大的存在</p><span id="more"></span><p>癌细胞为什么是人类无法驾驭的更强大的存在呢？<br>生命的存在是因为细胞分裂，正常的细胞分裂，都会磨损真核细胞染色体末端的端粒酶，端粒酶没有了就无法继续分裂。<br>但是癌细胞却有修复端粒酶的能力，可以无限繁殖下去，这正是永生的破解密码。</p><p>人格分裂/多重人格被定义为一种心理疾病，一个生命个体上存在两种或以上不同身份和人格状态。直白点说就是一个身体里住着好几个灵魂。</p><p>把这灵魂分为两类：<br>受我们意愿所控制的灵魂定义为主灵魂，那些不受我们意愿控制的灵魂为独立灵魂。</p><p>人的一生中应该都会遇到许多次的轻微的人格分裂时刻。<br>比如当你失恋了，你满脑子都是失恋的情景，你明明不想让自己想那个情景，但是就是不受控制的在脑子里闪现。<br>这个失恋的情景就是独立灵魂，不受控制的让你去想。</p><p>当大脑进入这样的状态时，有了不受控制的独立意识，我认为就是轻微的人格分裂了。<br>这种状态下，大脑非常疲惫（就好像汽车一直开在160km/h，又无法刹车），无法集中精力做事，甚至会影响你的身体状态。</p><p>在这种状态下，喜欢抽烟喝酒，想用外界的干预来抑制或麻醉独立灵魂。</p><p>人格分裂对于生命体来说无疑是非常痛苦的，但是对于人脑组织或灵魂来说，是不是进化了呢？</p><p>灵魂是不是更高维度的存在，降维寄宿到人的身体里。<br>想象一下灵魂出窍，其实不是生命体有灵魂，而是灵魂寄宿在生命体当中，人格分裂的人，是多个灵魂共同寄宿在同一个生命体中，生命结束的时候灵魂就会飞走。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;人格分裂和癌细胞一样，是人类无法驾驭的更强大的存在&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈" scheme="http://www.lights8080.com/categories/%E6%9D%82%E8%B0%88/"/>
    
    
    <category term="杂谈" scheme="http://www.lights8080.com/tags/%E6%9D%82%E8%B0%88/"/>
    
  </entry>
  
  <entry>
    <title>Beats-Filebeat介绍</title>
    <link href="http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E4%BB%8B%E7%BB%8D/"/>
    <id>http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E4%BB%8B%E7%BB%8D/</id>
    <published>2021-04-27T16:00:00.000Z</published>
    <updated>2021-06-08T02:23:20.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Filebeat介绍，包括工作方式、模块、如何避免数据重复、处理器的速查表。<br> 基于7.11版本。</p></blockquote><span id="more"></span><p>Beats是一款轻量级数据采集器，你可以将它作为代理程序安装在你的服务器上，然后将操作数据发送到 Elasticsearch。可以直接发送数据到 Elasticsearch 或者通过 Logstash，在那里你可以进一步处理和增强数据。</p><ul><li>Filebeat（日志文件）</li><li>Metricbeat（指标）</li><li>Heartbeat（可用性监控）</li><li>Functionbeat（函数计算采集器）</li></ul><h2 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h2><blockquote><p>Filebeat是用于转发集中日志数据的传输工具。作为服务器上的代理安装，收集日志事件，并将它们转发到Elasticsearch或Logstash。<br><a href="https://www.elastic.co/guide/en/beats/filebeat/7.11/index.html">https://www.elastic.co/guide/en/beats/filebeat/7.11/index.html</a></p></blockquote><h3 id="工作方式"><a href="#工作方式" class="headerlink" title="工作方式"></a>工作方式</h3><p>当启动Filebeat，会根据显示指定的日志数据启动一个或多个输入，每个日志文件都会启动一个收割机（harvester）。每个收割机会读取日志的最新内容，并将日志数据发送到libbeat，libbeat汇总事件并发送到输出。</p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/uPic/StbFBm.jpg" alt="IMAGE"/><p>Filebeat由两个主要部分组成：inputs和harvesters。它们一起工作以尾部文件将事件数据发送到指定的输出。</p><p>收割机（harvesters）：一个收割机负责读取单个文件的内容。收割机逐行读取每个文件并将内容发送到输出。每个文件启动一个收割机负责打开和关闭文件，收割机运行时文件描述符保持打开状态。如果文件被删除或重命名，Filebeat将继续读取该文件，副作用是磁盘上的空间将保留到收割机关闭为止。</p><p>输入（inputs）：一个输入负责管理收割机并查找所有可读取的资源。日志类型输入检查每个文件，以查看收割机是否需要启动，是否已经运行，或是否需要忽略该文件。自收割机关闭之后，如果文件大小有更改才会获取新行。</p><p>Filebeat保持每个文件的状态，并经常将状态刷新到磁盘的注册表文件。该状态用于记录收割机正在读取的最后一个偏移量并确保发送所有的日志行。如果输出不可达，则Filebeat会保持跟踪发送的最后几行，并在输出可用时继续读取文件。Filebeat运行时状态信息也会保持在内存中，当Filebeat重启时，将使用注册文件中的数据重新构建状态，并且在最后一个已知位置继续每个收割机。</p><p>对于每个输入，Filebeat会保持每个文件的状态。由于文件可以重命名和移动，因此文件名和路径不能标识一个文件。Filebeat将存储每个文件的唯一标识符以检测文件是否以前被获取过。</p><p>Filebeat保证事件将至少一次传递到输出，并且不会丢失数据。因为他在注册文件中存储了每个事件的传递状态。如果输出被阻止或未确认所有事件的情况下，Filebeat将继续尝试发送事件，直到输出确认接收为止。如果Filebeat在发送事件的过程中关闭，则不会等待输出确认所有的事件。重启Filebeat时，将再次发送关闭之前输出未确认的所有事件。这样可以确保每个事件至少发送一次，但是有可能会重复发送。</p><h3 id="如何避免Elasticsearch数据重复"><a href="#如何避免Elasticsearch数据重复" class="headerlink" title="如何避免Elasticsearch数据重复"></a>如何避免Elasticsearch数据重复</h3><p>由于Beats框架确保至少一次交付，又由于Elasticsearch的文档ID通常是接受到数据后才设置的，因此重复事件被索引为新文档。通过在建立索引期间设置，则Elasticsearch会覆盖现有文档而不是新创建一个新文档。</p><ol><li>在Beats中设置文档ID。</li><li>在Logstash管道设置文档ID。</li></ol><h3 id="填充地理位置信息"><a href="#填充地理位置信息" class="headerlink" title="填充地理位置信息"></a>填充地理位置信息</h3><p>基于IP地址填充地理位置信息。然后可以使用此信息来可视化IP地址在地图中的位置。</p><ol><li>Filebeat与Elasticsearch中的GoeIp处理器一起使用</li><li>Logstash中使用GeoIP过滤器</li></ol><h3 id="模块（Modules）"><a href="#模块（Modules）" class="headerlink" title="模块（Modules）"></a>模块（Modules）</h3><blockquote><p>Filebeat模块简化了常见的日志格式的收集，解析和可视化。每个Filebeat模块由一个或多个文件集组成，这些文件集包含摄取节点管道（ingest node pipelines），Elasticsearch模板，Filebeat输入配置和Kibana仪表板。</p></blockquote><ul><li>use ingest pipelines for parsing</li><li>use Logstash pipelines for parsing</li></ul><p>如Nginx日志，由一个或多个文件集组成（access和error）：</p><ul><li>Filebeat输入配置要查找的日志文件路径，还负责在需要时将多行事件缝合在一起。</li><li>Elasticsearch Ingest Node管道定义，用于解析日志行。</li><li>定义字段，为每个字段正确的配置到Elasticsearch。</li><li>Kibana仪表盘可视化日志文件</li></ul><h3 id="处理器（Processors）"><a href="#处理器（Processors）" class="headerlink" title="处理器（Processors）"></a>处理器（Processors）</h3><h4 id="过滤和增强数据的处理器"><a href="#过滤和增强数据的处理器" class="headerlink" title="过滤和增强数据的处理器"></a>过滤和增强数据的处理器</h4><p>如果只需要导出的数据的一部分或者需要增强导出数据。Filebeat提供了两个选项来过滤和增强导出的数据。</p><ol><li>可以为每个输入指定包含和排除的行或文件，需要为每个输入配置选项。（include_lines, exclude_lines, and exclude_files options）</li><li>定义处理器（Processor）可以的导出的所有数据进行全局处理。</li></ol><p>可以在配置中定义处理器，在发送到输出之前处理所有事件。libbeat提供的处理器分为：</p><ul><li>减少导出字段</li><li>增加元数据增强事件</li><li>执行其他处理和解码</li></ul><p>每个处理器都接收一个事件，对该事件应用已定义的操作，然后返回该事件。如果定义处理器列表，则将按照在Filebeat配置文件中定义的顺序执行它们。<br>执行顺序：event -&gt; processor 1 -&gt; event1 -&gt; processor 2 -&gt; event2 …</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">if:</span></span><br><span class="line">      <span class="string">&lt;condition&gt;</span></span><br><span class="line">    <span class="attr">then:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">    <span class="attr">else:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="string">...</span></span><br></pre></td></tr></table></figure><ul><li><p>add_docker_metadata<br>使用来自Docker容器的相关元数据注释每个事件。包括（Container ID、Name、Image、Labels）</p></li><li><p>add_fields<br>将其他字段添加到事件中</p></li><li><p>add_host_metadata<br>为事件添加主机信息</p></li><li><p>add_id<br>为事件生成唯一的ID</p></li><li><p>add_labels<br>将一组键值对添加到事件</p></li><li><p>add_locale<br>通过将机器的时区偏离UTC或时区名称来丰富每个事件</p></li><li><p>add_tags<br>将标签添加到标签列表中</p></li><li><p>convert<br>将事件中的字段转换为其他类型，例如将字符串转换为整数。</p></li><li><p>copy_fields<br>将一个字段复制到另一个字段。</p></li><li><p>decode_base64_field<br>指定要对base64进行解码的字段</p></li><li><p>dissect<br>解剖处理器使用定义的模式对传入的字符串进行标记</p></li><li><p>drop_event<br>如果满足相关条件，则drop_event处理器将丢弃整个事件。条件是强制性的，因为没有一个条件，所有事件都将被丢弃</p></li><li><p>drop_fields<br>指定在满足特定条件时要删除的字段，条件是可选的。@timestamp和type字段在列表中，也不能删除他们。</p></li><li><p>fingerprint<br>根据事件字段的指定子集生成事件的指纹。</p></li><li><p>include_fields<br>指定在满足特定条件时要导出的字段，条件是可选的。@timestamp和type字段，也始终将其导出。</p></li><li><p>rename<br>指定要重命名的字段的列表。</p></li><li><p>script<br>执行Javascript代码以处理事件。该处理器使用ECMAScript 5.1的纯Go实现，并且没有外部依赖性。</p></li><li><p>timestamp<br>时间戳处理器从字段解析时间戳。默认情况下，时间戳处理器将已解析的结果写入@timestamp字段。</p></li><li><p>truncate_fields<br>将字段截断为给定的大小。如果字段的大小小于限制，则该字段将保持不变。</p></li><li><p>urldecode<br>指定要从URL编码格式解码的字段列表</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Filebeat介绍，包括工作方式、模块、如何避免数据重复、处理器的速查表。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Filebeat" scheme="http://www.lights8080.com/tags/Filebeat/"/>
    
  </entry>
  
  <entry>
    <title>ELK-加密通信的说明和配置教程</title>
    <link href="http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1%E7%9A%84%E8%AF%B4%E6%98%8E%E5%92%8C%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/"/>
    <id>http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1%E7%9A%84%E8%AF%B4%E6%98%8E%E5%92%8C%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/</id>
    <published>2021-04-27T16:00:00.000Z</published>
    <updated>2021-06-07T01:58:46.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍Elasticsearch节点之间的加密通信、浏览器与Kibana之间的加密通信、Kibana与Elasticsearch之间的加密通信、操作步骤和配置说明。<br>基于7.11。</p></blockquote><span id="more"></span><h2 id="1-Elasticsearch加密通信"><a href="#1-Elasticsearch加密通信" class="headerlink" title="1 Elasticsearch加密通信"></a>1 Elasticsearch加密通信</h2><p>Elastic Stack安全特性能够加密加密往返于Elasticsearch集群以及从其内部的通信。使用传输层安全性(TLS/SSL)保护连接的安全。<br>未启用加密的群集将以纯文本格式（包括密码）发送所有数据。如果启用了Elasticsearch安全功能，除非您具有试用许可证，否则必须配置SSL/TLS进行节点间通信。</p><h3 id="1-1-Elasticsearch节点之间的加密通信"><a href="#1-1-Elasticsearch节点之间的加密通信" class="headerlink" title="1.1 Elasticsearch节点之间的加密通信"></a>1.1 Elasticsearch节点之间的加密通信</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-transport">https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-transport</a></p><ul><li>Verify that the xpack.security.enabled setting is true.（启用安全功能）</li><li>Generate a private key and X.509 certificate.（生成私钥和X.509证书）</li><li>Configure each node to:<ul><li>Required: Enable TLS on the transport layer.（传输层启用TLS）</li><li>Recommended: Enable TLS on the HTTP layer.（HTTP层启用TLS）</li></ul></li></ul><h3 id="1-2-HTTP客户端的加密通信"><a href="#1-2-HTTP客户端的加密通信" class="headerlink" title="1.2 HTTP客户端的加密通信"></a>1.2 HTTP客户端的加密通信</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-http">https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-http</a></p><ul><li>Generate node certificates.（生成节点证书）</li><li>Enable TLS and specify the information required to access the node’s certificate.（启用TLS并指定节点证书）</li><li>Restart Elasticsearch.（重启Elasticsearch）</li></ul><h2 id="2-Kibana通信加密"><a href="#2-Kibana通信加密" class="headerlink" title="2 Kibana通信加密"></a>2 Kibana通信加密</h2><p>传输层安全安全协议(SSL)和传输层安全协议(TLS)为数据传输提供加密。虽然这些术语通常可以互换使用，但 Kibana 只支持 TLS，它取代了旧的 SSL 协议。<br>浏览器将流量发送到 Kibana，Kibana 将流量发送到 Elasticsearch，这些通信通道分别配置为使用 TLS。</p><h3 id="2-1-浏览器与Kibana之间的加密通信"><a href="#2-1-浏览器与Kibana之间的加密通信" class="headerlink" title="2.1 浏览器与Kibana之间的加密通信"></a>2.1 浏览器与Kibana之间的加密通信</h3><p><a href="https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-browser-kib">https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-browser-kib</a></p><ol><li>获得 Kibana 的服务器证书和私钥</li><li>配置 Kibana 以访问服务器证书和私钥</li><li>将 Kibana 配置为为入站连接启用 TLS</li><li>重启 Kibana</li></ol><h3 id="2-2-Kibana与Elasticsearch之间的加密通信"><a href="#2-2-Kibana与Elasticsearch之间的加密通信" class="headerlink" title="2.2 Kibana与Elasticsearch之间的加密通信"></a>2.2 Kibana与Elasticsearch之间的加密通信</h3><p><a href="https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-kib-es">https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-kib-es</a></p><ul><li>Enable TLS on the HTTP layer in Elasticsearch.（在Elasticsearch的HTTP层上启动TLS）</li><li>Obtain the certificate authority (CA) certificate chain for Elasticsearch.（获取Elasticsearch的证书颁发机构(CA)证书链）<ul><li>used the elasticsearch-certutil http command,include the CA certificate chain in PEM format.（使用elasticsearch-certutil http命令生成CA证书链）</li><li>extract the CA certificate.（通过PKCS#12文件提取CA证书链）</li></ul></li><li>Configure Kibana to trust the Elasticsearch CA certificate chain for the HTTP layer.（配置Kibana以信任HTTP层的Elasticsearch CA证书链）</li><li>Configure Kibana to enable TLS for outbound connections to Elasticsearch.（配置Kibana与Elasticsearch的连接启用TLS）</li></ul><h2 id="3-操作步骤"><a href="#3-操作步骤" class="headerlink" title="3 操作步骤"></a>3 操作步骤</h2><ol><li><p>操作命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入Elasticsearch目录</span></span><br><span class="line">cd /data/elk/elasticsearch-7.11.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建证书颁发机构：获得文件：elastic-stack-ca.p12</span></span><br><span class="line">./bin/elasticsearch-certutil ca</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为每个节点生成证书和私钥，获得文件：elastic-certificates.p12</span></span><br><span class="line">./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成专门用于加密HTTP客户端通信的证书，获得文件：elasticsearch-ssl-http.zip</span></span><br><span class="line">./bin/elasticsearch-certutil http</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压HTTP通信证书，获得文件：elasticsearch/http.p12和kibana/elasticsearch-ca.pem</span></span><br><span class="line">unzip elasticsearch-ssl-http.zip</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在每个Elasticsearch节点的配置目录中创建一个文件夹certs，放置安全证书</span></span><br><span class="line">mkdir /data/elk/elasticsearch-7.11.2/config/certs</span><br><span class="line">cp elastic-certificates.p12 config/certs</span><br><span class="line">cp elasticsearch/http.p12 config/certs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制HTTP通信证书到Kibana配置目录</span></span><br><span class="line">cp kibana/elasticsearch-ca.pem /data/elk/kibana-7.11.2/config</span><br></pre></td></tr></table></figure></li><li><p>生成加密HTTP客户端通信证书说明（./bin/elasticsearch-certutil http）<br>参考：<a href="https://lights8080.github.io/post/es-an-quan-security">https://lights8080.github.io/post/es-an-quan-security</a></p></li></ol><h2 id="4-参数配置"><a href="#4-参数配置" class="headerlink" title="4 参数配置"></a>4 参数配置</h2><ol><li><p>Elasticsearch<br>elasticsearch-7.11.2/config/elasticsearch.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在节点上启用Elasticsearch安全功能</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 节点间加密通信配置</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span> </span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span> </span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span> </span><br><span class="line"><span class="comment"># HTTP加密通信配置</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">&quot;certs/http.p12&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>Kibana<br>kibana-7.11.2/config/kibana.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置Kibana与Elasticsearch的连接启用TLS</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;https://127.0.0.1:9200&quot;</span>]</span><br><span class="line"><span class="comment"># 配置信任HTTP层的Elasticsearch CA证书链</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.certificateAuthorities:</span> [<span class="string">&quot;/data/elk/kibana-7.11.2/config/elasticsearch-ca.pem&quot;</span>]</span><br></pre></td></tr></table></figure></li><li><p>Logstash<br>logstash-7.11.2/config/logstash-sample.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;https://127.0.0.1:9200&quot;]</span><br><span class="line">            user =&gt; &quot;elastic&quot;</span><br><span class="line">            password =&gt; &quot;xxxxxx&quot;</span><br><span class="line">            cacert =&gt; &quot;/data/elk/elasticsearch-7.11.2/config/certs/elasticsearch-ca.pem&quot;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Metricbeat<br>metricbeat-7.11.2/modules.d/elasticsearch-xpack.yml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- module: elasticsearch</span><br><span class="line">  xpack.enabled: true</span><br><span class="line">  period: 10s</span><br><span class="line">  hosts: [&quot;https://127.0.0.1:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;xxxxxx&quot;</span><br><span class="line">  ssl.certificate_authorities: [&quot;/data/elk/elasticsearch-7.11.2/config/certs/elasticsearch-ca.pem&quot;]</span><br></pre></td></tr></table></figure></li><li><p>其他Elastic产品使用加密通信<br>略</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍Elasticsearch节点之间的加密通信、浏览器与Kibana之间的加密通信、Kibana与Elasticsearch之间的加密通信、操作步骤和配置说明。&lt;br&gt;基于7.11。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-安全特性（Security）</title>
    <link href="http://www.lights8080.com/2021/04/27/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%EF%BC%88Security%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/04/27/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%EF%BC%88Security%EF%BC%89/</id>
    <published>2021-04-26T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Elasticsearch安全特性，介绍加密通讯的基本原理、开启安全特性的操作步骤、如何生成节点证书、用户认证和相关概念等。<br> 基于7.11版本。</p></blockquote><span id="more"></span><h2 id="一、安全特性"><a href="#一、安全特性" class="headerlink" title="一、安全特性"></a>一、安全特性</h2><p>Elastic Stack安全功能使您可以轻松保护集群。</p><p>Elasticsearch集群保护方式：</p><ul><li>通过密码保护，基于角色的访问控制和IP过滤防止未经授权的访问。</li><li>使用SSL/TLS加密保留数据的完整性。</li><li>维护审计跟踪，知道谁在对集群进行操作</li></ul><p>Elasticsearch配置安全的简易步骤：</p><ol><li>集群内每个节点设置为<code>xpack.security.enabled: true</code></li><li>为节点间通信配置TLS/SSL【#加密通讯】</li><li>启动Elasticsearch</li><li>设置内置用户和密码（命令：<code>elasticsearch-setup-passwords auto</code>）</li><li>设置角色和用户，控制对Elasticsearch的访问</li><li>(可选)启用审计功能<code>xpack.security.audit.enabled: true</code>，并重启集群</li></ol><h3 id="1-加密通讯"><a href="#1-加密通讯" class="headerlink" title="1 加密通讯"></a>1 加密通讯</h3><blockquote><p>未启用加密的群集将以纯文本格式（包括密码）发送所有数据。如果启用了Elasticsearch安全功能，除非您具有试用许可证，否则必须配置SSL/TLS进行节点间通信。</p></blockquote><ul><li>Elasticsearch集群节点间通信使用SSL/TLS加密，保护节点安全有助于降低基于网络的攻击的风险</li><li>要求节点使用SSL证书添加到集群时进行身份验证，新节点的身份验证有助于防止流氓节点加入群集并通过复制接收数据</li></ul><p>Elasticsearch集群配置STL</p><ol><li>为每个Elasticsearch节点生成一个私钥和X.509证书【#1.3 生成节点证书】</li><li>在集群中配置每个节点，以使用其签名证书标识自己，并在传输层上启用TLS。还可以选择在HTTP层上启用TLS</li><li>配置Kibana以加密浏览器和Kibana服务器之间的通信，并通过HTTPS连接到Elasticsearch</li><li>配置其他Elastic产品使用加密通信</li></ol><h4 id="1-1-加密集群中节点之间的通信"><a href="#1-1-加密集群中节点之间的通信" class="headerlink" title="1.1 加密集群中节点之间的通信"></a>1.1 加密集群中节点之间的通信</h4><ol><li>生成节点证书【#1.3 生成节点证书】</li><li>启用TLS并制定访问节点证书所需要的信息<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span></span><br></pre></td></tr></table></figure></li><li>（可选）如果你用密码保护节点的证书，将密码添加到 Elasticsearch 密钥存储库</li><li>重启Elasticsearch</li></ol><h4 id="1-2-加密HTTP客户端通信"><a href="#1-2-加密HTTP客户端通信" class="headerlink" title="1.2 加密HTTP客户端通信"></a>1.2 加密HTTP客户端通信</h4><ol><li>生成HTTP证书【#1.3 生成节点证书】</li><li>启用TLS并制定访问节点证书所需要的信息<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">&quot;http.p12&quot;</span></span><br></pre></td></tr></table></figure></li><li>（可选）如果你用密码保护节点的证书，将密码添加到 Elasticsearch 密钥存储库</li><li>重启Elasticsearch</li></ol><h4 id="1-3-生成节点证书"><a href="#1-3-生成节点证书" class="headerlink" title="1.3 生成节点证书"></a>1.3 生成节点证书</h4><ol><li>（可选）为 Elasticsearch 集群创建一个证书颁发机构。</li></ol><p><code>./bin/elasticsearch-certutil ca</code><br>输出文件是一个PKCS#12密钥存储库，其中包含证书颁发机构的公共证书和用于签署节点证书的私钥。</p><ol start="2"><li><p>为集群中的每个节点生成证书和私钥<br>交互形式：<br><code>./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</code><br>命令形式：<br><code>./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 --dns localhost --ip 127.0.0.1,::1 --out config/certs/node-1.p12</code><br>输出是一个包含节点证书、节点密钥和CA证书的PKCS#12密钥存储库。</p></li><li><p>（可选）生成专门用于加密 HTTP 客户端通信的附加证书。</p></li></ol><p><code>./bin/elasticsearch-certutil http</code><br>命令步骤如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Do you wish to generate a Certificate Signing Request (CSR)? - 是否生成证书签名请求(CSR)?</span></span></span><br><span class="line">Generate a CSR? [y/N]N</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Do you have an existing Certificate Authority (CA) key-pair that you wish to use to sign your certificate? -是否有一个现有的证书颁发机构(CA)密钥对，您希望使用它来签署证书?</span></span></span><br><span class="line">Use an existing CA? [y/N]y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># What is the path to your CA? - 你的CA路径在哪里?</span></span></span><br><span class="line">CA Path: /data/elk/elasticsearch-7.11.2/elastic-stack-ca.p12</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># How long should your certificates be valid? - 您的证书应该多长时间有效?</span></span></span><br><span class="line">For how long should your certificate be valid? [5y] 3Y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Do you wish to generate one certificate per node? - 是否希望每个节点生成一个证书?</span></span></span><br><span class="line">Generate a certificate per node? [y/N]N</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Which hostnames will be used to connect to your nodes? - 哪些主机名将用于连接到您的节点?</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Enter all the hostnames that you need, one per line. - 输入需要的所有主机名，每行一个。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## When you are done, press &lt;ENTER&gt; once more to move on to the next step. - 完成后，再次按&lt;ENTER&gt;继续下一步。</span></span></span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]Y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Which IP addresses will be used to connect to your nodes? - 哪些IP地址将用于连接到您的节点?</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Enter all the IP addresses that you need, one per line.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span></span></span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]Y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Other certificate options - 其他证书选项</span></span></span><br><span class="line">Do you wish to change any of these options? [y/N]N</span><br><span class="line">输出是一个.zip 文件，包含 Elasticsearch 和 Kibana 各自的一个目录</span><br></pre></td></tr></table></figure><p>输出文件elasticsearch-ssl-http.zip</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/elasticsearch</span><br><span class="line">|_ README.txt</span><br><span class="line">|_ http.p12</span><br><span class="line">|_ sample-elasticsearch.yml</span><br><span class="line"></span><br><span class="line">/kibana</span><br><span class="line">|_ README.txt</span><br><span class="line">|_ elasticsearch-ca.pem</span><br><span class="line">|_ sample-kibana.yml</span><br></pre></td></tr></table></figure><ol start="4"><li>将节点证书复制到适当的位置</li></ol><ul><li>在每个Elasticsearch节点上的配置目录中创建文件夹certs。如：/home/es/config/certs。</li><li>在每个节点上，将创建的证书复制到certs目录（通常是一个.p12文件）</li><li>如果生成了HTTP证书，复制http.p12到certs目录</li><li>配置其他Elastic产品，将证书复制到相关目录</li></ul><h3 id="2-用户认证"><a href="#2-用户认证" class="headerlink" title="2 用户认证"></a>2 用户认证</h3><p>安全功能提供了基于角色的访问控制（RBAC）机制，该机制使您可以通过为角色分配特权并将角色分配给用户或组来授权用户。<br>安全功能还提供了基于属性的访问控制（ABAC）机制，使您可以使用属性来限制对搜索查询和聚合中文档的访问。</p><p>role-based access control (RBAC) </p><ul><li>Secured Resource（访问受限的资源）：索引，别名，文档，字段，用户和Elasticsearch群集本身都是受保护对象。</li><li>Privilege（特权）：对受保护的资源执行的一个或多个动作的命名组，如read是索引特权，代表所有启用读取已索引/存储的数据的操作。</li><li>Permissions（权限）：针对受保护资源的一组一个或多个特权，权限可以很容易地用语言来描述。</li><li>Role（角色）：一组命名的权限</li><li>User（用户）：经过身份验证的用户</li><li>Group（用户组）：用户所属的一个或多个组</li></ul><p>内置用户</p><ul><li>这些内置用户存储在指定的.security索引中，由Elasticsearch管理。</li><li>elasticsearch-setup-passwords工具是首次设置内置用户密码的最简单方法</li></ul><p>基于令牌的身份验证</p><ul><li>token-service：访问令牌（根据OAuth2规范生成访问令牌和刷新令牌）是短期令牌，默认情况下20分钟后过期。（Authorization: Bearer xxx）</li><li>api-key-service：API秘钥，默认情况下API密钥不会过期，创建时，可以指定到期时间和权限。（Authorization: ApiKey xxx）</li></ul><h2 id="二、相关概念"><a href="#二、相关概念" class="headerlink" title="二、相关概念"></a>二、相关概念</h2><ul><li>SSL（Secure Socket Layer)/TLS(Transport Layer Security）</li><li>数字证书：互联网通讯中标志通讯各方身份信息的一系列数据</li><li>X.509：是一种数字证书（Public Key Certificates）的格式标准，主要定义了证书中应该包含哪些内容。<ul><li>HTTPS依赖的TLS/SSL证书使用的就是使用的X.509格式。一个X.509 Certificate包含一个Public Key和一个身份信息（a hostname, or an organization, or an individual），它要么是被CA签发的要么是自签发的。</li></ul></li><li>CA（Certificate Authority）：颁发数字证书的权威机构，承担公钥体系中公钥的合法性检验的责任。</li><li>编码格式：用来存储和发送公钥/私钥、证书和其他数据的文件格式；分为DER和PEM<ul><li>DER（Distinguished Encoding Rules）：二进制不可读，常用于Windows系统</li><li>PEM（Privacy-Enhanced Mail）：内容是BASE64编码，常用于*NIX系统</li></ul></li><li>PKCS（Public Key Cryptography Standards）：公钥密码学标准<ul><li>PKCS#12：描述个人信息交换语法标准，通常用来存储Private Keys和Public Key Certificates（例如前面提到的X.509）的文件格式，使用基于密码的对称密钥进行保护。</li></ul></li></ul><h2 id="三、参考文档"><a href="#三、参考文档" class="headerlink" title="三、参考文档"></a>三、参考文档</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/secure-cluster.html">安全集群</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#configuring-tls">加密通讯</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Elasticsearch安全特性，介绍加密通讯的基本原理、开启安全特性的操作步骤、如何生成节点证书、用户认证和相关概念等。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
</feed>
