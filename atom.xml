<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>七路灯</title>
  
  <subtitle>人的一生应当有许多停靠站，但愿每一个站台都有一盏雾中的灯。</subtitle>
  <link href="http://www.lights8080.com/atom.xml" rel="self"/>
  
  <link href="http://www.lights8080.com/"/>
  <updated>2021-06-07T09:01:39.000Z</updated>
  <id>http://www.lights8080.com/</id>
  
  <author>
    <name>七路灯</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title></title>
    <link href="http://www.lights8080.com/2021/06/07/%E6%9D%82%E8%B0%88/%E4%BA%BA%E6%A0%BC%E5%88%86%E8%A3%82/"/>
    <id>http://www.lights8080.com/2021/06/07/%E6%9D%82%E8%B0%88/%E4%BA%BA%E6%A0%BC%E5%88%86%E8%A3%82/</id>
    <published>2021-06-07T09:00:06.000Z</published>
    <updated>2021-06-07T09:01:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>-–<br>title: “人格分裂”<br>date: 2021-04-28<br>categories:<br>- 杂谈<br>tags:<br>- 杂谈</p><p>-–</p><p>人格分裂和癌细胞一样，是人类无法驾驭的更强大的存在</p><span id="more"></span><p>癌细胞为什么是人类无法驾驭的更强大的存在呢？<br>生命的存在是因为细胞分裂，正常的细胞分裂，都会磨损真核细胞染色体末端的端粒酶，端粒酶没有了就无法继续分裂。<br>但是癌细胞却有修复端粒酶的能力，可以无限繁殖下去，这正是永生的破解密码。</p><p>人格分裂/多重人格被定义为一种心理疾病，一个生命个体上存在两种或以上不同身份和人格状态。直白点说就是一个身体里住着好几个灵魂。</p><p>把这灵魂分为两类：<br>受我们意愿所控制的灵魂定义为主灵魂，那些不受我们意愿控制的灵魂为独立灵魂。</p><p>人的一生中应该都会遇到许多次的轻微的人格分裂时刻。<br>比如当你失恋了，你满脑子都是失恋的情景，你明明不想让自己想那个情景，但是就是不受控制的在脑子里闪现。<br>这个失恋的情景就是独立灵魂，不受控制的让你去想。</p><p>当大脑进入这样的状态时，有了不受控制的独立意识，我认为就是轻微的人格分裂了。<br>这种状态下，大脑非常疲惫（就好像汽车一直开在160km/h，又无法刹车），无法集中精力做事，甚至会影响你的身体状态。</p><p>在这种状态下，喜欢抽烟喝酒，想用外界的干预来抑制或麻醉独立灵魂。</p><p>人格分裂对于生命体来说无疑是非常痛苦的，但是对于人脑组织或灵魂来说，是不是进化了呢？</p><p>灵魂是不是更高维度的存在，降维寄宿到人的身体里。<br>想象一下灵魂出窍，其实不是生命体有灵魂，而是灵魂寄宿在生命体当中，人格分裂的人，是多个灵魂共同寄宿在同一个生命体中，生命结束的时候灵魂就会飞走。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;-–&lt;br&gt;title: “人格分裂”&lt;br&gt;date: 2021-04-28&lt;br&gt;categories:&lt;br&gt;- 杂谈&lt;br&gt;tags:&lt;br&gt;- 杂谈&lt;/p&gt;
&lt;p&gt;-–&lt;/p&gt;
&lt;p&gt;人格分裂和癌细胞一样，是人类无法驾驭的更强大的存在&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ELK-文章合集</title>
    <link href="http://www.lights8080.com/2021/06/07/%E6%8A%80%E6%9C%AF/ELK/ELK-%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/"/>
    <id>http://www.lights8080.com/2021/06/07/%E6%8A%80%E6%9C%AF/ELK/ELK-%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/</id>
    <published>2021-06-06T16:00:00.000Z</published>
    <updated>2021-06-07T08:40:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>ELK文章合集</p><span id="more"></span><ul><li><a href="">Logstash-介绍</a></li><li><a href="">Logstash-配置</a></li></ul><h4 id="什么是ELK-Stack（指的就是Elastic-Stack）"><a href="#什么是ELK-Stack（指的就是Elastic-Stack）" class="headerlink" title="什么是ELK Stack（指的就是Elastic Stack）"></a>什么是ELK Stack（指的就是Elastic Stack）</h4><p>一切都起源于 Elasticsearch…<br>引入 Logstash 和 Kibana，产品更强大，ELK源自三者首字母缩写<br>社区越来越壮大，用例越来越丰富<br>然后我们向 ELK 中加入了 Beats<br>那么，ELK 需要怎么变化呢？<br>就这样，Elastic Stack 这个名字应运而生了</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ELK文章合集&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>ELK-实践（业务框架&amp;业务配置）</title>
    <link href="http://www.lights8080.com/2021/06/04/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%A1%86%E6%9E%B6&amp;%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/06/04/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%A1%86%E6%9E%B6&amp;%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%EF%BC%89/</id>
    <published>2021-06-03T16:00:00.000Z</published>
    <updated>2021-06-07T08:54:30.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍基于业务的数据模型框架和业务配置（Elasticsearch的映射和索引、Logstash配置管理、Filebeat规则管理、同步脚本等）。<br>基于7.11版本。</p></blockquote><span id="more"></span><p>业务中Elasticsearch数据分为两类：</p><ul><li><p>日志类：数据线性增长，无修改操作，无主键，数据价值随时间递减。如：用户操作、异常信息等</p></li><li><p>业务类：有主键，允许修改删除，长期保留。如：订单信息、基础信息</p></li></ul><p>数据提取方式和特点：</p><p>日志类数据：Filebeat-&gt;Logstash-&gt;Elasticsearch。数据流、通用模型、容错性强</p><p>业务类数据：通过脚本获取数据信息（数据库、API等）直接更新到Elasticsearch。自定义灵活可控</p><p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/06/vgIs47.png"></p><h2 id="1-Elasticsearch-映射和索引"><a href="#1-Elasticsearch-映射和索引" class="headerlink" title="1. Elasticsearch 映射和索引"></a>1. Elasticsearch 映射和索引</h2><ul><li>lights-mappings：组件模板mappings</li><li>lights-settings：组件模板settings</li><li>lights-log：索引生命周期-日志类</li><li>lights-data：索引生命周期-数据类</li><li>lights-service-exception：服务异常信息（数据流）</li><li>lights-nginx-web：Nginx日志（数据流）</li><li>lights-order：订单信息（索引别名）</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 创建索引模板组件-mapping</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_component_template/lights-mappings</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;dynamic_date_formats&quot;:</span> [</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;dynamic_templates&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;string_as_keyword&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">1024</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="string">&quot;@timestamp&quot;</span><span class="string">:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;message&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;index&quot;:</span> <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;log&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;file&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                                <span class="attr">&quot;path&quot;:</span> &#123;</span><br><span class="line">                                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                                    <span class="attr">&quot;index&quot;:</span> <span class="literal">false</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板组件-setting</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_component_template/lights-settings</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;index&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">                <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;codec&quot;:</span> <span class="string">&quot;best_compression&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;default_field&quot;:</span> [</span><br><span class="line">                    <span class="string">&quot;@timestamp&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;message&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引生命周期-日志类</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">_ilm/policy/lights-log</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;phases&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;hot&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;rollover&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;max_size&quot;:</span> <span class="string">&quot;50GB&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;max_age&quot;:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;delete&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;min_age&quot;:</span> <span class="string">&quot;365d&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;delete&quot;:</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引生命周期-数据类</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/_ilm/policy/lights-data</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;policy&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;phases&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;hot&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;rollover&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;max_size&quot;:</span> <span class="string">&quot;50GB&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;max_age&quot;:</span> <span class="string">&quot;30d&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（数据流）-服务异常信息</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-service-exception</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-service-exception&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;data_stream&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index.lifecycle.name&quot;:</span> <span class="string">&quot;lights-log-30&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;composed_of&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-mappings&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lights-settings&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;_meta&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;:</span> <span class="string">&quot;索引模板-服务异常信息&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（数据流）-Nginx日志</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-nginx-web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-nginx-web&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;data_stream&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;codec&quot;:</span> <span class="string">&quot;best_compression&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index.lifecycle.name&quot;:</span> <span class="string">&quot;lights-log&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;bytes&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;request_time&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;upstream_status&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;upstream_response_time&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;composed_of&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-mappings&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lights-settings&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建索引模板（索引别名）-订单数据</span></span><br><span class="line"><span class="string">POST</span> <span class="string">/_index_template/lights-order</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;lights-order-*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;template&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;:</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;:</span> <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;15s&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;dynamic_date_formats&quot;:</span> [</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>,</span><br><span class="line">                <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;dynamic_templates&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;string_as_keyword&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;ignore_above&quot;:</span> <span class="number">1024</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;total_as_double&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;match_mapping_type&quot;:</span> <span class="string">&quot;long&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;match&quot;:</span>   <span class="string">&quot;*Amount&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;mapping&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;double&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;orderNum&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;logs&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;properties&quot;:</span> &#123;</span><br><span class="line">                        <span class="attr">&quot;remark&quot;:</span> &#123;</span><br><span class="line">                            <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;aliases&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;lights-order&quot;:</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;priority&quot;:</span> <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;_meta&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;description&quot;:</span> <span class="string">&quot;索引模板-订单数据&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-Logstash-Config"><a href="#2-Logstash-Config" class="headerlink" title="2. Logstash Config"></a>2. Logstash Config</h2><ol><li>通过Filebeat标签识别日志类型</li><li>根据具体的服务名称打上业务标签，过滤、处理数据</li><li>根据不同的业务标签，输出到不同的Elasticsearch索引</li></ol><p>config/lights.conf</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sample Logstash configuration for creating a simple</span></span><br><span class="line"><span class="comment"># Beats -&gt; Logstash -&gt; Elasticsearch pipeline.</span></span><br><span class="line"></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">    <span class="string">beats</span> &#123;</span><br><span class="line">        <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">5044</span></span><br><span class="line">        <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">filter</span> &#123;</span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;lights-service&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">if</span> <span class="type">!([service_name])</span> &#123;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">copy</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;[log][file][path]&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;log_file_path&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">split</span> <span class="string">=&gt;</span> [ <span class="string">&quot;log_file_path&quot;</span> , <span class="string">&quot;/&quot;</span> ]</span><br><span class="line">                <span class="string">add_field</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;service_name&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;[log_file_path][2]&#125;</span>&quot;</span> &#125;</span><br><span class="line">                <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;log_file_path&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">if</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; ERROR &quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;Exception&quot;</span> &#123;</span><br><span class="line">            <span class="string">truncate</span> &#123;</span><br><span class="line">                <span class="string">fields</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">                <span class="string">length_bytes</span> <span class="string">=&gt;</span> <span class="number">10000</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">grok</span> &#123;</span><br><span class="line">                <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                    <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>\n<span class="template-variable">%&#123;GREEDYDATA:throwable&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>\n<span class="template-variable">%&#123;GREEDYDATA:throwable&#125;</span>&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - <span class="template-variable">%&#123;DATA:error_message&#125;</span>&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;service-exception&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">mutate</span> &#123;</span><br><span class="line">                <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;service-exception&quot;</span> ]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">if</span> [<span class="string">throwable</span>] &#123;</span><br><span class="line">                <span class="string">mutate</span> &#123;</span><br><span class="line">                    <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;throwable&quot;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="string">else</span> &#123;</span><br><span class="line">            <span class="string">if</span> [<span class="string">service_name</span>] <span class="string">==</span> <span class="string">&quot;lights-search-service&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;LightSearchServiceImpl&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; INFO &quot;</span> &#123;</span><br><span class="line">                <span class="string">grok</span> &#123;</span><br><span class="line">                    <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                        <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                            <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> <span class="template-variable">%&#123;DATA:class&#125;</span> - <span class="template-variable">%&#123;GREEDYDATA:response_message&#125;</span>&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-search-service&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">mutate</span> &#123;</span><br><span class="line">                    <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;lights-search-service&quot;</span> ]</span><br><span class="line">                    <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;lights-nginx-web&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">grok</span> &#123;</span><br><span class="line">            <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">                <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                    <span class="string">&quot;<span class="template-variable">%&#123;IPORHOST:clientip&#125;</span> <span class="template-variable">%&#123;IPORHOST:server_name&#125;</span> <span class="template-variable">%&#123;HTTPDUSER:ident&#125;</span> <span class="template-variable">%&#123;HTTPDUSER:auth&#125;</span> \[<span class="template-variable">%&#123;HTTPDATE:timestamp&#125;</span>\] \&quot;(?:<span class="template-variable">%&#123;WORD:verb&#125;</span> <span class="template-variable">%&#123;DATA:request&#125;</span>(?: HTTP/<span class="template-variable">%&#123;NUMBER:httpversion&#125;</span>)?|<span class="template-variable">%&#123;DATA:rawrequest&#125;</span>)\&quot; (?:-|<span class="template-variable">%&#123;NUMBER:status&#125;</span>) (?:-|<span class="template-variable">%&#123;NUMBER:request_time&#125;</span>) (?:-|<span class="template-variable">%&#123;NUMBER:bytes&#125;</span>) \&quot;<span class="template-variable">%&#123;DATA:http_referer&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:http_user_agent&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:http_x_forwarded_for&#125;</span>\&quot; \&quot;<span class="template-variable">%&#123;DATA:upstream_addr&#125;</span>\&quot; <span class="template-variable">%&#123;NUMBER:upstream_status&#125;</span> <span class="template-variable">%&#123;NUMBER:upstream_response_time&#125;</span>&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">mutate</span> &#123;</span><br><span class="line">            <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">date</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>, <span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">mutate</span> &#123;</span><br><span class="line">        <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;@version&quot;</span>, <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;input&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">    <span class="comment">#stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span></span><br><span class="line">    <span class="string">if</span> <span class="string">&quot;_grokparsefailure&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">        <span class="string">file</span> &#123;</span><br><span class="line">            <span class="string">path</span> <span class="string">=&gt;</span> <span class="string">&quot;/opt/elk/logstash-7.11.2/_grokparsefailure-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="string">else</span> &#123;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;service-exception&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-service-exception&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;lights-search-service&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-search&quot;</span></span><br><span class="line">                <span class="comment">#document_id =&gt; &quot;%&#123;[@metadata][_id]&#125;&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">if</span> <span class="string">&quot;lights-nginx-web&quot;</span> <span class="string">in</span> [<span class="string">tags</span>] &#123;</span><br><span class="line">            <span class="string">elasticsearch</span> &#123;</span><br><span class="line">                <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">                <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-nginx-web&quot;</span></span><br><span class="line">                <span class="string">action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">                <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">                <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-1-Filebeat"><a href="#3-1-Filebeat" class="headerlink" title="3.1 Filebeat"></a>3.1 Filebeat</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx日志</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/log/nginx/lights.log</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;lights-nginx&quot;</span>]</span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Java日志(异常多行合并)</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/log/&lt;service-name&gt;/*.log</span></span><br><span class="line">  <span class="attr">exclude_lines:</span> [<span class="string">&#x27;/actuator/&#x27;</span>]</span><br><span class="line">  <span class="attr">exclude_files:</span> [<span class="string">&#x27;.gz$&#x27;</span>]</span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;lights-service&quot;</span>]</span><br><span class="line">  <span class="attr">multiline.type:</span> <span class="string">pattern</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">6h</span></span><br></pre></td></tr></table></figure><h2 id="3-2-脚本（同步到Elasticsearch）"><a href="#3-2-脚本（同步到Elasticsearch）" class="headerlink" title="3.2 脚本（同步到Elasticsearch）"></a>3.2 脚本（同步到Elasticsearch）</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 判断脚本正在执行</span></span><br><span class="line">LOCK=$(cat <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$LOCK</span> -eq 1 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;`date &quot;</span>+%Y-%m-%d %H:%M:%S<span class="string">&quot;` locked&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br><span class="line"></span><br><span class="line">DATE_BEGIN=$(cat <span class="variable">$es_script_path</span>/.lasttime_<span class="variable">$file_suffix</span>)</span><br><span class="line">DATE_END=`date +<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>`</span><br><span class="line">DATE_BEGIN=<span class="string">&quot;2021-05-01 09:00:10&quot;</span></span><br><span class="line">DATE_END=<span class="string">&quot;2021-05-01 09:00:10&quot;</span></span><br><span class="line"></span><br><span class="line">ORDERS_SQL=<span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">select order_no from lights.order where createtime BETWEEN &#x27;<span class="variable">$DATE_BEGIN</span>&#x27; and &#x27;<span class="variable">$DATE_END</span>&#x27;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 查询同步订单列表</span></span><br><span class="line">ORDERS_RESULT=$(mysql -u &lt;user&gt; &lt;db&gt; -e  <span class="string">&quot;<span class="variable">$ORDERS_SQL</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> LINE <span class="keyword">in</span> <span class="variable">$ORDERS_RESULT</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&#x27;order_no&#x27;</span> != <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    es_index=`<span class="built_in">echo</span> <span class="string">&quot;lights-order-20<span class="variable">$LINE</span>&quot;</span>|cut -c 1-20`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;sync order time:<span class="variable">$DATE_BEGIN</span> ~ <span class="variable">$DATE_END</span> order no: <span class="variable">$LINE</span>, es index: <span class="variable">$es_index</span>&quot;</span></span><br><span class="line">    <span class="comment"># 调用查询接口</span></span><br><span class="line">    orderdetail_result=$(curl -XPOST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;orderNo&quot;:&quot;&#x27;</span><span class="variable">$LINE</span><span class="string">&#x27;&quot;&#125;&#x27;</span> http://localhost:8080/flights-order-service/order/detail)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$orderdetail_result</span>&quot;</span> &gt; <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span></span><br><span class="line">    <span class="comment"># 时区设置</span></span><br><span class="line">    cat <span class="variable">$es_script_path</span>/.data_<span class="variable">$file_suffix</span> |jq <span class="string">&#x27;.orderInfo&#x27;</span> -c &gt;<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">    sed -i <span class="string">&#x27;s/[0-9]\&#123;4\&#125;-[0-9]\&#123;2\&#125;-[0-9]\&#123;2\&#125; [0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;:[0-9]\&#123;2\&#125;/&amp; +0800/g&#x27;</span> <span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">    <span class="comment"># 保持到Elasticsearch</span></span><br><span class="line">    curl -XPOST --user <span class="string">&#x27;elastic:&lt;password&gt;&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://localhost:9200/<span class="variable">$es_index</span>/_doc/<span class="variable">$LINE</span> -d@<span class="variable">$es_script_path</span>/.data_1_<span class="variable">$file_suffix</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新同步时间 及 解除正在执行标记</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DATE_END</span> &gt; <span class="variable">$es_script_path</span>/.lasttime_<span class="variable">$file_suffix</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt; <span class="variable">$es_script_path</span>/.lock_<span class="variable">$file_suffix</span></span><br></pre></td></tr></table></figure><h2 id="4-其他"><a href="#4-其他" class="headerlink" title="4. 其他"></a>4. 其他</h2><h4 id="1-Logstash-Req-Resp合并成一条事件"><a href="#1-Logstash-Req-Resp合并成一条事件" class="headerlink" title="1. Logstash Req-Resp合并成一条事件"></a>1. Logstash Req-Resp合并成一条事件</h4><p>正常情况下Controller层会拦截请求参数和响应结果并输出到日志，如何基于线程ID将前后两条日志记录合并到一个事件中。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">if</span> [<span class="string">service_name</span>] <span class="string">==</span> <span class="string">&quot;lights-order-service&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot;LIGHTS-RE&quot;</span> <span class="string">and</span> [<span class="string">message</span>] <span class="string">=~</span> <span class="string">&quot; INFO &quot;</span> &#123;</span><br><span class="line">    <span class="string">grok</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> [</span><br><span class="line">                <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - LIGHTS-<span class="template-variable">%&#123;DATA:type&#125;</span>-\[<span class="template-variable">%&#123;DATA:class_method&#125;</span>\] \[<span class="template-variable">%&#123;DATA:username&#125;</span>\] \[<span class="template-variable">%&#123;GREEDYDATA:request&#125;</span>\]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;<span class="template-variable">%&#123;TIMESTAMP_ISO8601:timestamp&#125;</span> \[<span class="template-variable">%&#123;DATA:thread&#125;</span>\] <span class="template-variable">%&#123;DATA:level&#125;</span> - LIGHTS-<span class="template-variable">%&#123;DATA:type&#125;</span>-\[<span class="template-variable">%&#123;DATA:class_method&#125;</span>\] <span class="template-variable">%&#123;GREEDYDATA:response&#125;</span> size:<span class="template-variable">%&#123;DATA:size&#125;</span> spend:<span class="template-variable">%&#123;DATA:spend&#125;</span>ms&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">id</span> <span class="string">=&gt;</span> <span class="string">&quot;lights-order-service&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">if</span> [<span class="string">type</span>] <span class="string">==</span> <span class="string">&quot;REQ&quot;</span> &#123;</span><br><span class="line">        <span class="string">aggregate</span> &#123;</span><br><span class="line">            <span class="string">task_id</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;thread&#125;</span>&quot;</span></span><br><span class="line">            <span class="string">code</span> <span class="string">=&gt;</span> <span class="string">&quot;map[&#x27;request_timestamp&#x27;] = event.get(&#x27;timestamp&#x27;); map[&#x27;username&#x27;] = event.get(&#x27;username&#x27;); map[&#x27;request&#x27;] = event.get(&#x27;request&#x27;)&quot;</span></span><br><span class="line">            <span class="string">map_action</span> <span class="string">=&gt;</span> <span class="string">&quot;create&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">if</span> [<span class="string">type</span>] <span class="string">==</span> <span class="string">&quot;RESP&quot;</span> &#123;</span><br><span class="line">        <span class="string">aggregate</span> &#123;</span><br><span class="line">            <span class="string">task_id</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;thread&#125;</span>&quot;</span></span><br><span class="line">            <span class="string">code</span> <span class="string">=&gt;</span> <span class="string">&quot;event.set(&#x27;request_timestamp&#x27;, map[&#x27;request_timestamp&#x27;]); event.set(&#x27;username&#x27;, map[&#x27;username&#x27;]); event.set(&#x27;request&#x27;, map[&#x27;request&#x27;])&quot;</span></span><br><span class="line">            <span class="string">map_action</span> <span class="string">=&gt;</span> <span class="string">&quot;update&quot;</span></span><br><span class="line">            <span class="string">end_of_task</span> <span class="string">=&gt;</span> <span class="literal">true</span></span><br><span class="line">            <span class="string">timeout</span> <span class="string">=&gt;</span> <span class="number">120</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">mutate</span> &#123;</span><br><span class="line">            <span class="string">add_tag</span> <span class="string">=&gt;</span> [ <span class="string">&quot;lights-order-service&quot;</span> ]</span><br><span class="line">            <span class="string">remove_field</span> <span class="string">=&gt;</span> [<span class="string">&quot;message&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-Kibana小技巧和注意事项"><a href="#2-Kibana小技巧和注意事项" class="headerlink" title="2. Kibana小技巧和注意事项"></a>2. Kibana小技巧和注意事项</h4><ol><li><p>Kibana可视化中Lens(条形图、饼图等)，如何使用索引的另一个时间x字段统计？<br>新建一个Kibana索引，选择x字段作为时间字段。</p></li><li><p>Kibana可视化中Lens(条形图、饼图等)，如何像TSVB那样使用公式计算值？<br>使用Kibana索引的脚本字段，在Lens中使用</p></li><li><p>Kibana中Discover时间框搜索是大于等于(&gt;=)开始时间，小于(&lt;)结束时间，对时间敏感的搜索需要注意</p></li></ol><h4 id="3-Elasticsearch时区问题"><a href="#3-Elasticsearch时区问题" class="headerlink" title="3. Elasticsearch时区问题"></a>3. Elasticsearch时区问题</h4><p>Elasticsearch存储和读取时都要带上时区</p><ul><li><p>Logstash存储修改UTC时间为东八区时间</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ruby &#123;</span><br><span class="line">            code =&gt; <span class="attr">&quot;event.set(&#x27;temp&#x27;, event.get(&#x27;@timestamp&#x27;).time.localtime + 8*60*60); event.set(&#x27;@timestamp&#x27;, event.get(&#x27;temp&#x27;))&quot;</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>直接存储ES的时间字段要带上时区信息<code>2021-05-15 00:00:00 +0800</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST --user <span class="string">&#x27;elastic:xxx&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> http://127.0.0.1:9200/es_index/_doc/<span class="variable">$LINE</span> -d@/json_data</span><br></pre></td></tr></table></figure></li><li><p>Kibana搜索时带上时区</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET lights-order/_count</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="string">&quot;2021-04-15 00:00:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="string">&quot;2021-04-15 23:59:59&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;time_zone&quot;</span>:<span class="string">&quot;+08:00&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-设计上的原则"><a href="#4-设计上的原则" class="headerlink" title="4. 设计上的原则"></a>4. 设计上的原则</h4><p>数据清洗一定发生在写入ES之前，而不是请求数据后处理，拿势必会降低请求速度和效率。<br>让ES做他擅长的事，检索+不复杂的聚合，否则数据量+复杂的业务逻辑会有性能问题。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍基于业务的数据模型框架和业务配置（Elasticsearch的映射和索引、Logstash配置管理、Filebeat规则管理、同步脚本等）。&lt;br&gt;基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-数据迁移</title>
    <link href="http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    <id>http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/</id>
    <published>2021-06-02T16:00:00.000Z</published>
    <updated>2021-06-07T07:04:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Reindex数据迁移"><a href="#Reindex数据迁移" class="headerlink" title="Reindex数据迁移"></a>Reindex数据迁移</h2><p>重建索引（_reindex），即：一旦索引被创建，则无法直接修改索引字段的mapping属性，必需要重建索引然后将旧的索引数据迁移到新的索引中才行（迁移过程底层使用了scroll API ）。</p><p>示例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;conflicts&quot;</span>: <span class="string">&quot;proceed&quot;</span>, <span class="comment"># 发生冲突继续执行</span></span><br><span class="line">      <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;old_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 5000, <span class="comment"># 设置每批迁移的文档记录数</span></span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;user&quot;</span>, <span class="string">&quot;_doc&quot;</span>], <span class="comment"># 可设置要迁移的索引字段，不设置则默认所有字段</span></span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123; <span class="comment"># 可设置要迁移的文档记录过滤条件</span></span><br><span class="line">          <span class="string">&quot;match_all&quot;</span>: &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;new_index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version_type&quot;</span>: <span class="string">&quot;internal&quot;</span> <span class="comment"># &quot;internal&quot;或者不设置，则Elasticsearch强制性的将文档转储到目标中，覆盖具有相同类型和ID的任何内容</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Reindex数据迁移&quot;&gt;&lt;a href=&quot;#Reindex数据迁移&quot; class=&quot;headerlink&quot; title=&quot;Reindex数据迁移&quot;&gt;&lt;/a&gt;Reindex数据迁移&lt;/h2&gt;&lt;p&gt;重建索引（_reindex），即：一旦索引被创建，则无法直接修改索引</summary>
      
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-配置及系统配置说明</title>
    <link href="http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/"/>
    <id>http://www.lights8080.com/2021/06/03/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/</id>
    <published>2021-06-02T16:00:00.000Z</published>
    <updated>2021-06-04T08:04:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>系统配置、Elasticsearch配置说明</p><span id="more"></span><h2 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h2><p>理想情况下，Elasticsearch应该单独运行在服务器上，并使用所有可用的资源。为了做到这一点，您需要配置您的操作系统，以允许运行Elasticsearch的用户访问超过默认允许的资源。</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/system-config.html">Important System Configuration</a></p><h3 id="系统配置-参考"><a href="#系统配置-参考" class="headerlink" title="系统配置-参考"></a>系统配置-参考</h3><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">elasticsearch soft memlock unlimited</span><br><span class="line">elasticsearch hard memlock unlimited</span><br><span class="line">elasticsearch soft nproc 4096</span><br><span class="line">elasticsearch hard nproc 4096</span><br></pre></td></tr></table></figure><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count = 262144</span><br><span class="line">net.ipv4.tcp_retries2 = 5</span><br></pre></td></tr></table></figure><h3 id="系统配置-说明"><a href="#系统配置-说明" class="headerlink" title="系统配置-说明"></a>系统配置-说明</h3><h4 id="Disable-swapping（禁用内存交互）"><a href="#Disable-swapping（禁用内存交互）" class="headerlink" title="Disable swapping（禁用内存交互）"></a>Disable swapping（禁用内存交互）</h4><p>大多数操作系统尝试为文件系统缓存使用尽可能多的内存，并急切地交换未使用的应用程序内存。这可能导致部分JVM堆甚至其可执行页被交换到磁盘。交换对于性能和节点稳定性非常不利，应该不惜一切代价避免。</p><ul><li><p>On Linux systems，临时禁用</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a</span><br></pre></td></tr></table></figure></li><li><p>On Linux systems，永久禁用<br>编辑/etc/fstab，注释掉包含swap的任意行</p></li><li><p>Elasticsearch配置<br>set bootstrap.memory_lock to true in elasticsearch.yml</p></li></ul><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># allow user &#x27;elasticsearch&#x27; mlockall</span></span><br><span class="line">elasticsearch soft memlock unlimited</span><br><span class="line">elasticsearch hard memlock unlimited</span><br></pre></td></tr></table></figure><p>检查：<br><code>GET _nodes?filter_path=**.mlockall</code><br>如果为false，最可能的原因是，运行Elasticsearch的用户没有锁定内存的权限，通过以下方式授权</p><h4 id="File-Descriptors（文件描述符）"><a href="#File-Descriptors（文件描述符）" class="headerlink" title="File Descriptors（文件描述符）"></a>File Descriptors（文件描述符）</h4><p>Elasticsearch使用了很多文件描述符或文件句柄。耗尽文件描述符可能是灾难性的，很可能会导致数据丢失。确保将运行Elasticsearch的用户打开文件描述符数量的限制增加到65536或更高。</p><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch  -  nofile  65535</span></span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></table></figure><p>检查：<br><code>GET _nodes/stats/process?filter_path=**.max_file_descriptors</code></p><h4 id="Virtual-memory（虚拟内存）"><a href="#Virtual-memory（虚拟内存）" class="headerlink" title="Virtual memory（虚拟内存）"></a>Virtual memory（虚拟内存）</h4><p>Elasticsearch默认使用一个mappfs目录来存储索引。默认操作系统对mmap计数的限制可能太低，这可能会导致内存不足异常。</p><ul><li><p>暂时设置<br><code>sysctl -w vm.max_map_count=262144</code></p></li><li><p>永久设置</p></li></ul><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置操作系统mmap数限制，Elasticsearch与Lucene使用mmap来映射部分索引到Elasticsearch的地址空间</span></span><br><span class="line"><span class="comment"># 为了让mmap生效，Elasticsearch还需要有创建需要内存映射区的能力。最大map数检查是确保内核允许创建至少262144个内存映射区</span></span><br><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure><h4 id="Number-of-threads（线程数）"><a href="#Number-of-threads（线程数）" class="headerlink" title="Number of threads（线程数）"></a>Number of threads（线程数）</h4><p>Elasticsearch为不同类型的操作使用了许多线程池。它能够在需要时创建新线程，这一点很重要。确保Elasticsearch用户可以创建的线程数量至少是4096个。</p><p>$ vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch soft nproc 4096</span><br><span class="line">elasticsearch hard nproc 4096</span><br></pre></td></tr></table></figure><h4 id="TCP-retransmission-timeout（TCP重传超时）"><a href="#TCP-retransmission-timeout（TCP重传超时）" class="headerlink" title="TCP retransmission timeout（TCP重传超时）"></a>TCP retransmission timeout（TCP重传超时）</h4><p>集群中的每一对节点通过许多TCP连接进行通信，这些TCP连接一直保持打开状态，直到其中一个节点关闭或由于底层基础设施中的故障而中断节点之间的通信。</p><p>TCP通过对通信应用程序隐藏临时的网络中断，在偶尔不可靠的网络上提供可靠的通信。在通知发送者任何问题之前，您的操作系统将多次重新传输任何丢失的消息。大多数Linux发行版默认重传任何丢失的数据包15次。重传速度呈指数级下降，所以这15次重传需要900秒才能完成。这意味着Linux使用这种方法需要花费许多分钟来检测网络分区或故障节点。Windows默认只有5次重传，相当于6秒左右的超时。</p><p>Linux默认允许在可能经历很长时间包丢失的网络上进行通信，但是对于单个数据中心内的生产网络来说，这个默认值太大了，就像大多数Elasticsearch集群一样。高可用集群必须能够快速检测节点故障，以便它们能够通过重新分配丢失的碎片、重新路由搜索以及可能选择一个新的主节点来迅速作出反应。因此，Linux用户应该减少TCP重传的最大数量。</p><p>$ vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_retries2 = 5</span><br></pre></td></tr></table></figure><h2 id="Elasticsearch配置"><a href="#Elasticsearch配置" class="headerlink" title="Elasticsearch配置"></a>Elasticsearch配置</h2><p>默认情况Elasticsearch假设处于开发模式中，任何的配置不正确都会在日志文件中写入警告，能够正常启动和运行节点；一旦配置了像network.host这样的网络设置，Elasticsearch就会假设处于生产环境中，并将上面的警告升级为异常，这些异常将阻止节点启动。</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/important-settings.html#important-settings">Important Elasticsearch configuration</a></p><h4 id="config-elasticsearch-yml"><a href="#config-elasticsearch-yml" class="headerlink" title="config/elasticsearch.yml"></a>config/elasticsearch.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ES数据目录和日志目录，path.data可以设置多个路径</span></span><br><span class="line"><span class="attr">path:</span></span><br><span class="line">  <span class="attr">logs:</span> <span class="string">/var/log/elasticsearch</span></span><br><span class="line">  <span class="attr">data:</span> <span class="string">/var/data/elasticsearch</span></span><br><span class="line"><span class="comment"># 集群名称，默认elasticsearch。相同的集群名称的节点，才能加入集群</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="comment"># 设置全新群集中符合主机资格的节点的初始集合（首次启动集群时需要）；默认为空表示该节点希望加入已经被引导的集群</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;10.188.80.14&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点名称，默认随机生成</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">prod-data-2</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 启用预处理，默认启用</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 集群绑定的主机名或IP地址，用于形成一个可以相互通讯的集群；0.0.0.0表示绑定到所有网络接口</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span></span><br><span class="line"><span class="comment"># 节点间通讯绑定端口，默认9300-9400</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提供可访问的集群列表，没有给出端口的通过`transport.port`确定端口，以前使用`discovery.zen.ping.unicast.hosts`</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;10.188.80.14&quot;</span>]</span><br><span class="line"><span class="comment"># 启用单节点发现（节点将选举自己为主节点，并且不会与任何其他节点一起加入集群），推迟了TLS的配置；默认形成多节点集群（发现其他节点，并允许他们加入集群）</span></span><br><span class="line"><span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群的最小master节点数，避免集群脑裂</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># HTTP服务绑定到的主机地址</span></span><br><span class="line"><span class="attr">http.bind_host:</span> </span><br><span class="line"><span class="comment"># 发布以供HTTP客户端连接的主机地址</span></span><br><span class="line"><span class="attr">http.publish_host:</span> </span><br><span class="line"><span class="comment"># http.bind_host and the http.publish_host</span></span><br><span class="line"><span class="attr">http.host:</span> <span class="string">&quot;10.188.80.14&quot;</span></span><br><span class="line"><span class="comment"># HTTP请求绑定端口，默认9200-9300</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment"># 允许跨域</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用swapping，避免影响集群的性能和稳定性，默认开启。（大多数操作系统尝试使用尽可能多的内存文件系统缓存和热切换出未使用的应用程序内存，避免JVM堆交互到磁盘上）</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启通过系统调用过滤器检查，默认为true，如果自己承担禁用系统调用过滤器的风险，设置为false</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动创建索引，默认为true</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 删除索引时必须显示的指定名称，默认为true</span></span><br><span class="line"><span class="attr">action.destructive_requires_name:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="config-jvm-options"><a href="#config-jvm-options" class="headerlink" title="config/ jvm.options"></a>config/ jvm.options</h4><ul><li>Elasticsearch有足够的可用堆是非常重要的。</li><li>堆的最小值（Xms）与堆的最大值（Xmx）设置成相同的。</li><li>Elasticsearch的可用堆越大，它能在内存中缓存的数据越多。但是需要注意堆越大在垃圾回收时造成的暂停会越长。</li><li>设置Xmx不要大于物理内存的50%。用来确保有足够多的物理内存预留给操作系统缓存。</li><li>禁止用串行收集器来运行Elasticsearch（-XX:+UseSerialGC），默认JVM配置通过Elasticsearch的配置将使用CMS回收器。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms8g</span><br><span class="line">-Xmx8g</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;系统配置、Elasticsearch配置说明&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>人体系统-糖</title>
    <link href="http://www.lights8080.com/2021/06/02/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F-%E7%B3%96/"/>
    <id>http://www.lights8080.com/2021/06/02/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F-%E7%B3%96/</id>
    <published>2021-06-01T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>糖对人体的重要性。什么是糖、糖的作用、糖的分类、葡萄糖的人体旅程。</p><span id="more"></span><h2 id="什么是糖"><a href="#什么是糖" class="headerlink" title="什么是糖"></a>什么是糖</h2><p>糖是一大类化学物质，糖类都是由碳氢氧三种元素构成的，最初观察发现其中氢和氧的比例是2:1，好像就是碳原子和几个水分子构成的，所以把糖类叫碳水化合物。后来发现一些糖中的氢和氧的比例不是2:1，所以把糖类叫碳水化合物不严谨。但是这个名字一直流传下来，平时所说的碳水化合物一般指的就是糖。</p><h2 id="糖的作用"><a href="#糖的作用" class="headerlink" title="糖的作用"></a>糖的作用</h2><p>糖是最主要的能源物质，人体进行各项生命活动所消耗的能量主要来自于糖类的氧化分解。分解速度快，提供能量非常迅速，我们的大脑和生理活动都需要糖。</p><p>人体获得能量：<br>葡萄糖 + 氧气 =&gt; 水 + 二氧化碳 + 能量</p><p>葡萄糖在无氧的情况下<br>葡萄糖 =&gt; 乳酸 + 能量(酸奶)<br>葡萄糖 =&gt; 酒精 + 能量(酒)</p><h2 id="糖的分类"><a href="#糖的分类" class="headerlink" title="糖的分类"></a>糖的分类</h2><p>糖不一定是甜的，甜的也不一定是糖。</p><h4 id="单糖"><a href="#单糖" class="headerlink" title="单糖"></a>单糖</h4><p>单糖是构成各种糖分子的基本单位，不能再水解，可以直接被人体吸收。<br>饮食中主要单糖有葡萄糖、果糖、半乳糖，其中葡萄糖是最重要的单糖。<br>所有含碳水化合物的食物进入血液之前，都要分解转化为葡萄糖，到达肠道后，在转运蛋白的帮助下穿过肠壁，最快地为人体提供能量。</p><ul><li>葡萄糖：经过肠道直接被人体吸收，进入到血液，称为血糖</li><li>果糖（水果、蜂蜜）：不直接被人体吸收，进入肝脏转换为葡萄糖或脂肪，因为其运转机制迟滞，没有葡萄糖进入血液得快，果糖更容易变成脂肪</li><li>半乳糖（牛奶）：不直接被人体吸收，进入肝脏转换为葡萄糖</li></ul><h4 id="二糖-双糖"><a href="#二糖-双糖" class="headerlink" title="二糖/双糖"></a>二糖/双糖</h4><p>两个单糖结合在一起组成了双糖，可以水解成单糖，被人体吸收</p><ul><li>麦芽糖（麦芽）：葡萄糖+葡萄糖</li><li>蔗糖（甘蔗）：葡萄糖+果糖</li><li>乳糖（牛奶）：葡萄糖+半乳糖</li></ul><h4 id="多糖"><a href="#多糖" class="headerlink" title="多糖"></a>多糖</h4><p>多糖相对来讲是复合的碳水化合物，由很多单糖通过糖苷链接在一起形成的聚合物，因此多糖结构非常大，经常有分支和很多分子。多糖不溶于水而且没有甜味。</p><ul><li>淀粉（大米、白面）：由葡萄糖连接而成</li><li>糖原（肝脏、肌肉）：肝脏可以把多余的单糖合成糖原储存在肝脏和肌肉里，当身体需要能量时糖原会迅速分解成葡萄糖。</li><li>脂肪（皮下、内脏）：糖原储存不下，更多的单糖会合成脂肪储存在皮下和内脏</li><li>纤维（木头、棉花、蔬菜）：不能消化的碳水化合物被划归为“膳食纤维”或者“不可用碳水化合物”。作用：有饱腹感、促进肠道蠕动、促进粪便形成</li><li>几丁质（虾壳、蟹壳）：人体不能消化的东西</li></ul><h4 id="代糖-甜味剂"><a href="#代糖-甜味剂" class="headerlink" title="代糖/甜味剂"></a>代糖/甜味剂</h4><p>通过人工化学改造或者合成的具有甜味的化学物质。特点是甜度非常高，几乎没有热量，也不具有任何营养价值。</p><ul><li>阿斯巴甜：甜度是等量蔗糖的200倍</li><li>三氯蔗糖：甜度是等量蔗糖的600倍</li></ul><h2 id="葡萄糖的人体旅程"><a href="#葡萄糖的人体旅程" class="headerlink" title="葡萄糖的人体旅程"></a>葡萄糖的人体旅程</h2><p>食物中的碳水化合物通过分解转换为单糖，其中葡萄糖经过肠壁吸收直接进入血液（此时叫血糖），果糖和半乳糖经过吸收进入到肝脏，被转换为葡萄糖、糖原或脂肪。</p><p>葡萄糖 ==&gt; 糖原/脂肪：胰岛素<br>葡萄糖 &lt;== 糖原/脂肪：胰高血糖素</p><p><img src="/Users/lihaipeng/Documents/wechat/PGbDKQ.png"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.zhihu.com/question/20714926/answer/73370674">碳水化合物和糖有什么区别？</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;糖对人体的重要性。什么是糖、糖的作用、糖的分类、葡萄糖的人体旅程。&lt;/p&gt;</summary>
    
    
    
    <category term="人体系统" scheme="http://www.lights8080.com/categories/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/"/>
    
    
    <category term="李永乐老师" scheme="http://www.lights8080.com/tags/%E6%9D%8E%E6%B0%B8%E4%B9%90%E8%80%81%E5%B8%88/"/>
    
    <category term="人体系统" scheme="http://www.lights8080.com/tags/%E4%BA%BA%E4%BD%93%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>Linux [buff/cache]内存缓存占用过高分析和优化</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/Linux%20[buffcache]%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90%E5%92%8C%E4%BC%98%E5%8C%96/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/Linux%20[buffcache]%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90%E5%92%8C%E4%BC%98%E5%8C%96/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:35.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>buff/cache过高问题解决过程。问题现场、问题分析、如何解决、扩展知识</p></blockquote><span id="more"></span><h2 id="问题现场"><a href="#问题现场" class="headerlink" title="问题现场"></a>问题现场</h2><p>查看系统内存的使用状态<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-free.jpg"></p><p>监控报警可用内存空间不足，常规的解决方案如下：</p><ol><li>增加内存（增加成本）</li><li>增加虚拟内存（影响性能）</li><li>定期清理缓存（echo 1 &gt; /proc/sys/vm/drop_caches）</li></ol><p>本文将介绍定期清除页面缓存，但是过会儿内存又被占满问题的分析。</p><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><ol><li><p>通过监控系统负载情况（vmstat 1），确定是页面缓存（cache项）占用量大，并且释放页面缓存后从块设备读入数据量（bi项）会马上增加。<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-vmstat.jpg"></p></li><li><p>通过监控io情况（iostat -x -k 1）也可以看出<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-iostat.jpg"></p></li><li><p>基于此可以猜测是有进程在频繁的读取文件导致，监视磁盘I/O使用状况（iotop -oP），释放页面缓存后有几个sed命令读取文件进程占用IO很高。<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-iotop.jpg"></p></li><li><p>至此结合业务分析是因为每分钟读取日志统计指标导致</p></li></ol><h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><h3 id="proc-meminfo"><a href="#proc-meminfo" class="headerlink" title="/proc/meminfo"></a>/proc/meminfo</h3><p>查看更详细的内存信息：<br><code>$ cat /proc/meminfo |grep -E &quot;Buffer|Cache|Swap|Mem|Shmem|Slab|SReclaimable|SUnreclaim&quot;</code><br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/linux-buff-meminfo.jpg"></p><ul><li>MemFree：空闲的物理内存</li><li>MemAvailable：可用的物理内存，MemFree+Buffers+Cached</li><li>Buffers：（Buffer Cache）对磁盘块设备数据的缓存</li><li>Cached：（Page Cache）对文件系统上文件数据的缓存，MemFree+SReclaimable</li><li>SwapTotal：虚拟内存，利用磁盘空间虚拟出的一块逻辑内存</li><li>Slab：Linux内存管理机制</li><li>SReclaimable：Slab可回收部分</li><li>SUnreclaim：Slab不可回收部分</li><li>Shmem：进程间共同使用的共享内存</li></ul><h3 id="proc-sys-vm-drop-caches"><a href="#proc-sys-vm-drop-caches" class="headerlink" title="/proc/sys/vm/drop_caches"></a>/proc/sys/vm/drop_caches</h3><p>清除缓存策略：<br>1：清除page cache<br>2：清除slab分配器中的对象（包括目录项和inode）<br>3：清除page cache和slab分配器中的对象</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://lights8080.github.io/post/oom-killer-ji-overcommit/">OOM killer及Overcommit</a><br><a href="https://blog.csdn.net/kunyus/article/details/104617426">Linux buffer/cache 内存占用过高的原因以及解决办法</a><br><a href="https://blog.csdn.net/linxi7/article/details/109078516">Linux查看Buffer&amp;Cache被哪些进程占用</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;buff/cache过高问题解决过程。问题现场、问题分析、如何解决、扩展知识&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/Linux/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>OOM killer及Overcommit</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/OOM%20killer%E5%8F%8AOvercommit/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/Linux/OOM%20killer%E5%8F%8AOvercommit/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:38.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>OOM killer(Out Of Memory killer)是Linux内核的一种内存管理机制，该机制在系统物理内存不足时，选择性杀死一些进程以释放内存，以使系统继续运行。</p></blockquote><span id="more"></span><h2 id="OOM-killer"><a href="#OOM-killer" class="headerlink" title="OOM killer"></a>OOM killer</h2><p>OOM killer(Out Of Memory killer)是Linux内核的一种内存管理机制，该机制在系统物理内存不足时，选择性（oom_killer遍历当前所有进程，根据进程的内存使用情况进行打分，然后从中选择一个分数最高的进程）杀死一些进程以释放内存，以使系统继续运行。</p><h3 id="Overcommit（过量使用）"><a href="#Overcommit（过量使用）" class="headerlink" title="Overcommit（过量使用）"></a>Overcommit（过量使用）</h3><p>这个特性出于优化系统考虑，因为进程实际使用到的内存往往比申请的内存少。</p><p>按照Linux的算法，物理内存页的分配发生在使用瞬间，而不是在申请瞬间。Overcommit针对的也是内存申请，而不是内存分配。</p><p>Linux下允许程序申请比系统可用内存更多的内存。因为不是所有的程序申请了内存就立刻使用的，当实际使用时超过可分配物理内存时，利用OOM机制选择性杀死一些进程以释放内存。</p><h3 id="参数调优"><a href="#参数调优" class="headerlink" title="参数调优"></a>参数调优</h3><p>vm.overcommit_memory</p><ul><li>0：OVERCOMMIT_GUESS（默认），内核将检查是否有足够的可用内存供应用进程使用</li><li>1：OVERCOMMIT_ALWAYS，允许超过CommitLimit的分配，即允许分配所有的物理内存，而不管当前的内存状态如何</li><li>2：OVERCOMMIT_NEVER，拒绝超过CommitLimit的分配，即拒绝等于或者大于CommitLimit指定的物理 RAM 比例的内存请求</li></ul><p>CommitLimit 和 Commited_AS</p><ul><li>CommitLimit：最大能分配的内存<ul><li>计算公式：(Physical RAM * vm.overcommit_ratio / 100) + Swap</li></ul></li><li>Committed_AS：当前已经分配的内存</li></ul><h3 id="OVERCOMMIT策略的可用内存判定"><a href="#OVERCOMMIT策略的可用内存判定" class="headerlink" title="OVERCOMMIT策略的可用内存判定"></a>OVERCOMMIT策略的可用内存判定</h3><ul><li>OVERCOMMIT_GUESS：判定可用内存 = free + buff/cache - share + Swap + SLAB已标记可回收的内存 - 系统运行预留的内存 - 管理员操作预留内存</li><li>OVERCOMMIT_ALWAYS：直接返回成功</li><li>OVERCOMMIT_NEVER：判断Committed_AS &lt; CommitLimit</li></ul><h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看overcommit策略</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/sys/vm/overcommit_memory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看进程OOM得分，oom_killer将首先杀死得分最高的进程</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/&lt;pid&gt;/oom_score</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看CommitLimit和Committed_AS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/meminfo |grep -i commit</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://blog.csdn.net/run_for_belief/article/details/83446344">Linux OOM killer机制介绍</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;OOM killer(Out Of Memory killer)是Linux内核的一种内存管理机制，该机制在系统物理内存不足时，选择性杀死一些进程以释放内存，以使系统继续运行。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/Linux/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Linux" scheme="http://www.lights8080.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Gateway与后端服务问题处理总结</title>
    <link href="http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/SpringCloud/Spring%20Cloud%20Gateway%E4%B8%8E%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/"/>
    <id>http://www.lights8080.com/2021/05/19/%E6%8A%80%E6%9C%AF/SpringCloud/Spring%20Cloud%20Gateway%E4%B8%8E%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/</id>
    <published>2021-05-18T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:41.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Spring Cloud Gateway相关问题分析、解决思路的过程。</p><ol><li>Connection prematurely closed BEFORE response</li><li>浪涌导致网关报错分析</li></ol></blockquote><span id="more"></span><h2 id="问题1（Connection-prematurely-closed-BEFORE-response）"><a href="#问题1（Connection-prematurely-closed-BEFORE-response）" class="headerlink" title="问题1（Connection prematurely closed BEFORE response）"></a>问题1（Connection prematurely closed BEFORE response）</h2><p>后端服务偶尔报错Connection prematurely closed BEFORE response。</p><p>这个问题的产生原因和解决办法网上很容易找到。我这里只贴出问题原理图和解决办法。<br>详细说明请参考<a href="https://javazhiyin.blog.csdn.net/article/details/112914264">https://javazhiyin.blog.csdn.net/article/details/112914264</a></p><p><strong>原理图</strong><br><img src="https://img-blog.csdnimg.cn/img_convert/87a7537eb4e30ab56e3f8a3d594ef544.png" alt="file"></p><p><strong>解决办法</strong></p><ol><li><p>spring cloud gateway增加jvm启动参数<br>后进先出策略，确保获取的连接最大概率是最近刚被用过的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dreactor.netty.pool.leasingStrategy=lifo</span><br></pre></td></tr></table></figure></li><li><p>后端服务配置<br>后端服务连接超时时长改为10秒（默认20s），超时没有数据交互则关闭连接。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">tomcat:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure></li><li><p>spring cloud gateway增加配置<br>设置连接的最大空闲时长为5秒（默认NULL：响应完成即可关闭），超时则关闭连接释放资源。<br>这个时长的设置要小于后端服务的连接超时时长，确保网关回收请求在后端服务回收请求之前完成。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-idle-time:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="问题2（浪涌导致网关报错分析）"><a href="#问题2（浪涌导致网关报错分析）" class="headerlink" title="问题2（浪涌导致网关报错分析）"></a>问题2（浪涌导致网关报错分析）</h2><blockquote><p>每天不定时出现响应失败，Nginx响应状态码出现大量的500和504，网关同样出现大量的500和504，后端服务正常。</p></blockquote><p>Nginx、Gateway、Service每小时统计数如下，其中Nginx，0点的数比较少是因为日志文件截取导致缺失<br><img src="https://img-blog.csdnimg.cn/img_convert/40470233cb556053f82cb6e3c6d1e615.png" alt="file"></p><ul><li>经过分析得到，2点是正常情况，Nginx-&gt;Gateway-&gt;Service数都对的上。</li><li>1点的数据显示Service收到的请求数减少，响应时间也正常，Gateway报错分为504：Gateway响应时间超过导致（配置的60s），500：Gateway连接超过导致（配置的3s），说明Gateway请求并未到达Service端。</li><li>查看Nginx和Gateway的连接数出现了激增，因为外部流量瞬间涌入导致服务器连接数资源被占用。<br><img src="https://img-blog.csdnimg.cn/img_convert/3bf64c40fde06be1e9c1f35e1d35e6f7.png" alt="file"><br><img src="https://img-blog.csdnimg.cn/img_convert/c0ae71367df1d41a1da2d5dd6626d3c2.png" alt="file"></li></ul><p><strong>优化方案</strong></p><ol><li><p>开启Gateway限流策略</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">200</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">50</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.requestedTokens:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">key-resolver:</span> <span class="string">&quot;#&#123;@userKeyResolver&#125;&quot;</span></span><br><span class="line">            <span class="attr">deny-empty-key:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></li><li><p>Gateway请求Service超时配置的60s，根据业务需要超过10s响应都视作无效，所以配置响应超时时间为10秒</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">response-timeout:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure></li><li><p>Gateway的连接池使用弹性方式，导致服务器连接数资源被占满，改为固定方式。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="comment"># 线程池类型，ELASTIC：弹性，FIXED：固定</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">FIXED</span></span><br><span class="line">          <span class="comment"># 超过此时间连接不使用就关闭</span></span><br><span class="line">          <span class="attr">max-idle-time:</span> <span class="number">5000</span></span><br><span class="line">          <span class="comment"># 线程池最大连接数，type=FIXED时有效</span></span><br><span class="line">          <span class="attr">max-connections:</span> <span class="number">200</span></span><br><span class="line">          <span class="comment"># 从线程池获取线程的最大等待时间，type=FIXED时有效</span></span><br><span class="line">          <span class="attr">acquire-timeout:</span> <span class="number">45000</span></span><br></pre></td></tr></table></figure></li><li><p>由于Gateway到不同的Service，响应时间不一样，可以在Service端的元数据信息中修改连接超时时间和响应超时时间</p></li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">response-timeout:</span> <span class="number">10000</span></span><br><span class="line">          <span class="attr">connect-timeout:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Spring Cloud Gateway相关问题分析、解决思路的过程。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Connection prematurely closed BEFORE response&lt;/li&gt;
&lt;li&gt;浪涌导致网关报错分析&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="SpringCloud" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/SpringCloud/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="SpringCloud" scheme="http://www.lights8080.com/tags/SpringCloud/"/>
    
    <category term="Spring Cloud Gateway" scheme="http://www.lights8080.com/tags/Spring-Cloud-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>思维乱撞</title>
    <link href="http://www.lights8080.com/2021/05/13/%E6%9D%82%E8%B0%88/%E6%80%9D%E7%BB%B4%E4%B9%B1%E6%92%9E/"/>
    <id>http://www.lights8080.com/2021/05/13/%E6%9D%82%E8%B0%88/%E6%80%9D%E7%BB%B4%E4%B9%B1%E6%92%9E/</id>
    <published>2021-05-12T16:00:00.000Z</published>
    <updated>2021-06-07T09:02:43.000Z</updated>
    
    <content type="html"><![CDATA[<p>思维局限性、美国个人支付、奋斗一生和及时行乐</p><span id="more"></span><p>如果发现一个软件很活跃，但你觉得用另一个产品不是更好吗甚至这个软件还有某些缺陷。那一定是你没有遇到适用场景，当遇到时，你会说这正是我想要的产品。</p><p>产品经理，应该从产品角度去思考用怎样的功能满足需求，而不是简单的把需求做成功能。</p><p>不懂产品，迎合需求，长期来看就是负债。</p><p>开发人员如果更懂产品，会写出更良好的结构化代码，而不是给代码打补丁。</p><hr><p>移动支付对我们来说太平常了。随处都可以拿出手机扫码支付。但是在美国个人支票几乎天天都还在用。出门购物刷信用卡/现金，金额较大的大都还用个人支票，比如：缴学费、交房租、还贷、包红包等。</p><p>我们看来这太落伍了，但站在系统角度，考虑健壮性和可用性，个人支票支付方式是个很好的方案。支付环境不依赖网络，设备，电力系统。单靠信用体系维护运行，零成本。</p><hr><p>有些人奋斗一生，生活水平提高了不少，但迫于社会价值观，内心所想被压抑一生。</p><p>有些人及时行乐，生活虽不富裕，但活的简简单单，随心所欲（在不伤害别人的前提下）。</p><p>艰苦奋斗还是随遇而安，卸掉社会属性，单从生命个体的角度看，怎样的一生更符合生命的本质呢？</p><p>写完之后我也不知道是怎么把它们联系在一起了。。。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;思维局限性、美国个人支付、奋斗一生和及时行乐&lt;/p&gt;</summary>
    
    
    
    <category term="杂谈" scheme="http://www.lights8080.com/categories/%E6%9D%82%E8%B0%88/"/>
    
    
    <category term="杂谈" scheme="http://www.lights8080.com/tags/%E6%9D%82%E8%B0%88/"/>
    
    <category term="美国个人支票" scheme="http://www.lights8080.com/tags/%E7%BE%8E%E5%9B%BD%E4%B8%AA%E4%BA%BA%E6%94%AF%E7%A5%A8/"/>
    
  </entry>
  
  <entry>
    <title>ELK-实践（架构选择&amp;部署说明）</title>
    <link href="http://www.lights8080.com/2021/05/10/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E6%9E%B6%E6%9E%84%E9%80%89%E6%8B%A9&amp;%E9%83%A8%E7%BD%B2%E8%AF%B4%E6%98%8E%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/05/10/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%AE%9E%E8%B7%B5%EF%BC%88%E6%9E%B6%E6%9E%84%E9%80%89%E6%8B%A9&amp;%E9%83%A8%E7%BD%B2%E8%AF%B4%E6%98%8E%EF%BC%89/</id>
    <published>2021-05-09T16:00:00.000Z</published>
    <updated>2021-06-07T06:07:28.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍业务规模和架构选择，以及部署说明。<br>基于7.11版本。</p></blockquote><span id="more"></span><h2 id="业务规模"><a href="#业务规模" class="headerlink" title="业务规模"></a>业务规模</h2><p>业务每天查询量在千万级，采集数据的规模上亿（后续会更大）。单台Logstash，数据延迟并不大，肉眼可见的Logstash的数据处理能力<br><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/2021/05/lmWxyk.jpg" alt="Logstash监控"></p><h2 id="架构选择"><a href="#架构选择" class="headerlink" title="架构选择"></a>架构选择</h2><p>ELK架构有很多种，这里简单列出常用的几个：</p><ul><li>架构1（最为简单）<br>Logstash -&gt; Elasticsearch -&gt; Kibana</li><li>架构2（使用Beats作为日志收集器）<br>Beats -&gt; Logstash -&gt; Elasticsearch -&gt; Kibana</li><li>架构3（引入消息队列）<br>Beats -&gt; Logstash -&gt; Kafka -&gt; Logstash -&gt; Elasticsearch -&gt; Kibana</li></ul><p>其中架构3可能是被大家积极推荐和最为认可的理想架构。优点是消息队列可以把数据缓存起来避免数据丢失，可以抵挡浪涌削峰填谷，保护下游Logstash。适用于日志规模比较庞大的场景。</p><p>但我的实践中采用的架构2，理由如下：</p><ul><li>消除不必要的复杂性，较低成本</li><li>关于数据丢失，Filebeat至少投递一次和Logstash持久队列可以解决这个问题</li><li>日志规模比较大的情况，可以水平扩展Logstash节点，一组Logstash之间实现负载</li><li>实践Logstash处理能力很强</li></ul><p><img src="https://www.elastic.co/guide/en/logstash/7.11/static/images/deploy3.png" alt="架构2"></p><h2 id="部署说明-amp-实践配置"><a href="#部署说明-amp-实践配置" class="headerlink" title="部署说明&amp;实践配置"></a>部署说明&amp;实践配置</h2><p>介绍服务器环境配置，以及Elasticsearch、Kibana、Logstash、Filebeat的部署和配置参考。</p><ul><li>logstash-7.11.2/config/lights.conf</li><li>filebeat-7.11.2/inputs.d/lights.yml<br>关于业务的这两个配置，不理解的请私信或留言吧</li></ul><h4 id="新建用户和修改文件夹权限"><a href="#新建用户和修改文件夹权限" class="headerlink" title="新建用户和修改文件夹权限"></a>新建用户和修改文件夹权限</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建用户</span></span><br><span class="line">$ groupadd elk</span><br><span class="line">$ useradd -m -d /home/elk -s /bin/bash -g elk elk</span><br><span class="line"><span class="comment"># 修改文件夹所属组</span></span><br><span class="line">$ chown -R elk:elk /opt/elk</span><br><span class="line">$ chown -R elk:elk /data/elk</span><br></pre></td></tr></table></figure><h4 id="修改系统配置"><a href="#修改系统配置" class="headerlink" title="修改系统配置"></a>修改系统配置</h4><ul><li><p>vim /etc/sysctl.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure></li><li><p>vim /etc/security/limits.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elk soft memlock unlimited</span><br><span class="line">elk hard memlock unlimited</span><br></pre></td></tr></table></figure></li></ul><h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><ul><li><p>vim bin/elasticsearch</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/elk/elasticsearch-7.11.2/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></li><li><p>vim config/jvm.options</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms8g</span><br><span class="line">-Xmx8g</span><br></pre></td></tr></table></figure></li><li><p>vim config/elasticsearch.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/data/elk/elasticsearch/data</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/data/elk/elasticsearch/logs</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="string">&quot;10.88.2.1&quot;</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;10.88.2.1&quot;</span>]</span><br><span class="line"><span class="comment">#discovery.type: single-node</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;10.88.2.1&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">bootstrap.system_call_filter:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ sh ./bin/elasticsearch -d -p es.pid</span><br><span class="line"><span class="comment"># 初始化内置用户</span></span><br><span class="line">$ bin/elasticsearch-setup-passwords auto</span><br></pre></td></tr></table></figure></li></ul><h4 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h4><ul><li><p>vim config/kibana.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">&quot;elk-1&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibana_system&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;xxxxxxx&quot;</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br><span class="line"><span class="attr">xpack.reporting.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="attr">xpack.security.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="attr">xpack.encryptedSavedObjects.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup sh ./bin/kibana &gt;kibana.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">netstat -napl|grep 5601</span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line"><span class="built_in">kill</span> &lt;port&gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h4><ul><li><p>vim config/jvm.options</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms4g</span><br><span class="line">-Xmx4g</span><br></pre></td></tr></table></figure></li><li><p>vim config/logstash.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pipeline.workers:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">queue.type:</span> <span class="string">persisted</span></span><br></pre></td></tr></table></figure></li><li><p>vim config/lights.conf</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略，请参考实践配置</span></span><br></pre></td></tr></table></figure><ul><li>命令<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试配置</span></span><br><span class="line">$ ./bin/logstash -f config/lights.conf --config.test_and_exit</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup ./bin/logstash -f config/lights.conf --config.reload.automatic &gt; logstash.log &amp;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h4><ul><li><p>vim filebeat.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.config.inputs:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/inputs.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">reload.period:</span> <span class="string">10s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.88.2.1:5044&quot;</span>]</span><br></pre></td></tr></table></figure></li><li><p>vim inputs.d/lights.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 略，请参考实践配置</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup ./filebeat -e &gt;filebeat.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Metricbeat"><a href="#Metricbeat" class="headerlink" title="Metricbeat"></a>Metricbeat</h4><ul><li><p>vim metricbeat.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">metricbeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">index.codec:</span> <span class="string">best_compression</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.kibana:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;10.88.2.1:5601&quot;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.88.2.1:9200&quot;</span>]</span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_host_metadata:</span> <span class="string">~</span></span><br></pre></td></tr></table></figure></li><li><p>vim modules.d/elasticsearch-xpack.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">xpack.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.88.2.1:9200&quot;</span>]</span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;password&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启elasticsearch模块</span></span><br><span class="line">$ ./metricbeat modules <span class="built_in">enable</span> elasticsearch-xpack</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ nohup ./metricbeat -e &gt;metricbeat.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍业务规模和架构选择，以及部署说明。&lt;br&gt;基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Beats-Filebeat命令&amp;配置说明</title>
    <link href="http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E5%91%BD%E4%BB%A4&amp;%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/"/>
    <id>http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E5%91%BD%E4%BB%A4&amp;%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E/</id>
    <published>2021-04-28T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:18.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍Filebeat命令、配置以及最佳实战。<br> 基于7.11版本。</p></blockquote><span id="more"></span><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><ul><li>export：导出配置到标准输出（configuration, index template, ILM policy, dashboard）</li><li>keystore：管理秘钥仓库</li><li>modules：管理模块配置</li><li>run：运行Filebeat。不知道命令的情况下，默认使用此命令<ul><li>–modules MODULE_LIST：指定运行的模块</li></ul></li><li>setup：一次性初始化环境。包括索引模板，ILM政策，写别名，Kibana仪表盘等<ul><li>–dashboards：设置Kibana仪表盘，需配置连接Kibana信息</li><li>–pipelines：设置Elasticsearch的ingest pipelines</li><li>-e：发送输出到标准错误而不是syslog</li><li>–index-management：设置与Elasticsearch索引管理相关的组件（template, ILM policy, and write alias）</li></ul></li><li>test：测试配置文件</li></ul><p>全局标记</p><ul><li>-E, –E “SETTING_NAME=VALUE”：覆盖指定的配置</li><li>-M, –M “VAR_NAME=VALUE”：覆盖默认的模块配置</li><li>-c, –c FILE：指定Filebeat的配置文件</li><li>-f：指定管道配置文件</li><li>-d, –d SELECTORS：调试选择器，”*”：开启所有组件的调试，”publish”：开启调试”publish“相关信息</li><li>-e, –e：日志发送到stderr并禁用syslog文件输出</li><li>–path.config：设置配置文件路径</li></ul><p>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 一次性设置Elasticsearch索引和Kibana仪表板，-e：发送输出到标准错误而不是syslog</span></span><br><span class="line">./filebeat setup -e</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用要运行的模块</span></span><br><span class="line">./filebeat modules enable system</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">sudo chown root filebeat.yml </span><br><span class="line">sudo ./filebeat -c filebeat.yml -e</span><br></pre></td></tr></table></figure><h2 id="配置说明-filebeat-yml"><a href="#配置说明-filebeat-yml" class="headerlink" title="配置说明 filebeat.yml"></a>配置说明 filebeat.yml</h2><ul><li>project paths：项目路径</li><li>general settings：配置包括Global、General</li><li>config file loading：允许外部加载inputs和modules配置</li><li>modules：一种开始处理常见日志格式的快速方法</li><li>inputs：指定Filebeat查找和处理的数据</li><li>output：指定输出。如：Logstash、Elasticsearch、Kafka</li><li>Processors：过滤和增强导出的数据</li><li>internal queue：存储事件的内部缓冲队列（内存和磁盘），负责缓冲输入事件并按批次发送到输出。</li><li>load balancing：配置输出的负载均衡</li><li>logging：Filebeat日志输出选项</li><li>http endpoint：Filebeat通过端点查看内部指标</li><li>autodiscover：容器运行时，自动发现配置，移动目标的监视系统</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### project Paths</span></span><br><span class="line"><span class="comment"># Filebeat主目录，默认安装路径</span></span><br><span class="line"><span class="attr">path.home:</span> </span><br><span class="line"><span class="attr">path.config:</span> <span class="string">$&#123;path.home&#125;</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">$&#123;path.home&#125;/data</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">$&#123;path.home&#125;/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Global Filebeat configuration options</span></span><br><span class="line"><span class="comment"># 注册表的根路径，默认$&#123;path.data&#125;/registry</span></span><br><span class="line"><span class="attr">filebeat.registry.path:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">filebeat.registry.file_permissions:</span> <span class="number">0600</span></span><br><span class="line"><span class="comment"># 控制何时将注册表项写入磁盘(刷新)的超时值</span></span><br><span class="line"><span class="attr">filebeat.registry.flush:</span> <span class="string">0s</span></span><br><span class="line"><span class="comment"># Filebeat 在关闭之前等待发布者完成发送事件的关闭时间</span></span><br><span class="line"><span class="attr">filebeat.shutdown_timeout:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### General configuration options</span></span><br><span class="line"><span class="comment"># Beat的名字，默认使用主机名</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="comment"># 标记列表，方便Kibana或Logstash过滤，如服务层，集群名等</span></span><br><span class="line"><span class="attr">tags:</span> [<span class="string">&quot;service-X&quot;</span>, <span class="string">&quot;web-tier&quot;</span>]</span><br><span class="line"><span class="comment"># 属性中添加附加信息的可选字段，如环境信息</span></span><br><span class="line"><span class="attr">fields:</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">staging</span></span><br><span class="line">  <span class="attr">service_name:</span> <span class="string">service-X</span></span><br><span class="line"><span class="comment"># 将自定义字段作为顶级字段存储到到输出文档中，默认false</span></span><br><span class="line"><span class="attr">fields_under_root:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Processors configuration</span></span><br><span class="line"><span class="comment"># 定义模块的处理器，删除所有DEBUG消息</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">drop_event:</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="attr">regexp:</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;^DBG:&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Logging</span></span><br><span class="line"><span class="attr">logging.level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">logging.to_files:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">logging.files:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/var/log/filebeat</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="comment"># 日志文件最大大小，默认10M</span></span><br><span class="line">  <span class="attr">rotateeverybytes:</span> <span class="number">10485760</span></span><br><span class="line">  <span class="comment"># 日志滚动删除旧文件，默认7</span></span><br><span class="line">  <span class="attr">keepfiles:</span> <span class="number">7</span></span><br><span class="line">  <span class="comment"># 日志文件滚动周期，默认禁用</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">24h</span></span><br><span class="line">  <span class="comment"># 标准错误记录到日志文件中</span></span><br><span class="line">  <span class="attr">redirect_stderr:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 定期记录内部发生变化的指标，默认开启</span></span><br><span class="line"><span class="attr">logging.metrics.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 记录内部指标的时间</span></span><br><span class="line"><span class="attr">logging.metrics.period:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 外部配置</span></span><br><span class="line"><span class="attr">filebeat.config.inputs:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 要检查的更改文件路径</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">configs/*.yml</span></span><br><span class="line">  <span class="comment"># 开启配置动态加载</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 指定检查文件更改的频率</span></span><br><span class="line">  <span class="attr">reload.period:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 日志输入</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/var/log/wifi.log&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/var/log/apache2/*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/var/log/*/*.log&quot;</span></span><br><span class="line">  <span class="comment"># 递归模式，默认false。For example: /foo/** expands to /foo, /foo/*, /foo/*/*, and so on</span></span><br><span class="line">  <span class="attr">recursive_glob.enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 文件编码</span></span><br><span class="line">  <span class="attr">encoding:</span> <span class="string">plain</span></span><br><span class="line">  <span class="comment"># 设置标记文件的位置</span></span><br><span class="line">  <span class="attr">file_identity.inode_marker.path:</span> <span class="string">/logs/.filebeat-marker</span></span><br><span class="line">  <span class="comment"># 标记列表，方便Kibana或Logstash过滤</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;service-X&quot;</span>, <span class="string">&quot;web-tier&quot;</span>]</span><br><span class="line">  <span class="comment"># 属性中添加附加信息的可选字段</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">staging</span></span><br><span class="line">  <span class="comment"># 将自定义字段作为顶级字段存储到到输出文档中</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 包含的正则表达式列表，先于exclude_lines执行</span></span><br><span class="line">  <span class="attr">include_lines:</span> [<span class="string">&#x27;^ERR&#x27;</span>, <span class="string">&#x27;^WARN&#x27;</span>]</span><br><span class="line">  <span class="comment"># 排除的正则表达式列表</span></span><br><span class="line">  <span class="attr">exclude_lines:</span> [<span class="string">&#x27;^DBG&#x27;</span>]</span><br><span class="line">  <span class="comment"># 多行消息匹配,Java 堆栈跟踪的例子（https://www.elastic.co/guide/en/beats/filebeat/7.x/multiline-examples.html）</span></span><br><span class="line">  <span class="attr">multiline.type:</span> <span class="string">pattern</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^[[:space:]]+(at|\.&#123;3&#125;)[[:space:]]+\b|^Caused by:&#x27;</span></span><br><span class="line">  <span class="comment"># 否定模式，true：没有匹配的行作为事件行的连贯行；false：匹配的行作为事件行的连贯行。默认false。</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 连贯行组合事件行之前（before）还是之后（after）</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">  <span class="comment"># 每个收割机获取文件时使用的缓冲区大小</span></span><br><span class="line">  <span class="attr">harvester_buffer_size:</span> <span class="number">16384</span></span><br><span class="line">  <span class="comment"># 单个日志消息的最大字节数，超出部分丢弃（10M）</span></span><br><span class="line">  <span class="attr">max_bytes:</span> <span class="number">10485760</span></span><br><span class="line">  <span class="comment"># 排除文件</span></span><br><span class="line">  <span class="attr">exclude_files:</span> [<span class="string">&#x27;\.gz$&#x27;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="comment">##### Harvester closing options</span></span><br><span class="line">  <span class="comment"># 指定的时间段后关闭文件句柄，基于文件的修改，被扫描到后继续进行。建议设置一个大于最少更新频率的值，默认5分钟</span></span><br><span class="line">  <span class="attr">close_inactive:</span> <span class="string">5m</span></span><br><span class="line">  <span class="comment"># 重命名或移动文件时关闭收割机，默认关闭</span></span><br><span class="line">  <span class="attr">close_renamed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 删除文件时立马关闭收割机，当文件再次出现时被扫描到后继续进行，默认启用</span></span><br><span class="line">  <span class="attr">close_removed:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 收割机到达文件末尾时立刻关闭，默认禁用</span></span><br><span class="line">  <span class="attr">close_eof:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 指定时间后关闭，按照扫描频路再次开启新的收割机，默认禁用</span></span><br><span class="line">  <span class="attr">close_timeout:</span> <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">##### State options</span></span><br><span class="line">  <span class="comment"># 指定时间段后文件无更新，则清除注册表中的状态，默认0，表示禁用清除注册表。clean_inactive设置必须大于ignore_older + scan_frequency，否则可能导致不断的重新发送全部内容</span></span><br><span class="line">  <span class="attr">clean_inactive:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 重命名或移动的文件，注册表中的状态将被清除。默认开启</span></span><br><span class="line">  <span class="attr">clean_removed:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 扫描频率，默认10秒</span></span><br><span class="line">  <span class="attr">scan_frequency:</span> <span class="string">10s</span></span><br><span class="line">  <span class="comment"># 扫描顺序，默认禁用，可选值：modtime|filename。如果为此设置指定值，则可以使用scan.order配置文件是按升序还是降序进行扫描</span></span><br><span class="line">  <span class="attr">scan.sort:</span> </span><br><span class="line">  <span class="attr">scan.order:</span> <span class="string">asc|desc</span></span><br><span class="line">  <span class="comment"># Filebeat 将开始在每个文件的结尾而不是开始读取新文件，适用于Filebeat尚未处理的文件。如果已经运行过Filebeat并且文件的状态已经保留，则tail_files配置无效。</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 忽略在指定时间跨度之前修改的所有文件，依赖于文件的修改时间。默认0，不忽略任何文件。必须大于close_inactive</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 限制并行启动的收割机数量</span></span><br><span class="line">  <span class="attr">harvester_limit:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># 根据文件的inode和设备id来区分文件</span></span><br><span class="line">  <span class="attr">file_identity.native:</span> <span class="string">~</span></span><br><span class="line">  <span class="comment"># 根据路径来区分文件</span></span><br><span class="line">  <span class="attr">file_identity.path:</span> <span class="string">~</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 日志输出</span></span><br><span class="line"><span class="attr">output.kafka:</span></span><br><span class="line">  <span class="comment"># kafka服务器</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;kafka1:9092&quot;</span>, <span class="string">&quot;kafka2:9092&quot;</span>, <span class="string">&quot;kafka3:9092&quot;</span>]</span><br><span class="line">  <span class="comment"># 动态设置topic</span></span><br><span class="line">  <span class="attr">topic:</span> <span class="string">&#x27;<span class="template-variable">%&#123;[fields.log_topic]&#125;</span>&#x27;</span></span><br><span class="line">  <span class="comment"># 事件将仅发布到可用分区</span></span><br><span class="line">  <span class="attr">partition.round_robin:</span></span><br><span class="line">    <span class="attr">reachable_only:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># ACK可靠性级别，默认1。0 = no response，1 = wait for local commit，-1 = wait for all replica to commit</span></span><br><span class="line">  <span class="attr">required_acks:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># gzip压缩级别，0禁用压缩</span></span><br><span class="line">  <span class="attr">compression:</span> <span class="string">gzip</span></span><br><span class="line">  <span class="attr">compression_level:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># 消息的最大字节数</span></span><br><span class="line">  <span class="attr">max_message_bytes:</span> <span class="number">1000000</span></span><br><span class="line"><span class="comment"># 负载均衡的Logstash</span></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;localhost:5044&quot;</span>, <span class="string">&quot;localhost:5045&quot;</span>]</span><br><span class="line">  <span class="attr">loadbalance:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">worker:</span> <span class="number">2</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">### Internal queue</span></span><br><span class="line"><span class="comment"># 用于缓冲要发布的事件的内部队列配置。默认mem（内存队列）</span></span><br><span class="line"><span class="attr">queue.mem:</span></span><br><span class="line">  <span class="comment"># 内存队列的最大缓冲事件数</span></span><br><span class="line">  <span class="attr">events:</span> <span class="number">4096</span></span><br><span class="line">  <span class="comment"># 发布所需的最小事件数，设置为0则发布事件直接输出使用，无需等待</span></span><br><span class="line">  <span class="attr">flush.min_events:</span> <span class="number">2048</span></span><br><span class="line">  <span class="comment"># 达到flush.min_events的最大等待事件，设置为0则无需等待</span></span><br><span class="line">  <span class="attr">flush.timeout:</span> <span class="string">1s</span></span><br><span class="line"><span class="attr">queue.disk:</span></span><br><span class="line">  <span class="comment"># 启用磁盘队列，指定最大大小既使用空间</span></span><br><span class="line">  <span class="attr">max_size:</span> <span class="string">10GB</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.data&#125;/diskqueue</span></span><br><span class="line">  <span class="comment"># 队列文件以段的形式保存，每个段包含一些待发送到输出的事件，所有事件发送后删除</span></span><br><span class="line">  <span class="attr">segment_size:</span> <span class="string">max_size</span> <span class="string">/</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># 当事件等待输出时，从磁盘读取到内存中的事件数。调高此值可以提高输出速度，但是会占用更多内存</span></span><br><span class="line">  <span class="attr">read_ahead:</span> <span class="number">512</span></span><br><span class="line">  <span class="comment"># 队列等待事件写入磁盘时可以存储到内存中的事件数</span></span><br><span class="line">  <span class="attr">write_ahead:</span> <span class="number">2048</span></span><br><span class="line">  <span class="comment"># 磁盘错误导致的队列操作失败，重试间隔时间</span></span><br><span class="line">  <span class="attr">retry_interval:</span> <span class="string">1s</span></span><br><span class="line">  <span class="comment"># 多个连续的写入磁盘错误，队列将重试间隔增加2倍，最大间隔时间</span></span><br><span class="line">  <span class="attr">max_retry_interval:</span> <span class="string">30s</span></span><br><span class="line"><span class="attr">queue.spool:</span></span><br></pre></td></tr></table></figure><h2 id="最佳实践调优"><a href="#最佳实践调优" class="headerlink" title="最佳实践调优"></a>最佳实践调优</h2><ul><li><p>文件内容变更延迟发送事件调优<br>默认基于内存缓冲事件，最晚需要11s才会发布事件到输出。<br><code>filebeat.inputs.type:log.scan_frequency: 10s</code>：文件的扫描频率<br><code>queue.mem.flush.timeout: 1s</code>：缓冲事件的超时时间<br><code>queue.mem.flush.min_events: 2048</code>：超时时间内发布事件所需的最小缓冲数</p></li><li><p>测试时编辑文件导致整个文件内容重新发送<br>不要用vim修改，使用<code>echo &quot;xxx&quot; &gt;&gt; log_file</code></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍Filebeat命令、配置以及最佳实战。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Filebeat" scheme="http://www.lights8080.com/tags/Filebeat/"/>
    
  </entry>
  
  <entry>
    <title>Kibana-介绍</title>
    <link href="http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Kibana-%E4%BB%8B%E7%BB%8D/"/>
    <id>http://www.lights8080.com/2021/04/29/%E6%8A%80%E6%9C%AF/ELK/Kibana-%E4%BB%8B%E7%BB%8D/</id>
    <published>2021-04-28T16:00:00.000Z</published>
    <updated>2021-06-07T01:58:36.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍Kibana的侧边栏、面板类型、配置说明等。<br> 基于7.11版本。</p></blockquote><span id="more"></span><h1 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h1><blockquote><p>Kibana是一个开源分析和可视化平台，旨在与Elasticsearch协同工作。您使用Kibana搜索，查看和与存储在Elasticsearch索引中的数据进行交互。您可以轻松执行高级数据分析，并在各种图表，表格和地图中可视化您的数据。<br><a href="https://www.elastic.co/guide/en/kibana/7.11/index.html">https://www.elastic.co/guide/en/kibana/7.11/index.html</a></p></blockquote><h2 id="侧边栏"><a href="#侧边栏" class="headerlink" title="侧边栏"></a>侧边栏</h2><ul><li>Discover（数据探索）：搜索、过滤和展示所选索引模型（Index Pattern）文档数据</li><li>Visualize（可视化）：为数据创建可视化控件</li><li>Dashboard（仪表盘）：展示保存的可视化结果集合</li><li>Canvas（画布）：非常自由灵活对数据进行可视化布局与展现</li><li>Maps（地图）：已地图的方式展示聚合信息</li><li>Machine Learning（机器学习）</li><li>Infrastructure（基础设施监控）：通过metricbeat监控基础服务。如：redis、rocketmq</li><li>Metrics（度量应用）：探索整个生态系统中有关系统和服务的指标</li><li>Logs（日志）：实时跟踪相关的日志数据；提供了一个紧凑的，类似控制台的显示器。可以实时日志拖尾</li><li>APM（Application Performance Monitoring-应用程序性能监视）：业务跟踪及监控。</li><li>Uptime（正常运行时间）：监控应用程序和服务的可用性问题；通过HTTP/S，TCP和ICMP监控网络端点的状态</li><li>SIEM（Security Information &amp; Event Management-安全信息与事件管理）：安全分析师的高度交互式工作区</li><li>Dev Tools（开发工具）：包括控制台、查询分析和聚合</li><li>Stack Monitoring（ELK监控）：可视化监控数据</li><li>Management（Kibana管理）：包括索引模式的初始设置和持续配置等</li></ul><h3 id="Dashboard（仪表板）"><a href="#Dashboard（仪表板）" class="headerlink" title="Dashboard（仪表板）"></a>Dashboard（仪表板）</h3><p>仪表板是用于分析数据的面板的集合。在仪表板上，您可以添加各种面板，可以重新排列并讲述关于数据的故事。</p><p>编辑仪表板：</p><ul><li>Add controls（添加控制器）</li><li>Add markdown（添加说明文档）</li><li>Arrange panels（面板排版）</li><li>Clone panels（克隆面板）</li><li>Customize time ranges（自定义时间范围）</li></ul><p>探索仪表板数据：</p><ul><li>Inspect elements（检查元素）：查看可视化和保存的搜索背后的数据和请求</li><li>Explore underlying data（探索面板底层数据）：可以在其中查看和过滤可视化面板中的数据，为了探索仪表板上面板的底层数据，Kibana打开了Discover，可视化的索引模式、筛选器、查询和时间范围将继续应用。仅适用于单个索引模式的面板</li></ul><p>自定义仪表板操作：</p><ul><li>Dashboard drilldowns（仪表盘深度探讨）：能够从另一个仪表板打开仪表板，带有时间范围、过滤器和其他参数，因此上下文保持不变。仪表板钻取可以帮助您从一个新的角度继续分析。</li><li>URL drilldowns（URL深度探讨）：能够从仪表板导航到内部或外部URL。目标URL可以是动态的，这取决于仪表板上下文或用户与面板的交互。</li></ul><p>共享仪表板：</p><ul><li>将代码嵌入网页中，必须具有Kibana访问权限才能查看嵌入式仪表板</li><li>直接链接到 Kibana 的控制面板</li><li>生成PDF/PNG报告</li></ul><h4 id="面板类型"><a href="#面板类型" class="headerlink" title="面板类型"></a>面板类型</h4><ul><li>Area（面积图）：使用面积图比较两个或多个类别随时间变化的趋势，并显示趋势的幅度。</li><li>Stacked Area（堆积面积图）：使用堆积面积图可视化部分-整体关系，并显示每个类别对累积总数的贡献。</li><li>Bar（条形图）：使用条形图对大量类别的数据进行比较，也支持水平条形图。</li><li>Stacked bar（堆积条形图）：使用堆叠的条形图可以比较分类值级别之间的数值。</li><li>Line（折线图）：使用折线图可以直观地显示一系列值，发现一段时间内的趋势并预测未来值。</li><li>Pie（饼图）：使用饼图显示多个类别之间的比较，说明一个类别相对于其他类别的优势，并显示百分比或比例数据。</li><li>Donut（甜甜圈图）：与饼形图相似，但删除了中心圆。当您想一次显示多个统计信息时，请使用甜甜圈图。</li><li>Tree map（树图）：将数据的不同部分关联到整体，使用树图可以有效利用空间来显示每个类别的总计百分比。</li><li>Heat map（热图）：显示数据的图形表示形式，其中各个值由颜色表示。当数据集包含范畴数据时，使用热图。</li><li>Goal（进度图）：显示指标如何朝固定目标发展，使用目标显示目标进度状态的易于阅读的视觉效果。</li><li>Gauge（计量图）：沿比例尺显示数据，使用计量图来显示度量值与参考阈值的关系。</li><li>Metric（度量值）：显示聚合的单个数值。</li><li>Data table（表格数据）：以表格格式显示原始数据或聚合结果。</li><li>Tag cloud（标签云）：显示单词在出现的频率，使用标签云可以轻松生成大型文档的摘要。</li><li>Maps（地图）</li><li>Lens（透镜）：创建强大的数据可视化效果的最简单、最快捷的方法。可以将任意多的数据字段拖放到可视化构建窗格中。</li><li>TSVB（时间序列数据）：TSVB是时间序列数据可视化工具，充分利用Elasticsearch聚合框架的功能。可以组合无数个聚合来显示数据。支持：选择不同的数据展示方式、叠加注释事件等。</li><li>Timelion（时间序列数据）：时间序列数据可视化工具，可以在单个可视化文件中组合独立的数据源。在7.0及更高版本中，不建议使用Timelion应用。</li><li>Vega（自定义可视化）：使用Vega和Vega-Lite构建自定义可视化，并由一个或多个数据源支持。支持：使用嵌套或父/子映射的聚合、没有索引模式的聚合、自定义时间过滤器查询、复杂的计算、从_source而不是聚合中提取数据等。</li><li>Controls（控制器）：可以实时过滤面板上的数据，支持选择列表和范围滑杆</li><li>Markdown（文本编辑器）：当您要将上下文（例如重要信息，说明和图像）添加到仪表板上的其他面板时，请使用Markdown。</li></ul><h3 id="Alerts-and-Actions（监控警报）"><a href="#Alerts-and-Actions（监控警报）" class="headerlink" title="Alerts and Actions（监控警报）"></a>Alerts and Actions（监控警报）</h3><ul><li>General alert details（警报详细信息）：<ul><li>Name：警报名称，显示在警报列表，帮助识别和查询警报</li><li>Tags：警报标签列表，显示在警报列表，有助于查询和组织警报</li><li>Check every：检查警报条件的频率</li><li>Notify every：限制重复报警的频率</li></ul></li><li>Alert type and conditions（警报类型和条件）：选择不同的警报类型不同的条件表达形式。<ul><li>Index threshold：索引阈值警报类型</li></ul></li><li>Action type and action details（动作类型和详细信息）：每个操作都必须指定一个连接器实例。<ul><li>Index：Index data into Elasticsearch</li><li>Email：Send email from your server</li><li>Server log：Add a message to a Kibana log</li><li>Webhook：Send a request to a web service</li></ul></li></ul><h3 id="Graph（图形分析）"><a href="#Graph（图形分析）" class="headerlink" title="Graph（图形分析）"></a>Graph（图形分析）</h3><p>图形分析功能使您能够发现 Elasticsearch 索引中的项目是如何相关的。您可以研究索引词汇之间的连接，并查看哪些连接最有意义。这在各种应用程序中都很有用，从欺诈检测到推荐引擎。</p><p>例如，图形浏览可以帮助您发现黑客所针对的网站漏洞，从而可以加固您的网站。或者，您可以向电子商务客户提供基于图的个性化推荐。</p><p>图形分析特性为 Kibana 提供了一个简单但强大的图形探索 API 和一个交互式图形可视化工具。两者都可以在现有的 Elasticsearch 索引中使用ー你不需要存储任何额外的数据来使用这些特性。</p><h2 id="kibana-yml"><a href="#kibana-yml" class="headerlink" title="kibana.yml"></a>kibana.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">&quot;elk-1&quot;</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;http://your_elasticsearch_host:9200&quot;</span>]</span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibana_system&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;xxxxxxxxxxxxxxx&quot;</span></span><br><span class="line"><span class="comment"># 防止会话在重启时失效</span></span><br><span class="line"><span class="attr">xpack.security.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="comment"># 防止挂起的报告在重新启动时失败</span></span><br><span class="line"><span class="attr">xpack.reporting.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br></pre></td></tr></table></figure><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="1-创建索引失败"><a href="#1-创建索引失败" class="headerlink" title="1. 创建索引失败"></a>1. 创建索引失败</h3><p>错误信息：POST 403 (forbidden) on create index pattern<br>解决办法：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT _settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;blocks&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;read_only_allow_delete&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍Kibana的侧边栏、面板类型、配置说明等。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Kibana" scheme="http://www.lights8080.com/tags/Kibana/"/>
    
  </entry>
  
  <entry>
    <title>Beats-Filebeat介绍</title>
    <link href="http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E4%BB%8B%E7%BB%8D/"/>
    <id>http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/Beats-Filebeat%E4%BB%8B%E7%BB%8D/</id>
    <published>2021-04-27T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:21.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Filebeat介绍，包括工作方式、模块、如何避免数据重复、处理器的速查表。<br> 基于7.11版本。</p></blockquote><span id="more"></span><p>Beats是一款轻量级数据采集器，你可以将它作为代理程序安装在你的服务器上，然后将操作数据发送到 Elasticsearch。可以直接发送数据到 Elasticsearch 或者通过 Logstash，在那里你可以进一步处理和增强数据。</p><ul><li>Filebeat（日志文件）</li><li>Metricbeat（指标）</li><li>Heartbeat（可用性监控）</li><li>Functionbeat（函数计算采集器）</li></ul><h2 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h2><blockquote><p>Filebeat是用于转发集中日志数据的传输工具。作为服务器上的代理安装，收集日志事件，并将它们转发到Elasticsearch或Logstash。<br><a href="https://www.elastic.co/guide/en/beats/filebeat/7.11/index.html">https://www.elastic.co/guide/en/beats/filebeat/7.11/index.html</a></p></blockquote><h3 id="工作方式"><a href="#工作方式" class="headerlink" title="工作方式"></a>工作方式</h3><p>当启动Filebeat，会根据显示指定的日志数据启动一个或多个输入，每个日志文件都会启动一个收割机（harvester）。每个收割机会读取日志的最新内容，并将日志数据发送到libbeat，libbeat汇总事件并发送到输出。</p><img src="https://gitee.com/lights8080/lights8080-oss/raw/master/uPic/StbFBm.jpg" alt="IMAGE"/><p>Filebeat由两个主要部分组成：inputs和harvesters。它们一起工作以尾部文件将事件数据发送到指定的输出。</p><p>收割机（harvesters）：一个收割机负责读取单个文件的内容。收割机逐行读取每个文件并将内容发送到输出。每个文件启动一个收割机负责打开和关闭文件，收割机运行时文件描述符保持打开状态。如果文件被删除或重命名，Filebeat将继续读取该文件，副作用是磁盘上的空间将保留到收割机关闭为止。</p><p>输入（inputs）：一个输入负责管理收割机并查找所有可读取的资源。日志类型输入检查每个文件，以查看收割机是否需要启动，是否已经运行，或是否需要忽略该文件。自收割机关闭之后，如果文件大小有更改才会获取新行。</p><p>Filebeat保持每个文件的状态，并经常将状态刷新到磁盘的注册表文件。该状态用于记录收割机正在读取的最后一个偏移量并确保发送所有的日志行。如果输出不可达，则Filebeat会保持跟踪发送的最后几行，并在输出可用时继续读取文件。Filebeat运行时状态信息也会保持在内存中，当Filebeat重启时，将使用注册文件中的数据重新构建状态，并且在最后一个已知位置继续每个收割机。</p><p>对于每个输入，Filebeat会保持每个文件的状态。由于文件可以重命名和移动，因此文件名和路径不能标识一个文件。Filebeat将存储每个文件的唯一标识符以检测文件是否以前被获取过。</p><p>Filebeat保证事件将至少一次传递到输出，并且不会丢失数据。因为他在注册文件中存储了每个事件的传递状态。如果输出被阻止或未确认所有事件的情况下，Filebeat将继续尝试发送事件，直到输出确认接收为止。如果Filebeat在发送事件的过程中关闭，则不会等待输出确认所有的事件。重启Filebeat时，将再次发送关闭之前输出未确认的所有事件。这样可以确保每个事件至少发送一次，但是有可能会重复发送。</p><h3 id="如何避免Elasticsearch数据重复"><a href="#如何避免Elasticsearch数据重复" class="headerlink" title="如何避免Elasticsearch数据重复"></a>如何避免Elasticsearch数据重复</h3><p>由于Beats框架确保至少一次交付，又由于Elasticsearch的文档ID通常是接受到数据后才设置的，因此重复事件被索引为新文档。通过在建立索引期间设置，则Elasticsearch会覆盖现有文档而不是新创建一个新文档。</p><ol><li>在Beats中设置文档ID。</li><li>在Logstash管道设置文档ID。</li></ol><h3 id="填充地理位置信息"><a href="#填充地理位置信息" class="headerlink" title="填充地理位置信息"></a>填充地理位置信息</h3><p>基于IP地址填充地理位置信息。然后可以使用此信息来可视化IP地址在地图中的位置。</p><ol><li>Filebeat与Elasticsearch中的GoeIp处理器一起使用</li><li>Logstash中使用GeoIP过滤器</li></ol><h3 id="模块（Modules）"><a href="#模块（Modules）" class="headerlink" title="模块（Modules）"></a>模块（Modules）</h3><blockquote><p>Filebeat模块简化了常见的日志格式的收集，解析和可视化。每个Filebeat模块由一个或多个文件集组成，这些文件集包含摄取节点管道（ingest node pipelines），Elasticsearch模板，Filebeat输入配置和Kibana仪表板。</p></blockquote><ul><li>use ingest pipelines for parsing</li><li>use Logstash pipelines for parsing</li></ul><p>如Nginx日志，由一个或多个文件集组成（access和error）：</p><ul><li>Filebeat输入配置要查找的日志文件路径，还负责在需要时将多行事件缝合在一起。</li><li>Elasticsearch Ingest Node管道定义，用于解析日志行。</li><li>定义字段，为每个字段正确的配置到Elasticsearch。</li><li>Kibana仪表盘可视化日志文件</li></ul><h3 id="处理器（Processors）"><a href="#处理器（Processors）" class="headerlink" title="处理器（Processors）"></a>处理器（Processors）</h3><h4 id="过滤和增强数据的处理器"><a href="#过滤和增强数据的处理器" class="headerlink" title="过滤和增强数据的处理器"></a>过滤和增强数据的处理器</h4><p>如果只需要导出的数据的一部分或者需要增强导出数据。Filebeat提供了两个选项来过滤和增强导出的数据。</p><ol><li>可以为每个输入指定包含和排除的行或文件，需要为每个输入配置选项。（include_lines, exclude_lines, and exclude_files options）</li><li>定义处理器（Processor）可以的导出的所有数据进行全局处理。</li></ol><p>可以在配置中定义处理器，在发送到输出之前处理所有事件。libbeat提供的处理器分为：</p><ul><li>减少导出字段</li><li>增加元数据增强事件</li><li>执行其他处理和解码</li></ul><p>每个处理器都接收一个事件，对该事件应用已定义的操作，然后返回该事件。如果定义处理器列表，则将按照在Filebeat配置文件中定义的顺序执行它们。<br>执行顺序：event -&gt; processor 1 -&gt; event1 -&gt; processor 2 -&gt; event2 …</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">if:</span></span><br><span class="line">      <span class="string">&lt;condition&gt;</span></span><br><span class="line">    <span class="attr">then:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">    <span class="attr">else:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&lt;processor_name&gt;:</span></span><br><span class="line">          <span class="string">&lt;parameters&gt;</span></span><br><span class="line">      <span class="string">...</span></span><br></pre></td></tr></table></figure><ul><li><p>add_docker_metadata<br>使用来自Docker容器的相关元数据注释每个事件。包括（Container ID、Name、Image、Labels）</p></li><li><p>add_fields<br>将其他字段添加到事件中</p></li><li><p>add_host_metadata<br>为事件添加主机信息</p></li><li><p>add_id<br>为事件生成唯一的ID</p></li><li><p>add_labels<br>将一组键值对添加到事件</p></li><li><p>add_locale<br>通过将机器的时区偏离UTC或时区名称来丰富每个事件</p></li><li><p>add_tags<br>将标签添加到标签列表中</p></li><li><p>convert<br>将事件中的字段转换为其他类型，例如将字符串转换为整数。</p></li><li><p>copy_fields<br>将一个字段复制到另一个字段。</p></li><li><p>decode_base64_field<br>指定要对base64进行解码的字段</p></li><li><p>dissect<br>解剖处理器使用定义的模式对传入的字符串进行标记</p></li><li><p>drop_event<br>如果满足相关条件，则drop_event处理器将丢弃整个事件。条件是强制性的，因为没有一个条件，所有事件都将被丢弃</p></li><li><p>drop_fields<br>指定在满足特定条件时要删除的字段，条件是可选的。@timestamp和type字段在列表中，也不能删除他们。</p></li><li><p>fingerprint<br>根据事件字段的指定子集生成事件的指纹。</p></li><li><p>include_fields<br>指定在满足特定条件时要导出的字段，条件是可选的。@timestamp和type字段，也始终将其导出。</p></li><li><p>rename<br>指定要重命名的字段的列表。</p></li><li><p>script<br>执行Javascript代码以处理事件。该处理器使用ECMAScript 5.1的纯Go实现，并且没有外部依赖性。</p></li><li><p>timestamp<br>时间戳处理器从字段解析时间戳。默认情况下，时间戳处理器将已解析的结果写入@timestamp字段。</p></li><li><p>truncate_fields<br>将字段截断为给定的大小。如果字段的大小小于限制，则该字段将保持不变。</p></li><li><p>urldecode<br>指定要从URL编码格式解码的字段列表</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Filebeat介绍，包括工作方式、模块、如何避免数据重复、处理器的速查表。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Filebeat" scheme="http://www.lights8080.com/tags/Filebeat/"/>
    
  </entry>
  
  <entry>
    <title>ELK-加密通信的说明和配置教程</title>
    <link href="http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1%E7%9A%84%E8%AF%B4%E6%98%8E%E5%92%8C%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/"/>
    <id>http://www.lights8080.com/2021/04/28/%E6%8A%80%E6%9C%AF/ELK/ELK-%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1%E7%9A%84%E8%AF%B4%E6%98%8E%E5%92%8C%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/</id>
    <published>2021-04-27T16:00:00.000Z</published>
    <updated>2021-06-07T01:58:46.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>介绍Elasticsearch节点之间的加密通信、浏览器与Kibana之间的加密通信、Kibana与Elasticsearch之间的加密通信、操作步骤和配置说明。<br>基于7.11。</p></blockquote><span id="more"></span><h2 id="1-Elasticsearch加密通信"><a href="#1-Elasticsearch加密通信" class="headerlink" title="1 Elasticsearch加密通信"></a>1 Elasticsearch加密通信</h2><p>Elastic Stack安全特性能够加密加密往返于Elasticsearch集群以及从其内部的通信。使用传输层安全性(TLS/SSL)保护连接的安全。<br>未启用加密的群集将以纯文本格式（包括密码）发送所有数据。如果启用了Elasticsearch安全功能，除非您具有试用许可证，否则必须配置SSL/TLS进行节点间通信。</p><h3 id="1-1-Elasticsearch节点之间的加密通信"><a href="#1-1-Elasticsearch节点之间的加密通信" class="headerlink" title="1.1 Elasticsearch节点之间的加密通信"></a>1.1 Elasticsearch节点之间的加密通信</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-transport">https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-transport</a></p><ul><li>Verify that the xpack.security.enabled setting is true.（启用安全功能）</li><li>Generate a private key and X.509 certificate.（生成私钥和X.509证书）</li><li>Configure each node to:<ul><li>Required: Enable TLS on the transport layer.（传输层启用TLS）</li><li>Recommended: Enable TLS on the HTTP layer.（HTTP层启用TLS）</li></ul></li></ul><h3 id="1-2-HTTP客户端的加密通信"><a href="#1-2-HTTP客户端的加密通信" class="headerlink" title="1.2 HTTP客户端的加密通信"></a>1.2 HTTP客户端的加密通信</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-http">https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#tls-http</a></p><ul><li>Generate node certificates.（生成节点证书）</li><li>Enable TLS and specify the information required to access the node’s certificate.（启用TLS并指定节点证书）</li><li>Restart Elasticsearch.（重启Elasticsearch）</li></ul><h2 id="2-Kibana通信加密"><a href="#2-Kibana通信加密" class="headerlink" title="2 Kibana通信加密"></a>2 Kibana通信加密</h2><p>传输层安全安全协议(SSL)和传输层安全协议(TLS)为数据传输提供加密。虽然这些术语通常可以互换使用，但 Kibana 只支持 TLS，它取代了旧的 SSL 协议。<br>浏览器将流量发送到 Kibana，Kibana 将流量发送到 Elasticsearch，这些通信通道分别配置为使用 TLS。</p><h3 id="2-1-浏览器与Kibana之间的加密通信"><a href="#2-1-浏览器与Kibana之间的加密通信" class="headerlink" title="2.1 浏览器与Kibana之间的加密通信"></a>2.1 浏览器与Kibana之间的加密通信</h3><p><a href="https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-browser-kib">https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-browser-kib</a></p><ol><li>获得 Kibana 的服务器证书和私钥</li><li>配置 Kibana 以访问服务器证书和私钥</li><li>将 Kibana 配置为为入站连接启用 TLS</li><li>重启 Kibana</li></ol><h3 id="2-2-Kibana与Elasticsearch之间的加密通信"><a href="#2-2-Kibana与Elasticsearch之间的加密通信" class="headerlink" title="2.2 Kibana与Elasticsearch之间的加密通信"></a>2.2 Kibana与Elasticsearch之间的加密通信</h3><p><a href="https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-kib-es">https://www.elastic.co/guide/en/kibana/7.11/configuring-tls.html#configuring-tls-kib-es</a></p><ul><li>Enable TLS on the HTTP layer in Elasticsearch.（在Elasticsearch的HTTP层上启动TLS）</li><li>Obtain the certificate authority (CA) certificate chain for Elasticsearch.（获取Elasticsearch的证书颁发机构(CA)证书链）<ul><li>used the elasticsearch-certutil http command,include the CA certificate chain in PEM format.（使用elasticsearch-certutil http命令生成CA证书链）</li><li>extract the CA certificate.（通过PKCS#12文件提取CA证书链）</li></ul></li><li>Configure Kibana to trust the Elasticsearch CA certificate chain for the HTTP layer.（配置Kibana以信任HTTP层的Elasticsearch CA证书链）</li><li>Configure Kibana to enable TLS for outbound connections to Elasticsearch.（配置Kibana与Elasticsearch的连接启用TLS）</li></ul><h2 id="3-操作步骤"><a href="#3-操作步骤" class="headerlink" title="3 操作步骤"></a>3 操作步骤</h2><ol><li><p>操作命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入Elasticsearch目录</span></span><br><span class="line">cd /data/elk/elasticsearch-7.11.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建证书颁发机构：获得文件：elastic-stack-ca.p12</span></span><br><span class="line">./bin/elasticsearch-certutil ca</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为每个节点生成证书和私钥，获得文件：elastic-certificates.p12</span></span><br><span class="line">./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成专门用于加密HTTP客户端通信的证书，获得文件：elasticsearch-ssl-http.zip</span></span><br><span class="line">./bin/elasticsearch-certutil http</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压HTTP通信证书，获得文件：elasticsearch/http.p12和kibana/elasticsearch-ca.pem</span></span><br><span class="line">unzip elasticsearch-ssl-http.zip</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在每个Elasticsearch节点的配置目录中创建一个文件夹certs，放置安全证书</span></span><br><span class="line">mkdir /data/elk/elasticsearch-7.11.2/config/certs</span><br><span class="line">cp elastic-certificates.p12 config/certs</span><br><span class="line">cp elasticsearch/http.p12 config/certs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制HTTP通信证书到Kibana配置目录</span></span><br><span class="line">cp kibana/elasticsearch-ca.pem /data/elk/kibana-7.11.2/config</span><br></pre></td></tr></table></figure></li><li><p>生成加密HTTP客户端通信证书说明（./bin/elasticsearch-certutil http）<br>参考：<a href="https://lights8080.github.io/post/es-an-quan-security">https://lights8080.github.io/post/es-an-quan-security</a></p></li></ol><h2 id="4-参数配置"><a href="#4-参数配置" class="headerlink" title="4 参数配置"></a>4 参数配置</h2><ol><li><p>Elasticsearch<br>elasticsearch-7.11.2/config/elasticsearch.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在节点上启用Elasticsearch安全功能</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 节点间加密通信配置</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span> </span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span> </span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span> </span><br><span class="line"><span class="comment"># HTTP加密通信配置</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">&quot;certs/http.p12&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>Kibana<br>kibana-7.11.2/config/kibana.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置Kibana与Elasticsearch的连接启用TLS</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;https://127.0.0.1:9200&quot;</span>]</span><br><span class="line"><span class="comment"># 配置信任HTTP层的Elasticsearch CA证书链</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.certificateAuthorities:</span> [<span class="string">&quot;/data/elk/kibana-7.11.2/config/elasticsearch-ca.pem&quot;</span>]</span><br></pre></td></tr></table></figure></li><li><p>Logstash<br>logstash-7.11.2/config/logstash-sample.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;https://127.0.0.1:9200&quot;]</span><br><span class="line">            user =&gt; &quot;elastic&quot;</span><br><span class="line">            password =&gt; &quot;xxxxxx&quot;</span><br><span class="line">            cacert =&gt; &quot;/data/elk/elasticsearch-7.11.2/config/certs/elasticsearch-ca.pem&quot;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Metricbeat<br>metricbeat-7.11.2/modules.d/elasticsearch-xpack.yml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- module: elasticsearch</span><br><span class="line">  xpack.enabled: true</span><br><span class="line">  period: 10s</span><br><span class="line">  hosts: [&quot;https://127.0.0.1:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;xxxxxx&quot;</span><br><span class="line">  ssl.certificate_authorities: [&quot;/data/elk/elasticsearch-7.11.2/config/certs/elasticsearch-ca.pem&quot;]</span><br></pre></td></tr></table></figure></li><li><p>其他Elastic产品使用加密通信<br>略</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;介绍Elasticsearch节点之间的加密通信、浏览器与Kibana之间的加密通信、Kibana与Elasticsearch之间的加密通信、操作步骤和配置说明。&lt;br&gt;基于7.11。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-安全特性（Security）</title>
    <link href="http://www.lights8080.com/2021/04/27/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%EF%BC%88Security%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/04/27/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%EF%BC%88Security%EF%BC%89/</id>
    <published>2021-04-26T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Elasticsearch安全特性，介绍加密通讯的基本原理、开启安全特性的操作步骤、如何生成节点证书、用户认证和相关概念等。<br> 基于7.11版本。</p></blockquote><span id="more"></span><h2 id="一、安全特性"><a href="#一、安全特性" class="headerlink" title="一、安全特性"></a>一、安全特性</h2><p>Elastic Stack安全功能使您可以轻松保护集群。</p><p>Elasticsearch集群保护方式：</p><ul><li>通过密码保护，基于角色的访问控制和IP过滤防止未经授权的访问。</li><li>使用SSL/TLS加密保留数据的完整性。</li><li>维护审计跟踪，知道谁在对集群进行操作</li></ul><p>Elasticsearch配置安全的简易步骤：</p><ol><li>集群内每个节点设置为<code>xpack.security.enabled: true</code></li><li>为节点间通信配置TLS/SSL【#加密通讯】</li><li>启动Elasticsearch</li><li>设置内置用户和密码（命令：<code>elasticsearch-setup-passwords auto</code>）</li><li>设置角色和用户，控制对Elasticsearch的访问</li><li>(可选)启用审计功能<code>xpack.security.audit.enabled: true</code>，并重启集群</li></ol><h3 id="1-加密通讯"><a href="#1-加密通讯" class="headerlink" title="1 加密通讯"></a>1 加密通讯</h3><blockquote><p>未启用加密的群集将以纯文本格式（包括密码）发送所有数据。如果启用了Elasticsearch安全功能，除非您具有试用许可证，否则必须配置SSL/TLS进行节点间通信。</p></blockquote><ul><li>Elasticsearch集群节点间通信使用SSL/TLS加密，保护节点安全有助于降低基于网络的攻击的风险</li><li>要求节点使用SSL证书添加到集群时进行身份验证，新节点的身份验证有助于防止流氓节点加入群集并通过复制接收数据</li></ul><p>Elasticsearch集群配置STL</p><ol><li>为每个Elasticsearch节点生成一个私钥和X.509证书【#1.3 生成节点证书】</li><li>在集群中配置每个节点，以使用其签名证书标识自己，并在传输层上启用TLS。还可以选择在HTTP层上启用TLS</li><li>配置Kibana以加密浏览器和Kibana服务器之间的通信，并通过HTTPS连接到Elasticsearch</li><li>配置其他Elastic产品使用加密通信</li></ol><h4 id="1-1-加密集群中节点之间的通信"><a href="#1-1-加密集群中节点之间的通信" class="headerlink" title="1.1 加密集群中节点之间的通信"></a>1.1 加密集群中节点之间的通信</h4><ol><li>生成节点证书【#1.3 生成节点证书】</li><li>启用TLS并制定访问节点证书所需要的信息<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">elastic-certificates.p12</span></span><br></pre></td></tr></table></figure></li><li>（可选）如果你用密码保护节点的证书，将密码添加到 Elasticsearch 密钥存储库</li><li>重启Elasticsearch</li></ol><h4 id="1-2-加密HTTP客户端通信"><a href="#1-2-加密HTTP客户端通信" class="headerlink" title="1.2 加密HTTP客户端通信"></a>1.2 加密HTTP客户端通信</h4><ol><li>生成HTTP证书【#1.3 生成节点证书】</li><li>启用TLS并制定访问节点证书所需要的信息<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">&quot;http.p12&quot;</span></span><br></pre></td></tr></table></figure></li><li>（可选）如果你用密码保护节点的证书，将密码添加到 Elasticsearch 密钥存储库</li><li>重启Elasticsearch</li></ol><h4 id="1-3-生成节点证书"><a href="#1-3-生成节点证书" class="headerlink" title="1.3 生成节点证书"></a>1.3 生成节点证书</h4><ol><li>（可选）为 Elasticsearch 集群创建一个证书颁发机构。</li></ol><p><code>./bin/elasticsearch-certutil ca</code><br>输出文件是一个PKCS#12密钥存储库，其中包含证书颁发机构的公共证书和用于签署节点证书的私钥。</p><ol start="2"><li><p>为集群中的每个节点生成证书和私钥<br>交互形式：<br><code>./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</code><br>命令形式：<br><code>./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 --dns localhost --ip 127.0.0.1,::1 --out config/certs/node-1.p12</code><br>输出是一个包含节点证书、节点密钥和CA证书的PKCS#12密钥存储库。</p></li><li><p>（可选）生成专门用于加密 HTTP 客户端通信的附加证书。</p></li></ol><p><code>./bin/elasticsearch-certutil http</code><br>命令步骤如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Do you wish to generate a Certificate Signing Request (CSR)? - 是否生成证书签名请求(CSR)?</span></span></span><br><span class="line">Generate a CSR? [y/N]N</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Do you have an existing Certificate Authority (CA) key-pair that you wish to use to sign your certificate? -是否有一个现有的证书颁发机构(CA)密钥对，您希望使用它来签署证书?</span></span></span><br><span class="line">Use an existing CA? [y/N]y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># What is the path to your CA? - 你的CA路径在哪里?</span></span></span><br><span class="line">CA Path: /data/elk/elasticsearch-7.11.2/elastic-stack-ca.p12</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># How long should your certificates be valid? - 您的证书应该多长时间有效?</span></span></span><br><span class="line">For how long should your certificate be valid? [5y] 3Y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Do you wish to generate one certificate per node? - 是否希望每个节点生成一个证书?</span></span></span><br><span class="line">Generate a certificate per node? [y/N]N</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Which hostnames will be used to connect to your nodes? - 哪些主机名将用于连接到您的节点?</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Enter all the hostnames that you need, one per line. - 输入需要的所有主机名，每行一个。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## When you are done, press &lt;ENTER&gt; once more to move on to the next step. - 完成后，再次按&lt;ENTER&gt;继续下一步。</span></span></span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]Y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Which IP addresses will be used to connect to your nodes? - 哪些IP地址将用于连接到您的节点?</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## Enter all the IP addresses that you need, one per line.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## When you are done, press &lt;ENTER&gt; once more to move on to the next step.</span></span></span><br><span class="line"></span><br><span class="line">Is this correct [Y/n]Y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Other certificate options - 其他证书选项</span></span></span><br><span class="line">Do you wish to change any of these options? [y/N]N</span><br><span class="line">输出是一个.zip 文件，包含 Elasticsearch 和 Kibana 各自的一个目录</span><br></pre></td></tr></table></figure><p>输出文件elasticsearch-ssl-http.zip</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/elasticsearch</span><br><span class="line">|_ README.txt</span><br><span class="line">|_ http.p12</span><br><span class="line">|_ sample-elasticsearch.yml</span><br><span class="line"></span><br><span class="line">/kibana</span><br><span class="line">|_ README.txt</span><br><span class="line">|_ elasticsearch-ca.pem</span><br><span class="line">|_ sample-kibana.yml</span><br></pre></td></tr></table></figure><ol start="4"><li>将节点证书复制到适当的位置</li></ol><ul><li>在每个Elasticsearch节点上的配置目录中创建文件夹certs。如：/home/es/config/certs。</li><li>在每个节点上，将创建的证书复制到certs目录（通常是一个.p12文件）</li><li>如果生成了HTTP证书，复制http.p12到certs目录</li><li>配置其他Elastic产品，将证书复制到相关目录</li></ul><h3 id="2-用户认证"><a href="#2-用户认证" class="headerlink" title="2 用户认证"></a>2 用户认证</h3><p>安全功能提供了基于角色的访问控制（RBAC）机制，该机制使您可以通过为角色分配特权并将角色分配给用户或组来授权用户。<br>安全功能还提供了基于属性的访问控制（ABAC）机制，使您可以使用属性来限制对搜索查询和聚合中文档的访问。</p><p>role-based access control (RBAC) </p><ul><li>Secured Resource（访问受限的资源）：索引，别名，文档，字段，用户和Elasticsearch群集本身都是受保护对象。</li><li>Privilege（特权）：对受保护的资源执行的一个或多个动作的命名组，如read是索引特权，代表所有启用读取已索引/存储的数据的操作。</li><li>Permissions（权限）：针对受保护资源的一组一个或多个特权，权限可以很容易地用语言来描述。</li><li>Role（角色）：一组命名的权限</li><li>User（用户）：经过身份验证的用户</li><li>Group（用户组）：用户所属的一个或多个组</li></ul><p>内置用户</p><ul><li>这些内置用户存储在指定的.security索引中，由Elasticsearch管理。</li><li>elasticsearch-setup-passwords工具是首次设置内置用户密码的最简单方法</li></ul><p>基于令牌的身份验证</p><ul><li>token-service：访问令牌（根据OAuth2规范生成访问令牌和刷新令牌）是短期令牌，默认情况下20分钟后过期。（Authorization: Bearer xxx）</li><li>api-key-service：API秘钥，默认情况下API密钥不会过期，创建时，可以指定到期时间和权限。（Authorization: ApiKey xxx）</li></ul><h2 id="二、相关概念"><a href="#二、相关概念" class="headerlink" title="二、相关概念"></a>二、相关概念</h2><ul><li>SSL（Secure Socket Layer)/TLS(Transport Layer Security）</li><li>数字证书：互联网通讯中标志通讯各方身份信息的一系列数据</li><li>X.509：是一种数字证书（Public Key Certificates）的格式标准，主要定义了证书中应该包含哪些内容。<ul><li>HTTPS依赖的TLS/SSL证书使用的就是使用的X.509格式。一个X.509 Certificate包含一个Public Key和一个身份信息（a hostname, or an organization, or an individual），它要么是被CA签发的要么是自签发的。</li></ul></li><li>CA（Certificate Authority）：颁发数字证书的权威机构，承担公钥体系中公钥的合法性检验的责任。</li><li>编码格式：用来存储和发送公钥/私钥、证书和其他数据的文件格式；分为DER和PEM<ul><li>DER（Distinguished Encoding Rules）：二进制不可读，常用于Windows系统</li><li>PEM（Privacy-Enhanced Mail）：内容是BASE64编码，常用于*NIX系统</li></ul></li><li>PKCS（Public Key Cryptography Standards）：公钥密码学标准<ul><li>PKCS#12：描述个人信息交换语法标准，通常用来存储Private Keys和Public Key Certificates（例如前面提到的X.509）的文件格式，使用基于密码的对称密钥进行保护。</li></ul></li></ul><h2 id="三、参考文档"><a href="#三、参考文档" class="headerlink" title="三、参考文档"></a>三、参考文档</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/secure-cluster.html">安全集群</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/configuring-tls.html#configuring-tls">加密通讯</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Elasticsearch安全特性，介绍加密通讯的基本原理、开启安全特性的操作步骤、如何生成节点证书、用户认证和相关概念等。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-聚合（Aggregations）</title>
    <link href="http://www.lights8080.com/2021/04/25/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E8%81%9A%E5%90%88%EF%BC%88Aggregations%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/04/25/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E8%81%9A%E5%90%88%EF%BC%88Aggregations%EF%BC%89/</id>
    <published>2021-04-24T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:08.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Elasticsearch聚合速查表，介绍指标聚合、桶分聚合、管道聚合的分类和聚合示例。<br> 基于7.11版本。</p></blockquote><span id="more"></span><p>聚合将数据汇总为指标, 统计, 或其他分析。</p><h2 id="聚合分类"><a href="#聚合分类" class="headerlink" title="聚合分类"></a>聚合分类</h2><ul><li>Metric：指标聚合，从文档字段值中计算指标，如总和、平均值等</li><li>Bucket：桶分聚合，根据字段值、范围或其他条件将文档分组为桶</li><li>Pipeline：管道聚合，从其他的聚合结果作为输入</li></ul><h3 id="Bucket"><a href="#Bucket" class="headerlink" title="Bucket"></a>Bucket</h3><ul><li>Adjacency matrix：邻接矩阵，获取矩阵每个组的计数</li><li>Auto-interval date histogram：时间柱状图，根据桶的数量自动的选择桶的间隔</li><li>Children：子聚合，如：join field</li><li>Composite：多存储桶聚合，类似于多字段分组</li><li>Date histogram：日期柱状图，可以按日历感知时间间隔（如：day，week，houth）和固定时间间隔。</li><li>Date range：时间范围聚合，from：从大于等于某个时间，to：到小于某个时间</li><li>Filter：过滤器聚合，将当前的聚合的上下文缩小到一组特定文档。在当前聚合上应用过滤，不影响其他聚合器。</li><li>Filters：多桶过滤器聚合，每个桶都与一个过滤器相关联</li><li>Geo-distance：地理距离聚合，工作在geo_point字段上，定义一个原点或一组距离范围的桶，评估落在每个桶的文档。</li><li>Geo hash grid：网格聚合，每个单元格使用自定义精度的geohash进行标记，geohash可以在1~12之间选择精度</li><li>Geotile grid：网格聚合，每个单元格对应许多在线地图的图块，使用{zoom}/{x}/{y}标记</li><li>Global：在搜索的上下文中定义一个，不受搜索影响的上下文进行聚合。与Filter对应</li><li>Histogram：柱状图聚合，指定间隔，返回落在间隔内的文档数</li><li>IP range：IP类型字段的范围聚合</li><li>Missing：NULL字段聚合</li><li>Nested：嵌套文档聚合</li><li>Parent：父文档聚合</li><li>Range：范围聚合，定义一组范围，每组范围代表一个桶</li><li>Rare terms：稀少（长期分布但不频繁的项）的术语聚合</li><li>Reverse nested：在嵌套聚合内定义聚合父文档</li><li>Sampler：采样器聚合，将聚合的文档限制在得分最高的文档上，降低繁重缓慢的聚合成本。shard_size：限制在每个分片上使用得分最高的文档数</li><li>Diversified sampler：多样化采集聚合，采用多样化的设置进行抽样可以提供一种方法来消除内容偏差</li><li>Terms：动态桶聚合。结果是近似值，可以通过size、shard_size来控制其精度。对标关系数据库中的group by。size：定义返回桶的数；shard_size：每个分片使用文档样本数</li><li>Significant terms：显著的关键词聚合，通过background sets（背景集合）对比聚合数据。通常使用整个索引库内容当做背景集合，可以通过background_filter设置。</li><li>Significant text：显著的文本聚合，像Significant terms一样，区别是作用在text字段</li><li>Variable width histogram：动态的宽度柱状图聚合，定义桶数，动态确定桶间隔。</li><li>Subtleties of bucketing range fields：范围字段导致桶数大于文档数</li></ul><h3 id="Metric"><a href="#Metric" class="headerlink" title="Metric"></a>Metric</h3><ul><li>Avg：计算平均值，单值的指标聚合，提取文档的数值型字段或提供的脚本。</li><li>Min：计算最小值，histogram fields时，返回values中的最小值</li><li>Max：计算最大值</li><li>Sum：计算总和</li><li>Boxplot：盒型图，返回最大值、最小值、25%、50%和75%的值。常用语响应时间的分析</li><li>Cardinality：去重求和，计算不同值的近似计数，可以从文档中的特定字段提取值，也可以通过脚本</li><li>stats：统计信息，多值的指标聚合，可以从文档中的特定字段提取值，也可以通过脚本<ul><li>status: min, max, sum, count and avg</li><li>string stats: count, min_length, max_length, avg_length, entropy</li><li>extended stats: sum_of_squares, variance, std_deviation</li></ul></li><li>geo：地图<ul><li>geo bounds: 地理边界聚合</li><li>geo centroid: 地理重心聚合</li></ul></li><li>Median absolute deviation：中位数绝对偏差，更可靠的统计信息，可以减少异常值对于数据集的影响。</li><li>Percentile rank：百分比等级，显示低于特定值的百分比。如：显示web服务加载时间的占比</li><li>Percentiles：百分位的值，显示出现百分位观察值的点，percents指定返回的百分位。如：显示大于观察值95%的值</li><li>Scripted metric：使用脚本执行获取指标</li><li>Value count：去重计数</li><li>Weighted avg：带权重的平均值</li></ul><h3 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h3><ul><li>Avg bucket：【sibling pipeline aggs】，计算平均值</li><li>max bucket：【sibling pipeline aggs】，计算最大值</li><li>min bucket：【sibling pipeline aggs】，计算最小值</li><li>sum bucket：【sibling pipeline aggs】，计算总和</li><li>bucket script：【parent pipeline aggs】，脚本计算</li><li>bucket selector：【parent pipeline aggs】，桶过滤</li><li>bucket sort：【parent pipeline aggs】，桶排序</li><li>cumulative cardinality：累积基数，此值显示自查询时间段开始以来总的计数，也可显示增量的计数。如：每天网站的新访问者新增数量。</li><li>cumulative sum：累积总和，此值显示自查询时间段开始以来累积总和。如：月销售额的累积总和。</li><li>derivative：柱状图导数计算</li><li>stats bucket：【sibling pipeline aggs】，统计信息，包括min, max, sum, count and avg</li><li>extended stats bucket：【sibling pipeline aggs】扩展的统计信息，包括平方和、标准差等</li><li>inference bucket：【parent pipeline aggs】，训练模型推断</li><li>moving average：滑动窗口平均值</li><li>moving function：滑动窗口上自定义函数</li><li>moving percentiles：基于百分位的滑动窗口</li><li>normalize：计算标准的数学值</li><li>percentiles bucket：计算桶的百分位的值</li><li>serial differencing：时间序列差值</li></ul><h3 id="示例1：聚合、分组"><a href="#示例1：聚合、分组" class="headerlink" title="示例1：聚合、分组"></a>示例1：聚合、分组</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  # 仅返回聚合结果，不需要搜索结果的内容</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    # 单列分组统计，sql: select sum(balance) as sum_balance,avg(balance) as avg_balance from bank group by state.keyword limit 10;</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      # 定义桶的类型</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      # 添加自定义Mata信息</span><br><span class="line">      &quot;meta&quot;: &#123;</span><br><span class="line">        &quot;my-metadata-field&quot;: &quot;foo&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      # 子聚合</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sum_balance&quot;: &#123;</span><br><span class="line">          &quot;sum&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    # 多列分组统计 sql: select sum(balance) as sum_balance from bank group by state.keyword, gender.keyword limit 50;</span><br><span class="line">    &quot;group_by_fields&quot;: &#123;</span><br><span class="line">      &quot;composite&quot;:&#123;</span><br><span class="line">        &quot;sources&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;state&quot;: &#123;</span><br><span class="line">              &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;state.keyword&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            &quot;gender&quot;: &#123;</span><br><span class="line">              &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;gender.keyword&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        # 查询记录数，默认10条</span><br><span class="line">        &quot;size&quot;: 50</span><br><span class="line">      &#125;,</span><br><span class="line">      # 子聚合</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;sum_balance&quot;: &#123;</span><br><span class="line">          &quot;sum&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  # 聚合后置过滤器，对聚合结果无影响</span><br><span class="line">  &quot;post_filter&quot;: &#123; </span><br><span class="line">    &quot;term&quot;: &#123; &quot;color&quot;: &quot;red&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="示例2：条件过滤，多列分组、排序、分页"><a href="#示例2：条件过滤，多列分组、排序、分页" class="headerlink" title="示例2：条件过滤，多列分组、排序、分页"></a>示例2：条件过滤，多列分组、排序、分页</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">GET /lights-order/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;gmtCreate&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: &quot;2021-05-06 00:00:00&quot;,</span><br><span class="line">        &quot;lte&quot;: &quot;2021-05-06 23:59:59&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">        &quot;time_zone&quot;:&quot;+08:00&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_fields&quot;: &#123;</span><br><span class="line">      &quot;composite&quot;:&#123;</span><br><span class="line">        &quot;sources&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;cid&quot;: &#123;</span><br><span class="line">              &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;cid&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            &quot;ipcc&quot;: &#123;</span><br><span class="line">              &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;ipcc&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;size&quot;: 50</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;sum_totalAmount&quot;: &#123;</span><br><span class="line">          &quot;sum&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;totalAmount&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;order_count&quot;: &#123;</span><br><span class="line">          &quot;value_count&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;id&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sales_bucket_sort&quot;: &#123;</span><br><span class="line">          &quot;bucket_sort&quot;: &#123;</span><br><span class="line">            &quot;sort&quot;: [</span><br><span class="line">              &#123; &quot;order_count&quot;: &#123; &quot;order&quot;: &quot;asc&quot; &#125; &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;from&quot;: 0, </span><br><span class="line">            &quot;size&quot;: 10</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Elasticsearch聚合速查表，介绍指标聚合、桶分聚合、管道聚合的分类和聚合示例。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>语录-3</title>
    <link href="http://www.lights8080.com/2021/04/16/%E8%AF%AD%E5%BD%95/%E8%AF%AD%E5%BD%95-3/"/>
    <id>http://www.lights8080.com/2021/04/16/%E8%AF%AD%E5%BD%95/%E8%AF%AD%E5%BD%95-3/</id>
    <published>2021-04-15T16:00:00.000Z</published>
    <updated>2021-06-07T02:00:19.000Z</updated>
    
    <content type="html"><![CDATA[<ol><li>五只猴子的故事</li><li>任正非在一次座谈会上谈加强项目财务的有效管理</li><li>眼镜蛇效应</li><li>能源效率的诅咒</li></ol><span id="more"></span><p>“ 分享几个小故事，都是从“阮一峰的网络日志”中读到。”</p><h2 id="1-五只猴子的故事"><a href="#1-五只猴子的故事" class="headerlink" title="1. 五只猴子的故事"></a>1. 五只猴子的故事</h2><p>科学家在笼子里放了五只猴子。笼子中间有一架梯子，梯子上面放着香蕉。<br>每当一只猴子爬上梯子，科学家就用冷水泼洒其余的猴子。过了一阵子，只要一只猴子爬上梯子，其他猴子就会殴打它。一段时间后，所有猴子都不敢爬上梯子。<br>然后，科学家用一只新猴子，替换了原来的一只猴子，并且停止用冷水泼洒猴子。这只新猴子立即爬楼梯去拿香蕉，但随即遭到其他猴子的殴打。经过几次殴打，新猴子学会了不爬梯子，即使它从来不知道为什么。<br>接着，替换了第二只猴子，也发生了同样的事情。刚才放进笼子的那只猴子，同样殴打了新来的猴子。替换了第三只猴子，也是如此。就这样，第四只、第五只猴子也接连被替换了。<br>最终，笼子里面的五只猴子，尽管从未被泼冷水，仍然继续殴打任何试图爬上梯子的猴子。<br>​</p><h2 id="2-任正非在一次座谈会上谈加强项目财务的有效管理"><a href="#2-任正非在一次座谈会上谈加强项目财务的有效管理" class="headerlink" title="2. 任正非在一次座谈会上谈加强项目财务的有效管理"></a>2. 任正非在一次座谈会上谈加强项目财务的有效管理</h2><p>任正非：我在越南提出一个问题，百年一遇的台风，把爱立信的铁塔吹倒了，诺基亚的铁塔也吹倒了，就我们的铁塔没有倒，我请问你这个财务人员，如何评价？</p><p>杜仲夏：这说明对成本管理并没有做好，这说明项目存在过度交付的问题。就像飞利浦的灯泡，只有两年寿命，用了两年刚好坏掉，这就是最好的产品。如果客户只付了两年灯泡的钱，但是我们保证10年的寿命，只能说明我们不懂经营。</p><p>任正非：但是我们当年考市场人员和财务人员的时候，每个人都充满了自豪感，你看，诺基亚和爱立信的铁塔都倒了，就我们没倒，华为的水平多高啊！华为公司的铁塔只有一个标准，在永远不会有台风的沙漠里，装的也是这种铁塔。我们僵化地制定了太高的标准，为此我们每年多浪费了10万到20万吨钢铁。所以，我们今天必须加强项目财务的有效管理，我想三五年后我们一定会看到有结果。</p><h2 id="3-眼镜蛇效应"><a href="#3-眼镜蛇效应" class="headerlink" title="3. 眼镜蛇效应"></a>3. 眼镜蛇效应</h2><p>眼镜蛇效应一词来自殖民时期的印度：英国政府计划要减少眼镜蛇的数量，因而颁布法令说每打死一条眼镜蛇都可以领取赏金。然而印度人为了赏金反而开始养殖眼镜蛇。当英国政府意识到这种情况而取消赏金后，养殖蛇的人把蛇都放了；放出去的蛇继而大量繁殖，结果眼镜蛇族群数量不減反增。</p><h2 id="4-能源效率的诅咒"><a href="#4-能源效率的诅咒" class="headerlink" title="4. 能源效率的诅咒"></a>4. 能源效率的诅咒</h2><p>我们为了降低能源消耗，发明了节省能源的 LED 照明。结果，更高效的照明导致了更多的照明，从而使得社会整体能源消耗增加。<br>很多事情都是这样，为了省电，我们提高了能源效率，结果人们因此买更多的电器，消耗更多的电。</p>]]></content>
    
    
    <summary type="html">&lt;ol&gt;
&lt;li&gt;五只猴子的故事&lt;/li&gt;
&lt;li&gt;任正非在一次座谈会上谈加强项目财务的有效管理&lt;/li&gt;
&lt;li&gt;眼镜蛇效应&lt;/li&gt;
&lt;li&gt;能源效率的诅咒&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="语录" scheme="http://www.lights8080.com/categories/%E8%AF%AD%E5%BD%95/"/>
    
    
    <category term="语录" scheme="http://www.lights8080.com/tags/%E8%AF%AD%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-搜索（Search-DSL）</title>
    <link href="http://www.lights8080.com/2021/04/08/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%90%9C%E7%B4%A2%EF%BC%88Search-DSL%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/04/08/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E6%90%9C%E7%B4%A2%EF%BC%88Search-DSL%EF%BC%89/</id>
    <published>2021-04-07T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:03.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Elasticsearch介绍查询搜索请求包含哪些选项，并介绍其中的Query DSL。包括语法说明、查询和过滤上下文、复合查询等和查询示例。<br>基于7.11版本。</p></blockquote><span id="more"></span><p>搜索请求是对Elasticsearch数据流或索引中的数据信息的请求，包括以下自定义选项：</p><ul><li>Query DSL（查询语法）</li><li>Aggregations（分组聚合）</li><li>Search multiple data streams and indices（多数据流和索引搜索）</li><li>Paginate search results（分页查询）</li><li>Retrieve selected fields（查询指定字段）</li><li>Sort search results（排序）</li><li>Run an async search（异步搜索）</li></ul><p>本文介绍其中的Query DSL。</p><h2 id="查询特定语言（Query-DSL-Domain-Specific-Language）"><a href="#查询特定语言（Query-DSL-Domain-Specific-Language）" class="headerlink" title="查询特定语言（Query DSL - Domain Specific Language）"></a>查询特定语言（Query DSL - Domain Specific Language）</h2><p>Elasticsearch提供了基于JSON的丰富的查询特定语言来定义查询，包含两种类型的子句组成：</p><ul><li>Leaf query clauses：页查询。在特定的字段中查找特定值，如match、term和range查询</li><li>Compound query clauses：复合查询。包装其他的Leaf和Compound子查询，逻辑组合多个查询（bool、dis_max），或更改其行为（constant_score）。</li></ul><h3 id="查询和过滤上下文（Query-and-filter-context）"><a href="#查询和过滤上下文（Query-and-filter-context）" class="headerlink" title="查询和过滤上下文（Query and filter context）"></a>查询和过滤上下文（Query and filter context）</h3><h4 id="相关性得分（relevance-scores）："><a href="#相关性得分（relevance-scores）：" class="headerlink" title="相关性得分（relevance scores）："></a>相关性得分（relevance scores）：</h4><p>Elasticsearch按相关性得分对匹配的搜索结果进行排序，该得分衡量每个文档与查询的匹配程度。<br>相关性得分是一个正浮点数，在查询API的_score元数据字段中返回，分值越高，文档越相关。<br>不同的查询类型可以计算不同的相关性得分，计算分数还取决于查询子句是运行在查询上下文还是过滤器上下文中。</p><h4 id="查询上下文（Query-context）："><a href="#查询上下文（Query-context）：" class="headerlink" title="查询上下文（Query context）："></a>查询上下文（Query context）：</h4><p>回答的是文档与该查询子句的匹配程度如何，主要用于计算文档相关性得分。</p><h4 id="过滤器上下文（Filter-context）："><a href="#过滤器上下文（Filter-context）：" class="headerlink" title="过滤器上下文（Filter context）："></a>过滤器上下文（Filter context）：</h4><p>回答的是文档与该查询子句是否匹配，主要用于过滤结构化数据，不计算相关性得分。<br>频繁的使用filter context将会被ES自动缓存，以提升性能。</p><h3 id="Compound-queries：复合查询"><a href="#Compound-queries：复合查询" class="headerlink" title="Compound queries：复合查询"></a>Compound queries：复合查询</h3><ul><li>boolean：匹配和过滤，满足条件可以获得更高的得分</li><li>boosting：降低文档的得分，而不是排除</li><li>constant_score：固定值得分</li><li>dis_max：提升多个文档具有相同固定值得分</li><li>function_score：根据算法修改查询文档得分</li></ul><h4 id="1-boolean-query"><a href="#1-boolean-query" class="headerlink" title="1. boolean query"></a>1. boolean query</h4><p>用于匹配和筛选文档。bool查询是采用more-matches-is-better的机制，因此满足must和should子句的文档将获得更高的分值。</p><ul><li>must：返回的文档必须满足此查询子句，参与分值计算</li><li>filter：返回的文档必须满足此查询子句，不参与分值计算，缓存结果</li><li>should：返回的文档可能满足此查询子句，参与分值计算</li><li>must_not：该查询子句必须不能出现在匹配的文档中，不参与分值计算，缓存结果</li><li>minimum_should_match：指定至少匹配几个should子句，若一个bool查询包含至少一个should子句且无must或filter子句，则默认值为1。</li><li>boost：提升权重</li></ul><h4 id="2-boosting"><a href="#2-boosting" class="headerlink" title="2. boosting"></a>2. boosting</h4><p>目的是降低某些文档分值，而不是从结果中排除。</p><p>boosting计算相关性得分规则：</p><ol><li>从符合positive子句的查询中获得原始的相关性得分</li><li>得分 乘上 negative_boost系数，获得最终得分</li></ol><ul><li>positive：必填，返回的文档必须匹配此查询。</li><li>negative：必填，降低匹配文档的分值。</li><li>negative_boost：必填，介于0~1.0之间的数</li></ul><h4 id="3-constant-score"><a href="#3-constant-score" class="headerlink" title="3. constant_score"></a>3. constant_score</h4><p>包装filter query并返回分值，分值等于boost参数。</p><ul><li>filter：必填，返回索引文档都必须匹配的查询条件</li><li>boost：可选，指定分值，默认为1</li></ul><h4 id="4-dis-max"><a href="#4-dis-max" class="headerlink" title="4. dis_max"></a>4. dis_max</h4><p>用于提升多个字段中包含相同术语的文档分配更高的得分。<br>dis_max计算相关性得分规则：</p><ol><li>获得匹配子句中最高得分</li><li>其他匹配的子句得分 乘上 tie_treaker系数</li><li>将最高得分与其他匹配得分相加，获得最终得分</li></ol><ul><li>queries：必填，返回的文档必须匹配一个或多个查询条件，匹配的条件越多则分值越高</li><li>tie_breaker：可选，介于0~1.0之间的数，用于增加匹配文档的分值。默认为0</li></ul><h4 id="5-function-score"><a href="#5-function-score" class="headerlink" title="5. function_score"></a>5. function_score</h4><p>允许修改查询文档的相关性得分，通过得分函数（function_score）在过滤后的文档集合上计算，获得最终得分。</p><ul><li>query：指定查询条件，默认”match_all”: {}</li><li>score_mode：计算分值的模式。multiply（默认）、sum、avg、first、max、min</li><li>boost_mode：计算的分值与查询分值合并模式。multiply（默认）、replace（忽略查询分值）、sum、avg、max、min</li><li>function_score：计算分值的函数。script_score（函数）、weight（权重）、random_score（0~1随机）、field_value_factor（字段因素）</li></ul><h3 id="Full-text-queries：全文检索，查询已分析的文本字段"><a href="#Full-text-queries：全文检索，查询已分析的文本字段" class="headerlink" title="Full text queries：全文检索，查询已分析的文本字段"></a>Full text queries：全文检索，查询已分析的文本字段</h3><ul><li>intervals：根据匹配项的顺序和接近程度返回文档</li><li>match：标准的全文查询，模糊匹配和短语接近查询</li><li>match_bool_prefix：分析其输入解析构造为bool query，最后一个词在前缀查询中使用</li><li>match_phrase：分析其输入解析为短语匹配查询</li><li>match_phrase_prefix：分析其输入解析为短语匹配查询，最后一个词在前缀查询中使用</li><li>multi_match：多个字段匹配查询</li><li>query_string：语法解析器查询</li><li>simple_query_string：更简单的语法解析器查询</li></ul><h3 id="Geo-queries：坐标查询"><a href="#Geo-queries：坐标查询" class="headerlink" title="Geo queries：坐标查询"></a>Geo queries：坐标查询</h3><ul><li>geo_bounding_box：矩形查询</li><li>geo_distance：坐标点范围查询</li><li>geo_polygon：多边形查询</li><li>geo_shape：包括几何图形查询和指定地理形状相交点查询</li></ul><h3 id="Shape-queries：像geo-shape一样，支持索引任意二维的几何图形功能"><a href="#Shape-queries：像geo-shape一样，支持索引任意二维的几何图形功能" class="headerlink" title="Shape queries：像geo_shape一样，支持索引任意二维的几何图形功能"></a>Shape queries：像geo_shape一样，支持索引任意二维的几何图形功能</h3><h3 id="Joining-queries：连接查询"><a href="#Joining-queries：连接查询" class="headerlink" title="Joining queries：连接查询"></a>Joining queries：连接查询</h3><ul><li>nested：嵌套类型查询</li><li>has_child：匹配子文档的字段，返回父文档。前提是同一索引中建立的父子关系</li><li>has_parent：匹配父文档的字段，返回所有子文档。前提是同一索引中建立的父子关系</li><li>parent_id：查询指定父文档的所有子文档。</li></ul><h3 id="Span-queries：区间查询。精准控制多个输入词的先后顺序，已经多个关键词在文档中的前后距离"><a href="#Span-queries：区间查询。精准控制多个输入词的先后顺序，已经多个关键词在文档中的前后距离" class="headerlink" title="Span queries：区间查询。精准控制多个输入词的先后顺序，已经多个关键词在文档中的前后距离"></a>Span queries：区间查询。精准控制多个输入词的先后顺序，已经多个关键词在文档中的前后距离</h3><ul><li>span_containing：区间列表查询</li><li>field_masking_span：允许跨越不同字段查询</li><li>span_first：跨度查询，匹配项必须出现在该字段的前N个位置</li><li>span_multi：Wraps a term, range, prefix, wildcard, regexp, or fuzzy query.</li><li>span_near：接受多个跨度查询，顺序相同且指定距离之内</li><li>span_not：包装其他span query，排除与该文档匹配的所有文档</li><li>span_or：返回任意指定查询匹配的文档</li><li>span_term：等同于term query，可以和其他span query一起使用</li><li>span_within：</li></ul><h3 id="Specialized-queries：专业的查询"><a href="#Specialized-queries：专业的查询" class="headerlink" title="Specialized queries：专业的查询"></a>Specialized queries：专业的查询</h3><ul><li>distance_feature：基于时间或坐标查询，越接近原点得分越高</li><li>more_like_this：按文本、文档和文档的集合查询</li><li>percolate：按存储的指定文档匹配查询</li><li>rank_feature：通过定义字段的rank_feature或rank_features属性值提高得分</li><li>script：脚本过滤文档</li><li>script_score：通过脚本自定义得分</li><li>wrapper：接受一个base64字符串查询</li><li>pinned：提升特定文档的查询</li></ul><h3 id="Term-level-queries：术语级查询"><a href="#Term-level-queries：术语级查询" class="headerlink" title="Term-level queries：术语级查询"></a>Term-level queries：术语级查询</h3><ul><li>exists：返回包含字段的任意文档</li><li>fuzzy：返回搜索词的相似词的文档</li><li>ids：返回指定ID的文档</li><li>prefix：返回字段中指定前缀的文档</li><li>range：返回范围内的文档</li><li>regexp：返回正则匹配的文档</li><li>term：返回字段中包含特定术语的文档</li><li>terms：返回字段中包含一个或多个术语的文档</li><li>terms_set：返回字段中包含最少数目术语的文档</li><li>type：返回指定类型的文档</li><li>wildcard：返回通配符匹配文档</li></ul><h3 id="查询示例"><a href="#查询示例" class="headerlink" title="查询示例"></a>查询示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 多索引同步搜索</span><br><span class="line">GET /my-index-000001,my-index-000002/_search</span><br><span class="line">&#123;</span><br><span class="line">  # 指定查询超时时间</span><br><span class="line">  &quot;timeout&quot;: &quot;2s&quot;,</span><br><span class="line">  # 字段匹配，相当于query context</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match_all&quot;: &#123;&#125;&#125;,</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Search&quot; &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      # 相当于filter context</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123; &quot;term&quot;:  &#123; &quot;status&quot;: &quot;published&quot; , &quot;_name&quot; : &quot;status_pub&quot;&#125;&#125;,</span><br><span class="line">        &#123; &quot;range&quot;: &#123; &quot;publish_date&quot;: &#123; &quot;gte&quot;: &quot;2015-01-01&quot; &#125;&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  # 排序</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123; &quot;account_number&quot;: &quot;asc&quot; &#125;,</span><br><span class="line">    &#123; &quot;post_date&quot; : &#123;&quot;order&quot; : &quot;asc&quot;&#125;&#125;,</span><br><span class="line">    &quot;_score&quot;</span><br><span class="line">  ],</span><br><span class="line">  # 范围搜索</span><br><span class="line">  &quot;range&quot;: &#123;</span><br><span class="line">    &quot;gmtCreate&quot;: &#123;</span><br><span class="line">      &quot;gte&quot;: &quot;2020-10-01 00:00:00&quot;,</span><br><span class="line">      &quot;lte&quot;: &quot;2020-10-31 23:59:59&quot;,</span><br><span class="line">      &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">      &quot;time_zone&quot;:&quot;+08:00&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  # 查询指定字段</span><br><span class="line">  &quot;fields&quot;: [&quot;user.id&quot;, &quot;@timestamp&quot;],</span><br><span class="line">  &quot;_source&quot;: false</span><br><span class="line">  # 分页</span><br><span class="line">  &quot;from&quot;: 10,</span><br><span class="line">  &quot;size&quot;: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Elasticsearch介绍查询搜索请求包含哪些选项，并介绍其中的Query DSL。包括语法说明、查询和过滤上下文、复合查询等和查询示例。&lt;br&gt;基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch-索引（Index）</title>
    <link href="http://www.lights8080.com/2021/04/07/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89/"/>
    <id>http://www.lights8080.com/2021/04/07/%E6%8A%80%E6%9C%AF/ELK/Elasticsearch-%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89/</id>
    <published>2021-04-06T16:00:00.000Z</published>
    <updated>2021-06-07T01:59:00.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Elasticsearch索引介绍，包括索引设置、索引模板、索引生命周期管理、翻滚索引、索引别名、滚动索引。<br> 基于7.11版本。</p></blockquote><span id="more"></span><h2 id="索引设置（Index-Settings）"><a href="#索引设置（Index-Settings）" class="headerlink" title="索引设置（Index Settings）"></a>索引设置（Index Settings）</h2><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><p>只能在创建索引时或关闭的索引上设置</p><ul><li>index.number_of_shards：主分片数量，默认1</li><li>index.number_of_routing_shards：拆分索引的路由分片数量，默认值位于2~1024之间，依赖索引主分片数量</li><li>index.shard.check_on_startup：打开前检查分片是否损坏，默认false</li><li>index.codec：压缩存储算法，默认LZ4</li><li>index.routing_partition_size：自定义路由可以到达的分片数量，默认1</li></ul><h3 id="dynamic"><a href="#dynamic" class="headerlink" title="dynamic"></a>dynamic</h3><p>可以使用API实时对索引进行操作</p><ul><li>index.number_of_replicas：主分片的副本数，默认1</li><li>index.auto_expand_replicas：根据集群中数据节点的数量自动扩展副本的数量，默认false</li><li>index.search.idle.after：搜索空闲之前不能接收搜索和获取请求的时间，默认30s</li><li>index.refresh_interval：刷新操作频率，最近对索引的更改既可见，默认1s。-1关闭刷新操作</li><li>index.max_result_window：查询索引结果的最大数量，默认10000</li><li>index.max_inner_result_window：内部或聚合命中最大数量，默认100</li><li>index.max_rescore_window：打分请求的最大索引数量，默认10000（同index.max_result_window）</li><li>index.max_docvalue_fields_search：查询中允许的最大字段数，默认100</li><li>index.max_script_fields：查询中允许的最大脚本字段数，默认32</li><li>index.query.default_field：查询返回的默认字段，默认*（表示所有）</li></ul><h2 id="索引模板（Index-Templates）"><a href="#索引模板（Index-Templates）" class="headerlink" title="索引模板（Index Templates）"></a>索引模板（Index Templates）</h2><p>索引模板是告诉Elasticsearch在创建索引时如何配置索引的一种方法。对于数据流（data stream），索引模板配置是创建他们的后备索引。在创建索引之前先配置模板，模板设置将用作创建索引的基础。</p><p>模板有两种类型，索引模板（index templates）和组件模板（component templates）。</p><p>组件模板是可重用的构建块，用于配置映射（mappings）、设置（settings）和别名（alias）。使用组件模板来构造索引模板，但它们不会直接应用于索引。索引模板可以包含组件模板的集合，也可以直接指定设置，映射和别名。如果匹配多个模板，优先使用优先级最高的模板。</p><p>可以使用模拟API创建索引，确定最终的索引设置。<code>POST /_index_template/_simulate</code>。</p><p>注意事项：</p><ul><li>如果新数据流或索引与多个索引模板匹配，则使用优先级最高的索引模板。</li><li>Elasticsearch内置了许多索引模板（如：metrics-<em>-</em>,logs-*-*），每个模板的优先级是100。如果不想使用内置模板，请为您的模板分配更高的优先级。</li><li>如果显式设置创建索引，并且该索引与索引模板匹配，则创建索引请求中的设置将优先于索引模板中指定的设置。</li><li>索引模板仅在创建索引期间应用。索引模板的更改不会影响现有索引。</li><li>当可组合模板匹配给定索引时，它始终优先于旧模板。如果没有可组合模板匹配，则旧版模板可能仍匹配并被应用。</li></ul><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/datastream_template</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment"># 1.1 匹配所有&quot;datastream-&quot;开头的索引</span></span><br><span class="line">  <span class="string">&quot;index_patterns&quot;</span>: [<span class="string">&quot;datastream-*&quot;</span>],</span><br><span class="line">  <span class="comment"># 2 指定创建数据流索引模板</span></span><br><span class="line">  <span class="string">&quot;data_stream&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;15s&quot;</span>,</span><br><span class="line">    <span class="comment"># 指定索引管理策略，索引关联策略</span></span><br><span class="line">    <span class="string">&quot;index.lifecycle.name&quot;</span>: <span class="string">&quot;datastream_policy&quot;</span>,</span><br><span class="line">    <span class="comment"># 指定滚动写别名</span></span><br><span class="line">    <span class="string">&quot;index.lifecycle.rollover_alias&quot;</span>: <span class="string">&quot;datastream&quot;</span>,</span><br><span class="line">    <span class="comment"># 满足策略的索引检查频率</span></span><br><span class="line">    <span class="string">&quot;indices.lifecycle.poll_interval&quot;</span>: <span class="string">&quot;10m&quot;</span>,</span><br><span class="line">    <span class="comment"># 跳过滚动</span></span><br><span class="line">    <span class="string">&quot;index.lifecycle.indexing_complete&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dynamic_date_formats&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>,</span><br><span class="line">      <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>,</span><br><span class="line">      <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>,</span><br><span class="line">      <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS Z&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;_default_&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;_all&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment"># 1.2 非数据流索引是使用</span></span><br><span class="line">  <span class="string">&quot;aliases&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;last_3_months&quot;</span>: &#123;&#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="索引生命周期管理（Index-Lifecycle-Manager-ILM）"><a href="#索引生命周期管理（Index-Lifecycle-Manager-ILM）" class="headerlink" title="索引生命周期管理（Index Lifecycle Manager - ILM）"></a>索引生命周期管理（Index Lifecycle Manager - ILM）</h2><p>配置索引生命周期管理策略，能够随着时间推移根据性能、弹性和保留要求自动的管理索引。</p><p>索引生命周期策略可以触发以下操作：</p><ul><li>翻转（Rollover）：当现有索引达到一定分片大小，文档数或使用年限时，为翻转目标创建新索引。翻转目标可以是索引别名或数据流。</li><li>收缩（Shrink）：减少索引中主碎片的数量。</li><li>强制合并（Force merge）：手动触发合并以减少索引每个分片中的段数，并释放已删除文档所使用的空间。</li><li>冻结（Freeze）：将索引设为只读，并最大程度地减少其内存占用量。</li><li>删除（Delete）：永久删除索引，包括其所有数据和元数据。</li></ul><p>使用ILM可以更轻松地管理热-温-冷体系结构中的索引，在使用时间序列数据时很常见（如日志和指标）。</p><h3 id="索引生命周期（Index-lifecycle）"><a href="#索引生命周期（Index-lifecycle）" class="headerlink" title="索引生命周期（Index lifecycle）"></a>索引生命周期（Index lifecycle）</h3><p>ILM定义了以下四个阶段（Phases）</p><ul><li>Hot：频繁的写入和查询</li><li>Warm：索引不在更新，仍然在查询</li><li>Cold：不再更新的索引，很少查询仍然可以搜索，查询较慢也没关系</li><li>Delete：不再需要的索引，可以安全的删除</li></ul><p>索引的生命周期策略指定了应用于哪些阶段，每个阶段中执行什么操作，以及何时在两个阶段之间进行转换。</p><p>创建索引时可以手动应用生命周期策略。对于时间序列索引，需要将生命周期策略与用于在序列中创建新索引的索引模板相关联。当索引滚动时，不会自动将手动应用的策略应用于新索引。</p><h4 id="阶段转换（phase-transitions）"><a href="#阶段转换（phase-transitions）" class="headerlink" title="阶段转换（phase transitions）"></a>阶段转换（phase transitions）</h4><p>ILM根据其年龄在整个生命周期中移动索引。要控制这些翻转的时间，请为每个阶段设置一个最小年龄。为了使索引移至下一阶段，当前阶段中的所有操作都必须完成，并且索引必须早于下一阶段的最小年龄。</p><p>最小年龄默认为0，这会导致ILM在当前阶段中的所有操作完成后立即将索引移至下一阶段。</p><p>如果索引具有未分配的分片并且集群运行状况为黄色，则索引仍可以根据其索引生命周期管理策略过渡到下一阶段。但是，由于Elasticsearch只能在绿色集群上执行某些清理任务，因此可能会有意外的副作用。</p><h4 id="阶段执行（phase-execution）"><a href="#阶段执行（phase-execution）" class="headerlink" title="阶段执行（phase execution）"></a>阶段执行（phase execution）</h4><p>ILM控制阶段中的动作的执行的顺序，以及哪些步骤是执行每个动作的必要索引操作。</p><p>当索引进入阶段后，ILM将阶段定义信息缓存在索引元数据中，这样可以确保索引政策更新不会将索引置于永远不退出阶段的状态。</p><p>ILM定期运行，检查索引是否符合策略标准，并执行所需的步骤。为了避免竞争情况，ILM可能需要运行多次执行，完成一项动作所需的所有步骤。这意味着即使<code>indexs.lifecycle.poll_interval</code>设置为10分钟并且索引满足翻转条件，也可能需要20分钟才能完成翻转。</p><h4 id="阶段动作（phase-actions）"><a href="#阶段动作（phase-actions）" class="headerlink" title="阶段动作（phase actions）"></a>阶段动作（phase actions）</h4><p>参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/ilm-index-lifecycle.html#ilm-phase-actions">https://www.elastic.co/guide/en/elasticsearch/reference/7.11/ilm-index-lifecycle.html#ilm-phase-actions</a></p><h3 id="索引生命周期动作（Index-Lifecycle-Actions）"><a href="#索引生命周期动作（Index-Lifecycle-Actions）" class="headerlink" title="索引生命周期动作（Index Lifecycle Actions）"></a>索引生命周期动作（Index Lifecycle Actions）</h3><ul><li>Allocate：将分片移动到具有不同性能特征的节点，并减少副本的数量。</li><li>Delete：永久删除索引。</li><li>Force merge：减少索引段的数量并清除已删除的文档。将索引设为只读。</li><li>Freeze：冻结索引以最大程度地减少其内存占用量。</li><li>Migrate：将索引分片移动到对应于当前 ILM 阶段的数据层。</li><li>Read only：阻止对索引的写操作。</li><li>Rollover：移动索引作为滚动别名的写索引，并开始索引到新索引。</li><li>Searchable snapshot：为配置库中的管理索引拍摄快照，并将其作为可搜索快照。</li><li>Set priority：降低索引在生命周期中的优先级，以确保首先恢复热索引。</li><li>Shrink：通过将索引缩小为新索引来减少主碎片的数量。</li><li>Unfollow：将关注者索引转换为常规索引。在Rollover、Shrink和Searchable snapshot操作之前自动执行。</li><li>Wait for snapshot：删除索引之前，请确保快照已存在。</li></ul><h3 id="ILM更新（Lifecycle-policy-updates）"><a href="#ILM更新（Lifecycle-policy-updates）" class="headerlink" title="ILM更新（Lifecycle policy updates）"></a>ILM更新（Lifecycle policy updates）</h3><p>您可以通过修改当前策略或切换到其他策略的方式来更改管理索引或滚动索引集合的生命周期。</p><p>为确保策略更新不会将索引置于无法退出当前阶段的状态，进入这个阶段时，阶段定义会缓存在索引元数据中。如果策略更新可以安全的应用，ILM更新缓冲的阶段定义；如果不能，则使用缓冲阶段定义完成该阶段。</p><h3 id="Rollover（翻转）"><a href="#Rollover（翻转）" class="headerlink" title="Rollover（翻转）"></a>Rollover（翻转）</h3><p>在为日志或指标等时间序列数据编制索引时，不能无限期地写入单个索引。为了满足索引和搜索性能要求并管理资源使用，可以写入索引直到达到某个阈值，然后创建一个新索引并开始写入该索引。</p><p>使用滚动索引能够：</p><ul><li>优化活跃的索引，以在高性能热节点上获得高接收速率。</li><li>针对热节点上的搜索性能进行优化。</li><li>将较旧的，访问频率较低的数据转移到价格较低的冷节点上。</li><li>根据您的保留政策，通过删除整个索引来删除数据。</li></ul><p>我们建议使用数据流来管理时间序列数据。数据流自动跟踪写入索引，同时将配置保持在最低水平。数据流设计用于仅追加数据，其中数据流名称可用作操作（读取，写入，翻转，收缩等）目标。如果您的用例需要就地更新数据，则可以使用索引别名来管理时间序列数据。</p><h4 id="自动翻转（automatic-rollover）："><a href="#自动翻转（automatic-rollover）：" class="headerlink" title="自动翻转（automatic rollover）："></a>自动翻转（automatic rollover）：</h4><p>ILM使您能够根据索引大小，文档数或使用年限自动翻转到新索引。触发翻转后，将创建一个新索引，将写入别名更新为指向新索引，并将所有后续更新写入新索引。<br>与基于时间的过渡相比，基于大小，文档数或使用年限翻转至新索引更可取。在任意时间滚动通常会导致许多小的索引，这可能会对性能和资源使用产生负面影响。</p><h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看索引所处哪个阶段、应用策略等</span></span><br><span class="line">GET datastream-*/_ilm/explain</span><br><span class="line"><span class="comment"># 创建索引管理策略</span></span><br><span class="line">PUT _ilm/policy/full_policy</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;policy&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;phases&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;hot&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;actions&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;rollover&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;max_age&quot;</span>: <span class="string">&quot;7d&quot;</span>,</span><br><span class="line">            <span class="string">&quot;max_size&quot;</span>: <span class="string">&quot;50G&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;warm&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;min_age&quot;</span>: <span class="string">&quot;30d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;actions&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;forcemerge&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;max_num_segments&quot;</span>: 1</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;shrink&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;number_of_shards&quot;</span>: 1</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;allocate&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;number_of_replicas&quot;</span>: 2</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;cold&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;min_age&quot;</span>: <span class="string">&quot;60d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;actions&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;allocate&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;require&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;box_type&quot;</span>: <span class="string">&quot;cold&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;delete&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;min_age&quot;</span>: <span class="string">&quot;90d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;actions&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;delete&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="数据流（Data-streams）"><a href="#数据流（Data-streams）" class="headerlink" title="数据流（Data streams）"></a>数据流（Data streams）</h2><p>数据流用于跨多个索引存储仅追加的时间序列数据，同时提供一个用于请求的数据流名称。<br>可以将索引和搜索请求直接提交到数据流。流自动将请求路由到存储流数据的索引。同样可以使用索引生命周期管理（ILM）来自动管理这些后备索引。<br>数据流非常适合日志，事件，指标和其他连续生成的数据。</p><h2 id="索引别名（index-alias）"><a href="#索引别名（index-alias）" class="headerlink" title="索引别名（index alias）"></a>索引别名（index alias）</h2><h4 id="Request-body"><a href="#Request-body" class="headerlink" title="Request body"></a>Request body</h4><ul><li>actions：必填，要执行的一组动作<ul><li>add：添加一个索引别名</li><li>remove：删除一个索引别名</li><li>remove_index：删除索引</li></ul></li></ul><p>actions on alias objects：</p><ul><li>index：指定索引名称，允许逗号分隔或通配符</li><li>alias：指定别名名称，允许逗号分隔或通配符</li><li>filter：使用别名查询时，限制条件</li><li>is_write_index：标记作为别名的写索引，一个别名同时只能有一个写索引</li><li>routing：指定路由到特定分片</li><li>search_routing：搜索路由</li><li>index_routing：索引路由</li></ul><h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">PUT /&lt;index&gt;/_alias/&lt;<span class="built_in">alias</span>&gt;</span><br><span class="line">DELETE /&lt;index&gt;/_alias/&lt;<span class="built_in">alias</span>&gt;</span><br><span class="line">GET /_alias</span><br><span class="line">GET /_alias/&lt;<span class="built_in">alias</span>&gt;</span><br><span class="line">GET /&lt;index&gt;/_alias/&lt;<span class="built_in">alias</span>&gt;</span><br><span class="line"></span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;actions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;remove&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;index&quot;</span>: <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;alias1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;index&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">                <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;alias1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;is_write_index&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;add&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;index&quot;</span>: <span class="string">&quot;test2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;alias&quot;</span>: <span class="string">&quot;alias1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;is_write_index&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="滚动索引（rollover-index）"><a href="#滚动索引（rollover-index）" class="headerlink" title="滚动索引（rollover index）"></a>滚动索引（rollover index）</h2><p>当现有的索引满足您提供的条件（a list of conditions）时，滚动索引API会为滚动目标（rollover target）创建一个新的索引。<br>当滚动目标是别名（alias）时，别名会指向新索引（当指向多个索引时，必须有一个索引设置<code>is_write_index=true</code>）<br>当滚动目标是数据流（data stream）时，新索引会成为数据流的写索引，并生成一个增量</p><h3 id="Rollover-request"><a href="#Rollover-request" class="headerlink" title="Rollover request"></a>Rollover request</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /&lt;rollover-target&gt;/_rollover/&lt;target-index&gt;</span><br><span class="line">POST /&lt;rollover-target&gt;/_rollover/</span><br></pre></td></tr></table></figure><p>滚动索引接受一个滚动目标（rollover target）和一个条件列表（a list of conditions）。可以使用API撤销太大或太旧的索引。</p><p>当满足滚动条件，滚动请求在不同的场景下，滚动操作有所不同：</p><ul><li>如果滚动目标是别名指向单个索引时：</li></ul><ol><li>创建新索引</li><li>别名指向新索引</li><li>原始索引中移除别名</li></ol><ul><li>如果滚动目标是别名指向多个索引时，必须有一个索引设置<code>is_write_index=true</code>：</li></ul><ol><li>创建新索引</li><li>设置新索引is_write_index=true</li><li>设置原始索引is_write_index=false</li></ol><ul><li>如果滚动目标是数据流：</li></ul><ol><li>创建新索引</li><li>在数据流上添加新索引作为支持索引和写索引</li><li>增加数据流的generation属性</li></ol><h3 id="Path-parameters"><a href="#Path-parameters" class="headerlink" title="Path parameters"></a>Path parameters</h3><ul><li><code>&lt;rollover-target&gt;</code>：必填，现有的分配给目标索引的索引别名或数据流名称。</li><li><code>&lt;target-index&gt;</code>：可选，用于创建和分配索引别名的目标索引名称。如果<code>&lt;rollover-target&gt;</code>是数据流，则不允许使用此参数。如果<code>&lt;rollover-target&gt;</code>是索引别名，则分配给以”-“和数字结尾的索引名称，如logs-000001。</li></ul><h3 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /logs-000001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aliases&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;logs_write&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add &gt; 1000 documents to logs-000001</span></span><br><span class="line"></span><br><span class="line">POST /logs_write/_rollover</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;conditions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_age&quot;</span>:   <span class="string">&quot;7d&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max_docs&quot;</span>:  1000,</span><br><span class="line">    <span class="string">&quot;max_size&quot;</span>:  <span class="string">&quot;5gb&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Elasticsearch索引介绍，包括索引设置、索引模板、索引生命周期管理、翻滚索引、索引别名、滚动索引。&lt;br&gt; 基于7.11版本。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="技术" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/categories/%E6%8A%80%E6%9C%AF/ELK/"/>
    
    
    <category term="技术" scheme="http://www.lights8080.com/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="ELK" scheme="http://www.lights8080.com/tags/ELK/"/>
    
    <category term="Elasticsearch" scheme="http://www.lights8080.com/tags/Elasticsearch/"/>
    
  </entry>
  
</feed>
